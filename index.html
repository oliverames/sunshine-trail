<!DOCTYPE html>
<html lang="en" dir="ltr" style="color-scheme: light;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>The Sunshine Trail | Lawson's Finest Liquids</title>
    <meta name="description" content="Explore Sunshine Spots from Waitsfield, VT to Asheville, NC. Interactive map of retailers, hiking trails, river put-ins, and community partners along the Appalachian corridor.">
    <meta name="keywords" content="Lawson's Finest Liquids, Sip of Sunshine, craft beer, Vermont brewery, hiking trails, Blue Ridge Parkway, Skyline Drive, Route 100, Appalachian trail, beer finder, outdoor adventures">
    <meta name="author" content="Lawson's Finest Liquids">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://sunshine-trail.demo.com/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sunshine-trail.demo.com/">
    <meta property="og:title" content="The Sunshine Trail | Lawson's Finest Liquids">
    <meta property="og:description" content="Explore Sunshine Spots from Waitsfield, VT to Asheville, NC. Interactive map of retailers, hiking trails, river put-ins, and community partners along the Appalachian corridor.">
    <meta property="og:image" content="https://sunshine-trail.demo.com/assets/images/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="The Sunshine Trail">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://sunshine-trail.demo.com/">
    <meta name="twitter:title" content="The Sunshine Trail | Lawson's Finest Liquids">
    <meta name="twitter:description" content="Explore Sunshine Spots from Waitsfield, VT to Asheville, NC. Interactive map of retailers, hiking trails, and community partners.">
    <meta name="twitter:image" content="https://sunshine-trail.demo.com/assets/images/og-image.png">

    <!-- Additional SEO Meta Tags -->
    <meta name="format-detection" content="telephone=no">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Geographic Meta Tags -->
    <meta name="geo.region" content="US-VT">
    <meta name="geo.placename" content="Waitsfield, Vermont">
    <meta name="geo.position" content="44.1859;-72.8294">
    <meta name="ICBM" content="44.1859, -72.8294">

    <meta name="theme-color" content="#f8e849" id="theme-color-default">
    <meta name="theme-color" content="#f8e849" media="(prefers-color-scheme: light)" id="theme-color-light">
    <meta name="theme-color" content="#f8e849" media="(prefers-color-scheme: dark)" id="theme-color-dark">
    <meta name="color-scheme" content="light">
    <meta name="supported-color-schemes" content="light">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Security Headers -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">

    <!-- Content Security Policy - allows necessary external resources -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://unpkg.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://use.typekit.net https://unpkg.com;
        font-src 'self' https://fonts.gstatic.com https://use.typekit.net data:;
        img-src 'self' data: blob: https: http:;
        connect-src 'self' https://nominatim.openstreetmap.org https://*.basemaps.cartocdn.com https://*.tile.openstreetmap.org;
        frame-ancestors 'self';
    ">

    <!-- Early auth check - runs before body parses to prevent any flash of password page -->
    <script>
        // Feature detection for localStorage (handles private browsing - Issue #20)
        try {
            if (localStorage.getItem('sunshineTrailAuth') === 'true') {
                document.documentElement.classList.add('authenticated');
                // Update theme color to white immediately
                document.querySelectorAll('meta[name="theme-color"]').forEach(m => m.content = '#ffffff');
            }
        } catch (e) {
            // localStorage not available (private browsing mode)
        }
    </script>
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <link rel="apple-touch-icon" href="assets/images/favicon.png">

    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@graph": [
            {
                "@type": "WebSite",
                "@id": "https://sunshine-trail.demo.com/#website",
                "url": "https://sunshine-trail.demo.com/",
                "name": "The Sunshine Trail",
                "description": "Interactive map of Sunshine Spots along the Appalachian corridor",
                "publisher": {
                    "@id": "https://sunshine-trail.demo.com/#organization"
                }
            },
            {
                "@type": "Organization",
                "@id": "https://sunshine-trail.demo.com/#organization",
                "name": "Lawson's Finest Liquids",
                "url": "https://www.lawsonsfinest.com",
                "slogan": "Finest. Freshest. Always Kept Cold.â„¢",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://www.lawsonsfinest.com/wp-content/uploads/2025/11/SOS-lockup.svg"
                },
                "sameAs": [
                    "https://www.facebook.com/LawsonsFinestLiquids/",
                    "https://www.instagram.com/lawsonsfinest/"
                ],
                "address": {
                    "@type": "PostalAddress",
                    "streetAddress": "155 Carroll Road",
                    "addressLocality": "Waitsfield",
                    "addressRegion": "VT",
                    "postalCode": "05673",
                    "addressCountry": "US"
                }
            },
            {
                "@type": "WebPage",
                "@id": "https://sunshine-trail.demo.com/#webpage",
                "url": "https://sunshine-trail.demo.com/",
                "name": "The Sunshine Trail | Lawson's Finest Liquids",
                "description": "Explore Sunshine Spots from Waitsfield, VT to Asheville, NC. Interactive map of retailers, hiking trails, river put-ins, and community partners.",
                "isPartOf": {
                    "@id": "https://sunshine-trail.demo.com/#website"
                },
                "about": {
                    "@id": "https://sunshine-trail.demo.com/#organization"
                },
                "primaryImageOfPage": {
                    "@type": "ImageObject",
                    "url": "https://sunshine-trail.demo.com/assets/images/og-image.png"
                }
            },
            {
                "@type": "TouristTrip",
                "name": "The Sunshine Trail Road Trip",
                "description": "The ultimate road trip from Asheville, NC to Waitsfield, VT via America's most scenic mountain roads including the Blue Ridge Parkway, Skyline Drive, and Vermont Route 100.",
                "touristType": ["Road Trip", "Beer Tourism", "Outdoor Adventure"],
                "itinerary": {
                    "@type": "ItemList",
                    "itemListElement": [
                        {
                            "@type": "ListItem",
                            "position": 1,
                            "name": "Blue Ridge Parkway",
                            "description": "469 miles of scenic mountain driving"
                        },
                        {
                            "@type": "ListItem",
                            "position": 2,
                            "name": "Skyline Drive",
                            "description": "105 miles through Shenandoah National Park"
                        },
                        {
                            "@type": "ListItem",
                            "position": 3,
                            "name": "I-81 / US-7 Connector",
                            "description": "Connecting route through Virginia and New York"
                        },
                        {
                            "@type": "ListItem",
                            "position": 4,
                            "name": "Vermont Route 100",
                            "description": "217 miles through the Green Mountains"
                        }
                    ]
                }
            }
        ]
    }
    </script>

    <!-- Resource preloading for critical assets (#44) -->
    <link rel="preload" href="assets/images/fidget-sun.png" as="image">
    <link rel="preload" href="assets/images/lawsons-logo.svg" as="image">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://nominatim.openstreetmap.org">
    <link rel="dns-prefetch" href="https://basemaps.cartocdn.com">

    <!-- Note: SRI hashes removed - unpkg content changes can invalidate hashes -->
    <!-- To re-add SRI, generate fresh hashes from https://www.srihash.org/ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <!-- Lawson's Finest Liquids Adobe Typekit Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/abz4zsp.css">
    <style>
        :root {
            /* Lawson's Finest brand colors - extracted from website */
            --sunshine-gold: #EAC054;      /* Primary gold from "Explore" text & Beer Finder button */
            --sunshine-orange: #E87722;    /* Orange from sun logo */
            --sunshine-red: #C13A28;       /* Red accent from sun logo */
            --deep-brown: #2d2a26;         /* Logo text color */
            --forest-green: #3A5F3A;       /* Trail marker - earthy green */
            --river-blue: #4A90A4;         /* River marker - mountain stream blue */
            --community-purple: #7B5B9A;   /* Community marker - softer purple */
            --cream: #FFFBF2;              /* Warm cream background */
            --light-gold: #FDF5E6;         /* Light gold for highlights */
            --amber: #FCB900;              /* Luminous amber from site */

            /* Responsive Breakpoints - Single Source of Truth (#39)
               These MUST match APP_CONFIG.BREAKPOINTS in JavaScript */
            --breakpoint-mobile: 768px;
            --breakpoint-tablet: 1024px;
            --breakpoint-desktop: 1280px;
            --breakpoint-sidebar-large: 1400px;
            --breakpoint-sidebar-xlarge: 1800px;

            /* Sidebar widths - MUST match APP_CONFIG.SIDEBAR_WIDTHS */
            --sidebar-width-default: 420px;
            --sidebar-width-large: 460px;
            --sidebar-width-xlarge: 500px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Allow text selection in input fields */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        html {
            /* White background for Safari tab bar color sampling */
            background-color: #ffffff;
        }

        /* When authenticated, body should also be white for Safari color sampling */
        html.authenticated body {
            background-color: #ffffff;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--light-gold);
            color: var(--deep-brown);
            display: flex;
            /* Prevent text selection and copying */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            flex-direction: column;
        }

        header {
            background: #ffffff;
            color: var(--deep-brown);
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e5e5;
            flex-shrink: 0;
            overflow: visible;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 2rem;
            overflow: visible;
        }

        /* Stack tagline under title when viewport is too narrow for side-by-side with sun */
        @media (max-width: 1280px) and (min-width: 769px) {
            header {
                flex-wrap: nowrap;
            }

            .logo-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
                flex-shrink: 0;
            }

            .tagline {
                font-size: 1rem;
            }

            h1 {
                font-size: 2rem;
                white-space: nowrap;
                word-break: keep-all;
                overflow-wrap: normal;
            }
        }

        .header-trail-logo {
            height: 55px;
            width: auto;
        }

        .brand-logo-link {
            display: flex;
            align-items: center;
        }

        .header-brand-logo {
            height: 38px;
            width: auto;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .header-brand-logo:hover {
            opacity: 0.85;
        }

        /* Fidget Sun Spinner */
        .fidget-sun-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            margin: -40px;
            cursor: grab;
        }

        .fidget-sun {
            width: 80px;
            height: 80px;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.05s linear;
            pointer-events: none;
        }

        .fidget-sun-container:active {
            cursor: grabbing;
        }

        .fidget-sun.spinning {
            transition: none;
        }

        /* Footer fidget sun - hidden on desktop */
        .fidget-sun-footer {
            display: none;
        }

        /* Sidebar fidget sun - hidden on desktop */
        .fidget-sun-sidebar {
            display: none;
        }

        @media (max-width: 768px) {
            /* Hide header fidget sun on tablet/mobile */
            .fidget-sun-container {
                display: none;
            }

            /* Show sidebar fidget sun on tablet/mobile */
            .fidget-sun-sidebar {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 30px 40px;
                margin-top: 1rem;
                cursor: grab;
                touch-action: none;
            }

            .fidget-sun-sidebar .fidget-sun {
                width: 80px;
                height: 80px;
                pointer-events: auto !important;
                cursor: grab;
                user-select: none;
                -webkit-user-drag: none;
                touch-action: none;
            }

            .fidget-sun-sidebar:active {
                cursor: grabbing;
            }
        }

        /* Larger fidget sun on bigger phones (iPhone Pro Max, etc.) */
        @media (max-width: 768px) and (min-width: 390px) {
            .fidget-sun-sidebar .fidget-sun {
                width: 100px;
                height: 100px;
            }

            .fidget-sun-sidebar {
                padding: 35px 45px;
            }
        }


        .header-title-link {
            text-decoration: none;
            color: inherit;
            display: block;
            overflow: visible;
        }

        .header-title-link:hover {
            opacity: 1;
        }

        h1 {
            font-family: "new-spirit", serif;
            font-weight: 700;
            font-size: 3rem;
            letter-spacing: 0.5px;
            color: var(--deep-brown);
            overflow: visible;
        }

        h1 span {
            --mouse-x: 50%;
            --mouse-y: 50%;
            --glow-intensity: 0;
            --glow-left: 0px;
            --glow-top: 0px;
            --glow-width: 100px;
            --glow-height: 50px;
            color: #ffc72d;
            cursor: default;
            position: relative;
            z-index: 1;
            overflow: visible;
        }

        /* God rays glow overlay - full viewport coverage, no clipping */
        #god-rays-glow {
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 9999;
        }

        #god-rays-glow.active {
            opacity: 1;
        }

        #god-rays-glow .glow-radial {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                rgba(255, 245, 180, 0.75) 0%,
                rgba(255, 230, 120, 0.55) 5%,
                rgba(255, 210, 80, 0.4) 12%,
                rgba(255, 190, 50, 0.25) 20%,
                rgba(255, 170, 30, 0.12) 30%,
                rgba(255, 150, 0, 0.04) 45%,
                transparent 60%
            );
        }

        /* HDR/P3 enhanced colors for wide-gamut displays */
        @supports (color: color(display-p3 1 1 1)) {
            @media (color-gamut: p3) {
                #god-rays-glow .glow-radial {
                    background: radial-gradient(
                        circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                        color(display-p3 1 0.98 0.75 / 0.75) 0%,
                        color(display-p3 1 0.92 0.5 / 0.55) 5%,
                        color(display-p3 1 0.85 0.35 / 0.4) 12%,
                        color(display-p3 1 0.78 0.22 / 0.25) 20%,
                        color(display-p3 1 0.7 0.12 / 0.12) 30%,
                        color(display-p3 1 0.62 0 / 0.04) 45%,
                        transparent 60%
                    );
                }
            }
        }

        #god-rays-glow .glow-rays {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                repeating-conic-gradient(
                    from 0deg at var(--mouse-x, 50%) var(--mouse-y, 50%),
                    transparent 0deg,
                    rgba(255, 230, 100, 0.25) 2deg,
                    transparent 4deg,
                    transparent 15deg
                );
            filter: blur(4px);
        }

        /* HDR rays for P3 displays */
        @supports (color: color(display-p3 1 1 1)) {
            @media (color-gamut: p3) {
                #god-rays-glow .glow-rays {
                    background:
                        repeating-conic-gradient(
                            from 0deg at var(--mouse-x, 50%) var(--mouse-y, 50%),
                            transparent 0deg,
                            color(display-p3 1 0.92 0.45 / 0.25) 2deg,
                            transparent 4deg,
                            transparent 15deg
                        );
                }
            }
        }

        .tagline {
            font-family: 'new-spirit', serif;
            font-size: 1.25rem;
            color: #666;
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
        }

        .cold-beer {
            transition: color 2.5s ease-out, text-shadow 2.5s ease-out;
            cursor: pointer;
            position: relative;
        }

        .cold-beer:hover {
            transition: color 0.6s ease, text-shadow 0.6s ease;
            color: #7ec8e3;
            text-shadow:
                0 0 8px rgba(135, 206, 235, 0.8),
                0 0 15px rgba(173, 216, 230, 0.6);
        }

        /* Full-page freeze overlay */
        .freeze-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(
                180deg,
                rgba(120, 170, 255, 0.40) 0%,
                rgba(100, 160, 250, 0.30) 50%,
                rgba(80, 150, 250, 0.20) 100%
            );
            pointer-events: none;
            opacity: 0;
            transition: opacity 2.5s ease-out; /* Slow fade-in matching snowflake fall time */
            z-index: 9998;
        }

        .freeze-overlay.active {
            opacity: 1;
            transition: opacity 2.5s ease-out; /* Fade in as first snowflakes fall */
        }

        .freeze-overlay.instant-off {
            opacity: 0;
            transition: opacity 0.8s ease-out;
        }

        /* Snowflake styles */
        .snowflake {
            position: fixed;
            top: -30px;
            color: #fff;
            font-size: 1.5rem;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            text-shadow: 0 0 8px rgba(200, 230, 255, 0.9), 0 0 15px rgba(173, 216, 230, 0.5);
            /* GPU acceleration for smooth mobile performance */
            will-change: transform, opacity;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        /* Snowfall animation - constant speed fall */
        /* Wind effect is applied separately via JavaScript left position adjustment */
        @keyframes snowfall {
            0% {
                transform: translateY(-20px) rotate(0deg) translateX(0);
                opacity: 0.75;
            }
            25% {
                transform: translateY(calc(27.5vh)) rotate(calc(var(--spin) * 0.25)) translateX(var(--sway1));
            }
            50% {
                transform: translateY(calc(55vh)) rotate(calc(var(--spin) * 0.5)) translateX(var(--sway2));
            }
            75% {
                transform: translateY(calc(82.5vh)) rotate(calc(var(--spin) * 0.75)) translateX(var(--sway3));
            }
            100% {
                transform: translateY(110vh) rotate(var(--spin)) translateX(var(--sway4));
                opacity: 0.25;
            }
        }

        /* Snowflake melting animation for thaw */
        @keyframes snowMelt {
            0% {
                opacity: 0.9;
                transform: scale(1);
            }
            50% {
                opacity: 0.4;
                transform: scale(0.7) translateY(5px);
            }
            100% {
                opacity: 0;
                transform: scale(0.3) translateY(15px);
            }
        }

        .snowflake.melting {
            animation: snowMelt 2.5s ease-out forwards !important;
        }

        .snowflake.thawing {
            transition: opacity 2.5s ease-out;
            opacity: 0 !important;
            /* Disable animation and transform updates during thaw for smoother fade */
            animation-play-state: paused !important;
        }

        /* Mobile-specific optimizations for smoother thaw */
        @media (max-width: 768px) {
            .snowflake.thawing {
                transition: opacity 3s ease-out; /* Longer fade on mobile */
            }
        }

        /* Snow close button (mobile only) - matches popup close button style */
        .snow-close-button {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .snow-close-button.visible {
            display: block;
            opacity: 1;
        }

        .snow-close-button::before {
            content: '';
            display: block;
            width: 18px;
            height: 18px;
            background: url('assets/images/close.svg') no-repeat center center;
            background-size: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .snow-close-button:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .filter-icon {
            width: 36px;
            height: 36px;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        main {
            position: relative;
            flex: 1;
            min-height: 0;
        }

        .sidebar {
            position: absolute;
            top: 1.25rem;
            left: 1.25rem;
            bottom: 1.25rem;
            width: 420px;
            background: white;
            padding: 1.25rem;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 16px;
            z-index: 1000;
        }

        .sidebar h2 {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--deep-brown);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .intro-text {
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: #555;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section h3 {
            font-family: 'new-spirit', serif;
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 0.75rem;
            color: var(--deep-brown);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        /* Only apply hover on devices that support it (not touch scroll) */
        @media (hover: hover) {
            .filter-item:hover {
                background-color: var(--light-gold);
            }
        }

        .filter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--sunshine-gold);
        }

        /* Hide checkbox when filter is loading, show spinner in its place */
        .filter-item.loading input[type="checkbox"] {
            display: none;
        }

        /* Filter spinner - replaces checkbox when loading */
        .filter-item .filter-spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gold);
            border-top-color: var(--sunshine-gold);
            border-radius: 50%;
            animation: filterSpinner 0.6s linear infinite;
            flex-shrink: 0;
        }

        .filter-item.loading .filter-spinner {
            display: block;
        }

        @keyframes filterSpinner {
            to { transform: rotate(360deg); }
        }

        .filter-item label {
            cursor: pointer;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }


        .count-badge {
            background: #ffc72d;
            padding: 0.25rem 0.6rem;
            border-radius: 8px;
            font-family: 'new-spirit', serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--deep-brown);
            min-width: 1.75rem;
            text-align: center;
        }

        .legend {
            background: #fffbf2;
            padding: 1rem;
            border-radius: 16px;
            margin-top: 1rem;
        }

        .legend h4 {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: var(--deep-brown);
        }

        .legend p {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--deep-brown);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        #map {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        /* Smooth Leaflet transitions */
        .leaflet-tile-container {
            transform: translateZ(0);
            will-change: transform;
        }

        .leaflet-zoom-anim .leaflet-zoom-animated {
            transition: transform 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .leaflet-pan-anim .leaflet-tile,
        .leaflet-pan-anim .leaflet-marker-pane {
            transition: transform 0.25s ease-out;
        }

        .leaflet-fade-anim .leaflet-popup {
            transition: opacity 0.2s ease-in-out;
        }

        /* Prevent marker icon distortion */
        .marker-icon {
            background: transparent !important;
        }

        /* Only apply hover effects on devices that support hover (not touch) */
        @media (hover: hover) and (pointer: fine) {
            .leaflet-marker-icon {
                transition: transform 0.15s ease-out, filter 0.15s ease-out;
                transform-origin: center bottom;
                /* GPU acceleration for smoother animations (Issue #37) */
                will-change: transform;
                transform: translateZ(0);
            }

            .leaflet-marker-icon:hover {
                transform: scale(1.1) translateY(-2px) translateZ(0);
            }
        }

        /* Disable transitions on touch devices to reduce jank (Issue #37) */
        @media (hover: none) {
            .leaflet-marker-icon {
                transition: none;
            }
        }

        /* Marker cluster styling */
        .marker-cluster {
            background: transparent;
        }

        .cluster-inner {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .cluster-brewery { background: #b45309; }
        .cluster-tastingroom { background: #dc2626; }
        .cluster-retailer { background: var(--sunshine-gold); color: var(--deep-brown); }
        .cluster-bar { background: #7c3aed; }
        .cluster-trail { background: var(--forest-green); }
        .cluster-river { background: var(--river-blue); }
        .cluster-community { background: var(--community-purple); }
        .cluster-charger { background: #22c55e; }

        /* Multi-category cluster pill - clear Leaflet defaults but allow pill background */
        .marker-cluster-pill {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Smooth fade-in for cluster pills at all zoom levels */
        .marker-cluster-pill > div {
            animation: clusterPillFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes clusterPillFadeIn {
            0% {
                opacity: 0;
            }
            40% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        /* Smooth transitions for cluster pills only */
        .marker-cluster-pill {
            transition: opacity 0.5s ease;
            /* GPU acceleration for smoother animations (Issue #37) */
            will-change: transform, opacity;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Faster animation on mobile to reduce perceived jank (Issue #37) */
        @media (max-width: 768px) {
            .marker-cluster-pill > div {
                animation-duration: 0.4s;
            }
        }

        /* High DPI optimization for marker icons on Retina displays (Issue #33) */
        @media (-webkit-min-device-pixel-ratio: 3), (min-resolution: 3dppx) {
            .leaflet-marker-icon img,
            .marker-cluster-pill img {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        /* Extra large phones (iPhone Pro Max 430px+) - adjust for better visibility (Issue #33) */
        @media (max-width: 768px) and (min-width: 428px) {
            /* Ensure cluster pills don't overflow on large screens */
            .marker-cluster {
                max-width: calc(100vw - 40px);
            }

            /* Slightly larger icons for better visibility on large phones */
            .marker-cluster-pill img {
                width: 32px !important;
                height: 32px !important;
            }

            /* Slightly larger markers for better touch targets */
            .leaflet-marker-icon {
                transform: scale(1.05);
            }
        }

        /* Custom Leaflet popup styles */
        /* Ensure popup pane is above the header (which has animation creating stacking context) */
        .leaflet-pane.leaflet-popup-pane {
            z-index: 10000 !important;
        }

        .leaflet-popup {
            z-index: 10001 !important;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .leaflet-popup-close-button {
            width: 26px !important;
            height: 26px !important;
            top: 20px !important;
            right: 24px !important;
            color: transparent !important;
            overflow: hidden;
            opacity: 0.9;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            position: absolute !important;
            z-index: 1000 !important;
            background-color: rgba(255, 255, 255, 0.85) !important;
            border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-close-button::before {
            content: '';
            display: block;
            width: 14px;
            height: 14px;
            background: url('assets/images/close.svg') no-repeat center center;
            background-size: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .leaflet-popup-close-button:hover {
            opacity: 1;
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-family: 'Open Sans', sans-serif;
        }

        .popup-title {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--deep-brown);
            margin-bottom: 0.5rem;
        }

        .popup-category {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        /* Add top padding when category is first (no image above) */
        .popup-category:first-child {
            margin-top: 20px;
        }

        .popup-category.brewery { background: #b45309; color: white; }
        .popup-category.tastingroom { background: #dc2626; color: white; }
        .popup-category.retailer { background: var(--sunshine-gold); color: var(--deep-brown); }
        .popup-category.bar { background: #7c3aed; color: white; }
        .popup-category.trail { background: var(--forest-green); color: white; }
        .popup-category.river { background: var(--river-blue); color: white; }
        .popup-category.community { background: var(--community-purple); color: white; }
        .popup-category.charger { background: #22c55e; color: white; }

        .popup-content-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }

        .popup-description {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .popup-location {
            font-size: 0.8rem;
            color: #777;
        }

        .popup-location a {
            color: var(--sunshine-gold);
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        .popup-location a:hover {
            color: var(--sunshine-orange);
        }

        .popup-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--river-blue);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .popup-link:hover {
            text-decoration: underline;
        }

        .popup-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        .popup-impact {
            background: var(--light-gold);
            padding: 0.6rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-size: 0.8rem;
            line-height: 1.5;
            border-left: 3px solid var(--sunshine-gold);
        }

        .popup-impact-label {
            font-weight: 600;
            color: var(--deep-brown);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .popup-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .popup-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1.1rem 1.75rem;
            border-radius: 50px;
            font-family: "new-spirit", serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            text-align: center;
            flex: 1;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
        }

        .popup-btn-primary {
            background: #ffc72d;
            color: #1a1a1a !important;
            overflow: hidden;
            position: relative;
        }

        .popup-btn-secondary {
            background: var(--deep-brown);
            color: #ffffff !important;
            border: none;
            overflow: hidden;
            position: relative;
        }

        @keyframes letterWave {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-4px);
            }
        }

        .wave-text span {
            display: inline-block;
            animation: letterWave 0.4s ease-in-out;
            animation-fill-mode: both;
        }

        .zoom-hint.wave-text span {
            animation: letterWave 0.25s ease-in-out;
        }

        /* Custom marker styles */
        .leaflet-marker-icon {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Improve rendering of marker icons (some contain embedded PNGs) */
        .leaflet-marker-icon img,
        .marker-cluster-pill img {
            image-rendering: -webkit-optimize-contrast; /* Chrome, Safari */
            image-rendering: crisp-edges; /* Firefox */
            -ms-interpolation-mode: nearest-neighbor; /* IE */
            backface-visibility: hidden;
            transform: translateZ(0); /* Force GPU rendering */
        }

        /* Cluster pill icon wave animation - matches letter wave (bounce up) */
        @keyframes iconWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        /* Only animate icons inside cluster pills on hover, not individual markers */
        @media (hover: hover) {
            .marker-cluster-pill:hover img {
                animation: iconWave 0.4s ease-in-out;
                animation-fill-mode: both;
            }

            /* Right-to-left stagger: last icon animates first (like button text) */
            .marker-cluster-pill:hover img:nth-last-child(2) { animation-delay: 0s; }
            .marker-cluster-pill:hover img:nth-last-child(3) { animation-delay: 0.05s; }
            .marker-cluster-pill:hover img:nth-last-child(4) { animation-delay: 0.1s; }
            .marker-cluster-pill:hover img:nth-last-child(5) { animation-delay: 0.15s; }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            html, body {
                height: auto;
                min-height: 100%;
                overflow-x: hidden;
                overflow-y: auto;
            }

            main {
                display: flex;
                flex-direction: column;
                height: auto;
                min-height: auto;
                overflow: visible;
            }

            .sidebar {
                position: relative;
                top: auto;
                left: auto;
                bottom: auto;
                width: 100%;
                padding: 1.5rem;
                order: 2;
                box-shadow: none;
                border-radius: 0;
                overflow-y: visible;
                height: auto;
                z-index: auto;
            }

            #map {
                position: relative;
                height: 50vh;
                min-height: 300px;
                max-height: 450px;
                order: 1;
                flex-shrink: 0;
                width: 100%;
                transition: height 0.3s ease, min-height 0.3s ease, max-height 0.3s ease;
            }

            /* Expanded map state for mobile - fills safe area below header */
            #map.map-expanded {
                /* Account for header (85px) + bottom safe area (home indicator on iPhone) */
                height: calc(100vh - 85px - env(safe-area-inset-bottom, 0px));
                height: calc(100dvh - 85px - env(safe-area-inset-bottom, 0px));
                min-height: calc(100vh - 85px - env(safe-area-inset-bottom, 0px));
                min-height: calc(100dvh - 85px - env(safe-area-inset-bottom, 0px));
                max-height: none;
                /* Add padding at bottom to prevent content from being under home indicator */
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            /* Hide sidebar content when map is expanded */
            #map.map-expanded ~ .sidebar {
                display: none;
            }

            /* Hide scroll indicator when map is expanded to prevent overlap with map controls */
            body:has(#map.map-expanded) .scroll-indicator {
                display: none !important;
            }

            header {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
            }

            .logo-section {
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
            }

            .tagline {
                font-size: 1rem;
                white-space: normal;
                text-align: center;
            }

            h1 {
                font-size: 1.8rem;
            }

            .header-trail-logo {
                height: 45px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .metric-item {
                margin: 0;
            }

            .metric-value {
                font-size: 1.4rem;
            }

            .metric-prefix {
                font-size: 0.95rem;
            }

            .metric-suffix {
                font-size: 0.8rem;
            }

            .metric-label {
                font-size: 0.75rem;
            }

            .bcorp-badge {
                padding: 1rem 1.5rem;
                max-width: 280px;
                margin: 0 auto;
            }

            .bcorp-badge img {
                height: auto;
                max-height: 120px;
            }

            .bottom-brand-logo {
                height: 45px;
            }

            /* Hide footer on mobile since logo will be in sidebar */
            .bottom-brand {
                display: none;
            }
        }

        /* Larger desktop screens */
        @media (min-width: 1400px) {
            .metric-value {
                font-size: 1.8rem;
            }

            h1 {
                font-size: 3.2rem;
            }

            .sidebar {
                width: 460px;
            }

            .zoom-hint {
                left: calc(490px + (100% - 490px) / 2);
            }
        }

        /* Very large screens */
        @media (min-width: 1800px) {
            .sidebar {
                width: 500px;
            }

            h1 {
                font-size: 3.5rem;
            }

            .zoom-hint {
                left: calc(530px + (100% - 530px) / 2);
            }
        }

        /* Desktop screens - use 1 column for metrics to fit decimal numbers */
        @media (min-width: 769px) {
            .metrics-grid {
                grid-template-columns: 1fr !important;
                gap: 0.4rem;
            }

            .metric-item {
                margin: 0;
                padding: 0.5rem;
            }
        }

        /* Zoom hint overlay - centered in visible map area */
        .zoom-hint {
            position: absolute;
            bottom: 100px;
            left: calc(450px + (100% - 450px) / 2);
            transform: translateX(-50%);
            background: rgba(45, 42, 38, 0.95);
            color: var(--cream);
            padding: 0.85rem 1.75rem;
            border-radius: 25px;
            font-family: 'new-spirit', serif;
            font-size: 1.2rem;
            font-weight: 700;
            z-index: 1000;
            pointer-events: auto;
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: breathingGlow 4s ease-in-out infinite;
        }

        @keyframes breathingGlow {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            30% {
                box-shadow: 0 0 25px rgba(234, 192, 84, 0.9), 0 0 50px rgba(234, 192, 84, 0.6), 0 0 80px rgba(234, 192, 84, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(234, 192, 84, 0.8), 0 0 45px rgba(234, 192, 84, 0.5), 0 0 70px rgba(234, 192, 84, 0.25);
            }
            70% {
                box-shadow: 0 0 15px rgba(234, 192, 84, 0.5), 0 0 30px rgba(234, 192, 84, 0.3), 0 0 50px rgba(234, 192, 84, 0.15);
            }
        }

        .zoom-hint:hover {
            /* Keep transform centered, no movement up */
            transform: translateX(-50%);
            /* Keep breathing glow animation - don't disable it */
        }

        .zoom-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Mobile zoom hint adjustments */
        @media (max-width: 768px) {
            .zoom-hint {
                left: 50%;
                bottom: 20px;
                font-size: 0.95rem;
                padding: 0.75rem 1.5rem;
                min-width: 200px;
                max-width: 85%;
                text-align: center;
                white-space: normal;
                line-height: 1.3;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Mobile: slower cluster pill fade */
        @media (max-width: 1200px) {
            .marker-cluster-pill > div {
                animation: clusterPillFadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            }
        }

        /* Style Leaflet zoom controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
            overflow: hidden;
        }

        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out {
            background: #ffc72d !important;
            color: var(--deep-brown) !important;
            font-weight: 700 !important;
            border: none !important;
            width: 48px !important;
            height: 48px !important;
            line-height: 48px !important;
            font-size: 26px !important;
        }

        .leaflet-control-zoom-in:hover,
        .leaflet-control-zoom-out:hover {
            background: #e6b328 !important;
        }

        .leaflet-control-zoom-in {
            border-radius: 10px 10px 0 0 !important;
        }

        .leaflet-control-zoom-out {
            border-radius: 0 0 10px 10px !important;
        }

        .leaflet-bottom.leaflet-right .leaflet-control-zoom {
            margin-bottom: 30px;
            margin-right: 15px;
        }

        /* Map Search Control - inside Leaflet control container, anchored to zoom buttons */
        .map-search-control {
            position: relative; /* Positioning context for results */
            margin-bottom: 10px; /* Gap between search and zoom buttons */
            margin-right: 15px; /* Same as zoom controls */
            pointer-events: auto !important; /* Override Leaflet's pointer-events: none on .leaflet-bottom */
        }

        .map-search-btn {
            width: 48px;
            height: 48px;
            background: #f8e849;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            pointer-events: auto !important; /* Ensure clickable */
            -webkit-tap-highlight-color: transparent;
            align-self: center; /* Ensure vertical alignment in flex container */
            flex-shrink: 0; /* Prevent shrinking */
            margin: 0; /* Remove any default margins */
        }

        .map-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .map-search-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .map-search-btn svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: var(--deep-brown);
            stroke-width: 2px;
            pointer-events: none; /* Clicks should go through to button */
        }

        .map-search-container {
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto !important; /* Override Leaflet's pointer-events: none */
        }

        .map-search-input {
            width: 0;
            height: 48px; /* Match search button height */
            padding: 0;
            margin: 0; /* Remove any default margins */
            border: none;
            border-radius: 10px;
            background: white;
            font-family: 'new-spirit', serif;
            font-size: 1rem;
            line-height: 48px; /* Match height for vertical text centering */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            outline: none;
            box-sizing: border-box;
            align-self: center; /* Ensure vertical alignment in flex container */
            flex-shrink: 0; /* Prevent shrinking */
            -webkit-appearance: none; /* Remove default browser styling */
            position: relative;
            top: -1px; /* Fine-tune vertical alignment with button */
        }

        .map-search-input.expanded {
            width: 320px;
            padding: 0 16px; /* Horizontal padding only - height handles vertical */
            opacity: 1;
        }

        .map-search-input::placeholder {
            color: #999;
        }

        .map-search-results {
            position: absolute;
            bottom: 60px; /* Float above the input */
            right: 56px; /* Align with input: 48px (button) + 8px (gap) */
            width: 320px; /* Same width as expanded input */
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: none;
            z-index: 1002;
            pointer-events: auto;
        }

        .map-search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #fff9e6;
        }

        .search-result-name {
            font-family: 'new-spirit', serif;
            font-weight: 600;
            color: var(--deep-brown);
            font-size: 0.95rem;
        }

        .search-result-location {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .search-result-category {
            display: inline-block;
            font-size: 0.7rem;
            background: #ffc72d;
            color: var(--deep-brown);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 4px;
            text-transform: capitalize;
        }

        .search-no-results {
            padding: 16px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            /* On mobile, search control is inside leaflet container - no absolute positioning needed */
            .map-search-control {
                /* Remove absolute positioning - let flexbox in leaflet container handle it */
                position: relative;
                bottom: auto;
                right: auto;
            }

            /* Mobile search input expands to left of button */
            .map-search-input.expanded {
                width: calc(100vw - 95px); /* Expand to fill available space */
                padding: 0 16px;
                font-size: 1rem;
            }

            /* Search results on mobile - wider to match input, position above input */
            .map-search-results {
                width: calc(100vw - 95px);
                right: 56px;
                bottom: 55px; /* Position above the 48px search input + gap */
                max-height: 200px;
            }
        }

        /* Extra narrow mobile viewports */
        @media (max-width: 420px) {
            /* Search control positioning handled by leaflet container */

            .map-search-input.expanded {
                width: calc(100vw - 85px); /* Slightly narrower margins */
            }

            .map-search-results {
                left: 10px;
                right: 10px;
                bottom: 55px; /* Position above the search input */
                width: auto; /* Override calc() width when using left/right */
            }
        }

        /* Sidebar brand section */
        .sidebar-brand {
            padding: 2rem 0;
            text-align: center;
            margin-top: 1.5rem;
            border-top: 1px solid #e5e5e5;
            animation: fadeInUp 0.6s ease-out 0.9s both;
        }

        .sidebar-brand-link {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .sidebar-brand-link:hover {
            opacity: 0.85;
            transform: translateY(-2px);
        }

        .sidebar-brand-logo {
            height: 60px;
            width: auto;
        }

        .sidebar-brand-cta {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--deep-brown);
            opacity: 0.7;
        }

        /* Bottom brand section (desktop footer) */
        .bottom-brand {
            padding: 3rem 2rem;
            text-align: center;
            background: transparent;
            display: none; /* Hidden by default, sidebar-brand is preferred */
        }

        .bottom-brand-link {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            transition: opacity 0.3s ease;
        }

        .bottom-brand-link:hover {
            opacity: 0.8;
        }

        .bottom-brand-logo {
            height: 70px;
            width: auto;
        }

        .bottom-brand-cta {
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            color: var(--deep-brown);
            opacity: 0.7;
        }

        .demo-disclaimer {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.75rem;
            color: var(--deep-brown);
            opacity: 0.5;
            margin: 1.5rem auto 0.5rem;
            max-width: 300px;
            line-height: 1.4;
        }

        .demo-copyright {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.7rem;
            color: var(--deep-brown);
            opacity: 0.4;
            margin: 0;
        }

        /* Have a Sip Section */
        .beer-section {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 16px;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1rem;
            animation: fadeInUp 0.6s ease-out 0.8s both;
        }

        .beer-section-image {
            flex: 0 0 auto;
            max-width: 340px;
            cursor: pointer;
            display: block;
        }

        .beer-section-image img {
            max-width: 100%;
            height: auto;
            transition: transform 0.3s ease;
        }

        .beer-section-image:hover img {
            transform: scale(1.05);
        }

        .beer-section-content {
            flex: 1;
        }

        .beer-section-content h3 {
            font-family: "new-spirit", serif;
            font-weight: 700;
            font-size: 1.75rem;
            color: var(--deep-brown);
            margin-bottom: 0.5rem;
        }

        .beer-section-content p {
            font-family: 'Open Sans', sans-serif;
            font-size: 1.05rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .beer-section-btn {
            display: inline-block;
            padding: 1.25rem 3rem;
            background: #ffc72d;
            color: #1a1a1a;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.25rem;
            border-radius: 50px;
            text-decoration: none;
            border: none;
        }


        @media (max-width: 768px) {
            .beer-section {
                padding: 1.25rem;
            }

            .beer-section-image {
                max-width: 280px;
            }

            .beer-section-content h3 {
                font-size: 1.3rem;
            }
        }

        /* Page Load Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Apply animations */
        header {
            animation: fadeInDown 0.6s ease-out;
        }

        .sidebar {
            animation: fadeInLeft 0.6s ease-out 0.2s both;
        }

        .intro-text {
            animation: fadeIn 0.8s ease-out 0.4s both;
        }

        .filter-section {
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }

        .filter-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Only apply hover on devices that support it (not touch scroll) */
        @media (hover: hover) {
            .filter-item:hover {
                transform: translateX(5px);
                background-color: var(--light-gold);
            }
        }

        .filter-item:active {
            transform: translateX(2px) scale(0.98);
        }

        .legend {
            animation: fadeInUp 0.6s ease-out 0.7s both;
        }

        #map {
            animation: fadeIn 1s ease-out 0.3s both;
        }

        footer {
            animation: fadeInUp 0.5s ease-out 0.8s both;
        }

        /* Filter checkbox animation */
        .filter-item input[type="checkbox"] {
            transition: transform 0.2s ease;
        }

        .filter-item input[type="checkbox"]:checked {
            animation: pulse 0.3s ease;
        }

        /* Count badge animation */
        .count-badge {
            transition: all 0.3s ease;
        }

        @media (hover: hover) {
            .filter-item:hover .count-badge {
                background: #ffc72d;
                transform: scale(1.1);
            }
        }

        /* Button hover effects */
        .popup-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .popup-btn:active {
            transform: translateY(0);
        }

        /* Logo hover effect - disabled */
        .header-trail-logo {
            transition: none;
        }

        .header-trail-logo:hover {
            transform: none;
        }

        /* Shimmer effect for loading state */
        .loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* State Filter Buttons */
        .state-filter-section {
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.6s ease-out 0.6s both;
        }

        .state-filter-section h3 {
            font-family: 'new-spirit', serif;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--deep-brown);
        }

        .state-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .state-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ffc72d;
            background: #FFFDF7;
            color: var(--deep-brown);
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        /* No fill/shadow/raise on hover - only wave animation */
        .state-btn:hover {
            /* Wave animation applied via JS - no visual changes here */
        }

        .state-btn:active {
            /* Subtle feedback on click only */
            opacity: 0.9;
        }

        .state-btn.active {
            background: #ffc72d;
            color: var(--deep-brown);
        }

        /* Live Metrics Section - Styled like Lawson's website */
        .metrics-section {
            background: #f7e949;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out 0.65s both;
            box-shadow: 0 4px 20px rgba(234, 192, 84, 0.3);
        }

        .metrics-section-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(45, 42, 38, 0.15);
        }

        .metrics-section-header h3 {
            font-family: 'new-spirit', serif;
            font-weight: 900;
            font-size: 1.75rem;
            color: var(--deep-brown);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 0 0 0.5rem 0;
        }

        .metrics-tagline {
            font-family: 'Open Sans', sans-serif;
            font-weight: 400;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--deep-brown);
            opacity: 0.85;
            margin: 0;
            line-height: 1.4;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        /* Mobile override for metrics grid - must come after base styles */
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr !important;
            }
        }

        .metric-item {
            text-align: center;
            padding: 0.75rem 0.5rem;
            background: #ffc72d;
            border-radius: 12px;
        }

        .metric-value {
            font-family: 'new-spirit', serif;
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--deep-brown);
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 2px;
        }

        .metric-prefix {
            font-size: 1rem;
        }

        .metric-suffix {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .metric-label {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.7rem;
            color: var(--deep-brown);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            opacity: 0.85;
        }

        .metric-link {
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metric-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .metric-link:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .metric-number {
            display: inline-block;
            min-width: 1ch;
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .metric-value.counting .metric-number {
            animation: countUp 0.1s ease-out;
        }

        /* Wave animation for metric numbers */
        .metric-number.wave span {
            display: inline-block;
            animation: letterWave 0.4s ease-in-out;
            animation-fill-mode: both;
        }

        /* Pulse dot for "live" indicator */
        .live-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: livePulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes livePulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
            }
        }

        /* Rotating metric carousel for solar display (Issue #15) */
        .metric-value-rotating {
            overflow: hidden;
            position: relative;
        }

        .metric-carousel {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .metric-slide {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.25rem;
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateX(100%);
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }

        .metric-slide.active {
            position: relative;
            opacity: 1;
            transform: translateX(0);
        }

        .metric-slide.exiting {
            transform: translateX(-100%);
            opacity: 0;
        }

        /* Smaller prefix text for "Powers" */
        .metric-slide .metric-prefix {
            font-size: 0.7em;
            font-weight: 500;
            margin-right: 0.2rem;
        }

        /* BCorp Section */
        .bcorp-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid rgba(45, 42, 38, 0.15);
        }

        /* Ensure equal spacing above metrics grid and below to bcorp */
        .metrics-grid {
            margin-bottom: 0;
        }

        .bcorp-badge {
            display: block;
            background: white;
            border-radius: 12px;
            padding: 1rem 2.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .bcorp-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .bcorp-badge img {
            width: 100%;
            height: auto;
        }

        /* Scenic Route Toggle */
        .route-toggle-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
            animation: fadeInUp 0.6s ease-out 0.55s both;
        }

        .route-toggle-section h3 {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.05rem;
            margin-bottom: 0.5rem;
            color: var(--deep-brown);
        }

        .route-info {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .route-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .route-toggle:hover {
            background-color: var(--light-gold);
        }

        .route-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--sunshine-gold);
            flex-shrink: 0;
        }

        /* Hide checkbox when loading, show spinner in its place */
        .route-toggle.loading input[type="checkbox"] {
            display: none;
        }

        .route-toggle label {
            cursor: pointer;
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            color: var(--deep-brown);
        }

        /* Route spinner - replaces checkbox when loading */
        .route-toggle .route-spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gold);
            border-top-color: var(--sunshine-gold);
            border-radius: 50%;
            animation: routeSpinner 0.6s linear infinite;
            flex-shrink: 0;
            order: -1; /* Place before label (where checkbox was) */
        }

        .route-toggle.loading .route-spinner {
            display: block;
        }

        @keyframes routeSpinner {
            to { transform: rotate(360deg); }
        }

        /* Route Legend */
        .route-legend {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #fffbf2;
            border-radius: 16px;
        }

        .get-itinerary-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        .get-itinerary-btn {
            display: inline-block;
            padding: 1rem 2.5rem;
            background: #ffc72d;
            border: none;
            border-radius: 50px;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1a1a1a;
            cursor: pointer;
            text-align: center;
        }

        .route-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .route-line {
            width: 24px;
            height: 4px;
            border-radius: 2px;
        }

        .route-line.blue-ridge {
            background: linear-gradient(90deg, #2E86AB, #4ECDC4);
        }

        .route-line.skyline {
            background: linear-gradient(90deg, #7B68EE, #9370DB);
        }

        .route-line.route-100 {
            background: linear-gradient(90deg, #228B22, #32CD32);
        }

        .route-line.connector {
            background: #888;
            border-style: dashed;
        }

        /* Hide Leaflet attribution */
        .leaflet-control-attribution {
            display: none !important;
        }

        /* Email Signup Modal */
        .email-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .email-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .email-modal {
            background: #f7e949;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .email-modal-overlay.visible .email-modal {
            transform: scale(1) translateY(0);
        }

        /* Email modal close button - matches popup close button style */
        .email-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.85);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .email-modal-close::before {
            content: '';
            display: block;
            width: 16px;
            height: 16px;
            background: url('assets/images/close.svg') no-repeat center center;
            background-size: contain;
        }

        .email-modal-close:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 1);
        }

        .email-modal-close:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .email-modal-close {
                width: 44px;
                height: 44px;
                top: 12px;
                right: 12px;
            }

            .email-modal-close::before {
                width: 20px;
                height: 20px;
            }
        }

        .email-modal-sun {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            touch-action: none;
        }

        .fidget-sun-modal {
            width: 80px;
            height: 80px;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.05s linear;
        }

        .fidget-sun-modal.spinning {
            transition: none;
        }

        .email-modal-sun:active {
            cursor: grabbing;
        }

        .email-modal h2 {
            font-family: 'new-spirit', serif;
            font-weight: 800;
            font-size: 1.75rem;
            color: var(--deep-brown);
            margin-bottom: 0.75rem;
        }

        .email-modal p {
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            color: var(--deep-brown);
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .email-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .email-input {
            padding: 1rem 1.25rem;
            font-size: 1rem;
            border: none;
            border-radius: 50px;
            font-family: 'Open Sans', sans-serif;
            transition: box-shadow 0.2s;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .email-input:focus {
            outline: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        .email-input::placeholder {
            color: #999;
        }

        .email-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--deep-brown);
            cursor: pointer;
        }

        .email-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--deep-brown);
        }

        .location-field {
            position: relative;
            animation: fadeInDown 0.3s ease-out;
            margin-top: 0.75rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .location-input {
            background: #ffffff !important;
        }

        .location-input.detecting {
            background: linear-gradient(90deg, #ffffff 0%, #f0f8ff 50%, #ffffff 100%) !important;
            background-size: 200% 100% !important;
            animation: locationShimmer 1.5s ease-in-out infinite !important;
        }

        @keyframes locationShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .email-submit {
            padding: 1.1rem 2rem;
            background: #ffc72d;
            color: var(--deep-brown);
            border: none;
            border-radius: 50px;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        /* Ripple effect for submit button */
        .email-submit::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .email-submit:active::after {
            width: 300px;
            height: 300px;
        }

        .email-disclaimer {
            font-size: 0.8rem !important;
            color: var(--deep-brown) !important;
            opacity: 0.7;
            margin-bottom: 0 !important;
            margin-top: 1rem !important;
        }

        @media (max-width: 768px) {
            .email-modal {
                padding: 2rem 1.5rem;
                margin: 0;
                width: 100%;
                height: 100%;
                max-width: 100%;
                border-radius: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .email-modal h2 {
                font-size: 1.4rem;
            }

            .email-modal p {
                font-size: 0.9rem;
            }

            /* Mobile touch feedback for Live Impact buttons - raise effect on active */
            .metric-link:hover {
                transform: none;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .metric-link:active {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
            }
        }

        /* Mobile Scroll Indicator - floating button that scrolls up/down */
        .scroll-indicator {
            display: none; /* Hidden on desktop */
        }

        @media (max-width: 768px) {
            .scroll-indicator {
                display: flex;
                position: fixed;
                bottom: calc(20px + env(safe-area-inset-bottom, 0px));
                right: 15px;
                width: 52px;
                height: 52px;
                background: rgba(255, 255, 255, 0.88);
                border: none;
                border-radius: 10px;
                cursor: pointer;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.25);
                z-index: 9997; /* Below sun rays (9999) and snow (9998) */
                transition: transform 0.2s ease, box-shadow 0.2s ease;
                -webkit-tap-highlight-color: transparent;
                pointer-events: auto !important;
            }

            /* Hover state - lift and add shadow, don't change color */
            @media (hover: hover) {
                .scroll-indicator:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 6px 16px rgba(0,0,0,0.30);
                }
            }

            /* When over yellow backgrounds, use fully opaque white with subtle border for better contrast */
            .scroll-indicator.over-yellow {
                background: rgba(255, 255, 255, 0.98);
                border: 1px solid rgba(45, 42, 38, 0.12);
                box-shadow: 0 4px 14px rgba(0, 0, 0, 0.22);
            }

            .scroll-indicator:active {
                transform: scale(0.95);
            }

            .scroll-indicator svg {
                width: 28px;
                height: 28px;
                fill: none;
                stroke: var(--deep-brown);
                stroke-width: 2.5px;
                transition: transform 0.3s ease;
                pointer-events: none;
            }

            /* Flip arrow when pointing up */
            .scroll-indicator.up svg {
                transform: rotate(180deg);
            }

            /* Bounce animation to draw attention - larger and more noticeable */
            @keyframes scrollBounce {
                0%, 100% { transform: translateY(0); }
                25% { transform: translateY(-12px); }
                50% { transform: translateY(-8px); }
                75% { transform: translateY(-14px); }
            }

            .scroll-indicator.bounce {
                animation: scrollBounce 1.2s ease-in-out;
            }
        }

        /* Beer section image - viewport-based animation on mobile */
        @media (max-width: 768px) {
            .beer-section-image img {
                transition: transform 0.5s ease;
            }

            .beer-section-image.in-view img {
                transform: scale(1.05);
            }
        }

        /* Prevent body scroll when password overlay is visible */
        html:not(.authenticated) {
            overflow: hidden;
            height: 100%;
        }

        html:not(.authenticated) body {
            overflow: hidden;
            height: 100%;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }

        /* Password Protection Overlay - presentation gate */
        /* Styled to match email modal for consistency */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8e849;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            transition: opacity 0.8s ease, visibility 0.8s ease;
            /* Prevent touch events from passing through to body */
            touch-action: none;
            -webkit-overflow-scrolling: auto;
            overscroll-behavior: contain;
        }

        /* Hide immediately for returning users - no transition */
        .password-overlay.instant-hidden {
            display: none !important;
        }

        /* Hide password overlay when authenticated (set by early script in head) */
        html.authenticated .password-overlay {
            display: none !important;
        }

        .password-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .password-overlay-content {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        /* Rotating sun for password modal */
        .password-sun {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            touch-action: none;
        }

        .fidget-sun-password {
            width: 120px;
            height: 120px;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.05s linear;
            pointer-events: none;
        }

        .fidget-sun-password.spinning {
            transition: none;
        }

        .password-sun:active {
            cursor: grabbing;
        }

        /* Make password sun bigger on mobile for better touch interaction */
        @media (max-width: 768px) {
            .fidget-sun-password {
                width: 160px;
                height: 160px;
            }

            .password-sun {
                padding: 20px;
                margin: -10px;
            }
        }

        /* Even bigger on larger phones for better prominence */
        @media (max-width: 768px) and (min-width: 390px) {
            .fidget-sun-password {
                width: 180px;
                height: 180px;
            }
        }

        /* Extra large on Pro Max phones (iPhone 14/15/16/17 Pro Max ~430px) */
        @media (max-width: 768px) and (min-width: 428px) {
            .fidget-sun-password {
                width: 200px;
                height: 200px;
            }
        }

        .password-overlay h1 {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 3rem;
            color: var(--deep-brown);
            margin-top: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .password-overlay .welcome-text {
            font-family: 'new-spirit', serif;
            font-weight: 800;
            font-size: 3rem;
            color: var(--deep-brown);
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.5s ease, transform 0.5s ease;
            /* Position absolutely so it doesn't take up space when hidden */
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.8);
        }

        .password-overlay .welcome-text.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .password-input-container {
            margin-bottom: 1rem;
        }

        /* Rounded pill input to match email modal */
        .password-input {
            width: 100%;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            border: none;
            border-radius: 50px;
            font-family: 'Open Sans', sans-serif;
            transition: box-shadow 0.2s;
            background: #ffffff;
            color: var(--deep-brown);
            text-align: center;
            letter-spacing: 2px;
        }

        .password-input::placeholder {
            color: #999;
            letter-spacing: normal;
        }

        .password-input:focus {
            outline: none;
        }

        /* Gold pill button to match email modal - wave animation only */
        .password-submit {
            width: 100%;
            padding: 1.1rem 2rem;
            background: #ffc72d;
            color: var(--deep-brown);
            border: none;
            border-radius: 50px;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        /* Wave text animation support for password submit */
        .password-submit.wave-text span {
            display: inline-block;
            animation: letterWave 0.4s ease-in-out;
            animation-fill-mode: both;
        }

        .password-error {
            color: #c0392b;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            margin-top: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .password-error.visible {
            opacity: 1;
        }

        .password-footer {
            position: absolute;
            bottom: 2rem;
            left: 0;
            right: 0;
            text-align: center;
            padding: 0 2rem;
        }

        .password-footer p {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.85rem;
            color: var(--deep-brown);
            opacity: 0.7;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .password-overlay h1 {
                font-size: 1.8rem;
            }
            .password-overlay .welcome-text {
                font-size: 2.5rem;
            }
            .password-footer {
                bottom: 1.5rem;
            }
            .password-footer p {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay - presentation gate -->
    <div class="password-overlay" id="password-overlay">
        <div class="password-overlay-content" id="password-content">
            <div class="password-sun">
                <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun-password" id="fidget-sun-password" draggable="false">
            </div>
            <h1>The Sunshine Trail</h1>
            <div class="password-input-container">
                <input type="password" class="password-input" id="password-input" placeholder="Enter password" autocomplete="off" aria-label="Password">
            </div>
            <button class="password-submit" id="password-submit" aria-label="Submit password">Enter</button>
            <div class="password-error" id="password-error">Incorrect password</div>
        </div>
        <div class="welcome-text" id="welcome-text">Welcome</div>
        <div class="password-footer">
            <p>This is a demonstration project and is not operated by or affiliated with Lawson's Finest Liquids.<br>Â© 2026 Ames Consulting LLC. All rights reserved.</p>
        </div>
    </div>

    <!-- Freeze overlay for cold beer hover effect -->
    <div class="freeze-overlay" id="freeze-overlay"></div>
    <button class="snow-close-button" id="snow-close-button" aria-label="Stop snow effect"></button>

    <!-- Mobile scroll indicator - floats above content, below effects -->
    <button class="scroll-indicator" id="scroll-indicator" aria-label="Scroll page">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4v16m0 0l-6-6m6 6l6-6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- God rays glow overlay - fixed position, highest z-index -->
    <div id="god-rays-glow">
        <div class="glow-radial"></div>
        <div class="glow-rays"></div>
    </div>

    <header>
        <div class="logo-section">
            <a href="./" class="header-title-link">
                <h1>The <span>Sunshine</span> Trail</h1>
            </a>
            <p class="tagline">Mountain communities. Outdoor adventures. <span class="cold-beer">Cold beer.</span></p>
        </div>
        <div class="fidget-sun-container">
            <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun" id="fidget-sun" draggable="false">
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <p class="intro-text">
                Explore the <strong>Sunshine Spots</strong> from Waitsfield, Vermont to Asheville, North Carolina.
                Discover retailers, hiking trails, river put-ins, and the community organizations we support along the way.
            </p>

            <div class="metrics-section">
                <div class="metrics-section-header">
                    <h3><span class="live-dot"></span> Live Impact</h3>
                    <p class="metrics-tagline">We pour a little good back into every community we call home.</p>
                </div>
                <div class="metrics-grid">
                    <a href="https://www.lawsonsfinest.com/sip/sunshine-fund/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value" id="metric-donated">
                            <span class="metric-prefix">$</span>
                            <span class="metric-number" id="donations-counter">0</span>
                        </div>
                        <div class="metric-label">Dollars Raised</div>
                    </a>
                    <a href="https://www.lawsonsfinest.com/sip/green-is-grand/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value metric-value-rotating" id="metric-solar">
                            <!-- Rotating metric display (Issue #15) -->
                            <div class="metric-carousel">
                                <div class="metric-slide active" data-metric="kwh">
                                    <span class="metric-number" id="solar-counter">0</span>
                                    <span class="metric-suffix">kWh</span>
                                </div>
                                <div class="metric-slide" data-metric="evmiles">
                                    <span class="metric-number" id="solar-evmiles">0</span>
                                    <span class="metric-suffix">EV miles</span>
                                </div>
                                <div class="metric-slide" data-metric="homes">
                                    <span class="metric-prefix">Powers</span>
                                    <span class="metric-number" id="solar-homes">0</span>
                                    <span class="metric-suffix">homes/yr</span>
                                </div>
                            </div>
                        </div>
                        <div class="metric-label">Solar Generated</div>
                    </a>
                    <a href="https://www.bcorporation.net/en-us/find-a-b-corp/company/lawsons-finest-liquids/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value" id="metric-bcorp">
                            <span class="metric-number">83.6</span>
                        </div>
                        <div class="metric-label">B Impact Score</div>
                    </a>
                    <a href="https://www.lawsonsfinest.com/sip/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value" id="metric-nonprofits">
                            <span class="metric-number">496</span>
                        </div>
                        <div class="metric-label">Nonprofits</div>
                    </a>
                </div>
                <div class="bcorp-section">
                    <a href="https://www.bcorporation.net/en-us/find-a-b-corp/company/lawsons-finest-liquids/" target="_blank" rel="noopener noreferrer" class="bcorp-badge" title="Certified B Corporation">
                        <img src="assets/images/b-corp-logo.png" alt="Certified B Corporation" loading="lazy">
                    </a>
                </div>
            </div>

            <div class="route-toggle-section">
                <h3>The Sunshine Trail Route</h3>
                <p class="route-info">The ultimate road trip from Asheville, NC to Waitsfield, VT via America's most scenic mountain roads.</p>
                <div class="route-toggle" id="route-toggle-container">
                    <input type="checkbox" id="toggle-scenic-route" checked>
                    <label for="toggle-scenic-route">Show Route on Map</label>
                    <span class="route-spinner"></span>
                </div>

                <div class="route-legend" id="route-legend" style="display: none;">
                    <div class="route-legend-item">
                        <span class="route-line blue-ridge"></span>
                        <span>Blue Ridge Parkway (469 mi)</span>
                    </div>
                    <div class="route-legend-item">
                        <span class="route-line skyline"></span>
                        <span>Skyline Drive (105 mi)</span>
                    </div>
                    <div class="route-legend-item">
                        <span class="route-line connector"></span>
                        <span>I-81 / US-7 Connector</span>
                    </div>
                    <div class="route-legend-item">
                        <span class="route-line route-100"></span>
                        <span>VT Route 100 (217 mi)</span>
                    </div>
                    <div class="get-itinerary-btn-container">
                        <button class="get-itinerary-btn" id="get-itinerary-btn" aria-label="Get road trip itinerary">Get Itinerary</button>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Filter by Category</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <input type="checkbox" id="filter-breweries" checked>
                        <span class="filter-spinner"></span>
                        <label for="filter-breweries">
                            <img src="assets/images/marker-brewery.svg" alt="" class="filter-icon">
                            Breweries
                            <span class="count-badge" id="count-breweries">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-tastingrooms" checked>
                        <span class="filter-spinner"></span>
                        <label for="filter-tastingrooms">
                            <img src="assets/images/marker-tastingroom.svg" alt="" class="filter-icon">
                            Tasting Rooms
                            <span class="count-badge" id="count-tastingrooms">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-retailers" checked>
                        <span class="filter-spinner"></span>
                        <label for="filter-retailers">
                            <img src="assets/images/marker-retailer.svg" alt="" class="filter-icon">
                            Retailers
                            <span class="count-badge" id="count-retailers">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-bars" checked>
                        <span class="filter-spinner"></span>
                        <label for="filter-bars">
                            <img src="assets/images/marker-bar.svg" alt="" class="filter-icon">
                            Bars & Restaurants
                            <span class="count-badge" id="count-bars">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-trails" checked>
                        <span class="filter-spinner"></span>
                        <label for="filter-trails">
                            <img src="assets/images/marker-trail.svg?v=2" alt="" class="filter-icon">
                            Trails
                            <span class="count-badge" id="count-trails">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-rivers" checked>
                        <span class="filter-spinner"></span>
                        <label for="filter-rivers">
                            <img src="assets/images/marker-river.svg?v=2" alt="" class="filter-icon">
                            River Put-ins
                            <span class="count-badge" id="count-rivers">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-community" checked>
                        <span class="filter-spinner"></span>
                        <label for="filter-community">
                            <img src="assets/images/marker-community.svg" alt="" class="filter-icon">
                            Community Partners
                            <span class="count-badge" id="count-community">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-chargers">
                        <span class="filter-spinner"></span>
                        <label for="filter-chargers">
                            <img src="assets/images/marker-charger.svg" alt="" class="filter-icon">
                            DC Fast Chargers
                            <span class="count-badge" id="count-chargers">0</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="state-filter-section">
                <h3>Filter by State</h3>
                <div class="state-buttons">
                    <button class="state-btn all-states active" data-state="all">All States</button>
                    <button class="state-btn" data-state="VT">VT</button>
                    <button class="state-btn" data-state="NH">NH</button>
                    <button class="state-btn" data-state="ME">ME</button>
                    <button class="state-btn" data-state="MA">MA</button>
                    <button class="state-btn" data-state="RI">RI</button>
                    <button class="state-btn" data-state="CT">CT</button>
                    <button class="state-btn" data-state="NY">NY</button>
                    <button class="state-btn" data-state="NJ">NJ</button>
                    <button class="state-btn" data-state="PA">PA</button>
                    <button class="state-btn" data-state="VA">VA</button>
                    <button class="state-btn" data-state="NC">NC</button>
                </div>
            </div>

            <div class="beer-section">
                <a href="https://www.lawsonsfinest.com/beer/" target="_blank" rel="noopener noreferrer" class="beer-section-image">
                    <img src="assets/images/beer-cans.png" alt="Lawson's Finest Liquids beers - Hop Wired, Sip of Sunshine, Little Sip" loading="lazy">
                </a>
                <div class="beer-section-content">
                    <h3>Have a Sip!</h3>
                    <p>Learn more about our finest and freshest signature liquids, limited releases, and taproom regulars.</p>
                    <a href="https://www.lawsonsfinest.com/beer/" target="_blank" rel="noopener noreferrer" class="beer-section-btn">Our Beers</a>
                </div>
            </div>

            <div class="legend">
                <h4>About This Trail</h4>
                <p>
                    The Sunshine Trail celebrates the shared culture of mountain communities along the East Coast -
                    from the Green Mountains of Vermont to the Blue Ridge of North Carolina.
                    Every spot on this map represents our commitment to quality, community, and the great outdoors.
                </p>
            </div>

            <div class="sidebar-brand">
                <a href="https://www.lawsonsfinest.com" target="_blank" rel="noopener noreferrer" class="sidebar-brand-link">
                    <img src="assets/images/lawsons-logo.svg" alt="Lawson's Finest Liquids" class="sidebar-brand-logo">
                    <span class="sidebar-brand-cta">Visit lawsonsfinest.com</span>
                </a>
                <p class="demo-disclaimer">This is a demonstration project and is not operated by or affiliated with Lawson's Finest Liquids.</p>
                <p class="demo-copyright">&copy; 2026 Ames Consulting LLC. All rights reserved.</p>
                <div class="fidget-sun-sidebar">
                    <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun" id="fidget-sun-sidebar" draggable="false">
                </div>
            </div>
        </aside>

        <div id="map" role="application" aria-label="Interactive map of Sunshine Trail locations from Vermont to North Carolina">
            <div class="zoom-hint" id="zoom-hint" title="Click to find Sunshine Spots near you">
                <span>Zoom for detail</span>
            </div>
            <!-- Map Search Control -->
            <div class="map-search-control" id="map-search-control">
                <div class="map-search-results" id="map-search-results"></div>
                <div class="map-search-container">
                    <input type="text" class="map-search-input" id="map-search-input" placeholder="Search places or listings..." aria-label="Search map locations">
                    <button class="map-search-btn" id="map-search-btn" title="Search map" aria-label="Search map">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="6" fill="none"/>
                            <line x1="14.5" y1="14.5" x2="20" y2="20"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Email Signup Modal -->
    <div class="email-modal-overlay" id="email-modal">
        <div class="email-modal">
            <button class="email-modal-close" id="email-modal-close" aria-label="Close"></button>
            <div class="email-modal-sun">
                <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun-modal" id="fidget-sun-modal" draggable="false" loading="lazy">
            </div>
            <h2>Get Your Free Road Trip Guide</h2>
            <p>Join the Lawson's newsletter to receive a detailed Sunshine Trail road trip plan with recommended stops, local tips, and exclusive brewery news.</p>
            <form class="email-form" id="email-form" aria-label="Newsletter signup form">
                <input type="text" placeholder="Your Name" required class="email-input" id="name-input" aria-label="Your name" aria-required="true">
                <input type="email" placeholder="Your Email" required class="email-input" id="email-input" aria-label="Your email address" aria-required="true">
                <label class="email-checkbox">
                    <input type="checkbox" id="local-checkbox" aria-label="Receive local happenings newsletter">
                    <span>Send me info about local happenings</span>
                </label>
                <div class="location-field" id="location-field" style="display: none;">
                    <input type="text" placeholder="Detecting your location..." class="email-input location-input" id="location-input" aria-label="Your location">
                </div>
                <button type="submit" class="email-submit" aria-label="Submit and send itinerary">Send My Itinerary</button>
            </form>
            <p class="email-disclaimer">By signing up, you'll join the Lawson's Finest newsletter. Unsubscribe anytime.</p>
        </div>
    </div>

    <footer class="bottom-brand">
        <a href="https://www.lawsonsfinest.com" target="_blank" rel="noopener noreferrer" class="bottom-brand-link">
            <img src="assets/images/lawsons-logo.svg" alt="Lawson's Finest Liquids" class="bottom-brand-logo" loading="lazy">
            <span class="bottom-brand-cta">Visit lawsonsfinest.com</span>
        </a>
        <p class="demo-disclaimer">This is a demonstration project and is not operated by or affiliated with Lawson's Finest Liquids.</p>
        <p class="demo-copyright">&copy; 2026 Ames Consulting LLC. All rights reserved.</p>
        <div class="fidget-sun-footer">
            <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun" id="fidget-sun-footer" draggable="false" loading="lazy">
        </div>
    </footer>

    <!-- Note: SRI hashes removed - unpkg content changes can invalidate hashes -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin="anonymous"></script>
    <script>
        // ============================================
        // SECURITY UTILITIES
        // ============================================

        // HTML escaping utility to prevent XSS attacks (Security Fix)
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Safe URL validation
        function isValidUrl(url) {
            if (!url) return false;
            try {
                const parsed = new URL(url);
                return parsed.protocol === 'https:' || parsed.protocol === 'http:';
            } catch {
                return false;
            }
        }

        // localStorage feature detection (handles private browsing mode)
        function storageAvailable() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        // ============================================
        // APPLICATION CONSTANTS (#37 - extract magic numbers)
        // Centralized configuration for maintainability
        // ============================================
        const APP_CONFIG = {
            // Timing constants
            GEOCODING_RATE_LIMIT_MS: 1100,  // Nominatim requires 1 request/second
            FORM_RATE_LIMIT_MS: 5000,       // 5 seconds between form submissions
            EMAIL_MODAL_DELAY_MS: 30000,    // 30 seconds before showing email modal
            POPUP_ANIMATION_MS: 300,        // Popup pan animation duration
            CLUSTER_DOUBLE_CLICK_MS: 2000,  // Time window for cluster double-click

            // Responsive Breakpoints - Single Source of Truth (#39)
            // These values MUST match the CSS media queries
            BREAKPOINTS: {
                MOBILE: 768,          // @media (max-width: 768px) - full-width map
                TABLET: 1024,         // Tablet upper bound
                DESKTOP: 1280,        // Desktop with floating sidebar
                SIDEBAR_LARGE: 1400,  // @media (min-width: 1400px) - wider sidebar
                SIDEBAR_XLARGE: 1800  // @media (min-width: 1800px) - widest sidebar
            },
            MIN_VIEWPORT_HEIGHT: 600,  // Short viewport threshold for zoom limits

            // Sidebar widths by breakpoint (matches CSS)
            // On desktop, sidebar floats over map, reducing "safe area"
            SIDEBAR_WIDTHS: {
                DEFAULT: 420,   // 769px - 1399px
                LARGE: 460,     // 1400px - 1799px
                XLARGE: 500     // 1800px+
            },

            // Map constants
            MAX_ZOOM_LEVEL: 15,             // Maximum zoom for clusters
            CLUSTER_SPIDERFY_ZOOM: 12,      // Zoom level for cluster spiderfy

            // Validation constants
            MAX_EMAIL_LENGTH: 254,          // RFC 5321 max email length
            MAX_NAME_LENGTH: 100,           // Max name input length
            MAX_LOCATION_LENGTH: 200,       // Max location input length

            // Floating-point comparison
            COORDINATE_EPSILON: 0.000001    // Epsilon for lat/lng comparison
        };

        // ============================================
        // VIEWPORT UTILITIES - Dynamic Responsive Helpers (#39)
        // Single source of truth for viewport queries
        // ============================================
        const Viewport = {
            // Current dimensions
            width: () => window.innerWidth,
            height: () => window.innerHeight,

            // Breakpoint queries
            isMobile: () => window.innerWidth <= APP_CONFIG.BREAKPOINTS.MOBILE,
            isTablet: () => {
                const w = window.innerWidth;
                return w > APP_CONFIG.BREAKPOINTS.MOBILE && w < APP_CONFIG.BREAKPOINTS.DESKTOP;
            },
            isDesktop: () => window.innerWidth >= APP_CONFIG.BREAKPOINTS.DESKTOP,
            isShortViewport: () => window.innerHeight < APP_CONFIG.MIN_VIEWPORT_HEIGHT,

            // Sidebar width calculation (0 on mobile, varies on desktop)
            getSidebarWidth: () => {
                if (Viewport.isMobile()) return 0;
                const w = window.innerWidth;
                if (w >= APP_CONFIG.BREAKPOINTS.SIDEBAR_XLARGE) {
                    return APP_CONFIG.SIDEBAR_WIDTHS.XLARGE;
                }
                if (w >= APP_CONFIG.BREAKPOINTS.SIDEBAR_LARGE) {
                    return APP_CONFIG.SIDEBAR_WIDTHS.LARGE;
                }
                return APP_CONFIG.SIDEBAR_WIDTHS.DEFAULT;
            },

            // Map safe area - the usable map width after sidebar overlap
            // On mobile: full width. On desktop: viewport minus floating sidebar
            getMapSafeWidth: () => {
                return Viewport.width() - Viewport.getSidebarWidth();
            },

            // Get the center point of the map safe area (accounts for sidebar)
            getMapSafeCenterX: () => {
                const sidebarWidth = Viewport.getSidebarWidth();
                // Safe area starts after sidebar, center is in the middle of safe area
                return sidebarWidth + (Viewport.getMapSafeWidth() / 2);
            },

            // Get current breakpoint name (useful for debugging)
            getCurrentBreakpoint: () => {
                const w = window.innerWidth;
                if (w <= APP_CONFIG.BREAKPOINTS.MOBILE) return 'mobile';
                if (w < APP_CONFIG.BREAKPOINTS.DESKTOP) return 'tablet';
                if (w < APP_CONFIG.BREAKPOINTS.SIDEBAR_LARGE) return 'desktop';
                if (w < APP_CONFIG.BREAKPOINTS.SIDEBAR_XLARGE) return 'desktop-large';
                return 'desktop-xlarge';
            }
        };

        // Shared emoji array for fidget sun burst animations (#51 - consolidate duplicates)
        const FIDGET_SUN_EMOJIS = ['ðŸ˜Š', 'ðŸ˜', 'ðŸº', 'ðŸ»', 'â˜€ï¸', 'ðŸ§Š', 'ðŸŒˆ'];

        // ============================================
        // PAGE VISIBILITY API - PAUSE ANIMATIONS WHEN TAB HIDDEN
        // Performance Fix: Prevents battery drain from idle animations
        // Note: Defined early so FidgetSunSpinner class can use it
        // ============================================
        let pageIsVisible = !document.hidden;
        const animationResumers = []; // Callbacks to resume animations when page becomes visible

        document.addEventListener('visibilitychange', function() {
            pageIsVisible = !document.hidden;
            if (pageIsVisible) {
                // Resume all registered animations
                animationResumers.forEach(resume => resume());
            }
        });

        // Register an animation to be paused/resumed with visibility
        function registerVisibilityAnimation(resumeCallback) {
            animationResumers.push(resumeCallback);
        }

        // ============================================
        // FIDGET SUN SPINNER CLASS (#36 - Consolidated)
        // Reusable class for all fidget sun spinners
        // Physics-based rotation with momentum, emoji burst, idle spin
        // ============================================
        class FidgetSunSpinner {
            constructor(elementId, options = {}) {
                this.element = document.getElementById(elementId);
                if (!this.element) return;

                this.container = this.element.parentElement;
                this.options = {
                    friction: options.friction || 0.9995,  // Ultra-low friction
                    idleSpeed: options.idleSpeed || 0.1,   // Idle rotation speed
                    emojis: options.emojis || FIDGET_SUN_EMOJIS,
                    burstCount: options.burstCount || 20,
                    enableIdle: options.enableIdle !== false,
                    preventBubble: options.preventBubble || false,
                    ...options
                };

                // Physics state
                this.rotation = 0;
                this.velocity = 0;
                this.isDragging = false;
                this.lastAngle = 0;
                this.lastTime = 0;
                this.animationId = null;
                this.idleRotation = 0;

                // Click detection state
                this.clickStartTime = 0;
                this.clickStartPos = { x: 0, y: 0 };

                // Bound methods for event listener cleanup
                this._boundDrag = this.drag.bind(this);
                this._boundEndDrag = this.endDrag.bind(this);
                this._boundIdleSpin = this.idleSpin.bind(this);

                this.init();
            }

            init() {
                if (!this.container) return;

                // Prevent clicks from bubbling (useful for modal fidget suns)
                if (this.options.preventBubble) {
                    this.element.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }

                // Mouse events - use container for larger hit area
                this.container.addEventListener('mousedown', (e) => this.startDrag(e));
                document.addEventListener('mousemove', this._boundDrag);
                document.addEventListener('mouseup', this._boundEndDrag);

                // Touch events
                this.container.addEventListener('touchstart', (e) => this.startDrag(e), { passive: false });
                document.addEventListener('touchmove', this._boundDrag, { passive: false });
                document.addEventListener('touchend', this._boundEndDrag);

                // Click/tap for emoji burst
                this.container.addEventListener('mousedown', (e) => this.recordClickStart(e));
                this.container.addEventListener('mouseup', (e) => this.checkBurst(e));
                this.container.addEventListener('touchstart', (e) => this.recordTouchStart(e), { passive: true });
                this.container.addEventListener('touchend', (e) => this.checkTouchBurst(e), { passive: true });

                // Start idle spin
                if (this.options.enableIdle) {
                    this.idleSpin();
                    registerVisibilityAnimation(this._boundIdleSpin);
                }
            }

            getAngle(e) {
                const rect = this.element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            startDrag(e) {
                e.preventDefault();
                this.isDragging = true;
                this.element.classList.add('spinning');
                this.lastAngle = this.getAngle(e);
                this.lastTime = Date.now();
                this.velocity = 0;
                if (this.animationId) cancelAnimationFrame(this.animationId);
            }

            drag(e) {
                if (!this.isDragging) return;
                e.preventDefault();
                const currentAngle = this.getAngle(e);
                const now = Date.now();
                const dt = Math.max(now - this.lastTime, 1);

                let deltaAngle = currentAngle - this.lastAngle;
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                this.rotation += deltaAngle * (180 / Math.PI);
                this.velocity = (deltaAngle * (180 / Math.PI)) / dt * 35;

                this.element.style.transform = `rotate(${this.rotation}deg)`;
                this.lastAngle = currentAngle;
                this.lastTime = now;
            }

            endDrag() {
                if (!this.isDragging) return;
                this.isDragging = false;
                this.element.classList.remove('spinning');
                this.animateMomentum();
            }

            animateMomentum() {
                if (Math.abs(this.velocity) < 0.005) {
                    this.velocity = 0;
                    return;
                }
                this.rotation += this.velocity;
                this.velocity *= this.options.friction;
                this.element.style.transform = `rotate(${this.rotation}deg)`;
                this.animationId = requestAnimationFrame(() => this.animateMomentum());
            }

            recordClickStart(e) {
                this.clickStartTime = Date.now();
                this.clickStartPos = { x: e.clientX, y: e.clientY };
            }

            recordTouchStart(e) {
                this.clickStartTime = Date.now();
                if (e.touches && e.touches.length > 0) {
                    this.clickStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            }

            checkBurst(e) {
                const elapsed = Date.now() - this.clickStartTime;
                const moved = Math.sqrt(
                    Math.pow(e.clientX - this.clickStartPos.x, 2) +
                    Math.pow(e.clientY - this.clickStartPos.y, 2)
                );
                if (elapsed < 200 && moved < 10) {
                    this.burstEmojis(e);
                }
            }

            checkTouchBurst(e) {
                const elapsed = Date.now() - this.clickStartTime;
                const endPos = e.changedTouches && e.changedTouches.length > 0
                    ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY }
                    : this.clickStartPos;
                const moved = Math.sqrt(
                    Math.pow(endPos.x - this.clickStartPos.x, 2) +
                    Math.pow(endPos.y - this.clickStartPos.y, 2)
                );
                if (elapsed < 300 && moved < 30) {
                    this.burstEmojis({ clientX: endPos.x, clientY: endPos.y });
                }
            }

            burstEmojis(e) {
                const rect = this.element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const shuffled = [...this.options.emojis].sort(() => Math.random() - 0.5);
                const selectedEmojis = shuffled.slice(0, 3);

                for (let i = 0; i < this.options.burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = selectedEmojis[Math.floor(Math.random() * selectedEmojis.length)];
                    const size = 24 + Math.random() * 20;
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${size}px;
                        pointer-events: none;
                        z-index: 10000;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    const angle = (Math.PI * 2 * i / this.options.burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 250 + Math.random() * 200;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 400;
                    const startTime = performance.now();
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 180 + Math.random() * 180;

                    function animateEmoji(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);
                        const scale = 1 + t * 0.5;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmoji);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmoji);
                }
            }

            idleSpin() {
                if (!pageIsVisible) return;
                if (!this.isDragging && Math.abs(this.velocity) < 0.1) {
                    this.idleRotation += this.options.idleSpeed;
                    this.element.style.transform = `rotate(${this.rotation + this.idleRotation}deg)`;
                }
                requestAnimationFrame(this._boundIdleSpin);
            }

            // Cleanup method for when spinner should be destroyed
            destroy() {
                document.removeEventListener('mousemove', this._boundDrag);
                document.removeEventListener('mouseup', this._boundEndDrag);
                document.removeEventListener('touchmove', this._boundDrag);
                document.removeEventListener('touchend', this._boundEndDrag);
                if (this.animationId) cancelAnimationFrame(this.animationId);
            }
        }

        // ============================================
        // PASSWORD PROTECTION OVERLAY
        // NOTE: This is a PRESENTATION GATE only, not security.
        // The password is visible in source code intentionally.
        // For actual security, use server-side authentication.
        // Uses localStorage for persistent caching
        // ============================================
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const passwordError = document.getElementById('password-error');
        const passwordContent = document.getElementById('password-content');
        const welcomeText = document.getElementById('welcome-text');
        // Presentation gate password (intentionally visible - not for security)
        const correctPassword = 'hireme';

        // Track authentication state for email timer
        window.siteRevealed = false;

        // Early search state declaration (needed before route toggle code)
        // Full collapse implementation - gets elements each time for safety
        let searchExpanded = false;
        window.collapseSearch = function() {
            searchExpanded = false;
            const input = document.getElementById('map-search-input');
            const results = document.getElementById('map-search-results');
            if (input) {
                input.classList.remove('expanded');
                input.value = '';
                input.blur();
            }
            if (results) {
                results.classList.remove('visible');
                results.innerHTML = '';
            }
            // Collapse map on mobile when search is closed (unless popup is open)
            if (Viewport.isMobile()) {
                const mapEl = document.getElementById('map');
                const hasOpenPopup = document.querySelector('.leaflet-popup');
                if (mapEl && mapEl.classList.contains('map-expanded') && !hasOpenPopup) {
                    mapEl.classList.remove('map-expanded');
                    setTimeout(() => {
                        if (window.map) window.map.invalidateSize({ animate: true });
                    }, 350);
                }
            }
        };

        // Update Safari theme-color to white (for after password page)
        function updateThemeColorToWhite() {
            const themeColorDefault = document.getElementById('theme-color-default');
            const themeColorLight = document.getElementById('theme-color-light');
            const themeColorDark = document.getElementById('theme-color-dark');
            if (themeColorDefault) themeColorDefault.content = '#ffffff';
            if (themeColorLight) themeColorLight.content = '#ffffff';
            if (themeColorDark) themeColorDark.content = '#ffffff';
        }

        // Check if already authenticated (persistent with localStorage)
        // Uses storageAvailable() for feature detection (Issue #20)
        const isAuthenticated = storageAvailable() && localStorage.getItem('sunshineTrailAuth') === 'true';
        if (isAuthenticated && passwordOverlay) {
            // Hide immediately - no flash, no transition
            passwordOverlay.classList.add('instant-hidden');
            window.siteRevealed = true;
            // Update theme color to white for main page
            updateThemeColorToWhite();
        }

        // Track password overlay event listeners for cleanup (Memory Leak Fix)
        const passwordOverlayListeners = [];
        function addPasswordListener(target, type, handler, options) {
            target.addEventListener(type, handler, options);
            passwordOverlayListeners.push({ target, type, handler, options });
        }
        function cleanupPasswordListeners() {
            passwordOverlayListeners.forEach(({ target, type, handler, options }) => {
                target.removeEventListener(type, handler, options);
            });
            passwordOverlayListeners.length = 0;
        }

        function completeAuthentication() {
            passwordOverlay.classList.add('hidden');
            // Add authenticated class to enable body scrolling
            document.documentElement.classList.add('authenticated');
            // Use localStorage for persistent caching
            if (storageAvailable()) {
                localStorage.setItem('sunshineTrailAuth', 'true');
            }
            // Signal that site is revealed (for email timer)
            window.siteRevealed = true;
            window.dispatchEvent(new CustomEvent('siteRevealed'));
            // Update theme color to white for main page
            updateThemeColorToWhite();
            // Clean up password overlay event listeners (Memory Leak Fix)
            cleanupPasswordListeners();
        }

        function handlePasswordSubmit() {
            const enteredPassword = passwordInput.value.toLowerCase().trim();
            if (enteredPassword === correctPassword) {
                // Correct password - show welcome and fade out
                passwordContent.style.opacity = '0';
                passwordContent.style.transform = 'scale(0.9)';
                passwordContent.style.transition = 'opacity 0.3s ease, transform 0.3s ease';

                setTimeout(() => {
                    passwordContent.style.display = 'none';
                    welcomeText.classList.add('visible');
                }, 300);

                setTimeout(() => {
                    completeAuthentication();
                }, 1500);
            } else {
                // Incorrect password - show error
                passwordError.classList.add('visible');
                passwordInput.value = '';
                passwordInput.focus();

                // Hide error after 2 seconds
                setTimeout(() => {
                    passwordError.classList.remove('visible');
                }, 2000);
            }
        }

        if (passwordSubmit) {
            passwordSubmit.addEventListener('click', handlePasswordSubmit);
        }

        if (passwordInput) {
            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handlePasswordSubmit();
                }
            });
            // Focus password input on load if not authenticated
            if (!isAuthenticated) {
                setTimeout(() => passwordInput.focus(), 100);
            }
        }

        // ============================================
        // FIDGET SUN SPINNER FOR PASSWORD MODAL
        // Same physics as header fidget sun with idle spin and emoji burst
        // ============================================
        const fidgetSunPassword = document.getElementById('fidget-sun-password');
        const passwordSunContainer = document.querySelector('.password-sun');

        if (fidgetSunPassword && passwordSunContainer && !isAuthenticated) {
            let passwordSunRotation = 0;
            let passwordSunVelocity = 0;
            let passwordSunLastAngle = 0;
            let passwordSunLastTime = 0;
            let passwordSunIsDragging = false;
            let passwordSunAnimationFrame = null;
            let passwordIdleRotation = 0;

            function getPasswordSunAngle(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            function startPasswordSunDrag(e) {
                e.preventDefault();
                passwordSunIsDragging = true;
                fidgetSunPassword.classList.add('spinning');
                const rect = fidgetSunPassword.getBoundingClientRect();
                passwordSunLastAngle = getPasswordSunAngle(e, rect);
                passwordSunLastTime = Date.now();
                passwordSunVelocity = 0;
                if (passwordSunAnimationFrame) cancelAnimationFrame(passwordSunAnimationFrame);
            }

            function movePasswordSunDrag(e) {
                if (!passwordSunIsDragging) return;
                e.preventDefault();
                const rect = fidgetSunPassword.getBoundingClientRect();
                const currentAngle = getPasswordSunAngle(e, rect);
                const now = Date.now();
                const dt = Math.max(now - passwordSunLastTime, 1);

                let deltaAngle = currentAngle - passwordSunLastAngle;
                // Handle angle wrap-around
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                passwordSunRotation += deltaAngle * (180 / Math.PI);
                passwordSunVelocity = (deltaAngle * (180 / Math.PI)) / dt * 35;

                fidgetSunPassword.style.transform = `rotate(${passwordSunRotation}deg)`;
                passwordSunLastAngle = currentAngle;
                passwordSunLastTime = now;
            }

            function endPasswordSunDrag() {
                if (!passwordSunIsDragging) return;
                passwordSunIsDragging = false;
                fidgetSunPassword.classList.remove('spinning');
                animatePasswordMomentum();
            }

            function animatePasswordMomentum() {
                if (Math.abs(passwordSunVelocity) < 0.005) {
                    passwordSunVelocity = 0;
                    return;
                }
                passwordSunRotation += passwordSunVelocity;
                passwordSunVelocity *= 0.9995;
                fidgetSunPassword.style.transform = `rotate(${passwordSunRotation}deg)`;
                passwordSunAnimationFrame = requestAnimationFrame(animatePasswordMomentum);
            }

            // Mouse events (using tracked listeners for cleanup - Memory Leak Fix)
            addPasswordListener(passwordSunContainer, 'mousedown', startPasswordSunDrag);
            addPasswordListener(document, 'mousemove', movePasswordSunDrag);
            addPasswordListener(document, 'mouseup', endPasswordSunDrag);

            // Touch events (using tracked listeners for cleanup - Memory Leak Fix)
            addPasswordListener(passwordSunContainer, 'touchstart', startPasswordSunDrag, { passive: false });
            addPasswordListener(document, 'touchmove', movePasswordSunDrag, { passive: false });
            addPasswordListener(document, 'touchend', endPasswordSunDrag);

            // Emoji burst on click/tap
            const passwordEmojis = ['ðŸ˜Š', 'ðŸ˜', 'ðŸº', 'ðŸ»', 'â˜€ï¸', 'ðŸ§Š', 'ðŸŒˆ'];
            let passwordClickStartTime = 0;
            let passwordClickStartPos = { x: 0, y: 0 };

            passwordSunContainer.addEventListener('mousedown', (e) => {
                passwordClickStartTime = Date.now();
                passwordClickStartPos = { x: e.clientX, y: e.clientY };
            });

            passwordSunContainer.addEventListener('mouseup', (e) => {
                const elapsed = Date.now() - passwordClickStartTime;
                const moved = Math.sqrt(
                    Math.pow(e.clientX - passwordClickStartPos.x, 2) +
                    Math.pow(e.clientY - passwordClickStartPos.y, 2)
                );
                if (elapsed < 200 && moved < 10) {
                    burstPasswordEmojis(e);
                }
            });

            passwordSunContainer.addEventListener('touchstart', (e) => {
                passwordClickStartTime = Date.now();
                if (e.touches && e.touches.length > 0) {
                    passwordClickStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            }, { passive: true });

            passwordSunContainer.addEventListener('touchend', (e) => {
                const elapsed = Date.now() - passwordClickStartTime;
                const endPos = e.changedTouches && e.changedTouches.length > 0
                    ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY }
                    : passwordClickStartPos;
                const moved = Math.sqrt(
                    Math.pow(endPos.x - passwordClickStartPos.x, 2) +
                    Math.pow(endPos.y - passwordClickStartPos.y, 2)
                );
                if (elapsed < 300 && moved < 30) {
                    burstPasswordEmojis({ clientX: endPos.x, clientY: endPos.y });
                }
            }, { passive: true });

            function burstPasswordEmojis(e) {
                const rect = fidgetSunPassword.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const shuffled = [...passwordEmojis].sort(() => Math.random() - 0.5);
                const selectedEmojis = shuffled.slice(0, 3);

                const burstCount = 20;
                for (let i = 0; i < burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = selectedEmojis[Math.floor(Math.random() * selectedEmojis.length)];
                    const size = 24 + Math.random() * 20;
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${size}px;
                        pointer-events: none;
                        z-index: 100000;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    const angle = (Math.PI * 2 * i / burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 250 + Math.random() * 200;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 400;
                    const startTime = performance.now();
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 180 + Math.random() * 180;

                    function animateEmoji(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);
                        const scale = 1 + t * 0.5;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmoji);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmoji);
                }
            }

            // Gentle idle spin (pauses when tab hidden to save battery)
            function passwordIdleSpin() {
                if (!pageIsVisible) return; // Pause when tab hidden
                if (!passwordSunIsDragging && Math.abs(passwordSunVelocity) < 0.1) {
                    passwordIdleRotation += 0.1;
                    fidgetSunPassword.style.transform = `rotate(${passwordSunRotation + passwordIdleRotation}deg)`;
                }
                requestAnimationFrame(passwordIdleSpin);
            }
            passwordIdleSpin();
            registerVisibilityAnimation(passwordIdleSpin);
        }

        // Initialize the map with smooth scrolling and animations
        const map = L.map('map', {
            center: [39.5, -77.5],
            zoom: 6,
            zoomControl: false,  // We'll add it manually to bottom-right
            scrollWheelZoom: true,
            zoomSnap: 0.1,              // Allow finer zoom levels
            zoomDelta: 0.25,            // Smaller zoom steps for smoother feel
            wheelPxPerZoomLevel: 100,   // More wheel movement per zoom level
            wheelDebounceTime: 40,      // Responsive wheel zoom
            zoomAnimation: true,
            fadeAnimation: true,
            markerZoomAnimation: true,
            inertia: true,
            inertiaDeceleration: 2000,  // Smooth deceleration
            inertiaMaxSpeed: 2000,
            easeLinearity: 0.2,         // Smoother easing
            tap: true,
            touchZoom: true,
            doubleClickZoom: true,
            boxZoom: true
        });

        // Expose map globally for cross-function access
        window.map = map;

        // Add a styled tile layer with smooth transitions
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19,
            updateWhenZooming: false,
            updateWhenIdle: true,
            keepBuffer: 4
        }).addTo(map);

        // Handle window resize
        // If user has zoomed: preserve their current view
        // If user hasn't zoomed: recenter to fit all markers in safe area
        let resizeTimeout;
        let lastBounds = null;

        window.addEventListener('resize', function() {
            if (!lastBounds) {
                lastBounds = map.getBounds();
            }
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                map.invalidateSize();

                // Check if unifiedCluster exists and user hasn't manually zoomed
                if (typeof unifiedCluster !== 'undefined' && !userHasZoomed) {
                    // Recenter to fit all markers
                    const clusterBounds = unifiedCluster.getBounds();
                    if (clusterBounds && clusterBounds.isValid()) {
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;
                        let maxZoom = 6;

                        if (viewportWidth < 768 || viewportHeight < 600) {
                            maxZoom = 4;
                        } else if (viewportWidth < 1200) {
                            maxZoom = 5;
                        }

                        fitBoundsWithSidebarOffset(clusterBounds, {
                            animate: true,
                            duration: 0.5,
                            maxZoom: maxZoom,
                            padding: [40, 40]
                        });
                    }
                } else if (lastBounds) {
                    // User has zoomed - restore their view
                    map.fitBounds(lastBounds, { animate: false });
                }
                lastBounds = null;
            }, 150);
        });

        // Define marker icons - using custom images with correct dimensions
        const markerIcons = {
            retailer: 'assets/images/marker-retailer.svg',
            brewery: 'assets/images/marker-brewery.svg',
            tastingroom: 'assets/images/marker-tastingroom.svg',
            bar: 'assets/images/marker-bar.svg',
            trail: 'assets/images/marker-trail.svg?v=2',
            river: 'assets/images/marker-river.svg?v=2',
            community: 'assets/images/marker-community.svg',
            charger: 'assets/images/marker-charger.svg'
        };

        // Create marker icon with pill background
        function createMarkerIcon(category) {
            const iconUrl = markerIcons[category];
            const pillStyle = 'display:flex;align-items:center;justify-content:center;width:46px;height:46px;background:#FFFDF7;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.25);border:2px solid #ffc72d;position:relative;';

            // Standard icon size for all categories (all icons are now square)
            const iconSize = '28px';
            const imgStyle = 'width:' + iconSize + ';height:' + iconSize + ';object-fit:contain;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);';

            return L.divIcon({
                html: '<div style="' + pillStyle + '"><img src="' + iconUrl + '" style="' + imgStyle + '" alt=""></div>',
                className: 'marker-icon-pill',
                iconSize: L.point(46, 46),
                iconAnchor: L.point(23, 23),
                popupAnchor: L.point(0, -23)
            });
        }

        // Sunshine Trail Data
        const sunshineSpots = [
            // === BREWERIES ===
            {
                name: "Lawson's Finest Liquids Brewery",
                category: "brewery",
                image: "place-headers/lawsons-finest-brewery.jpg",
                lat: 44.1852,
                lng: -72.8288,
                location: "155 Carroll Road, Waitsfield, VT",
                description: "The destination brewery and spiritual home of Lawson's Finest Liquids. Features a 34-barrel brewhouse, taproom, and Vermont's largest solar canopy.",
                url: "https://www.lawsonsfinest.com/taproom/"
            },
            {
                name: "Lawson's Original Nanobrewery",
                category: "brewery",
                image: "place-headers/lawsons-nanobrewery.jpg",
                lat: 44.1189,
                lng: -72.8556,
                location: "Warren, VT",
                description: "The 'Crooked Cabin' where Sean Lawson founded the brand in 2008. This 1-barrel nanobrewery is used for R&D and small-batch experimentation. Not open to public.",
                url: "https://www.lawsonsfinest.com/about-us/history/"
            },
            {
                name: "Two Roads Brewing Company",
                category: "brewery",
                image: "place-headers/two-roads-brewing.jpg",
                lat: 41.1884,
                lng: -73.1318,
                location: "1700 Stratford Ave, Stratford, CT",
                description: "Strategic production partner where Sip of Sunshine is brewed for regional distribution. Alternating proprietorship allows Lawson's direct quality control.",
                url: "https://tworoadsbrewing.com/"
            },

            // === TASTING ROOMS ===
            {
                name: "Lawson's Finest Taproom",
                category: "tastingroom",
                image: "place-headers/lawsons-taproom.jpg",
                lat: 44.1854,
                lng: -72.8285,
                location: "155 Carroll Road, Waitsfield, VT",
                description: "The primary tasting room featuring taproom-exclusive beers, seasonal releases, and the full Lawson's experience. Open daily with food menu and Bark Park for dogs.",
                url: "https://www.lawsonsfinest.com/taproom/"
            },

            // === BARS & RESTAURANTS ===
            // North Carolina
            {
                name: "The Whale",
                category: "bar",
                image: "place-headers/the-whale.jpg",
                lat: 35.5847,
                lng: -82.5673,
                location: "507 Haywood Rd, West Asheville, NC",
                description: "Tastemaker craft beer bar chosen as a primary launch partner for Lawson's NC distribution in 2024. Known for curated draft selection.",
                url: "https://thewhalecollective.com/west-asheville-nc/"
            },
            // Pennsylvania
            {
                name: "City Tap House",
                category: "bar",
                image: "place-headers/city-tap-house.jpg",
                lat: 39.9543,
                lng: -75.1715,
                location: "2 Logan Square, Philadelphia, PA",
                description: "Upscale gastropub explicitly featuring Sip of Sunshine on draft. Part of the Center City SIPS happy hour circuit.",
                url: "https://citytap.com/"
            },
            {
                name: "Uptown Beer Garden",
                category: "bar",
                image: "place-headers/uptown-beer-garden.jpg",
                lat: 39.9536,
                lng: -75.1656,
                location: "1500 JFK Blvd, Philadelphia, PA",
                description: "Massive outdoor beer garden highlighted as a 'SIPS of Sunshine' destination during Philadelphia's summer happy hour program.",
                url: "https://www.uptownbeer.com/"
            },
            // New York
            {
                name: "Greenwood Park",
                category: "bar",
                image: "https://images.unsplash.com/photo-1571613316887-6f8d5cbf7ef7?w=800",
                lat: 40.6592,
                lng: -73.9897,
                location: "555 7th Ave, Brooklyn, NY",
                description: "Massive Brooklyn beer garden that hosted Lawson's Summer Solstice event, indicating strong brand activation capabilities.",
                url: "https://greenwoodparkbk.com/"
            },
            {
                name: "Stout NYC - Grand Central",
                category: "bar",
                image: "https://images.unsplash.com/photo-1546622891-02c72c1537b6?w=800",
                lat: 40.7527,
                lng: -73.9772,
                location: "133 W 33rd St, New York, NY",
                description: "High-visibility commuter hub capturing Metro-North traffic. Key draft account for the NYC market.",
                url: "https://stoutnyc.com/"
            },
            // Connecticut
            {
                name: "Eli Cannon's Tap Room",
                category: "bar",
                image: "https://images.unsplash.com/photo-1534353473418-4cfa6c56fd38?w=800",
                lat: 41.5623,
                lng: -72.6506,
                location: "695 Main St, Middletown, CT",
                description: "Legendary beer bar that hosted Summer Solstice with rare kegs of Double Sunshine. A craft beer institution since 1994.",
                url: "https://elicannons.com/"
            },
            // Rhode Island
            {
                name: "The Red Door",
                category: "bar",
                image: "place-headers/the-red-door.jpg",
                lat: 41.8236,
                lng: -71.4222,
                location: "49 Peck St, Providence, RI",
                description: "Upscale cocktail bar featuring Lawson's on a curated beer list. Emphasizes culinary and cocktail pairing.",
                url: "https://reddoorpvd.com/"
            },
            // Massachusetts
            {
                name: "Five Horses Tavern",
                category: "bar",
                image: "place-headers/five-horses-tavern.jpg",
                lat: 42.3388,
                lng: -71.0885,
                location: "535 Columbus Ave, Boston, MA",
                description: "Craft-centric gastropub with 40 rotating drafts. A staple account for consistent Lawson's volume in Boston.",
                url: "https://www.fivehorsestavern.com/"
            },
            // Maine
            {
                name: "Luna Rooftop",
                category: "bar",
                image: "https://images.unsplash.com/photo-1527192491265-7e15c55b1ed2?w=800",
                lat: 43.6568,
                lng: -70.2495,
                location: "Canopy Portland Waterfront, Portland, ME",
                description: "High-end rooftop bar positioning Lawson's as a premium lifestyle beverage in Portland's competitive craft scene.",
                url: "https://lunarooftopbarmaine.com/"
            },
            {
                name: "Hunt & Alpine Club",
                category: "bar",
                image: "place-headers/hunt-alpine-club.png",
                lat: 43.6591,
                lng: -70.2554,
                location: "75 Market St, Portland, ME",
                description: "James Beard semi-finalist cocktail bar. Lawson's presence here validates quality among mixology connoisseurs.",
                url: "https://www.huntandalpineclub.com/"
            },
            // Vermont
            {
                name: "Worthy Burger",
                category: "bar",
                image: "place-headers/worthy-burger.jpg",
                lat: 43.7864,
                lng: -72.5209,
                location: "56 Rainbow St, South Royalton, VT",
                description: "Craft beer destination that hosted the Summer Solstice event, indicating priority status for Lawson's draft takeovers.",
                url: "https://worthyvermont.com/"
            },
            // Maine - Additional
            {
                name: "The Thirsty Pig",
                category: "bar",
                image: "place-headers/stock-craft-beer-bar-1.jpg",
                lat: 43.6576,
                lng: -70.2521,
                location: "37 Exchange St, Portland, ME",
                description: "Staple of Portland's Old Port district specializing in house-made sausages and craft beer.",
                url: "https://www.thethirstypig.com/"
            },
            {
                name: "Bonfire Country Bar",
                category: "bar",
                image: "place-headers/bonfire-country-bar.jpg",
                lat: 43.6553,
                lng: -70.2577,
                location: "24 Preble St, Portland, ME",
                description: "High-volume venue with Bacon Happier Hour featuring Lawson's in their 20-tap lineup.",
                url: "https://www.bonfirecountrybar.com/"
            },
            // Rhode Island - Additional
            {
                name: "Moonshine Alley",
                category: "bar",
                image: "place-headers/stock-craft-beer-bar-2.jpg",
                lat: 41.8230,
                lng: -71.4150,
                location: "293 Atwells Ave, Providence, RI",
                description: "Nashville-themed venue on Federal Hill serving Lawson's alongside Southern comfort food.",
                url: "https://www.moonshinealley.com/"
            },
            {
                name: "The Scurvy Dog",
                category: "bar",
                image: "place-headers/stock-craft-beer-bar-3.jpg",
                lat: 41.8188,
                lng: -71.4380,
                location: "1718 Westminster St, Providence, RI",
                description: "Self-described punk rock pub. Explicitly lists Sip of Sunshine cans. Validates street credibility.",
                url: "https://www.scurvydogbar.com/"
            },
            {
                name: "McBride's Irish Pub",
                category: "bar",
                image: "place-headers/stock-irish-pub.jpg",
                lat: 41.8306,
                lng: -71.3978,
                location: "161 Wayland Ave, Providence, RI",
                description: "Historic venue and community hub for Wayland Square neighborhood. Lawson's as a premium option.",
                url: "https://mcbrides-pub.com/"
            },
            // Massachusetts - Additional
            {
                name: "Bostonia Public House",
                category: "bar",
                image: "place-headers/stock-craft-beer-bar-1.jpg",
                lat: 42.3551,
                lng: -71.0549,
                location: "131 State St, Boston, MA",
                description: "Financial district venue serving 16oz Sip of Sunshine, targeting corporate after-work crowd.",
                url: "https://bostoniapublichouse.com/"
            },
            // New York - Additional
            {
                name: "Stout NYC - Penn Station",
                category: "bar",
                image: "place-headers/stock-craft-beer-bar-2.jpg",
                lat: 40.7505,
                lng: -73.9934,
                location: "Penn Station Area, New York, NY",
                description: "Major transit hub location (Amtrak/LIRR/NJT) with high-volume draft account.",
                url: "https://stoutnyc.com/"
            },
            // New Hampshire
            {
                name: "Dwyer's Pub",
                category: "bar",
                image: "place-headers/stock-irish-pub.jpg",
                lat: 43.0718,
                lng: -70.7626,
                location: "195 Fleet St, Portsmouth, NH",
                description: "Hosted Summer Solstice event with Double Sunshine on draft. Key NH market account.",
                url: "https://www.dwyerspub.com/"
            },
            // Pennsylvania - Additional SIPS Venues
            {
                name: "McGillin's Olde Ale House",
                category: "bar",
                image: "place-headers/mcgillins-olde-ale-house.jpg",
                lat: 39.9512,
                lng: -75.1610,
                location: "1310 Drury St, Philadelphia, PA",
                description: "Philadelphia's oldest continuously operating tavern (est. 1860). Center City SIPS participant.",
                url: "https://mcgillins.com/"
            },
            {
                name: "Independence Beer Garden",
                category: "bar",
                image: "place-headers/independence-beer-garden.jpg",
                lat: 39.9494,
                lng: -75.1502,
                location: "100 S Independence Mall W, Philadelphia, PA",
                description: "Large outdoor beer garden near Independence Hall. Major SIPS venue with hundreds of seats.",
                url: "https://phlbeergarden.com/"
            },
            {
                name: "Barcade",
                category: "bar",
                image: "place-headers/barcade.jpg",
                lat: 39.9497,
                lng: -75.1595,
                location: "1326 Chestnut St, Philadelphia, PA",
                description: "Arcade bar combining classic games with craft beer. SIPS participant featuring Lawson's drafts.",
                url: "https://barcadephiladelphia.com/"
            },
            {
                name: "BrÃ¼ Craft & Wurst",
                category: "bar",
                image: "place-headers/stock-craft-beer-bar-3.jpg",
                lat: 39.9502,
                lng: -75.1603,
                location: "1318 Chestnut St, Philadelphia, PA",
                description: "German-style beer hall and SIPS venue. Perfect pairing for Lawson's IPAs.",
                url: "https://brucraftwurst.com/"
            },
            {
                name: "Fado Irish Pub",
                category: "bar",
                image: "place-headers/stock-irish-pub.jpg",
                lat: 39.9480,
                lng: -75.1651,
                location: "1500 Locust St, Philadelphia, PA",
                description: "Authentic Irish pub on Rittenhouse Row. SIPS participant with extensive craft selection.",
                url: "https://fadoirishpub.com/philadelphia/"
            },

            // === RETAILERS ===
            // Vermont
            {
                name: "Lawson's Finest Liquids Taproom",
                category: "retailer",
                image: "https://www.lawsonsfinest.com/wp-content/uploads/2025/12/LFL_Taproom_Night-1.jpg",
                lat: 44.1852,
                lng: -72.8288,
                location: "Waitsfield, VT",
                description: "The home of Sip of Sunshine. Visit our taproom for the freshest pours and exclusive releases.",
                url: "https://www.lawsonsfinest.com"
            },
            {
                name: "Mad River Taste Place",
                category: "retailer",
                image: "place-headers/mad-river-taste-place.jpg",
                lat: 44.1870,
                lng: -72.8256,
                location: "Waitsfield, VT",
                description: "The Valley's go-to destination for Vermont craft beer, local cider, wine, and hyper-local spirits.",
                url: "https://madrivervalley.com"
            },
            {
                name: "Mehuron's Supermarket",
                category: "retailer",
                image: "place-headers/mehurons-supermarket.jpg",
                lat: 44.1858,
                lng: -72.8271,
                location: "Waitsfield, VT",
                description: "Local grocery with an excellent Vermont craft beer selection including Lawson's Finest.",
                url: "https://www.mehurons.com/"
            },
            {
                name: "JD's Quick Stop",
                category: "retailer",
                image: "place-headers/stock-bottle-shop.jpg",
                lat: 43.9289,
                lng: -72.8411,
                location: "Hancock, VT",
                description: "Famous beer cave with a curated selection of Vermont's finest including Lawson's, Heady Topper, and more.",
                url: "https://www.google.com/search?q=JDs+Quick+Stop+Beer+Cave+Hancock+VT"
            },
            // Massachusetts
            {
                name: "Craft Beer Cellar - Belmont",
                category: "retailer",
                image: "place-headers/stock-bottle-shop.jpg",
                lat: 42.3962,
                lng: -71.1784,
                location: "Belmont, MA",
                description: "Premier craft beer retailer featuring rotating selections from Lawson's Finest Liquids.",
                url: "https://craftbeercellar.com"
            },
            {
                name: "Blanchard's Liquors",
                category: "retailer",
                image: "place-headers/stock-liquor-store.jpg",
                lat: 42.3151,
                lng: -71.0589,
                location: "Boston, MA",
                description: "Boston's destination for craft beer with regular Lawson's Finest availability.",
                url: "https://blanchards.net/"
            },
            // Connecticut
            {
                name: "Two Roads Brewing Company",
                category: "retailer",
                image: "place-headers/two-roads-brewing.jpg",
                lat: 41.2226,
                lng: -73.1353,
                location: "Stratford, CT",
                description: "Our brewing partner - Sip of Sunshine is brewed here. Visit the taproom for fresh pours.",
                url: "https://tworoadsbrewing.com"
            },
            // New York
            {
                name: "Whole Foods Market - Union Square",
                category: "retailer",
                image: "place-headers/stock-grocery-store.jpg",
                lat: 40.7359,
                lng: -73.9911,
                location: "New York, NY",
                description: "Quality craft beer selection in Manhattan including Lawson's Finest offerings.",
                url: "https://www.wholefoodsmarket.com/stores/unionsquare"
            },
            // Pennsylvania
            {
                name: "Monk's Cafe",
                category: "retailer",
                image: "place-headers/monks-cafe.jpg",
                lat: 39.9478,
                lng: -75.1639,
                location: "Philadelphia, PA",
                description: "Legendary Philadelphia beer bar known for exceptional craft selections.",
                url: "https://monkscafe.com"
            },
            {
                name: "Tired Hands Brewing Company",
                category: "retailer",
                image: "place-headers/tired-hands-brewing.jpg",
                lat: 40.0054,
                lng: -75.3099,
                location: "Ardmore, PA",
                description: "Award-winning brewery and fermentaria with rotating guest taps.",
                url: "https://tiredhands.com"
            },
            // Virginia
            {
                name: "Total Wine & More - Richmond",
                category: "retailer",
                image: "place-headers/stock-liquor-store.jpg",
                lat: 37.5955,
                lng: -77.5201,
                location: "Richmond, VA",
                description: "Extensive craft beer selection with regular Lawson's Finest availability.",
                url: "https://totalwine.com"
            },
            {
                name: "The Veil Brewing Co.",
                category: "retailer",
                image: "place-headers/the-veil-brewing.png",
                lat: 37.5541,
                lng: -77.4599,
                location: "Richmond, VA",
                description: "Richmond's favorite brewery - check for Lawson's guest taps and events.",
                url: "https://theveilbrewing.com"
            },
            // North Carolina
            {
                name: "Weinhaus",
                category: "retailer",
                image: "place-headers/weinhaus.jpg",
                lat: 35.5951,
                lng: -82.5515,
                location: "Asheville, NC",
                description: "Downtown Asheville's oldest and largest bottle shop with 12 local NC beers on tap.",
                url: "https://weinhaus.com"
            },
            {
                name: "Local 604 Bottle Shop - West",
                category: "retailer",
                image: "place-headers/local-604-bottle-shop.jpg",
                lat: 35.5847,
                lng: -82.5760,
                location: "Asheville, NC",
                description: "West Asheville's best little bottle shop with over 20 local breweries represented.",
                url: "https://local604avl.com"
            },
            {
                name: "The Whale - A Craft Beer Collective",
                category: "retailer",
                lat: 35.5943,
                lng: -82.5540,
                location: "Asheville, NC",
                description: "Exceptional craft beer selection - one of the best bottle shops on the East Coast.",
                url: "https://thewhalecollective.com/"
            },
            {
                name: "Appalachian Vintner",
                category: "retailer",
                lat: 35.6012,
                lng: -82.5568,
                location: "Asheville, NC",
                description: "Great selection and one-stop shopping for beer and wine in Asheville.",
                url: "https://www.appalachianvintner.com/"
            },
            // Additional Vermont Retailers
            {
                name: "Cold Hollow Cider Mill",
                category: "retailer",
                image: "place-headers/cold-hollow-cider-mill.jpg",
                lat: 44.3856,
                lng: -72.7469,
                location: "Waterbury, VT",
                description: "Iconic Vermont destination with craft beer, fresh cider donuts, and local products. A Route 100 must-stop.",
                url: "https://coldhollow.com"
            },
            {
                name: "Stowe Public House",
                category: "retailer",
                image: "place-headers/stowe-public-house.jpg",
                lat: 44.4654,
                lng: -72.6874,
                location: "Stowe, VT",
                description: "Classic Vermont tavern with an excellent rotating craft beer selection including Lawson's Finest.",
                url: "https://www.stowepublichouse.com/"
            },
            // Additional New Hampshire
            {
                name: "Bert's Better Beers",
                category: "retailer",
                lat: 42.9956,
                lng: -71.4548,
                location: "Hooksett, NH",
                description: "New Hampshire's premier craft beer destination with 1,200+ craft beers. Consistently stocks Lawson's.",
                url: "https://bertsbetterbeers.com",
                image: "https://bertsbetterbeers.com/wp-content/uploads/2023/03/berts-storefront.jpg"
            },
            // Additional Massachusetts
            {
                name: "Yankee Spirits",
                category: "retailer",
                lat: 42.0834,
                lng: -71.0184,
                location: "Attleboro, MA",
                description: "Award-winning liquor store chain with extensive craft beer selection including Lawson's Finest.",
                url: "https://yankeespirits.com"
            },
            {
                name: "Stop & Shop - Boston",
                category: "retailer",
                lat: 42.3467,
                lng: -71.0972,
                location: "Boston, MA",
                description: "Major grocery chain carrying Lawson's Sip of Sunshine in 4-packs. Cold stored for freshness.",
                url: "https://stopandshop.com"
            },
            {
                name: "Gordon's Fine Wines & Liquors",
                category: "retailer",
                image: "place-headers/gordons-fine-wines.jpg",
                lat: 42.4501,
                lng: -71.2326,
                location: "Waltham, MA",
                description: "Family-owned since 1936. Excellent craft beer cave with rotating Lawson's selections.",
                url: "https://gordonswine.com"
            },
            // Additional Connecticut
            {
                name: "Craft Beer Shop - New Haven",
                category: "retailer",
                lat: 41.3083,
                lng: -72.9279,
                location: "New Haven, CT",
                description: "Dedicated craft beer bottle shop in the heart of New Haven. Fresh Lawson's regularly in stock.",
                url: "https://www.google.com/search?q=Craft+Beer+Shop+New+Haven+CT"
            },
            // Additional New York
            {
                name: "Half Time Beverage",
                category: "retailer",
                lat: 41.0255,
                lng: -73.7618,
                location: "Mamaroneck, NY",
                description: "Legendary NY craft beer destination with 2,000+ beers. A bucket-list stop for beer lovers.",
                url: "https://halftimebeverage.com"
            },
            {
                name: "Whole Foods Market - Brooklyn",
                category: "retailer",
                lat: 40.6892,
                lng: -73.9785,
                location: "Brooklyn, NY",
                description: "Fort Greene location with curated craft beer selection including Lawson's Sip of Sunshine.",
                url: "https://wholefoodsmarket.com"
            },
            {
                name: "Wegmans - Rochester",
                category: "retailer",
                lat: 43.1166,
                lng: -77.6088,
                location: "Rochester, NY",
                description: "The original Wegmans location with an exceptional beer department. Lawson's regularly stocked.",
                url: "https://wegmans.com"
            },
            // Additional New Jersey
            {
                name: "Wegmans - Princeton",
                category: "retailer",
                lat: 40.3176,
                lng: -74.6532,
                location: "Princeton, NJ",
                description: "Premium grocery with outstanding craft beer selection and cold storage. Fresh Lawson's available.",
                url: "https://wegmans.com"
            },
            {
                name: "Jersey City Super Buy Rite",
                category: "retailer",
                lat: 40.7282,
                lng: -74.0776,
                location: "575 Manila Ave, Jersey City, NJ",
                description: "New Jersey's largest liquor store with over 30,000 sq ft and one of the largest beer selections in the world. Fresh Lawson's regularly in stock.",
                url: "https://buyritewines.com/"
            },
            // Additional Pennsylvania
            {
                name: "ACME Markets - Wayne",
                category: "retailer",
                lat: 40.0439,
                lng: -75.3879,
                location: "Wayne, PA",
                description: "Full-service grocery with craft beer section featuring Lawson's Sip of Sunshine.",
                url: "https://acmemarkets.com"
            },
            {
                name: "Wegmans - King of Prussia",
                category: "retailer",
                lat: 40.0878,
                lng: -75.3889,
                location: "King of Prussia, PA",
                description: "Expansive beer department with dedicated craft section. Lawson's kept cold for optimal freshness.",
                url: "https://wegmans.com"
            },
            // Additional Virginia
            {
                name: "Total Wine & More - Leesburg",
                category: "retailer",
                lat: 39.1157,
                lng: -77.5636,
                location: "1610 Village Market Blvd, Leesburg, VA",
                description: "Northern Virginia craft beer destination with extensive selection. Fresh Lawson's Sip of Sunshine regularly in stock.",
                url: "https://www.totalwine.com/store-info/virginia-leesburg/218"
            },
            {
                name: "Whole Foods Market - Fairfax",
                category: "retailer",
                lat: 38.8462,
                lng: -77.3064,
                location: "Fairfax, VA",
                description: "Fresh Lawson's on draft and in cans. Part of their curated Virginia craft beer program.",
                url: "https://wholefoodsmarket.com"
            },
            {
                name: "Beer Run - Charlottesville",
                category: "retailer",
                lat: 38.0293,
                lng: -78.4767,
                location: "Charlottesville, VA",
                description: "Craft beer bar and bottle shop near UVA. Fresh Lawson's in cans with rotating draft selections.",
                url: "https://beerrun.com"
            },
            {
                name: "The Staunton Grocery",
                category: "retailer",
                lat: 38.1496,
                lng: -79.0717,
                location: "103 S Coalter St, Staunton, VA",
                description: "Boutique grocery in the Shenandoah Valley with curated craft beer selection. Near Skyline Drive entrance.",
                url: "https://thestauntongrocery.shopsettings.com/"
            },
            // Additional North Carolina
            {
                name: "Tasty Beverage Co.",
                category: "retailer",
                lat: 35.7721,
                lng: -78.6386,
                location: "Raleigh, NC",
                description: "Raleigh's premier craft beer bottle shop with 1,000+ selections. Fresh Lawson's available.",
                url: "https://tastybeverageco.com"
            },
            {
                name: "Good Bottle Co.",
                category: "retailer",
                lat: 35.2106,
                lng: -80.8308,
                location: "Charlotte, NC",
                description: "South End Charlotte's neighborhood bottle shop with curated craft selections including Lawson's.",
                url: "https://goodbottleco.com"
            },
            {
                name: "Wedge Brewing - Grove Arcade",
                category: "retailer",
                lat: 35.5923,
                lng: -82.5574,
                location: "1 Page Ave, Suite 152, Asheville, NC",
                description: "Historic Grove Arcade taproom featuring Asheville-brewed craft beers. Great selection of local and regional brews including Lawson's.",
                url: "https://wedgebrewing.com/locations/grove-arcade/"
            },
            // Rhode Island
            {
                name: "Nikki's Liquors",
                category: "retailer",
                lat: 41.8240,
                lng: -71.4128,
                location: "Providence, RI",
                description: "Providence's go-to craft beer destination. Extensive selection with regular Lawson's stock.",
                url: "https://nikkisliquors.com"
            },
            // Maine
            {
                name: "RSVP Discount Beverage",
                category: "retailer",
                lat: 43.6591,
                lng: -70.2568,
                location: "Portland, ME",
                description: "Portland's largest beer selection with 1,500+ craft beers. Fresh Lawson's in the cooler.",
                url: "https://rsvpdiscountbeverage.com"
            },

            // === TRAILS ===
            // Vermont
            {
                name: "Camel's Hump via Long Trail",
                category: "trail",
                lat: 44.3198,
                lng: -72.8862,
                location: "Duxbury, VT",
                description: "Vermont's most iconic mountain with 360-degree views. 6.8 miles round trip. One of only four peaks in Vermont with alpine tundra.",
                image: "place-headers/camels-hump.jpg",
                url: "https://www.alltrails.com/trail/us/vermont/camels-hump-via-long-trail-and-burrows-trail"
            },
            {
                name: "Stratton Mountain",
                category: "trail",
                lat: 43.0822,
                lng: -72.9089,
                location: "Stratton, VT",
                description: "Where Benton MacKaye conceived the Appalachian Trail. Features peaceful streams, meadows, and pristine Stratton Pond.",
                image: "place-headers/stock-hiking-trail-1.jpg",
                url: "https://www.alltrails.com/trail/us/vermont/stratton-mountain-and-stratton-pond-via-long-trail"
            },
            {
                name: "Mount Mansfield - Long Trail",
                category: "trail",
                lat: 44.5437,
                lng: -72.8143,
                location: "Stowe, VT",
                description: "Vermont's highest peak at 4,393 ft. Stunning ridge walk along 'The Chin' with alpine scenery.",
                image: "place-headers/stock-hiking-trail-2.jpg",
                url: "https://www.alltrails.com/trail/us/vermont/mount-mansfield-via-sunset-ridge-and-long-trail"
            },
            // New Hampshire
            {
                name: "Franconia Ridge Loop",
                category: "trail",
                lat: 44.1604,
                lng: -71.6447,
                location: "Franconia, NH",
                description: "One of the premier day hikes in the entire country. Above-treeline ridge walk with 360-degree views. 8.9 miles.",
                image: "place-headers/stock-mountain-ridge.jpg",
                url: "https://www.alltrails.com/trail/us/new-hampshire/franconia-ridge-trail-loop"
            },
            {
                name: "Mount Washington via Tuckerman Ravine",
                category: "trail",
                lat: 44.2706,
                lng: -71.3033,
                location: "Pinkham Notch, NH",
                description: "The Northeast's highest peak at 6,288 ft. Historic and challenging. Once held the world wind speed record.",
                image: "place-headers/mount-washington.jpg",
                url: "https://www.alltrails.com/trail/us/new-hampshire/mount-washington-via-tuckerman-ravine-trail"
            },
            // Massachusetts
            {
                name: "Mount Greylock - Appalachian Trail",
                category: "trail",
                lat: 42.6376,
                lng: -73.1662,
                location: "Adams, MA",
                description: "Massachusetts' highest point at 3,491 ft. The AT passes over the summit with panoramic views of five states.",
                image: "place-headers/mount-greylock.jpeg",
                url: "https://www.alltrails.com/trail/us/massachusetts/mount-greylock-via-hopper-trail"
            },
            {
                name: "Taconic Highlands - Mount Everett",
                category: "trail",
                lat: 42.0977,
                lng: -73.4374,
                location: "Mount Washington, MA",
                description: "A 17-mile AT section with old-growth forest, waterfalls, and open summits without crossing a single road.",
                image: "place-headers/stock-hiking-trail-1.jpg",
                url: "https://www.alltrails.com/trail/us/massachusetts/mount-everett-via-appalachian-trail"
            },
            // Pennsylvania
            {
                name: "Hawk Mountain Sanctuary",
                category: "trail",
                lat: 40.6359,
                lng: -75.9871,
                location: "Kempton, PA",
                description: "World-renowned raptor migration site. Over 20,000 hawks fly over each fall. Multiple scenic overlooks.",
                image: "place-headers/stock-hawk-flying.jpg",
                url: "https://www.hawkmountain.org/visit/plan-your-visit"
            },
            {
                name: "The Pinnacle",
                category: "trail",
                lat: 40.5805,
                lng: -75.9143,
                location: "Hamburg, PA",
                description: "Considered by many to be the AT's best view in Pennsylvania. 9-mile loop with stunning rock formations.",
                image: "place-headers/stock-rock-outcrop.jpg",
                url: "https://www.alltrails.com/trail/us/pennsylvania/pinnacle-and-pulpit-rock-loop-via-appalachian-trail"
            },
            // Virginia
            {
                name: "McAfee Knob",
                category: "trail",
                lat: 37.2390,
                lng: -80.0328,
                location: "Salem, VA",
                description: "The most photographed spot on the entire Appalachian Trail. Iconic rock outcrop with widescreen mountain views. 8.8 miles.",
                image: "place-headers/stock-appalachian-trail.jpg",
                url: "https://www.alltrails.com/trail/us/virginia/mcafee-knob-via-appalachian-trail"
            },
            {
                name: "Three Ridges Wilderness",
                category: "trail",
                lat: 37.9189,
                lng: -79.0168,
                location: "Waynesboro, VA",
                description: "Scenic views, 40-foot waterfalls, and swimming holes. A challenging but rewarding AT section.",
                image: "place-headers/stock-hiking-trail-2.jpg",
                url: "https://www.alltrails.com/trail/us/virginia/three-ridges-via-appalachian-trail"
            },
            {
                name: "Old Rag Mountain",
                category: "trail",
                lat: 38.5533,
                lng: -78.3161,
                location: "Shenandoah NP, VA",
                description: "Virginia's most popular hike. Iconic rock scramble with 360-degree views from the summit.",
                image: "place-headers/stock-rock-outcrop.jpg",
                url: "https://www.alltrails.com/trail/us/virginia/old-rag-mountain-loop-trail"
            },
            // North Carolina
            {
                name: "Max Patch",
                category: "trail",
                lat: 35.7972,
                lng: -82.9569,
                location: "Hot Springs, NC",
                description: "A rolling, grassy mountaintop bald with endless wildflowers and stunning 360-degree panoramas. One of our favorites on the AT.",
                image: "place-headers/stock-mountain-meadow.jpg",
                url: "https://www.alltrails.com/trail/us/north-carolina/max-patch-loop-trail"
            },
            {
                name: "Roan Highlands - Carvers Gap",
                category: "trail",
                lat: 36.1064,
                lng: -82.1098,
                location: "Roan Mountain, NC/TN",
                description: "Rolling balds with fields of wildflowers. Hike to Round Bald, Jane Bald, and Grassy Ridge for incredible views.",
                image: "place-headers/stock-mountain-meadow.jpg",
                url: "https://www.alltrails.com/trail/us/north-carolina/grassy-ridge-bald-via-appalachian-trail"
            },
            {
                name: "Craggy Gardens",
                category: "trail",
                lat: 35.7019,
                lng: -82.3790,
                location: "Blue Ridge Parkway, NC",
                description: "Famous for rhododendron blooms. Easy to moderate trails with panoramic Blue Ridge views.",
                image: "place-headers/craggy-gardens.jpg",
                url: "https://www.alltrails.com/trail/us/north-carolina/craggy-gardens-trail"
            },
            {
                name: "Looking Glass Rock",
                category: "trail",
                lat: 35.2957,
                lng: -82.7877,
                location: "Pisgah NF, NC",
                description: "Iconic granite dome near Brevard. Challenging 6.5-mile hike rewarded with spectacular views.",
                image: "place-headers/stock-mountain-ridge.jpg",
                url: "https://www.alltrails.com/trail/us/north-carolina/looking-glass-rock-trail"
            },

            // === RIVER PUT-INS ===
            // Vermont
            {
                name: "Mad River - Waitsfield Access",
                category: "river",
                lat: 44.1892,
                lng: -72.8301,
                location: "Waitsfield, VT",
                description: "Local favorite for kayaking and swimming. Class I-II rapids through the heart of the Mad River Valley.",
                image: "place-headers/stock-kayaking-river-1.jpg",
                url: "https://www.clearwatervt.com/trips"
            },
            {
                name: "White River - Chelsea Park",
                category: "river",
                lat: 43.7832,
                lng: -72.4689,
                location: "Sharon, VT",
                description: "Vermont's longest undammed river. Popular put-in for scenic day paddles with few portages required.",
                image: "place-headers/stock-river-paddling.jpg",
                url: "https://www.vermontpaddlers.club/white-river"
            },
            {
                name: "Connecticut River - Wilgus State Park",
                category: "river",
                lat: 43.4397,
                lng: -72.4128,
                location: "Ascutney, VT",
                description: "Canoe and kayak rentals available. Part of the 400-mile Connecticut River Paddlers' Trail.",
                image: "place-headers/connecticut-river.png",
                url: "https://www.connecticutriverpaddlerstrail.org"
            },
            // New Hampshire
            {
                name: "Connecticut River - Hanover",
                category: "river",
                lat: 43.7022,
                lng: -72.2896,
                location: "Hanover, NH",
                description: "Easy access point on New England's longest river. Beautiful paddling through scenic Upper Valley.",
                image: "place-headers/stock-kayaking-river-1.jpg",
                url: "https://www.ledyardcanoeclub.org"
            },
            // Virginia
            {
                name: "James River - Buchanan",
                category: "river",
                lat: 37.5275,
                lng: -79.6787,
                location: "Buchanan, VA",
                description: "Upper James River Water Trail access. 64 miles of paddling through the Allegheny and Blue Ridge Mountains.",
                image: "place-headers/james-river.png",
                url: "https://www.upperjamesriverwatertrail.com"
            },
            {
                name: "Roanoke River Blueway - Wasena Park",
                category: "river",
                lat: 37.2620,
                lng: -79.9571,
                location: "Roanoke, VA",
                description: "Voted one of the best urban kayaking spots in the US. Easy float through Virginia's Blue Ridge.",
                image: "place-headers/stock-river-paddling.jpg",
                url: "https://www.roanokecountyparks.com/283/Roanoke-River-Blueway"
            },
            {
                name: "New River - McCoy Access",
                category: "river",
                lat: 37.2419,
                lng: -80.6009,
                location: "Giles County, VA",
                description: "Start of the 37-mile New River Water Trail. Class I to III rapids through stunning mountain scenery.",
                image: "place-headers/new-river.jpg",
                url: "https://www.newriverwatertrail.com"
            },
            // North Carolina
            {
                name: "French Broad River - Asheville",
                category: "river",
                lat: 35.5707,
                lng: -82.5779,
                location: "Asheville, NC",
                description: "The heart of Asheville's outdoor scene. Multiple access points for tubing, kayaking, and paddleboarding.",
                image: "place-headers/french-broad-asheville.jpg",
                url: "https://www.ashevilleoutdoorcenter.com"
            },
            {
                name: "French Broad River - Headwaters",
                category: "river",
                lat: 35.1430,
                lng: -82.8256,
                location: "Rosman, NC",
                description: "Headwaters Outfitters offers 3-7 hour self-guided trips. Pristine paddling southwest of Asheville.",
                image: "place-headers/french-broad-headwaters.jpg",
                url: "https://www.headwatersoutfitters.com"
            },
            {
                name: "Yadkin River - Surry County",
                category: "river",
                lat: 36.4117,
                lng: -80.6776,
                location: "Elkin, NC",
                description: "Over 100 miles of canoe/kayak waters. Surry County has more river access points than any other NC county.",
                image: "place-headers/stock-kayaking-river-1.jpg",
                url: "https://www.yadkinriverbluetrail.com"
            },

            // === COMMUNITY PARTNERS ===
            // Verified Lawson's Finest Liquids donation recipients from Cosmic Shift IPA,
            // Sunshine Fund, GivingTuesday, and Good Brews for a Cause programs.
            // Total: $3M+ donated to 400+ nonprofits since 2018.

            // VERMONT - Sunshine Fund & Home State Partners
            {
                name: "Vermont Foodbank",
                category: "community",
                state: "VT",
                lat: 44.2004,
                lng: -72.5073,
                location: "Barre, VT",
                description: "Vermont's largest hunger-relief organization, serving all 14 counties through a network of food shelves, meal sites, and community programs.",
                impact: "Thanks to support from Lawson's Cosmic Shift IPA, families like the Martins in rural Vermont can count on fresh produce and protein each week. 'After my husband's job loss, the food shelf kept our kids fed while we got back on our feet.'",
                image: "place-headers/vermont-foodbank.jpg",
                url: "https://vtfoodbank.org",
                donateUrl: "https://vtfoodbank.org/give"
            },
            {
                name: "Upper Valley Haven",
                category: "community",
                state: "VT",
                lat: 43.6489,
                lng: -72.3212,
                location: "White River Junction, VT",
                description: "Providing food, shelter, education, and service coordination for families and individuals in need in the Upper Valley.",
                impact: "2024 Sunshine Fund recipient. The Haven helped Sarah, a single mom, transition from their shelter to stable housing. 'They didn't just give me a roof - they helped me build a future for my daughter.'",
                image: "place-headers/upper-valley-haven.jpg",
                url: "https://uppervalleyhaven.org",
                donateUrl: "https://uppervalleyhaven.org/donate"
            },
            {
                name: "Committee on Temporary Shelter (COTS)",
                category: "community",
                state: "VT",
                lat: 44.4759,
                lng: -73.2121,
                location: "Burlington, VT",
                description: "Working to end homelessness in Vermont through shelter, housing, and prevention services since 1982.",
                impact: "2024 Sunshine Fund recipient. Last winter, COTS helped 47 people find permanent housing. James, a veteran, says: 'COTS gave me more than shelter. They gave me back my dignity and a place to call home.'",
                image: "place-headers/cots.jpg",
                url: "https://cotsonline.org",
                donateUrl: "https://cotsonline.org/donate"
            },
            {
                name: "Green Mountain Farm-to-School",
                category: "community",
                state: "VT",
                lat: 44.0354,
                lng: -73.1795,
                location: "Newport, VT",
                description: "Connecting Vermont farms with schools to provide fresh, local food while teaching kids about nutrition and agriculture.",
                impact: "2024 Sunshine Fund recipient. Thanks to their programs, students in Orleans County now grow vegetables in school gardens. Teacher Amy shares: 'Kids who never touched a vegetable are now excited to eat what they planted.'",
                image: "place-headers/green-mountain-farm-to-school.jpg",
                url: "https://greenmountainfarmtoschool.org",
                donateUrl: "https://greenmountainfarmtoschool.org/donate"
            },
            {
                name: "Friends of the Winooski River",
                category: "community",
                state: "VT",
                lat: 44.4875,
                lng: -72.8899,
                location: "Montpelier, VT",
                description: "Protecting and restoring the Winooski River watershed through education, advocacy, and community engagement.",
                impact: "2024 Sunshine Fund recipient. Their river cleanup events have removed tons of debris while educating hundreds of volunteers. 'Every paddle on the Winooski is cleaner because of their work,' says kayaker Tom.",
                image: "place-headers/friends-of-winooski-river.jpg",
                url: "https://winooskiriver.org",
                donateUrl: "https://winooskiriver.org/donate"
            },
            {
                name: "Vermont Community Foundation",
                category: "community",
                state: "VT",
                lat: 44.2598,
                lng: -72.5754,
                location: "Middlebury, VT",
                description: "Partner for the inaugural SIPosium, supporting Vermont's flood recovery and building community resilience across the state.",
                impact: "After devastating floods, the Foundation mobilized rapid response grants. Homeowner Maria recalls: 'Within days of losing everything, we had help rebuilding. The Vermont spirit is real.'",
                image: "place-headers/vermont-community-foundation.png",
                url: "https://vermontcf.org",
                donateUrl: "https://vermontcf.org/give"
            },
            {
                name: "Northeast Kingdom Community Action (NEKCA)",
                category: "community",
                state: "VT",
                lat: 44.5342,
                lng: -72.0196,
                location: "St. Johnsbury, VT",
                description: "Fighting poverty and building community in Vermont's Northeast Kingdom through comprehensive support services.",
                impact: "2024 Sunshine Fund recipient. NEKCA's heating assistance kept 200+ families warm last winter. 'Choosing between heat and food shouldn't happen in Vermont,' says director Lisa. 'We make sure it doesn't.'",
                image: "place-headers/nekca.png",
                url: "https://nekcavt.org",
                donateUrl: "https://nekcavt.org/donate"
            },

            // NEW HAMPSHIRE - Cosmic Shift Beneficiary
            {
                name: "NH Food Alliance",
                category: "community",
                state: "NH",
                lat: 43.2081,
                lng: -71.5376,
                location: "Concord, NH",
                description: "Building a thriving, fair, and sustainable food system in New Hampshire by connecting farmers, food banks, and communities.",
                impact: "Cosmic Shift IPA beneficiary. The Alliance helped launch 12 new farm-to-food-bank partnerships. Farmer Jake says: 'Now my extra harvest feeds families instead of going to waste. It's farming with purpose.'",
                image: "place-headers/nh-food-alliance.png",
                url: "https://nhfoodalliance.org",
                donateUrl: "https://nhfoodalliance.org/donate"
            },

            // MAINE - Cosmic Shift Beneficiary
            {
                name: "Cultivating Community",
                category: "community",
                state: "ME",
                lat: 43.6591,
                lng: -70.2568,
                location: "Portland, ME",
                description: "Growing food, farmers, and community through urban agriculture programs that serve immigrant and refugee communities.",
                impact: "Cosmic Shift IPA beneficiary. Their refugee farming program has helped 50+ families grow food from their homelands. Amara, from Somalia, shares: 'This garden connects me to home while feeding my children here.'",
                image: "place-headers/cultivating-community.jpg",
                url: "https://cultivatingcommunity.org",
                donateUrl: "https://cultivatingcommunity.org/donate"
            },

            // MASSACHUSETTS - Cosmic Shift Beneficiary
            {
                name: "Spoonfuls (Lovin' Spoonfuls)",
                category: "community",
                state: "MA",
                lat: 42.3376,
                lng: -71.2087,
                location: "Newton, MA",
                description: "New England's largest food rescue operation, preventing 5M+ pounds of fresh food from going to waste each year.",
                impact: "Cosmic Shift IPA beneficiary. Their trucks rescue food daily from grocery stores and restaurants. Shelter director Mike says: 'Spoonfuls brings us restaurant-quality food. Our guests eat with dignity.'",
                image: "place-headers/spoonfuls.jpg",
                url: "https://spoonfuls.org",
                donateUrl: "https://spoonfuls.org/donate"
            },

            // RHODE ISLAND - Cosmic Shift Beneficiary
            {
                name: "Rhode Island Community Food Bank",
                category: "community",
                state: "RI",
                lat: 41.8176,
                lng: -71.3743,
                location: "Providence, RI",
                description: "Fighting hunger and improving lives by providing nutritious food to Rhode Islanders facing food insecurity.",
                impact: "Cosmic Shift IPA beneficiary. They distributed 18 million pounds of food last year. Grandmother Rosa shares: 'When times get hard, the food bank is there. My grandkids never go to bed hungry.'",
                image: "place-headers/ri-community-food-bank.png",
                url: "https://rifoodbank.org",
                donateUrl: "https://rifoodbank.org/donate"
            },

            // CONNECTICUT - Cosmic Shift Beneficiary
            {
                name: "Alzheimer's Association - CT Chapter",
                category: "community",
                state: "CT",
                lat: 41.3651,
                lng: -72.9275,
                location: "New Haven, CT",
                description: "Leading the way in Alzheimer's care, support, and research - providing resources for patients and their families.",
                impact: "Cosmic Shift IPA beneficiary. Their support groups help caregivers cope. David, caring for his wife, says: 'I thought I was alone until I found this community. Now I have strength to keep going.'",
                url: "https://alz.org/ct",
                donateUrl: "https://act.alz.org/donate"
            },

            // NEW YORK - Cosmic Shift Beneficiaries
            {
                name: "City Harvest",
                category: "community",
                state: "NY",
                lat: 40.7549,
                lng: -73.9840,
                location: "New York, NY",
                description: "NYC's largest food rescue organization, collecting excess food and delivering it to soup kitchens, food pantries, and community programs.",
                impact: "Cosmic Shift IPA beneficiary. Their trucks rescue 70 million pounds of food annually. Chef Marcus volunteers weekly: 'Food that would be thrown away instead feeds thousands. That's the magic of City Harvest.'",
                image: "place-headers/city-harvest.jpg",
                url: "https://cityharvest.org",
                donateUrl: "https://cityharvest.org/donate"
            },
            {
                name: "United Way of Greater Rochester",
                category: "community",
                state: "NY",
                lat: 43.1566,
                lng: -77.6088,
                location: "Rochester, NY",
                description: "Building stronger communities through education, financial stability, and health initiatives across the Finger Lakes region.",
                impact: "Cosmic Shift IPA beneficiary. Their early literacy programs have helped 3,000+ kids start school ready to learn. Teacher Patricia notes: 'The difference is clear on day one. These kids are confident and curious.'",
                image: "place-headers/stock-food-bank.jpg",
                url: "https://unitedwayrocflx.org",
                donateUrl: "https://unitedwayrocflx.org/donate"
            },

            // NEW JERSEY - Cosmic Shift Beneficiary
            {
                name: "Community FoodBank of New Jersey",
                category: "community",
                state: "NJ",
                lat: 40.7101,
                lng: -74.2097,
                location: "Hillside, NJ",
                description: "Fighting hunger and poverty in New Jersey, distributing food to over 800 partner agencies across the state.",
                impact: "Cosmic Shift IPA beneficiary. They provide 90 million meals annually. Single dad Robert shares: 'The food bank doesn't just fill our fridge - it lets me be a better father because I'm not worried about dinner.'",
                url: "https://cfbnj.org",
                donateUrl: "https://cfbnj.org/donate"
            },

            // PENNSYLVANIA - Cosmic Shift Beneficiary
            {
                name: "Philabundance",
                category: "community",
                state: "PA",
                lat: 39.9153,
                lng: -75.1566,
                location: "Philadelphia, PA",
                description: "The Delaware Valley's largest hunger relief organization, serving 135,000+ people weekly through 350 agency partners.",
                impact: "Cosmic Shift IPA beneficiary. Their Community Kitchen also trains formerly incarcerated individuals for culinary careers. Graduate Jerome says: 'They gave me skills and a second chance. Now I'm a sous chef.'",
                image: "place-headers/stock-food-bank.jpg",
                url: "https://philabundance.org",
                donateUrl: "https://philabundance.org/donate"
            },

            // VIRGINIA - Conservation Partner
            {
                name: "James River Association",
                category: "community",
                state: "VA",
                lat: 37.5328,
                lng: -77.4360,
                location: "Richmond, VA",
                description: "Protecting and restoring Virginia's historic James River watershed from the mountains to the Chesapeake Bay since 1976.",
                impact: "Their paddle trips connect thousands with the river each year. Kayaker Christine says: 'I never knew Richmond had such an amazing river until JRA showed me. Now I'm a volunteer river cleaner.'",
                image: "place-headers/james-river-association.png",
                url: "https://thejamesriver.org",
                donateUrl: "https://thejamesriver.org/donate"
            },

            // NORTH CAROLINA - Conservation & Food Security Partners
            {
                name: "Blue Ridge Parkway Foundation",
                category: "community",
                state: "NC",
                lat: 35.5682,
                lng: -82.5315,
                location: "Asheville, NC",
                description: "Preserving America's Favorite Drive by supporting trails, overlooks, and visitor experiences along 469 miles of scenic mountain road.",
                impact: "Their trail crews maintain hundreds of miles of hiking paths. Volunteer Sam shares: 'Every weekend, we're out there clearing trails so families can enjoy these views for generations to come.'",
                image: "place-headers/blue-ridge-parkway-foundation.webp",
                url: "https://brpfoundation.org",
                donateUrl: "https://brpfoundation.org/donate"
            },
            {
                name: "French Broad Riverkeeper (MountainTrue)",
                category: "community",
                state: "NC",
                lat: 35.5946,
                lng: -82.5516,
                location: "Asheville, NC",
                description: "Protecting the waters of the French Broad River watershed through monitoring, advocacy, and community engagement.",
                impact: "Their water quality testing and advocacy has made the French Broad swimmable again. Paddler Jen says: 'I remember when no one would touch this water. Now my kids swim here every summer.'",
                image: "place-headers/french-broad-riverkeeper.jpg",
                url: "https://mountaintrue.org",
                donateUrl: "https://mountaintrue.org/donate"
            },
            {
                name: "MANNA FoodBank",
                category: "community",
                state: "NC",
                lat: 35.5781,
                lng: -82.5024,
                location: "Asheville, NC",
                description: "Ending hunger in Western North Carolina by distributing 50,000+ pounds of food daily through 200+ partner organizations.",
                impact: "After Hurricane Helene, MANNA mobilized emergency food distribution to hard-hit communities. Recipient Angela says: 'We lost everything, but MANNA made sure we didn't lose hope. Hot meals meant the world.'",
                image: "place-headers/stock-food-bank.jpg",
                url: "https://mannafoodbank.org",
                donateUrl: "https://mannafoodbank.org/donate"
            },

            // === DC FAST CHARGERS ===
            // North Carolina
            {
                name: "Tesla Supercharger - Asheville",
                category: "charger",
                lat: 35.5732,
                lng: -82.5413,
                location: "264 Thetford St, Asheville, NC",
                description: "Tesla Supercharger with 8 stalls, up to 250kW. Located near downtown Asheville.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Tesla Supercharger - Mt Airy",
                category: "charger",
                lat: 36.5082,
                lng: -80.6193,
                location: "2905 Rockford St, Mt Airy, NC",
                description: "Tesla Supercharger with 8 stalls, up to 250kW. Great stop on Blue Ridge Parkway northern section.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Boone",
                category: "charger",
                lat: 36.2038,
                lng: -81.6580,
                location: "1180 Blowing Rock Rd, Boone, NC",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Near Blowing Rock and Blue Ridge Parkway.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            // Virginia
            {
                name: "Electrify America - Staunton",
                category: "charger",
                lat: 38.1408,
                lng: -79.0556,
                location: "255 Lucy Ln, Staunton, VA",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Perfect stop at the north end of Skyline Drive.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Waynesboro",
                category: "charger",
                lat: 38.0686,
                lng: -78.9036,
                location: "109 Lucy Ln, Waynesboro, VA",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Near Skyline Drive and Blue Ridge Parkway junction.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Tesla Supercharger - Charlottesville",
                category: "charger",
                lat: 38.0543,
                lng: -78.4975,
                location: "1954 Rio Hill Center, Charlottesville, VA",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Great stop when heading north from Skyline Drive.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            // Massachusetts
            {
                name: "Electrify America - Springfield",
                category: "charger",
                lat: 42.1186,
                lng: -72.5428,
                location: "1655 Boston Rd, Springfield, MA",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Gateway to New England.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            // New Hampshire
            {
                name: "Electrify America - Hooksett",
                category: "charger",
                lat: 43.0697,
                lng: -71.4378,
                location: "1328 Hooksett Rd, Hooksett, NH",
                description: "Electrify America DC fast chargers, up to 350kW. Key I-93 corridor stop en route to Vermont.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            // Vermont
            {
                name: "ChargePoint DC Fast - Waitsfield",
                category: "charger",
                lat: 44.1861,
                lng: -72.8277,
                location: "5134 Main St, Waitsfield, VT",
                description: "ChargePoint DC fast charger at Mobil station, 180kW. Right in the heart of Mad River Valley near Lawson's Taproom.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.chargepoint.com/en-us/drivers/find-charger"
            },
            {
                name: "ChargePoint DC Fast - Mad River Green",
                category: "charger",
                lat: 44.1875,
                lng: -72.8261,
                location: "Village Square, Waitsfield, VT",
                description: "ChargePoint DC fast charger at Mad River Green shopping center, 62kW. Walking distance to local shops and Lawson's.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.chargepoint.com/en-us/drivers/find-charger"
            },
            {
                name: "Tesla Supercharger - Waterbury",
                category: "charger",
                lat: 44.3396,
                lng: -72.7530,
                location: "1899 Waterbury-Stowe Rd, Waterbury, VT",
                description: "Tesla Supercharger with 8 stalls near Ben & Jerry's Factory. Popular tourist stop.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - White River Junction",
                category: "charger",
                lat: 43.6489,
                lng: -72.3195,
                location: "270 N Hartland Rd, White River Junction, VT",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Key I-91/I-89 interchange stop.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "NEVI Fast Charger - Bradford",
                category: "charger",
                lat: 43.9931,
                lng: -72.1292,
                location: "172 Waits River Rd, Bradford, VT",
                description: "Vermont NEVI program DC fast charger at Denny Park, up to 150kW. Scenic I-91 corridor charging.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.driveelectricvt.com/"
            },
            // Additional DC Fast Chargers to ensure 100-200 mile coverage
            {
                name: "Electrify America - Roanoke",
                category: "charger",
                lat: 37.2756,
                lng: -79.9414,
                location: "4807 Valley View Blvd NW, Roanoke, VA",
                description: "Electrify America DC fast chargers at Target, up to 350kW. Key stop between Blue Ridge Parkway and Skyline Drive.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Lynchburg",
                category: "charger",
                lat: 37.3540,
                lng: -79.1784,
                location: "3901 Wards Rd, Lynchburg, VA",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Strategic stop on US-29 corridor.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Tysons Corner",
                category: "charger",
                lat: 38.9187,
                lng: -77.2311,
                location: "8357 Leesburg Pike, Tysons, VA",
                description: "Electrify America DC fast chargers, up to 350kW. Major Northern Virginia hub near I-495 Beltway.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Newark",
                category: "charger",
                lat: 40.7282,
                lng: -74.1724,
                location: "450 Broad St, Newark, NJ",
                description: "Tesla Supercharger with 20 stalls, up to 250kW. Key New Jersey Turnpike corridor stop.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Edison",
                category: "charger",
                lat: 40.5187,
                lng: -74.4121,
                location: "1931 Route 27, Edison, NJ",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Central New Jersey charging hub.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Milford",
                category: "charger",
                lat: 41.2223,
                lng: -73.0648,
                location: "1201 Boston Post Rd, Milford, CT",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Convenient I-95 corridor stop between NY and MA.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Hartford",
                category: "charger",
                lat: 41.7410,
                lng: -72.6739,
                location: "495 Flatbush Ave, Hartford, CT",
                description: "Electrify America DC fast chargers, up to 350kW. Central Connecticut charging hub on I-84.",
                image: "place-headers/stock-ev-charger.jpg",
                url: "https://www.electrifyamerica.com/locate-charger/"
            }
        ];

        // Category icon paths for cluster display
        const categoryIconPaths = {
            brewery: 'assets/images/marker-brewery.svg',
            tastingroom: 'assets/images/marker-tastingroom.svg',
            retailer: 'assets/images/marker-retailer.svg',
            bar: 'assets/images/marker-bar.svg',
            trail: 'assets/images/marker-trail.svg?v=2',
            river: 'assets/images/marker-river.svg?v=2',
            community: 'assets/images/marker-community.svg',
            charger: 'assets/images/marker-charger.svg'
        };

        // Category display order for consistent icon ordering
        const categoryOrder = ['brewery', 'tastingroom', 'retailer', 'bar', 'trail', 'river', 'community', 'charger'];

        // ============================================
        // DYNAMIC VIEWPORT UTILITIES
        // Calculates visible map area accounting for sidebar overlay
        // ============================================

        // Get sidebar width in pixels based on screen size
        // Uses Viewport utility for single source of truth (#39)
        function getSidebarWidth() {
            return Viewport.getSidebarWidth();
        }

        // Get the visible map viewport dimensions (excluding sidebar overlay)
        function getVisibleViewport() {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return { width: window.innerWidth, height: window.innerHeight, offsetX: 0 };

            const rect = mapContainer.getBoundingClientRect();
            const sidebarWidth = getSidebarWidth();

            return {
                width: rect.width - sidebarWidth,  // Visible width (excluding sidebar)
                height: rect.height,
                totalWidth: rect.width,
                sidebarWidth: sidebarWidth,
                offsetX: sidebarWidth / 2  // Offset to center in visible area
            };
        }

        // Convert a lat/lng to the visual center of the visible map area
        // This shifts the center to the right to account for sidebar overlay
        function getOffsetCenter(latLng, zoom) {
            const viewport = getVisibleViewport();
            if (viewport.sidebarWidth === 0) return latLng;  // No offset needed on mobile

            const targetPoint = map.project(latLng, zoom || map.getZoom());
            targetPoint.x -= viewport.offsetX;
            return map.unproject(targetPoint, zoom || map.getZoom());
        }

        // Pan to a location, centering it in the visible map area
        function panToWithOffset(latLng, options = {}) {
            const offsetCenter = getOffsetCenter(latLng);
            map.panTo(offsetCenter, options);
        }

        // Fly to a location, centering it in the visible map area
        function flyToWithOffset(latLng, zoom, options = {}) {
            const offsetCenter = getOffsetCenter(latLng, zoom);
            map.flyTo(offsetCenter, zoom, {
                animate: true,
                duration: 1.0,
                ...options
            });
        }

        // Get padding for fitBounds - account for sidebar floating over map
        // Left padding must be sidebar width + margins + buffer to keep pills visible
        function getSidebarPadding() {
            if (Viewport.isMobile()) {
                // Mobile: sidebar is stacked below map (CSS: position: relative)
                return [20, 40, 380, 40]; // [top, right, bottom, left]
            }
            const sidebarWidth = getSidebarWidth();
            const margin = 20; // sidebar left margin
            const buffer = 80; // extra buffer for pill radius
            return [60, 60, 60, sidebarWidth + margin + buffer];
        }

        // Custom fitBounds that treats the visible map area (right of sidebar) as the target
        // Uses paddingTopLeft to offset bounds calculation so markers appear in visible area
        function fitBoundsWithSidebarOffset(bounds, options = {}) {
            const viewport = getVisibleViewport();

            if (viewport.sidebarWidth === 0) {
                // Mobile/tablet: extra bottom padding to keep content above "Zoom for detail" button
                map.fitBounds(bounds, {
                    ...options,
                    paddingTopLeft: L.point(40, 20),
                    paddingBottomRight: L.point(40, 140)
                });
                return;
            }

            // Calculate padding dynamically based on actual sidebar width
            // Pill clusters can be 150-200px wide, so we need generous padding
            const leftPadding = viewport.sidebarWidth + 120; // sidebar + margin + pill buffer
            const rightPadding = 140; // buffer for pill clusters on right edge
            const topPadding = 80;
            const bottomPadding = 140; // space for zoom hint button

            map.fitBounds(bounds, {
                ...options,
                paddingTopLeft: L.point(leftPadding, topPadding),
                paddingBottomRight: L.point(rightPadding, bottomPadding)
            });
        }

        // Create unified marker cluster group with multi-category support
        function createUnifiedClusterIcon(cluster) {
            const markers = cluster.getAllChildMarkers();
            const categories = new Set();

            markers.forEach(marker => {
                if (marker.options.category) {
                    categories.add(marker.options.category);
                }
            });

            const uniqueCategories = categoryOrder.filter(cat => categories.has(cat));
            const count = cluster.getChildCount();

            // Consistent icon size across all pills - 28px standard for all icons
            const standardIconSize = '28px';

            function getIconSize(cat) {
                return standardIconSize;
            }

            if (uniqueCategories.length === 1) {
                // Single category - show icon + count in pill format
                const cat = uniqueCategories[0];
                const iconSize = getIconSize(cat);

                const pillStyle = 'position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:inline-flex;align-items:center;gap:5px;padding:8px 12px;background:#FFFDF7;border-radius:23px;box-shadow:0 2px 8px rgba(0,0,0,0.25);border:2px solid #ffc72d;white-space:nowrap;';
                const countStyle = 'font-family:new-spirit,serif;font-weight:700;font-size:14px;color:#2D2A26;background:#ffc72d;padding:4px 10px;border-radius:12px;margin-left:3px;min-width:24px;text-align:center;';
                const iconHtml = '<img src="' + categoryIconPaths[cat] + '" style="width:' + iconSize + ';height:' + iconSize + ';flex-shrink:0;object-fit:contain;display:block;" alt="">';

                const width = 120;
                const height = 50;

                return L.divIcon({
                    html: '<div style="' + pillStyle + '">' + iconHtml + '<span style="' + countStyle + '">' + count + '</span></div>',
                    className: 'marker-cluster-pill',
                    iconSize: L.point(width, height),
                    iconAnchor: L.point(width / 2, height / 2)
                });
            } else {
                // Multiple categories - show icons for each type with consistent size
                const iconsHtml = uniqueCategories.slice(0, 4).map(cat => {
                    const iconSize = getIconSize(cat);
                    return '<img src="' + categoryIconPaths[cat] + '" style="width:' + iconSize + ';height:' + iconSize + ';flex-shrink:0;object-fit:contain;display:block;" alt="">';
                }).join('');

                const numIcons = Math.min(uniqueCategories.length, 4);
                // Calculate dimensions based on content - generous sizing to contain pill
                // Added extra buffer to ensure all icons fit within the container
                const width = (numIcons * 40) + 100;
                const height = 60;

                // Use inline styles to guarantee rendering - absolutely positioned to center in container
                const pillStyle = 'position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:inline-flex;align-items:center;gap:5px;padding:8px 12px;background:#FFFDF7;border-radius:23px;box-shadow:0 2px 8px rgba(0,0,0,0.25);border:2px solid #ffc72d;white-space:nowrap;';
                const countStyle = 'font-family:new-spirit,serif;font-weight:700;font-size:14px;color:#2D2A26;background:#ffc72d;padding:4px 10px;border-radius:12px;margin-left:3px;min-width:24px;text-align:center;';

                return L.divIcon({
                    html: '<div style="' + pillStyle + '">' + iconsHtml + '<span style="' + countStyle + '">' + count + '</span></div>',
                    className: 'marker-cluster-pill',
                    iconSize: L.point(width, height),
                    iconAnchor: L.point(width / 2, height / 2)
                });
            }
        }

        const clusterOptions = {
            showCoverageOnHover: false,
            spiderfyOnMaxZoom: true,  // Spider out only when can't zoom any further
            zoomToBoundsOnClick: false,  // We'll handle this manually with sidebar padding
            disableClusteringAtZoom: 15,  // Separate markers at zoom 15+ (lowered for Philadelphia visibility)
            maxClusterRadius: 120,  // Standard radius for city-level visibility
            iconCreateFunction: createUnifiedClusterIcon,
            spiderLegPolylineOptions: { weight: 2, color: '#ffc72d', opacity: 0.6 },
            spiderfyDistanceMultiplier: 1.8,  // More spread out spider
            animate: false,  // Disable cluster animations to reduce jank on mobile (Issue #37)
            animateAddingMarkers: false  // Disable fly-in animation on initial load
        };

        // Create a unified cluster group for all main markers
        const unifiedCluster = L.markerClusterGroup(clusterOptions);


        // Store markers by category for filtering
        const markersByCategory = {
            brewery: [],
            tastingroom: [],
            retailer: [],
            bar: [],
            trail: [],
            river: [],
            community: [],
            charger: []
        };

        // Track which categories are visible
        const visibleCategories = {
            brewery: true,
            tastingroom: true,
            retailer: true,
            bar: true,
            trail: true,
            river: true,
            community: true,
            charger: false
        };

        // Add markers to respective layers
        sunshineSpots.forEach(spot => {
            const icon = createMarkerIcon(spot.category);

            // Build popup content with enhanced information for community partners
            let popupContent = '';

            // Add image if available (Security: validate URL and escape alt text)
            if (spot.image && isValidUrl(spot.image)) {
                popupContent += `<img src="${escapeHtml(spot.image)}" alt="${escapeHtml(spot.name)}" class="popup-image" loading="lazy">`;
            }

            const categoryLabels = {
                'brewery': 'Brewery',
                'tastingroom': 'Tasting Room',
                'retailer': 'Retailer',
                'bar': 'Bar & Restaurant',
                'trail': 'Trail',
                'river': 'River Put-in',
                'community': 'Community Partner',
                'charger': 'DC Fast Charger'
            };
            const categoryLabel = categoryLabels[spot.category] || escapeHtml(spot.category);
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.location || '')}`;
            // Security: escape all user-visible text to prevent XSS
            popupContent += `
                <div class="popup-category ${escapeHtml(spot.category)}">${escapeHtml(categoryLabel)}</div>
                <div class="popup-title">${escapeHtml(spot.name)}</div>
                <div class="popup-description">${escapeHtml(spot.description)}</div>
                <div class="popup-location"><a href="${escapeHtml(mapsUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(spot.location)}</a></div>
            `;

            // Add impact story for community partners (Security: escape content)
            if (spot.impact) {
                popupContent += `
                    <div class="popup-impact">
                        <div class="popup-impact-label">Impact Story</div>
                        ${escapeHtml(spot.impact)}
                    </div>
                `;
            }

            // Add buttons (Security: validate URLs before rendering)
            if ((spot.url && isValidUrl(spot.url)) || (spot.donateUrl && isValidUrl(spot.donateUrl))) {
                popupContent += '<div class="popup-buttons">';
                if (spot.url && isValidUrl(spot.url)) {
                    popupContent += `<a href="${escapeHtml(spot.url)}" target="_blank" rel="noopener noreferrer" class="popup-btn popup-btn-primary">Learn More</a>`;
                }
                if (spot.donateUrl && isValidUrl(spot.donateUrl)) {
                    popupContent += `<a href="${escapeHtml(spot.donateUrl)}" target="_blank" rel="noopener noreferrer" class="popup-btn popup-btn-secondary">Donate</a>`;
                }
                popupContent += '</div>';
            }

            const marker = L.marker([spot.lat, spot.lng], { icon: icon, category: spot.category })
                .bindPopup(popupContent, { maxWidth: 320, closeOnClick: false, autoClose: false });

            // Store marker by category
            markersByCategory[spot.category].push(marker);

            // Add to unified cluster (chargers start hidden, added when route is shown)
            if (spot.category !== 'charger') {
                unifiedCluster.addLayer(marker);
            }
        });

        // Add unified cluster to map
        unifiedCluster.addTo(map);

        // Fit initial view to show all markers with sidebar offset
        // Use setTimeout to ensure cluster is fully rendered before calculating bounds
        setTimeout(function() {
            const clusterBounds = unifiedCluster.getBounds();
            if (clusterBounds.isValid()) {
                // Adapt maxZoom based on viewport - smaller screens need to zoom out more
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                let initialMaxZoom = 6;  // Default for large/wide screens

                if (viewportWidth < 768 || viewportHeight < 600) {
                    initialMaxZoom = 4;  // Small phones and narrow/short viewports
                } else if (viewportWidth < 1200) {
                    initialMaxZoom = 5;  // Tablets and medium screens
                }

                fitBoundsWithSidebarOffset(clusterBounds, {
                    animate: false,  // No animation on initial load
                    maxZoom: initialMaxZoom,
                    padding: [40, 40]
                });
            }
            // Mark initial load complete after a short delay to allow zoom events to finish
            setTimeout(function() {
                window.isInitialLoad = false;
            }, 200);
        }, 100);

        // Track last clicked cluster for repeated zoom behavior (Issue #35)
        let lastClickedCluster = null;
        let lastClickedClusterLatLng = null;
        let lastClickTime = 0;

        // Custom cluster click handler - zoom with sidebar padding
        unifiedCluster.on('clusterclick', function(e) {
            const cluster = e.layer;
            const currentZoom = map.getZoom();
            const childCount = cluster.getChildCount();
            const now = Date.now();
            const clusterLatLng = cluster.getLatLng();

            // If already at high zoom or few markers, spiderfy immediately
            if (currentZoom >= 15 || (currentZoom >= 12 && childCount <= 5)) {
                cluster.spiderfy();
                lastClickedCluster = null;
                lastClickedClusterLatLng = null;
                return;
            }

            // Check if this is the same cluster clicked within 2 seconds
            // Bug Fix: Use epsilon comparison for floating-point coordinates
            const EPSILON = 0.000001;
            const isSameCluster = lastClickedClusterLatLng &&
                                  Math.abs(lastClickedClusterLatLng.lat - clusterLatLng.lat) < EPSILON &&
                                  Math.abs(lastClickedClusterLatLng.lng - clusterLatLng.lng) < EPSILON &&
                                  (now - lastClickTime) < 2000;

            const bounds = cluster.getBounds();

            if (isSameCluster) {
                // Same cluster clicked again - zoom in 1.5 levels for progressive drilling
                const newZoom = Math.min(currentZoom + 1.5, 15);
                map.setView(clusterLatLng, newZoom, {
                    animate: !Viewport.isMobile(),  // Disable animation on mobile to reduce jank
                    duration: 0.4
                });
            } else {
                // Different cluster or first click - fit bounds normally
                fitBoundsWithSidebarOffset(bounds, {
                    animate: !Viewport.isMobile(),  // Disable animation on mobile to reduce jank
                    duration: 0.5,
                    easeLinearity: 0.25,
                    maxZoom: 15,  // Don't zoom in too far, let user click again if needed
                    padding: [60, 60]  // Generous padding to keep markers visible
                });
            }

            // Update tracking
            lastClickedCluster = cluster;
            lastClickedClusterLatLng = clusterLatLng;
            lastClickTime = now;
        });


        // Function to refresh the unified cluster based on visible categories
        function refreshUnifiedCluster() {
            unifiedCluster.clearLayers();
            Object.entries(markersByCategory).forEach(([category, markers]) => {
                if (visibleCategories[category]) {
                    markers.forEach(marker => unifiedCluster.addLayer(marker));
                }
            });
        }

        // Cache DOM element references for count displays (#40, #50 - performance fix)
        const countElements = {
            brewery: document.getElementById('count-breweries'),
            tastingroom: document.getElementById('count-tastingrooms'),
            retailer: document.getElementById('count-retailers'),
            bar: document.getElementById('count-bars'),
            trail: document.getElementById('count-trails'),
            river: document.getElementById('count-rivers'),
            community: document.getElementById('count-community'),
            charger: document.getElementById('count-chargers')
        };

        // Pre-compute category counts (only changes when data changes, not on filter toggle)
        const categoryCounts = {
            brewery: sunshineSpots.filter(s => s.category === 'brewery').length,
            tastingroom: sunshineSpots.filter(s => s.category === 'tastingroom').length,
            retailer: sunshineSpots.filter(s => s.category === 'retailer').length,
            bar: sunshineSpots.filter(s => s.category === 'bar').length,
            trail: sunshineSpots.filter(s => s.category === 'trail').length,
            river: sunshineSpots.filter(s => s.category === 'river').length,
            community: sunshineSpots.filter(s => s.category === 'community').length,
            charger: sunshineSpots.filter(s => s.category === 'charger').length
        };

        // Update counts - now uses cached elements and pre-computed counts
        function updateCounts() {
            Object.keys(countElements).forEach(category => {
                if (countElements[category]) {
                    countElements[category].textContent = categoryCounts[category];
                }
            });
        }
        updateCounts();

        // Helper function to handle filter changes with loading spinner
        function handleFilterChange(checkbox, categoryKey) {
            const filterItem = checkbox.closest('.filter-item');

            // Show loading spinner
            filterItem.classList.add('loading');

            // Use requestAnimationFrame + setTimeout to ensure spinner renders before heavy operations
            requestAnimationFrame(() => {
                setTimeout(() => {
                    try {
                        visibleCategories[categoryKey] = checkbox.checked;
                        refreshUnifiedCluster();
                    } catch (error) {
                        console.error('Filter change error:', error);
                    } finally {
                        // Always hide spinner, even on error (Bug Fix #29)
                        requestAnimationFrame(() => {
                            filterItem.classList.remove('loading');
                        });
                    }
                }, 10);
            });
        }

        // Filter functionality - using unified cluster
        document.getElementById('filter-breweries').addEventListener('change', function() {
            handleFilterChange(this, 'brewery');
        });

        document.getElementById('filter-tastingrooms').addEventListener('change', function() {
            handleFilterChange(this, 'tastingroom');
        });

        document.getElementById('filter-retailers').addEventListener('change', function() {
            handleFilterChange(this, 'retailer');
        });

        document.getElementById('filter-bars').addEventListener('change', function() {
            handleFilterChange(this, 'bar');
        });

        document.getElementById('filter-trails').addEventListener('change', function() {
            handleFilterChange(this, 'trail');
        });

        document.getElementById('filter-rivers').addEventListener('change', function() {
            handleFilterChange(this, 'river');
        });

        document.getElementById('filter-community').addEventListener('change', function() {
            handleFilterChange(this, 'community');
        });

        document.getElementById('filter-chargers').addEventListener('change', function() {
            const filterItem = this.closest('.filter-item');
            const checkbox = this;

            // Show loading spinner
            filterItem.classList.add('loading');

            // Use requestAnimationFrame + setTimeout to ensure spinner renders before heavy operations
            requestAnimationFrame(() => {
                setTimeout(() => {
                    try {
                        visibleCategories.charger = checkbox.checked;

                        // If user tries to enable chargers, also enable the route (chargers are only relevant along the route)
                        if (checkbox.checked) {
                            const routeCheckbox = document.getElementById('toggle-scenic-route');
                            if (routeCheckbox && !routeCheckbox.checked) {
                                routeCheckbox.checked = true;
                                // Trigger the change event to load the route
                                routeCheckbox.dispatchEvent(new Event('change'));
                            }
                        }

                        refreshUnifiedCluster();
                    } catch (error) {
                        console.error('Charger filter change error:', error);
                    } finally {
                        // Always hide spinner, even on error (Bug Fix #29)
                        requestAnimationFrame(() => {
                            filterItem.classList.remove('loading');
                        });
                    }
                }, 10);
            });
        });

        // Make entire filter item row clickable to toggle checkbox
        document.querySelectorAll('.filter-item').forEach(filterItem => {
            filterItem.addEventListener('click', function(e) {
                // Don't double-toggle if clicking on checkbox, label, or anything inside label
                // (clicking inside label already triggers native checkbox toggle via for attribute)
                if (e.target.tagName === 'INPUT' || e.target.closest('label')) {
                    return;
                }
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });

        // Store user's map location for location-aware zooming
        let userMapLocation = null;

        // Add zoom control to bottom-right
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Move search control into Leaflet control container (anchored to zoom buttons)
        const searchControl = document.getElementById('map-search-control');
        const leafletControlContainer = document.querySelector('.leaflet-bottom.leaflet-right');
        if (searchControl && leafletControlContainer) {
            // Insert search control before the zoom control
            const zoomControl = leafletControlContainer.querySelector('.leaflet-control-zoom');
            if (zoomControl) {
                leafletControlContainer.insertBefore(searchControl, zoomControl);
            } else {
                leafletControlContainer.appendChild(searchControl);
            }
        }

        // Request geolocation immediately on page load for location-aware zooming
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userMapLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    // User location acquired for zoom guidance (PII removed from console)
                },
                () => { /* Geolocation denied or failed - silent fail */ },
                { enableHighAccuracy: false, timeout: 10000 }
            );
        }

        // Override zoom-in button to drift toward user's physical location
        setTimeout(() => {
            const zoomInBtn = document.querySelector('.leaflet-control-zoom-in');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', (e) => {
                    // If we have user location, guide zoom toward it
                    if (userMapLocation) {
                        e.stopPropagation();
                        e.preventDefault();

                        // Hide zoom hint when user manually zooms (Issue #26)
                        const zoomHintEl = document.getElementById('zoom-hint');
                        if (zoomHintEl) {
                            zoomHintEl.classList.add('hidden');
                        }
                        if (typeof userHasZoomed !== 'undefined') {
                            window.userHasZoomed = true;
                        }

                        const currentZoom = map.getZoom();
                        const currentCenter = map.getCenter();

                        // More aggressive drift toward user location - noticeable on first click
                        // Use 45% movement per click for clear direction while staying smooth
                        const newLat = currentCenter.lat + (userMapLocation.lat - currentCenter.lat) * 0.45;
                        const newLng = currentCenter.lng + (userMapLocation.lng - currentCenter.lng) * 0.45;

                        map.setView([newLat, newLng], currentZoom + 0.5, {
                            animate: true,
                            duration: 0.4
                        });
                    }
                }, true);
            }
        }, 100);

        // Fit map to show all markers with smooth animation
        const allMarkers = sunshineSpots.map(s => [s.lat, s.lng]);
        fitBoundsWithSidebarOffset(allMarkers, {
            animate: true,
            duration: 1.0
        });

        // Enable marker animations after initial load completes
        setTimeout(() => {
            unifiedCluster.options.animate = true;
            unifiedCluster.options.animateAddingMarkers = true;
        }, 1500);

        // Zoom hint - hide when zoomed in past level 9
        // Bug Fix: Add null checks to prevent crashes if elements don't exist
        const zoomHint = document.getElementById('zoom-hint');
        const zoomHintText = zoomHint ? zoomHint.querySelector('span') : null;
        const zoomHintOriginalText = zoomHintText ? zoomHintText.textContent : '';

        // Only set up zoom hint handlers if elements exist
        if (zoomHint && zoomHintText) {
            // Wave animation on hover for zoom hint (faster timing)
            zoomHint.addEventListener('mouseenter', () => {
                createWaveAnimation(zoomHintText, 0.015);
            });
            zoomHint.addEventListener('mouseleave', () => {
                resetWaveAnimation(zoomHintText, zoomHintOriginalText);
            });
        }

        // Click handler - find nearest Sunshine Spot (with null check)
        if (zoomHint) zoomHint.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            zoomHintText.textContent = 'Finding you...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    // Store user location for zoom button guidance
                    userMapLocation = { lat: userLat, lng: userLng };

                    // Haversine formula for accurate geographic distance calculation
                    function haversineDistance(lat1, lng1, lat2, lng2) {
                        const R = 6371; // Earth's radius in kilometers
                        const dLat = (lat2 - lat1) * Math.PI / 180;
                        const dLng = (lng2 - lng1) * Math.PI / 180;
                        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        return R * c; // Distance in kilometers
                    }

                    // Find the nearest spot
                    let nearestSpot = null;
                    let nearestDistance = Infinity;

                    sunshineSpots.forEach(spot => {
                        const distance = haversineDistance(userLat, userLng, spot.lat, spot.lng);
                        if (distance < nearestDistance) {
                            nearestDistance = distance;
                            nearestSpot = spot;
                        }
                    });

                    if (nearestSpot) {
                        // Create bounds that include user location and nearest spot
                        const bounds = L.latLngBounds([
                            [userLat, userLng],
                            [nearestSpot.lat, nearestSpot.lng]
                        ]);

                        // Zoom to show both with padding
                        fitBoundsWithSidebarOffset(bounds, {
                            maxZoom: 12,
                            animate: true,
                            duration: 1.0
                        });

                        // Add a temporary marker for user location
                        const userMarker = L.circleMarker([userLat, userLng], {
                            radius: 10,
                            fillColor: '#4285F4',
                            color: '#ffffff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(map);

                        // Pulse animation for user location
                        const pulseMarker = L.circleMarker([userLat, userLng], {
                            radius: 20,
                            fillColor: '#4285F4',
                            color: '#4285F4',
                            weight: 2,
                            opacity: 0.5,
                            fillOpacity: 0.2
                        }).addTo(map);

                        // Remove user markers after 10 seconds
                        setTimeout(() => {
                            map.removeLayer(userMarker);
                            map.removeLayer(pulseMarker);
                        }, 10000);
                    }

                    zoomHintText.textContent = zoomHintOriginalText;
                    zoomHint.classList.add('hidden');
                },
                (error) => {
                    zoomHintText.textContent = zoomHintOriginalText;
                    alert('Unable to get your location. Please try zooming manually.');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });

        // Track if user has explicitly interacted with zoom controls (Issue #26)
        // Only hide zoom hint when user CLICKS zoom buttons, not on programmatic zooms
        let userHasZoomed = false;
        window.isInitialLoad = true;  // Flag for initial load state

        // Note: We do NOT hide zoom hint on zoomstart/zoomend events because those
        // fire for ALL zooms including programmatic ones (state filter, route toggle).
        // Zoom hint should only hide when user explicitly clicks zoom buttons.

        // Hide zoom hint when Leaflet zoom buttons are explicitly clicked
        setTimeout(() => {
            const zoomInBtn = document.querySelector('.leaflet-control-zoom-in');
            const zoomOutBtn = document.querySelector('.leaflet-control-zoom-out');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    userHasZoomed = true;
                    zoomHint.classList.add('hidden');
                });
            }
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    userHasZoomed = true;
                    zoomHint.classList.add('hidden');
                });
            }
        }, 100); // Small delay to ensure Leaflet controls are rendered

        // Save map position before popup opens, restore on close (mobile only)
        let savedMapState = null;
        let popupJustOpened = false; // Prevent immediate close on mobile touch

        map.on('popupopen', function(e) {
            // Set protection flag on mobile to prevent immediate close from touch event bubbling
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                popupJustOpened = true;
                setTimeout(() => {
                    popupJustOpened = false;
                }, 300); // 300ms protection window
            }

            // Expand map on mobile to show full popup
            if (Viewport.isMobile()) {
                const mapEl = document.getElementById('map');
                if (mapEl && !mapEl.classList.contains('map-expanded')) {
                    mapEl.classList.add('map-expanded');
                    // Scroll map into view smoothly
                    mapEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Tell Leaflet the container size changed
                    setTimeout(() => {
                        map.invalidateSize({ animate: false });  // No animation for cleaner timing (Issue #37)
                    }, 350); // Wait for CSS transition
                }
            }

            // Only save state on mobile/tablet (not full desktop)
            if (!Viewport.isDesktop()) {
                savedMapState = {
                    center: map.getCenter(),
                    zoom: map.getZoom()
                };
            }

            // Center map to show pin+popup as a unit within the safe area
            if (e.popup && e.popup._latlng) {
                // On mobile, wait longer for map resize to complete (CSS transition + invalidateSize)
                // On desktop, wait just for popup to render
                const isMobile = Viewport.isMobile();
                const mapEl = document.getElementById('map');
                const isExpanding = isMobile && mapEl && mapEl.classList.contains('map-expanded');
                const waitTime = isExpanding ? 400 : 100; // 400ms = 350ms CSS + 50ms buffer (no invalidateSize animation now - Issue #34)

                // Cancel any pending centering operations to prevent race conditions (Issue #34)
                if (window.popupCenteringTimeout) {
                    clearTimeout(window.popupCenteringTimeout);
                }

                window.popupCenteringTimeout = setTimeout(() => {
                    // Bug Fix: Check if popup is still open before processing (Race Condition Fix)
                    if (!e.popup || !map.hasLayer(e.popup)) return;

                    // Use requestAnimationFrame for smooth rendering (Issue #34, #37)
                    requestAnimationFrame(() => {
                        // Double-check popup still exists after rAF (another race condition check)
                        if (!e.popup || !map.hasLayer(e.popup)) return;
                        const popupEl = e.popup.getElement();
                        if (!popupEl) return;

                        // Force layout reflow before measuring to ensure accurate values (Issue #34)
                        const mapContainerEl = map.getContainer();
                        if (!mapContainerEl) return;
                        mapContainerEl.offsetHeight;

                        const popupRect = popupEl.getBoundingClientRect();
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer) return; // Null check
                    const mapRect = mapContainer.getBoundingClientRect();

                    // Get marker position on screen
                    const markerPoint = map.latLngToContainerPoint(e.popup._latlng);
                    const markerScreenY = mapRect.top + markerPoint.y;
                    const markerScreenX = mapRect.left + markerPoint.x;

                    // Calculate combined bounding box of popup + marker pin
                    // Popup is above the marker, pin extends ~20px below the popup anchor
                    const pinHeight = 35; // Approximate marker pin height
                    const combinedTop = popupRect.top;
                    const combinedBottom = markerScreenY + pinHeight;
                    const combinedLeft = Math.min(popupRect.left, markerScreenX - 20);
                    const combinedRight = Math.max(popupRect.right, markerScreenX + 20);
                    const combinedHeight = combinedBottom - combinedTop;
                    const combinedWidth = combinedRight - combinedLeft;
                    const combinedCenterX = combinedLeft + combinedWidth / 2;
                    const combinedCenterY = combinedTop + combinedHeight / 2;

                    // Calculate visible safe area (accounting for sidebar on desktop and header)
                    const padding = 30; // Padding from edges
                    let safeLeft = mapRect.left + padding;
                    let safeRight = mapRect.right - padding;

                    // Account for sticky header that overlays the map
                    // Header is approximately 85px on mobile, need to keep popup below it
                    const header = document.querySelector('header');
                    const headerHeight = header ? header.offsetHeight : 85;
                    const safeTop = mapRect.top + headerHeight + padding;
                    const safeBottom = mapRect.bottom - padding;

                    // On desktop, account for sidebar overlay
                    if (!isMobile) {
                        const sidebar = document.querySelector('.sidebar');
                        if (sidebar) {
                            const sidebarWidth = sidebar.offsetWidth;
                            safeLeft = mapRect.left + sidebarWidth + padding;
                        }
                    }

                    // Calculate center of the safe area
                    const safeCenterX = (safeLeft + safeRight) / 2;
                    const safeCenterY = (safeTop + safeBottom) / 2;

                    // Calculate shift needed to center the popup+pin unit in safe area
                    let xShift = combinedCenterX - safeCenterX;
                    let yShift = safeCenterY - combinedCenterY;

                    // Check if combined unit fits within safe area, if not just ensure it's visible
                    const safeWidth = safeRight - safeLeft;
                    const safeHeight = safeBottom - safeTop;

                    // CRITICAL: Always ensure popup top (close button) is below the header
                    // The close button is at the very top of the popup, so we need padding there
                    const closeButtonPadding = 15; // Extra padding to ensure close button is clickable
                    const minTopRequired = safeTop + closeButtonPadding;

                    // If popup top is above the safe area, shift down to make it visible
                    if (combinedTop < minTopRequired) {
                        const shiftNeeded = minTopRequired - combinedTop;
                        yShift = shiftNeeded; // Positive: when subtracted at line 6655, pans map center up, moving popup down
                    }

                    // If popup+pin is taller than safe area, prioritize showing top of popup
                    if (combinedHeight > safeHeight) {
                        yShift = minTopRequired - combinedTop; // Show popup top below header
                    }

                    // If popup+pin is wider than safe area, center it as best we can
                    if (combinedWidth > safeWidth) {
                        xShift = combinedCenterX - safeCenterX;
                    }

                    // Only pan if we need to adjust significantly (avoid jitter)
                    if (Math.abs(xShift) > 10 || Math.abs(yShift) > 10) {
                        // Bound shift values to prevent extreme jumps (COTS -> Montreal bug fix)
                        // Max shift should be no more than half the map container size
                        const maxShift = Math.min(mapRect.width, mapRect.height) / 2;
                        xShift = Math.max(-maxShift, Math.min(maxShift, xShift));
                        yShift = Math.max(-maxShift, Math.min(maxShift, yShift));

                        const center = map.getCenter();
                        const point = map.latLngToContainerPoint(center);
                        // Add xShift to move content left when popup is right of safe center
                        // Subtract yShift to move content down when popup is above safe center
                        const newPoint = L.point(point.x + xShift, point.y - yShift);
                        const newLatLng = map.containerPointToLatLng(newPoint);

                        // Final sanity check: don't pan more than ~2 degrees from the marker location
                        // This prevents jumping to completely different regions
                        const markerLat = e.popup._latlng.lat;
                        const markerLng = e.popup._latlng.lng;
                        const latDiff = Math.abs(newLatLng.lat - markerLat);
                        const lngDiff = Math.abs(newLatLng.lng - markerLng);

                        if (latDiff < 2 && lngDiff < 2) {
                            // Safe to pan - within reasonable distance of marker
                            // Reduced duration from 0.4s to 0.3s for snappier feel (Issue #37)
                            map.panTo(newLatLng, { animate: true, duration: 0.3, easeLinearity: 0.2 });
                        } else {
                            // Shift is too extreme - just center on marker with slight offset for popup
                            const simpleOffset = map.getSize().y * 0.15; // 15% offset for popup above marker
                            const offsetCenter = map.containerPointToLatLng(
                                map.latLngToContainerPoint(e.popup._latlng).add([0, simpleOffset])
                            );
                            map.panTo(offsetCenter, { animate: true, duration: 0.3, easeLinearity: 0.2 });
                        }
                    }
                    }); // Close requestAnimationFrame
                }, waitTime);
            }
        });

        // Manual popup close on map click (since autoClose is disabled)
        // This provides better control over popup behavior on touch devices
        map.on('click', function(e) {
            if (popupJustOpened) {
                // Don't close popup that was just opened (prevents immediate close on touch)
                return;
            }
            // Only close if clicking directly on map, not on a marker/cluster/popup
            if (e.originalEvent &&
                !e.originalEvent.target.closest('.leaflet-marker-icon') &&
                !e.originalEvent.target.closest('.leaflet-popup') &&
                !e.originalEvent.target.closest('.marker-cluster-pill')) {
                map.closePopup();
            }
        });

        map.on('popupclose', function(e) {
            // Collapse map on mobile
            if (Viewport.isMobile()) {
                const mapEl = document.getElementById('map');
                if (mapEl && mapEl.classList.contains('map-expanded')) {
                    mapEl.classList.remove('map-expanded');
                    // Tell Leaflet the container size changed
                    setTimeout(() => {
                        map.invalidateSize({ animate: true });
                    }, 350); // Wait for CSS transition
                }
            }

            // Only restore state on mobile/tablet (not full desktop)
            if (!Viewport.isDesktop() && savedMapState) {
                map.setView(savedMapState.center, savedMapState.zoom, {
                    animate: true,
                    duration: 0.5
                });
                savedMapState = null;
            }
        });

        // State filtering for community partners
        let currentStateFilter = 'all';
        const stateButtons = document.querySelectorAll('.state-btn');

        // Create a Map to store marker-to-spot associations for state filtering
        const markerToSpotMap = new Map();
        const communitySpots = sunshineSpots.filter(s => s.category === 'community');
        markersByCategory.community.forEach((marker, index) => {
            if (communitySpots[index]) {
                markerToSpotMap.set(marker, communitySpots[index]);
            }
        });

        // Initialize allCommunityMarkers immediately to prevent race conditions
        window.allCommunityMarkers = [...markersByCategory.community];

        // Debounce for rapid filter changes
        let filterDebounceTimer = null;
        let isFiltering = false;

        function filterByState(state) {
            // Debounce rapid filter changes
            if (filterDebounceTimer) {
                clearTimeout(filterDebounceTimer);
            }

            // Update button states immediately for responsive UI
            stateButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.state === state) {
                    btn.classList.add('active');
                }
            });

            filterDebounceTimer = setTimeout(() => {
                // Prevent concurrent filter operations
                if (isFiltering) return;
                isFiltering = true;

                currentStateFilter = state;

                // Filter community markers by state using the marker-to-spot map
                if (state === 'all') {
                    markersByCategory.community = [...window.allCommunityMarkers];
                } else {
                    markersByCategory.community = window.allCommunityMarkers.filter(marker => {
                        const spot = markerToSpotMap.get(marker);
                        return spot && spot.state === state;
                    });
                }

                // Refresh the unified cluster
                refreshUnifiedCluster();

                // Update community count badge
                const filteredCount = markersByCategory.community.length;
                document.getElementById('count-community').textContent = filteredCount;

                // If filtering to a specific state, zoom to show all markers in that state
                if (state !== 'all') {
                    // On mobile, scroll to the map first (#12)
                    if (Viewport.isMobile()) {
                        const mapElement = document.getElementById('map');
                        if (mapElement) {
                            // Use setTimeout to ensure scroll happens after any DOM updates
                            setTimeout(() => {
                                mapElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 100);
                        }
                    }

                    // Get ALL markers in the selected state (not just community partners)
                    // Check both explicit state property and parse from location string
                    const stateMarkers = sunshineSpots.filter(s => {
                        // Check explicit state property
                        if (s.state === state) return true;
                        // Parse state from location string (#33 - improved regex to handle more formats)
                        // Handles: "City, ST", "City ST", "City, ST 12345", "city, st" (case-insensitive)
                        if (s.location) {
                            // Match state abbreviation after comma or space, case-insensitive
                            const stateMatch = s.location.match(/[,\s]\s*([A-Za-z]{2})(?:\s+\d{5})?(?:\s|$)/i);
                            if (stateMatch && stateMatch[1].toUpperCase() === state) return true;
                        }
                        return false;
                    });
                    if (stateMarkers.length > 0) {
                        const bounds = stateMarkers.map(s => [s.lat, s.lng]);
                        // Responsive padding - less on mobile for better map utilization
                        const isMobile = Viewport.isMobile();
                        const paddingValue = isMobile ? 40 : 80;
                        // Zoom to fit all markers in the state - let bounds determine appropriate zoom
                        fitBoundsWithSidebarOffset(bounds, {
                            animate: true,
                            duration: 0.8,
                            maxZoom: isMobile ? 12 : 13,  // Slightly lower max zoom on mobile to show more context
                            padding: [paddingValue, paddingValue]
                        });
                    }

                    // Note: Don't hide zoom hint on state filter - it should only hide
                    // when user explicitly clicks zoom buttons (Issue #26)
                }

                isFiltering = false;
            }, 50); // 50ms debounce
        }

        // Add click handlers to state buttons
        stateButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterByState(btn.dataset.state);
            });
        });

        // ============================================
        // LIVE IMPACT METRICS - Based on actual Lawson's data
        // ============================================
        // Data sources: Lawson's Impact Reports, Brewbound, CraftBrewingBusiness
        //
        // DONATIONS MODEL (verified data points):
        // - Program started: 2018
        // - 2021: $239,832 donated (confirmed)
        // - 2022: $290,000 donated (confirmed)
        // - By mid-2022: $926,352 cumulative
        // - By mid-2023: $1.25M cumulative
        // - By end 2023: $2M+ cumulative
        // - Current (2026): ~$3M to 496 nonprofits
        // - Growth: Started ~$150k/year, now ~$520k/year
        //
        // SOLAR MODEL (verified data points):
        // - 2019: 43kW rooftop array installed (52,000 kWh/year)
        // - 2022: 215kW solar canopy added (495 panels)
        // - 2023: Additional arrays = 570,000 kWh/year total
        // - 100% solar offset achieved
        //
        // WASTE: 97.2% diversion achieved 2024
        // ============================================

        const impactMetrics = {
            donations: {
                // Base: $3,000,000 as of Jan 1, 2026 (to 496 nonprofits since 2018)
                baseDate: new Date('2026-01-01T00:00:00'),
                baseAmount: 3000000,
                // Current annual rate: ~$520,000/year, growing at 5% annually
                annualRate: 520000,
                annualGrowthRate: 0.05,
                // 10-year projection: ~$9.5M by 2036
            },
            solar: {
                // Cumulative kWh since 2019:
                // 2019-2021: 52,000 kWh/year Ã— 3 = 156,000
                // 2022: ~150,000 (canopy added mid-year)
                // 2023-2025: 570,000 kWh/year Ã— 3 = 1,710,000
                // Total by Jan 1, 2026: ~2,016,000 kWh
                baseDate: new Date('2026-01-01T00:00:00'),
                baseAmount: 2016000,
                // Current annual rate: 570,000 kWh/year
                annualRate: 570000,
                // Slight efficiency gains: 2% per year
                annualGrowthRate: 0.02,
                // 10-year projection: ~8.5M kWh cumulative by 2036
            },
            waste: {
                // 97.2% waste diversion (achieved 2024)
                // Projecting slight improvement to 98.5% by 2036
                baseDate: new Date('2026-01-01T00:00:00'),
                baseValue: 97.2,
                targetValue: 98.5,
                yearsToTarget: 10
            }
        };

        function calculateCurrentDonations() {
            const now = new Date();
            const msElapsed = now - impactMetrics.donations.baseDate;
            const yearsElapsed = msElapsed / (1000 * 60 * 60 * 24 * 365.25);

            if (yearsElapsed < 0) {
                // Before base date, calculate backwards
                return impactMetrics.donations.baseAmount;
            }

            // Calculate with compound growth on the rate
            let totalAdded = 0;
            const baseRate = impactMetrics.donations.annualRate;
            const growth = impactMetrics.donations.annualGrowthRate;

            // For continuous calculation, integrate the growth
            // Simplified: use average rate for the period
            const avgRate = baseRate * (1 + growth * yearsElapsed / 2);
            totalAdded = avgRate * yearsElapsed;

            return impactMetrics.donations.baseAmount + totalAdded;
        }

        function calculateCurrentSolar() {
            const now = new Date();
            const msElapsed = now - impactMetrics.solar.baseDate;
            const yearsElapsed = msElapsed / (1000 * 60 * 60 * 24 * 365.25);

            if (yearsElapsed < 0) {
                return impactMetrics.solar.baseAmount;
            }

            // Calculate with slight efficiency gains
            const baseRate = impactMetrics.solar.annualRate;
            const growth = impactMetrics.solar.annualGrowthRate;
            const avgRate = baseRate * (1 + growth * yearsElapsed / 2);
            const totalAdded = avgRate * yearsElapsed;

            return impactMetrics.solar.baseAmount + totalAdded;
        }

        function calculateCurrentWaste() {
            const now = new Date();
            const msElapsed = now - impactMetrics.waste.baseDate;
            const yearsElapsed = msElapsed / (1000 * 60 * 60 * 24 * 365.25);

            if (yearsElapsed < 0) {
                return impactMetrics.waste.baseValue;
            }

            // Linear progression toward target
            const progress = Math.min(yearsElapsed / impactMetrics.waste.yearsToTarget, 1);
            const increase = (impactMetrics.waste.targetValue - impactMetrics.waste.baseValue) * progress;

            return impactMetrics.waste.baseValue + increase;
        }

        // Smooth animated counter that transitions to a target value
        function animateToValue(element, targetValue, duration, formatFn) {
            const startValue = parseFloat(element.textContent.replace(/[,$]/g, '')) || 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = startValue + (targetValue - startValue) * easeOutQuart;

                element.textContent = formatFn(currentValue);

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Format functions - show cents/decimals for live ticker effect
        const formatDollars = (val) => val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatKwh = (val) => val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatPercent = (val) => val.toFixed(1);
        // Format for whole numbers (EV miles, homes)
        const formatWholeNumber = (val) => Math.round(val).toLocaleString('en-US');

        // Solar metric conversions (Issue #15)
        // EV efficiency: ~3.5 miles per kWh (average for modern EVs)
        const KWH_TO_EV_MILES = 3.5;
        // Average US home uses ~10,500 kWh per year (EIA data)
        const KWH_PER_HOME_YEAR = 10500;

        function convertKwhToEvMiles(kwh) {
            return kwh * KWH_TO_EV_MILES;
        }

        function convertKwhToHomesPowered(kwh) {
            return kwh / KWH_PER_HOME_YEAR;
        }

        // Live ticker update
        let metricsStarted = false;
        let metricsRunning = false; // Track if intervals are currently running
        let tickerInterval = null;
        let solarCarouselIndex = 0;
        let solarCarouselInterval = null;

        // Pause metrics intervals when tab is hidden to save battery (Bug Fix #30)
        function pauseMetricsIntervals() {
            if (tickerInterval) {
                clearInterval(tickerInterval);
                tickerInterval = null;
            }
            if (solarCarouselInterval) {
                clearInterval(solarCarouselInterval);
                solarCarouselInterval = null;
            }
            metricsRunning = false;
        }

        // Resume metrics intervals when tab becomes visible
        function resumeMetricsIntervals() {
            if (!metricsStarted || metricsRunning) return;
            metricsRunning = true;

            const donationsEl = document.getElementById('donations-counter');
            const solarEl = document.getElementById('solar-counter');
            const evMilesEl = document.getElementById('solar-evmiles');
            const homesEl = document.getElementById('solar-homes');
            const carouselSlides = document.querySelectorAll('.metric-carousel .metric-slide');

            tickerInterval = setInterval(() => {
                const newDonations = calculateCurrentDonations();
                const newSolar = calculateCurrentSolar();

                if (donationsEl) donationsEl.textContent = formatDollars(newDonations);
                if (solarEl) solarEl.textContent = formatKwh(newSolar);
                if (evMilesEl) evMilesEl.textContent = formatWholeNumber(convertKwhToEvMiles(newSolar));
                if (homesEl) homesEl.textContent = formatWholeNumber(convertKwhToHomesPowered(newSolar));
            }, 100);

            if (carouselSlides.length > 1) {
                solarCarouselInterval = setInterval(() => {
                    const current = carouselSlides[solarCarouselIndex];
                    current.classList.remove('active');
                    current.classList.add('exiting');
                    solarCarouselIndex = (solarCarouselIndex + 1) % carouselSlides.length;
                    const next = carouselSlides[solarCarouselIndex];
                    setTimeout(() => {
                        current.classList.remove('exiting');
                        next.classList.add('active');
                    }, 500);
                }, 5000);
            }
        }

        // Register with visibility API to pause/resume
        registerVisibilityAnimation(() => {
            if (metricsStarted) resumeMetricsIntervals();
        });

        // Also pause when tab hidden
        document.addEventListener('visibilitychange', function metricsVisibility() {
            if (document.hidden) {
                pauseMetricsIntervals();
            }
        });

        function startLiveTicker() {
            if (metricsStarted) return;
            metricsStarted = true;

            const donationsEl = document.getElementById('donations-counter');
            const solarEl = document.getElementById('solar-counter');
            const evMilesEl = document.getElementById('solar-evmiles');
            const homesEl = document.getElementById('solar-homes');
            const carouselSlides = document.querySelectorAll('.metric-carousel .metric-slide');

            // Initial animation from 0 to current values
            const currentDonations = calculateCurrentDonations();
            const currentSolar = calculateCurrentSolar();

            animateToValue(donationsEl, currentDonations, 2500, formatDollars);
            animateToValue(solarEl, currentSolar, 2500, formatKwh);
            animateToValue(evMilesEl, convertKwhToEvMiles(currentSolar), 2500, formatWholeNumber);
            animateToValue(homesEl, convertKwhToHomesPowered(currentSolar), 2500, formatWholeNumber);

            // After initial animation, start live updates every 100ms
            // This makes the counters tick up in real-time showing ongoing impact
            let lastDonations = currentDonations;
            let lastSolar = currentSolar;

            setTimeout(() => {
                // Mark intervals as running (for pause/resume on visibility change)
                metricsRunning = true;

                tickerInterval = setInterval(() => {
                    const newDonations = calculateCurrentDonations();
                    const newSolar = calculateCurrentSolar();

                    if (donationsEl) {
                        donationsEl.textContent = formatDollars(newDonations);
                        lastDonations = newDonations;
                    }
                    // Update all three solar metric displays
                    if (solarEl) {
                        solarEl.textContent = formatKwh(newSolar);
                    }
                    if (evMilesEl) {
                        evMilesEl.textContent = formatWholeNumber(convertKwhToEvMiles(newSolar));
                    }
                    if (homesEl) {
                        homesEl.textContent = formatWholeNumber(convertKwhToHomesPowered(newSolar));
                    }
                    lastSolar = newSolar;
                }, 100);

                // Start carousel rotation for solar metric (Issue #15)
                // Rotate every 5 seconds as requested
                if (carouselSlides.length > 1) {
                    solarCarouselInterval = setInterval(() => {
                        // Mark current as exiting
                        const current = carouselSlides[solarCarouselIndex];
                        current.classList.remove('active');
                        current.classList.add('exiting');

                        // Move to next slide
                        solarCarouselIndex = (solarCarouselIndex + 1) % carouselSlides.length;
                        const next = carouselSlides[solarCarouselIndex];

                        // After exit animation, switch to next
                        setTimeout(() => {
                            current.classList.remove('exiting');
                            next.classList.add('active');
                        }, 500); // Match CSS transition duration
                    }, 5000); // 5 seconds per slide
                }
            }, 2600);
        }

        // Use Intersection Observer to trigger animation when visible
        const metricsSection = document.querySelector('.metrics-section');
        if (metricsSection) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        startLiveTicker();
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.3 });

            observer.observe(metricsSection);
        }

        // ============================================
        // SCENIC ROUTE OVERLAYS
        // The Sunshine Trail: Asheville, NC to Waitsfield, VT
        // ============================================

        // Define scenic route coordinates
        // Blue Ridge Parkway: Asheville, NC (Milepost 382) to Waynesboro, VA (Milepost 0)
        const blueRidgeParkway = [
            // Blue Ridge Parkway: Asheville to Waynesboro (469 miles)
            // More detailed waypoints following the actual parkway route
            [35.5951, -82.5515],  // Asheville, NC (Folk Art Center area)
            [35.6100, -82.4800],  // BRP heading northeast
            [35.6450, -82.3750],  // Craggy Gardens approach
            [35.6810, -82.3790],  // Craggy Gardens Visitor Center
            [35.7650, -82.2650],  // Mount Mitchell Spur (MP 355)
            [35.7980, -82.2270],  // Black Mountain Gap
            [35.8550, -82.1350],  // Crabtree Falls area
            [35.9170, -82.0640],  // Little Switzerland
            [35.9550, -81.9370],  // Linville Falls (MP 316)
            [36.0200, -81.8600],  // Linville Gorge area
            [36.0880, -81.8030],  // Grandfather Mountain approach
            [36.1350, -81.7480],  // Linn Cove Viaduct
            [36.1580, -81.7050],  // Julian Price Park
            [36.2000, -81.6800],  // Moses Cone Manor
            [36.2987, -81.6904],  // Blowing Rock
            [36.3100, -81.5800],  // Thunder Hill
            [36.3600, -81.4200],  // E.B. Jeffress Park
            [36.4200, -81.2800],  // Doughton Park
            [36.5000, -81.0500],  // Air Bellows Gap
            [36.5569, -80.9897],  // Fancy Gap
            [36.6300, -80.6500],  // Groundhog Mountain
            [36.7180, -80.4070],  // Mabry Mill (MP 176)
            [36.7700, -80.3200],  // Rocky Knob
            [36.8400, -80.2400],  // Smart View
            [36.9500, -80.1500],  // Roanoke Mountain
            [37.0889, -80.1869],  // Roanoke area (MP 120)
            [37.2000, -80.0800],  // Peaks of Otter area
            [37.3100, -79.8500],  // Apple Orchard Mountain
            [37.4530, -79.6190],  // Natural Bridge area
            [37.5500, -79.5000],  // Buena Vista area
            [37.6600, -79.3400],  // Lexington area
            [37.7700, -79.2000],  // Steeles Tavern
            [37.8600, -79.0800],  // Staunton area
            [37.9500, -78.9700],  // Afton Mountain approach
            [38.0330, -78.8690],  // Waynesboro / Rockfish Gap (BRP terminus, MP 0)
        ];

        // Skyline Drive: Waynesboro (Rockfish Gap) to Front Royal (105 miles)
        const skylineDrive = [
            // More detailed waypoints following the Skyline Drive through Shenandoah
            [38.0330, -78.8690],  // Rockfish Gap (southern entrance, MP 105)
            [38.0800, -78.8100],  // Jarman Gap
            [38.1200, -78.7700],  // Sawmill Run Overlook
            [38.1900, -78.7500],  // Swift Run Gap (MP 65)
            [38.2350, -78.7100],  // South River Overlook
            [38.2800, -78.6900],  // Lewis Mountain
            [38.3200, -78.6650],  // Pocosin Mission
            [38.3600, -78.6500],  // Big Meadows (MP 51)
            [38.4000, -78.6000],  // Dark Hollow Falls area
            [38.4500, -78.5500],  // Skyland Resort area
            [38.4900, -78.4800],  // Stony Man Overlook
            [38.5250, -78.4300],  // Little Stony Man
            [38.5533, -78.3800],  // Mary's Rock area
            [38.5900, -78.3500],  // Panorama area
            [38.6300, -78.3350],  // Thornton Gap (MP 31)
            [38.6800, -78.3100],  // Pass Mountain
            [38.7200, -78.2900],  // Elkwallow Wayside
            [38.7700, -78.2600],  // Range View Overlook
            [38.8200, -78.2300],  // Dickey Ridge Visitor Center
            [38.8600, -78.2100],  // Signal Knob Overlook
            [38.9030, -78.1940],  // Front Royal (northern terminus, MP 0)
        ];

        // Connector Route: Front Royal, VA to Bennington, VT via I-81 / I-87 / US-7
        const connectorRoute = [
            [38.9030, -78.1940],  // Front Royal, VA
            [39.1850, -77.5100],  // Winchester, VA
            [39.4580, -77.4000],  // Hagerstown, MD
            [39.7600, -77.5700],  // Chambersburg, PA
            [40.2700, -76.8800],  // Harrisburg, PA
            [40.5800, -75.4900],  // Allentown area
            [41.0400, -74.1300],  // Northern NJ
            [41.7000, -73.9200],  // Poughkeepsie, NY
            [42.2500, -73.7900],  // Hudson, NY
            [42.6500, -73.7500],  // Albany area
            [42.8800, -73.2000],  // Bennington, VT
        ];

        // Vermont Route 100: Wilmington to Waitsfield (217 miles of scenic mountain road)
        // Known as "The Skier's Highway" - one of America's most scenic drives
        const route100Vermont = [
            [42.8800, -73.2000],  // Bennington (connector from US-7)
            [42.9200, -72.9500],  // Route 9 heading east
            [42.8678, -72.8711],  // Wilmington (Route 100 begins)
            [42.9400, -72.8300],  // West Dover
            [43.0100, -72.8000],  // Mount Snow area
            [43.0700, -72.7900],  // Wardsboro
            [43.1300, -72.7850],  // South Londonderry
            [43.1597, -72.7792],  // Jamaica
            [43.2200, -72.7600],  // Rawsonville
            [43.2600, -72.7400],  // Londonderry
            [43.3200, -72.7200],  // Peru
            [43.3890, -72.7000],  // Weston (Vermont Country Store)
            [43.4300, -72.7150],  // Andover
            [43.4700, -72.7300],  // Ludlow (Okemo Mountain)
            [43.5200, -72.7200],  // Tyson
            [43.5500, -72.7100],  // Plymouth (Calvin Coolidge homestead)
            [43.5900, -72.7500],  // Bridgewater Corners
            [43.6200, -72.7900],  // Killington Access Road
            [43.6700, -72.8100],  // Sherburne Pass area
            [43.7100, -72.8200],  // Pittsfield
            [43.7600, -72.8200],  // Stockbridge
            [43.8200, -72.8350],  // Gaysville
            [43.8800, -72.8400],  // Rochester
            [43.9200, -72.8350],  // Hancock
            [43.9700, -72.8400],  // Granville (Moss Glen Falls)
            [44.0200, -72.8350],  // Granville Gulf
            [44.0800, -72.8200],  // Warren (Sugarbush)
            [44.1400, -72.8250],  // Irasville
            [44.1852, -72.8288],  // Waitsfield (Lawson's Finest HQ - journey's end!)
        ];

        // Create route layers
        const routeLayers = L.layerGroup();

        const blueRidgePolyline = L.polyline(blueRidgeParkway, {
            color: '#2E86AB',
            weight: 5,
            opacity: 0.85,
            smoothFactor: 1.5,
            dashArray: null
        }).bindPopup('<strong>Blue Ridge Parkway</strong><br>469 miles of America\'s most scenic mountain road, connecting Great Smoky Mountains to Shenandoah National Park.');

        const skylinePolyline = L.polyline(skylineDrive, {
            color: '#7B68EE',
            weight: 5,
            opacity: 0.85,
            smoothFactor: 1.5,
            dashArray: null
        }).bindPopup('<strong>Skyline Drive</strong><br>105 miles through Shenandoah National Park with 75 scenic overlooks and stunning Blue Ridge views.');

        const connectorPolyline = L.polyline(connectorRoute, {
            color: '#888888',
            weight: 3,
            opacity: 0.6,
            smoothFactor: 1.5,
            dashArray: '10, 10'
        }).bindPopup('<strong>Connector Route</strong><br>Interstate and highway connection from Shenandoah to southern Vermont via the Hudson Valley.');

        const route100Polyline = L.polyline(route100Vermont, {
            color: '#228B22',
            weight: 5,
            opacity: 0.85,
            smoothFactor: 1.5,
            dashArray: null
        }).bindPopup('<strong>Vermont Route 100</strong><br>217 miles through the Green Mountains - Vermont\'s "Main Street" and the best fall foliage drive in New England.');

        // Add all routes to the layer group
        routeLayers.addLayer(blueRidgePolyline);
        routeLayers.addLayer(skylinePolyline);
        routeLayers.addLayer(connectorPolyline);
        routeLayers.addLayer(route100Polyline);

        // Toggle scenic route visibility
        const routeToggle = document.getElementById('toggle-scenic-route');
        const routeLegend = document.getElementById('route-legend');
        const chargerFilter = document.getElementById('filter-chargers');
        const chargerFilterItem = chargerFilter.closest('.filter-item');

        // Initially disable charger filter (route not shown)
        chargerFilter.checked = false;
        chargerFilter.disabled = true;
        chargerFilterItem.style.opacity = '0.5';
        chargerFilterItem.title = 'Enable "Show The Sunshine Trail Route" to see DC Fast Chargers';

        // Email modal timer variables (defined here so they're available in the handler)
        let emailModalTimer = null;
        let emailModalStartTime = null;
        let emailModalElapsedTime = 0;
        const emailModalDelay = 30000; // 30 seconds
        const emailModalShownKey = 'sunshineTrailEmailModalShown';
        // Use storageAvailable() for feature detection (Issue #20)
        let emailModalShownEarly = storageAvailable() && localStorage.getItem(emailModalShownKey) === 'true';

        // Start email modal timer ONLY AFTER site is revealed (password authenticated)
        // 30 seconds of ACTIVE viewing after authentication
        // Uses visibility API to pause timer when tab is in background
        if (!emailModalShownEarly) {
            const emailModalEl = document.getElementById('email-modal');

            function startEmailTimer() {
                // Don't start timer until site is revealed (password authenticated)
                if (!window.siteRevealed) return;
                if (emailModalShownEarly || emailModalTimer) return;
                emailModalStartTime = Date.now();
                const remainingTime = emailModalDelay - emailModalElapsedTime;
                emailModalTimer = setTimeout(() => {
                    if (emailModalEl && !emailModalShownEarly && !document.hidden) {
                        emailModalEl.classList.add('visible');
                        emailModalShownEarly = true;
                        if (storageAvailable()) localStorage.setItem(emailModalShownKey, 'true');
                    }
                }, remainingTime);
            }

            function pauseEmailTimer() {
                if (emailModalTimer) {
                    clearTimeout(emailModalTimer);
                    emailModalTimer = null;
                    // Calculate elapsed time
                    if (emailModalStartTime) {
                        emailModalElapsedTime += Date.now() - emailModalStartTime;
                        emailModalStartTime = null;
                    }
                }
            }

            // Handle visibility changes (tab switching, minimizing)
            document.addEventListener('visibilitychange', () => {
                if (emailModalShownEarly || !window.siteRevealed) return;
                if (document.hidden) {
                    pauseEmailTimer();
                } else {
                    startEmailTimer();
                }
            });

            // Listen for site reveal event (password authentication complete)
            window.addEventListener('siteRevealed', () => {
                if (!document.hidden) {
                    startEmailTimer();
                }
            });

            // Start timer if page is visible AND site is already revealed (cached auth)
            if (!document.hidden && window.siteRevealed) {
                startEmailTimer();
            }
        }

        routeToggle.addEventListener('change', function() {
            const zoomHintEl = document.getElementById('zoom-hint');
            const routeToggleContainer = document.getElementById('route-toggle-container');

            // Close search when toggling route
            if (window.collapseSearch) window.collapseSearch();

            if (this.checked) {
                // Show loading spinner FIRST - let it render before heavy operations
                routeToggleContainer.classList.add('loading');

                // Use requestAnimationFrame + setTimeout to ensure spinner renders before heavy operations
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        map.addLayer(routeLayers);
                        routeLegend.style.display = 'flex';

                        // Keep zoom hint visible until user manually zooms (Issue #26)
                        // The zoom hint will auto-hide via the userHasZoomed flag when user interacts with zoom controls

                        // Show chargers when route is shown (add to unified cluster)
                        visibleCategories.charger = true;
                        chargerFilter.checked = true;
                        chargerFilter.disabled = false;
                        chargerFilterItem.style.opacity = '1';
                        chargerFilterItem.title = '';
                        refreshUnifiedCluster();

                        // Animate to show full route with extra padding for wide cluster pills
                        const fullRoute = [
                            ...blueRidgeParkway,
                            ...skylineDrive,
                            ...connectorRoute,
                            ...route100Vermont
                        ];
                        const sidebarWidth = getSidebarWidth();

                        // Use different padding for mobile vs desktop
                        if (Viewport.isMobile()) {
                            map.fitBounds(fullRoute, {
                                animate: true,
                                duration: 1.0,
                                padding: [50, 30]
                            });
                        } else {
                            map.fitBounds(fullRoute, {
                                animate: true,
                                duration: 1.0,
                                paddingTopLeft: L.point(sidebarWidth + 180, 100),
                                paddingBottomRight: L.point(250, 100)
                            });
                        }

                        // Hide spinner after map operations complete
                        setTimeout(() => {
                            routeToggleContainer.classList.remove('loading');
                        }, 800);
                    }, 16); // One frame delay after rAF ensures paint happens first
                });
            } else {

                // Show loading spinner FIRST - let it render before heavy operations
                routeToggleContainer.classList.add('loading');

                // Use requestAnimationFrame + setTimeout to ensure spinner renders before heavy operations
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        map.removeLayer(routeLayers);
                        routeLegend.style.display = 'none';

                        // Show zoom hint again when route is hidden (if zoom level warrants it)
                        if (zoomHintEl && map.getZoom() < 9) zoomHintEl.style.display = 'block';

                        // Hide chargers when route is hidden (remove from unified cluster)
                        visibleCategories.charger = false;
                        chargerFilter.checked = false;
                        chargerFilter.disabled = true;
                        chargerFilterItem.style.opacity = '0.5';
                        chargerFilterItem.title = 'Enable "Show The Sunshine Trail Route" to see DC Fast Chargers';
                        refreshUnifiedCluster();

                        // Hide spinner after map operations complete
                        setTimeout(() => {
                            routeToggleContainer.classList.remove('loading');
                        }, 400);
                    }, 16); // One frame delay after rAF ensures paint happens first
                });
            }
        });

        // Load route immediately since checkbox is checked by default in HTML
        // Directly add route layers and show legend (more reliable than triggering change event)
        if (routeToggle && routeToggle.checked) {
            map.addLayer(routeLayers);
            routeLegend.style.display = 'flex';

            // Enable chargers since route is shown
            visibleCategories.charger = true;
            chargerFilter.checked = true;
            chargerFilter.disabled = false;
            chargerFilterItem.style.opacity = '1';
            chargerFilterItem.title = '';
            refreshUnifiedCluster();

            // Keep zoom hint visible until user manually zooms (Issue #26)
            // It will auto-hide via userHasZoomed flag when user clicks zoom controls

            // Fit bounds to show full route AND all markers
            const fullRoute = [
                ...blueRidgeParkway,
                ...skylineDrive,
                ...connectorRoute,
                ...route100Vermont
            ];

            // Include all spot locations in the bounds
            const allSpotLocations = sunshineSpots.map(s => [s.lat, s.lng]);
            const combinedBounds = L.latLngBounds([...fullRoute, ...allSpotLocations]);

            // Calculate appropriate zoom based on viewport
            // Mobile needs to zoom in more since map area is smaller
            const isMobile = Viewport.isMobile();
            const minZoom = isMobile ? 5 : 5;  // Minimum zoom to keep focus on east coast
            const maxZoom = isMobile ? 6 : 7;  // Maximum zoom

            // Use sidebar-aware fitBounds for proper safe area
            fitBoundsWithSidebarOffset(combinedBounds, {
                animate: false,
                maxZoom: maxZoom,
                padding: isMobile ? [30, 20] : [40, 40]
            });

            // Ensure we don't zoom out too far (keep focus on east coast US)
            setTimeout(() => {
                if (map.getZoom() < minZoom) {
                    const center = combinedBounds.getCenter();
                    map.setView(center, minZoom, { animate: false });
                }
            }, 100);
        }

        // ============================================
        // EMAIL SIGNUP MODAL
        // Timer starts 30 seconds from page load (defined above)
        // ============================================
        const emailModal = document.getElementById('email-modal');
        const emailModalClose = document.getElementById('email-modal-close');
        const emailForm = document.getElementById('email-form');

        function hideEmailModal() {
            if (emailModal) {
                emailModal.classList.remove('visible');
            }
        }

        // Close modal handlers
        if (emailModalClose) {
            emailModalClose.addEventListener('click', hideEmailModal);
        }

        if (emailModal) {
            emailModal.addEventListener('click', function(e) {
                if (e.target === emailModal) {
                    hideEmailModal();
                }
            });
        }

        // Get Itinerary button - always shows modal
        const getItineraryBtn = document.getElementById('get-itinerary-btn');
        if (getItineraryBtn) {
            getItineraryBtn.addEventListener('click', function() {
                if (emailModal) {
                    emailModal.classList.add('visible');
                    // Mark as shown so 30-second timer doesn't show it again
                    emailModalShownEarly = true;
                    if (storageAvailable()) localStorage.setItem(emailModalShownKey, 'true');
                    if (emailModalTimer) {
                        clearTimeout(emailModalTimer);
                        emailModalTimer = null;
                    }
                }
            });
        }

        // Location checkbox handling with geolocation
        const localCheckbox = document.getElementById('local-checkbox');
        const locationField = document.getElementById('location-field');
        const locationInput = document.getElementById('location-input');
        let userLocation = null;
        let locationDetectionCancelled = false;

        // If user types in the location field, cancel geolocation detection
        if (locationInput) {
            locationInput.addEventListener('input', function() {
                locationDetectionCancelled = true;
                locationInput.classList.remove('detecting');
                locationInput.placeholder = 'Enter your location';
            });
        }

        if (localCheckbox) {
            localCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    locationField.style.display = 'block';
                    locationInput.classList.add('detecting');
                    locationInput.value = '';
                    locationInput.placeholder = 'Detecting your location...';
                    locationDetectionCancelled = false;

                    // Request geolocation
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            async function(position) {
                                // If user started typing, don't overwrite their input
                                if (locationDetectionCancelled) return;

                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                userLocation = { lat, lng };

                                // Reverse geocode using OpenStreetMap Nominatim (free, no API key)
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 10000);

                                try {
                                    const response = await fetch(
                                        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
                                        {
                                            headers: { 'Accept': 'application/json' },
                                            signal: controller.signal
                                        }
                                    );
                                    clearTimeout(timeoutId);

                                    // Check again in case user typed while fetching
                                    if (locationDetectionCancelled) return;

                                    if (!response.ok) {
                                        throw new Error(`HTTP ${response.status}`);
                                    }

                                    const data = await response.json();

                                    // Build a readable address (town, state)
                                    let address = '';
                                    if (data.address) {
                                        const a = data.address;
                                        // Try various location fields Nominatim might return
                                        const city = a.city || a.town || a.village || a.hamlet || a.municipality || a.county || a.suburb || '';
                                        const state = a.state || a.province || a.region || '';
                                        if (city && state) {
                                            address = `${city}, ${state}`;
                                        } else if (city) {
                                            address = city;
                                        } else if (state) {
                                            address = state;
                                        }
                                    }

                                    // Fallback to display_name if we couldn't extract city/state
                                    if (!address && data.display_name) {
                                        // display_name is like "123 Main St, Northfield, Vermont, USA"
                                        // Extract meaningful parts (skip house number, get town/state)
                                        const parts = data.display_name.split(',').map(p => p.trim());
                                        // Find state-like parts and town
                                        if (parts.length >= 2) {
                                            // Usually format is: specific, town, county, state, country
                                            // Try to get town and state (skip first part if it's a number/address)
                                            const filtered = parts.filter(p => !/^\d/.test(p) && p.toLowerCase() !== 'usa' && p.toLowerCase() !== 'united states');
                                            if (filtered.length >= 2) {
                                                address = `${filtered[0]}, ${filtered[1]}`;
                                            } else if (filtered.length === 1) {
                                                address = filtered[0];
                                            }
                                        }
                                    }

                                    locationInput.classList.remove('detecting');
                                    if (address) {
                                        locationInput.value = address;
                                    } else {
                                        locationInput.placeholder = 'Enter your location';
                                    }
                                } catch (error) {
                                    clearTimeout(timeoutId);
                                    if (error.name === 'AbortError') {
                                        console.warn('Reverse geocoding timed out');
                                    } else {
                                        console.error('Geocoding error:', error);
                                    }
                                    if (locationDetectionCancelled) return;
                                    locationInput.classList.remove('detecting');
                                    locationInput.placeholder = 'Enter your location';
                                }
                            },
                            function(error) {
                                if (locationDetectionCancelled) return;
                                console.error('Geolocation error:', error);
                                locationInput.classList.remove('detecting');
                                locationInput.placeholder = 'Enter your location';
                                locationInput.value = '';

                                // Show helpful message based on error
                                if (error.code === error.PERMISSION_DENIED) {
                                    locationInput.placeholder = 'Location denied - enter manually';
                                } else if (error.code === error.POSITION_UNAVAILABLE) {
                                    locationInput.placeholder = 'Enter your location';
                                } else {
                                    locationInput.placeholder = 'Enter your location';
                                }
                            },
                            { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
                        );
                    } else {
                        locationInput.classList.remove('detecting');
                        locationInput.placeholder = 'Enter your location';
                    }
                } else {
                    locationField.style.display = 'none';
                    userLocation = null;
                    locationDetectionCancelled = false;
                }
            });
        }

        // Form submission rate limiting (#25) - prevent spam
        let lastFormSubmission = 0;
        const FORM_RATE_LIMIT_MS = 5000; // 5 seconds between submissions

        // Handle form submission
        if (emailForm) {
            emailForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Rate limiting check (#25)
                const now = Date.now();
                if (now - lastFormSubmission < FORM_RATE_LIMIT_MS) {
                    alert('Please wait a few seconds before submitting again.');
                    return;
                }

                const name = document.getElementById('name-input').value.trim();
                const email = document.getElementById('email-input').value.trim();
                const localHappenings = document.getElementById('local-checkbox').checked;
                const location = locationInput ? locationInput.value.trim() : '';

                // Enhanced input validation (#26)
                // Email validation - RFC 5322 simplified
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!email || !emailRegex.test(email)) {
                    alert('Please enter a valid email address');
                    return;
                }
                // Email max length check
                if (email.length > 254) {
                    alert('Email address is too long');
                    return;
                }
                // Name validation - letters, spaces, hyphens, apostrophes only
                const nameRegex = /^[a-zA-Z\s\-']+$/;
                if (!name || name.length < 1 || name.length > 100 || !nameRegex.test(name)) {
                    alert('Please enter a valid name (letters only)');
                    return;
                }
                // Location validation if provided (no script injection)
                if (location && (location.length > 200 || /<script/i.test(location))) {
                    alert('Please enter a valid location');
                    return;
                }

                // Update rate limit timestamp
                lastFormSubmission = now;
                // Show success message - use safe DOM APIs to prevent XSS (Security Fix)
                const successMsg = document.createElement('p');
                successMsg.style.cssText = 'color: var(--deep-brown); font-weight: 600; font-size: 1.1rem;';
                const firstName = name.split(' ')[0].substring(0, 50); // Limit length
                successMsg.textContent = 'Thanks, ' + firstName + '! Check your inbox for your road trip guide. ðŸš—â˜€ï¸';
                // Clear form and append success message safely
                while (emailForm.firstChild) {
                    emailForm.removeChild(emailForm.firstChild);
                }
                emailForm.appendChild(successMsg);
                // Close modal after 5 seconds
                setTimeout(hideEmailModal, 5000);
            });
        }

        // ============================================
        // MODAL FIDGET SUN SPINNER
        // Same spinning behavior as header version
        // ============================================
        const fidgetSunModal = document.getElementById('fidget-sun-modal');
        const fidgetModalContainer = fidgetSunModal ? fidgetSunModal.parentElement : null;
        if (fidgetSunModal && fidgetModalContainer) {
            // Prevent clicks on fidget sun from closing the modal
            fidgetModalContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            fidgetSunModal.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            let rotationM = 0;
            let velocityM = 0;
            let isDraggingM = false;
            let lastAngleM = 0;
            let lastTimeM = 0;
            let animationIdM = null;

            function getAngleM(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            function startDragM(e) {
                e.preventDefault();
                e.stopPropagation();
                isDraggingM = true;
                fidgetSunModal.classList.add('spinning');
                const rect = fidgetSunModal.getBoundingClientRect();
                lastAngleM = getAngleM(e, rect);
                lastTimeM = Date.now();
                velocityM = 0;
                if (animationIdM) cancelAnimationFrame(animationIdM);
            }

            function dragM(e) {
                if (!isDraggingM) return;
                e.preventDefault();
                const rect = fidgetSunModal.getBoundingClientRect();
                const currentAngle = getAngleM(e, rect);
                const now = Date.now();
                const dt = Math.max(now - lastTimeM, 1);

                let deltaAngle = currentAngle - lastAngleM;
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                rotationM += deltaAngle * (180 / Math.PI);
                velocityM = (deltaAngle * (180 / Math.PI)) / dt * 35;

                fidgetSunModal.style.transform = `rotate(${rotationM}deg)`;
                lastAngleM = currentAngle;
                lastTimeM = now;
            }

            function endDragM() {
                if (!isDraggingM) return;
                isDraggingM = false;
                fidgetSunModal.classList.remove('spinning');
                animateMomentumM();
            }

            function animateMomentumM() {
                if (Math.abs(velocityM) < 0.005) {
                    velocityM = 0;
                    return;
                }
                rotationM += velocityM;
                velocityM *= 0.9995;
                fidgetSunModal.style.transform = `rotate(${rotationM}deg)`;
                animationIdM = requestAnimationFrame(animateMomentumM);
            }

            fidgetModalContainer.addEventListener('mousedown', startDragM);
            document.addEventListener('mousemove', dragM);
            document.addEventListener('mouseup', endDragM);
            fidgetModalContainer.addEventListener('touchstart', startDragM, { passive: false });
            document.addEventListener('touchmove', dragM, { passive: false });
            document.addEventListener('touchend', endDragM);

            // Emoji burst on click/tap for modal sun
            const emojisM = FIDGET_SUN_EMOJIS; // Use shared emoji array (#51)
            let clickStartTimeM = 0;
            let clickStartPosM = { x: 0, y: 0 };

            function getClientPosM(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }

            fidgetModalContainer.addEventListener('mousedown', (e) => {
                clickStartTimeM = Date.now();
                const pos = getClientPosM(e);
                clickStartPosM = { x: pos.x, y: pos.y };
            });

            fidgetModalContainer.addEventListener('mouseup', (e) => {
                const elapsed = Date.now() - clickStartTimeM;
                const pos = getClientPosM(e);
                const moved = Math.sqrt(
                    Math.pow(pos.x - clickStartPosM.x, 2) +
                    Math.pow(pos.y - clickStartPosM.y, 2)
                );
                if (elapsed < 300 && moved < 20) {
                    burstEmojisModal(pos);
                }
            });

            fidgetModalContainer.addEventListener('touchstart', (e) => {
                clickStartTimeM = Date.now();
                const pos = getClientPosM(e);
                clickStartPosM = { x: pos.x, y: pos.y };
            });

            fidgetModalContainer.addEventListener('touchend', (e) => {
                const elapsed = Date.now() - clickStartTimeM;
                const endPos = e.changedTouches ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY } : clickStartPosM;
                const moved = Math.sqrt(
                    Math.pow(endPos.x - clickStartPosM.x, 2) +
                    Math.pow(endPos.y - clickStartPosM.y, 2)
                );
                if (elapsed < 300 && moved < 50) {
                    burstEmojisModal(endPos);
                }
            });

            function burstEmojisModal(pos) {
                const rect = fidgetSunModal.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const shuffled = [...emojisM].sort(() => Math.random() - 0.5);
                const burstEmojis = shuffled.slice(0, 3);
                const burstCount = 8 + Math.floor(Math.random() * 5);

                for (let i = 0; i < burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = burstEmojis[i % burstEmojis.length];
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${20 + Math.random() * 16}px;
                        pointer-events: none;
                        z-index: 10002;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    const angle = (Math.PI * 2 * i / burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 200 + Math.random() * 150;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 350;
                    const startTime = performance.now();
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 150 + Math.random() * 150;

                    function animateEmojiModal(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);
                        const scale = 1 + t * 0.4;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmojiModal);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmojiModal);
                }
            }

            // Gentle idle spin for modal sun (pauses when tab hidden to save battery)
            let idleRotationM = 0;
            function idleSpinM() {
                if (!pageIsVisible) return; // Pause when tab hidden
                if (!isDraggingM && Math.abs(velocityM) < 0.1) {
                    idleRotationM += 0.05;
                    fidgetSunModal.style.transform = `rotate(${rotationM + idleRotationM}deg)`;
                }
                requestAnimationFrame(idleSpinM);
            }
            idleSpinM();
            registerVisibilityAnimation(idleSpinM);
        }

        // ============================================
        // BUTTON WAVE ANIMATION
        // Stadium-style wave effect on hover
        // ============================================
        function createWaveAnimation(button, delayPerChar = 0.03) {
            const text = button.textContent;
            button.innerHTML = '';
            button.classList.add('wave-text');

            const chars = [...text];
            const totalChars = chars.length;

            // Split text into spans for each character - animate right to left
            chars.forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char === ' ' ? '\u00A0' : char; // Use non-breaking space
                // Reverse the delay: last char starts first, first char starts last
                span.style.animationDelay = `${(totalChars - 1 - index) * delayPerChar}s`;
                button.appendChild(span);
            });
        }

        function resetWaveAnimation(button, originalText) {
            button.classList.remove('wave-text');
            button.textContent = originalText;
        }

        // Apply wave animation to buttons
        document.querySelectorAll('.popup-btn, .beer-section-btn, .get-itinerary-btn, .email-submit, .state-btn, .password-submit').forEach(btn => {
            const originalText = btn.textContent;
            // Faster animation for short buttons (state buttons, email submit)
            const delay = (btn.classList.contains('email-submit') || btn.classList.contains('state-btn')) ? 0.02 : 0.03;

            btn.addEventListener('mouseenter', () => {
                createWaveAnimation(btn, delay);
            });

            btn.addEventListener('mouseleave', () => {
                resetWaveAnimation(btn, originalText);
            });
        });

        // For dynamically created popup buttons, use event delegation
        document.addEventListener('mouseenter', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('popup-btn')) {
                if (!e.target._originalText) {
                    e.target._originalText = e.target.textContent;
                }
                if (!e.target.classList.contains('wave-text')) {
                    createWaveAnimation(e.target);
                }
            }
        }, true);

        document.addEventListener('mouseleave', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('popup-btn') && e.target._originalText) {
                resetWaveAnimation(e.target, e.target._originalText);
            }
        }, true);

        // ============================================
        // MAP SEARCH FUNCTIONALITY
        // Search listings and locations
        // ============================================
        const mapSearchBtn = document.getElementById('map-search-btn');
        const mapSearchInput = document.getElementById('map-search-input');
        const mapSearchResults = document.getElementById('map-search-results');
        // searchExpanded is defined globally at the top of the script

        // Helper function to collapse search (closes input and results)
        // This is called when user interacts with other UI elements
        // Always hides results regardless of searchExpanded state to handle edge cases
        function collapseSearch() {
            searchExpanded = false;
            if (mapSearchInput) {
                mapSearchInput.classList.remove('expanded');
                mapSearchInput.value = '';
                mapSearchInput.blur(); // Remove focus
            }
            if (mapSearchResults) {
                mapSearchResults.classList.remove('visible');
                mapSearchResults.innerHTML = ''; // Clear results content
            }
            // Collapse map on mobile when search is closed (unless popup is open)
            if (Viewport.isMobile()) {
                const mapEl = document.getElementById('map');
                const hasOpenPopup = document.querySelector('.leaflet-popup');
                if (mapEl && mapEl.classList.contains('map-expanded') && !hasOpenPopup) {
                    mapEl.classList.remove('map-expanded');
                    setTimeout(() => {
                        if (window.map) window.map.invalidateSize({ animate: true });
                    }, 350);
                }
            }
        }

        // Expose collapseSearch globally so other sections can use it
        // This overwrites the placeholder defined earlier in the script
        window.collapseSearch = collapseSearch;

        // Global Escape key handler - closes search from anywhere
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && (searchExpanded || mapSearchResults?.classList.contains('visible'))) {
                collapseSearch();
            }
        });

        if (mapSearchBtn && mapSearchInput && mapSearchResults) {
            // Note: Removed auto-scroll behaviors - search should not scroll the page

            // Toggle search input expansion - handler function
            // Check both state variable AND DOM state for robustness
            function toggleSearch(e) {
                e.preventDefault();
                e.stopPropagation(); // Prevent event from bubbling to document click handler

                // Check actual DOM state as well as variable for robustness
                const isInputExpanded = mapSearchInput.classList.contains('expanded');
                const areResultsVisible = mapSearchResults.classList.contains('visible');
                const isActuallyExpanded = searchExpanded || isInputExpanded || areResultsVisible;

                if (!isActuallyExpanded) {
                    // Expand search
                    searchExpanded = true;
                    mapSearchInput.classList.add('expanded');
                    mapSearchInput.focus();
                    // Hide zoom hint when search is expanded (#11)
                    const zoomHintEl = document.getElementById('zoom-hint');
                    if (zoomHintEl) {
                        zoomHintEl.classList.add('hidden');
                    }
                    // Expand map on mobile to show more search results
                    if (Viewport.isMobile()) {
                        const mapEl = document.getElementById('map');
                        if (mapEl && !mapEl.classList.contains('map-expanded')) {
                            mapEl.classList.add('map-expanded');
                            // Scroll map into view smoothly - better than window.scrollTo which fights with keyboard
                            mapEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            setTimeout(() => {
                                if (window.map) window.map.invalidateSize({ animate: true });
                            }, 350);
                        }
                    }
                } else {
                    // Collapse search - use helper function for consistency
                    collapseSearch();
                }
            }

            // Add both click and touchend for mobile compatibility
            // Fix double-firing by tracking touch events (Bug Fix)
            let searchTouchHandled = false;
            mapSearchBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                searchTouchHandled = true;
                toggleSearch(e);
                setTimeout(() => { searchTouchHandled = false; }, 300);
            }, { passive: false });
            mapSearchBtn.addEventListener('click', (e) => {
                if (searchTouchHandled) return; // Prevent double-firing on touch devices
                toggleSearch(e);
            });

            // Close search when clicking outside search control
            // Check both searchExpanded state AND if results are visible (handles edge cases)
            document.addEventListener('click', (e) => {
                const resultsVisible = mapSearchResults.classList.contains('visible');
                if ((searchExpanded || resultsVisible) && !e.target.closest('#map-search-control')) {
                    collapseSearch();
                }
            });

            // Also close search when clicking anywhere in sidebar (except search control)
            // This ensures interactions like checkboxes, toggles, etc. close the search
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.addEventListener('click', (e) => {
                    const resultsVisible = mapSearchResults.classList.contains('visible');
                    if ((searchExpanded || resultsVisible) && !e.target.closest('#map-search-control')) {
                        collapseSearch();
                    }
                }, true); // Use capture phase to ensure this fires before other handlers
            }

            // Fuzzy search function for listings
            function searchListings(query) {
                const normalizedQuery = query.toLowerCase().replace(/\s+/g, '');
                return sunshineSpots.filter(spot => {
                    const nameMatch = spot.name.toLowerCase().replace(/\s+/g, '').includes(normalizedQuery);
                    const locationMatch = spot.location && spot.location.toLowerCase().replace(/\s+/g, '').includes(normalizedQuery);
                    const descMatch = spot.description && spot.description.toLowerCase().includes(query.toLowerCase());
                    return nameMatch || locationMatch || descMatch;
                }).slice(0, 8); // Limit to 8 results
            }

            // Geocode location using Nominatim with rate limiting and caching (Performance + API Policy Fix)
            const geocodeCache = new Map();
            let lastGeocodingCall = 0;
            const GEOCODING_RATE_LIMIT_MS = 1100; // Nominatim requires 1 request/second

            async function geocodeLocation(query) {
                // Check cache first
                const cacheKey = query.toLowerCase().trim();
                if (geocodeCache.has(cacheKey)) {
                    return geocodeCache.get(cacheKey);
                }

                // Rate limiting - wait if needed
                const now = Date.now();
                const timeSinceLastCall = now - lastGeocodingCall;
                if (timeSinceLastCall < GEOCODING_RATE_LIMIT_MS) {
                    await new Promise(r => setTimeout(r, GEOCODING_RATE_LIMIT_MS - timeSinceLastCall));
                }
                lastGeocodingCall = Date.now();

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=3&countrycodes=us`,
                        {
                            headers: { 'Accept': 'application/json' },
                            signal: controller.signal
                        }
                    );
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const results = data.map(item => ({
                        name: item.display_name.split(',').slice(0, 2).join(','),
                        fullName: item.display_name,
                        lat: parseFloat(item.lat),
                        lng: parseFloat(item.lon),
                        type: 'location'
                    }));
                    // Cache results for future queries
                    geocodeCache.set(cacheKey, results);
                    return results;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.warn('Geocoding request timed out');
                    } else {
                        console.error('Geocoding error:', error);
                    }
                    return [];
                }
            }

            // Render search results
            function renderSearchResults(listings, locations) {
                mapSearchResults.innerHTML = '';

                if (listings.length === 0 && locations.length === 0) {
                    mapSearchResults.innerHTML = '<div class="search-no-results">No results found</div>';
                    mapSearchResults.classList.add('visible');
                    return;
                }

                // Add listing results (Security: use safe DOM methods to prevent XSS)
                listings.forEach(spot => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    // Build safely using DOM APIs instead of innerHTML
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'search-result-name';
                    nameDiv.textContent = spot.name;
                    const locDiv = document.createElement('div');
                    locDiv.className = 'search-result-location';
                    locDiv.textContent = spot.location || '';
                    const catSpan = document.createElement('span');
                    catSpan.className = 'search-result-category';
                    catSpan.textContent = spot.category;
                    item.appendChild(nameDiv);
                    item.appendChild(locDiv);
                    item.appendChild(catSpan);

                    // Handler function for selecting this search result
                    const selectResult = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Close search first
                        collapseSearch();

                        // Find the marker first
                        let targetMarker = null;
                        unifiedCluster.eachLayer(layer => {
                            if (layer.getLatLng &&
                                Math.abs(layer.getLatLng().lat - spot.lat) < 0.0001 &&
                                Math.abs(layer.getLatLng().lng - spot.lng) < 0.0001) {
                                targetMarker = layer;
                            }
                        });

                        if (targetMarker) {
                            // Use zoomToShowLayer which handles clusters properly
                            unifiedCluster.zoomToShowLayer(targetMarker, () => {
                                setTimeout(() => targetMarker.openPopup(), 100);
                            });
                        } else {
                            // Fallback: fly to location using viewport-aware utility
                            flyToWithOffset(L.latLng(spot.lat, spot.lng), 17);
                        }
                    };

                    // Add both click and touchend for mobile compatibility (#13)
                    item.addEventListener('click', selectResult);
                    item.addEventListener('touchend', selectResult, { passive: false });
                    mapSearchResults.appendChild(item);
                });

                // Add location results with separator if we have both types
                if (listings.length > 0 && locations.length > 0) {
                    const separator = document.createElement('div');
                    separator.style.cssText = 'padding: 8px 16px; font-size: 0.75rem; color: #999; background: #f5f5f5; text-transform: uppercase; letter-spacing: 1px;';
                    separator.textContent = 'Places';
                    mapSearchResults.appendChild(separator);
                }

                // Security: use safe DOM methods for location results to prevent XSS
                locations.forEach(loc => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'search-result-name';
                    nameDiv.textContent = loc.name;
                    const locDiv = document.createElement('div');
                    locDiv.className = 'search-result-location';
                    locDiv.textContent = loc.fullName;
                    item.appendChild(nameDiv);
                    item.appendChild(locDiv);

                    // Handler function for selecting this location result
                    const selectLocation = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Close search first
                        collapseSearch();

                        // Fly to location using viewport-aware utility
                        flyToWithOffset(L.latLng(loc.lat, loc.lng), 12);
                    };

                    // Add both click and touchend for mobile compatibility (#13)
                    item.addEventListener('click', selectLocation);
                    item.addEventListener('touchend', selectLocation, { passive: false });
                    mapSearchResults.appendChild(item);
                });

                mapSearchResults.classList.add('visible');
            }

            // Debounce search
            let searchTimeout;
            mapSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                if (query.length < 2) {
                    mapSearchResults.classList.remove('visible');
                    return;
                }

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    // Search listings first
                    const listingResults = searchListings(query);

                    // If we have good listing matches, show them immediately
                    if (listingResults.length > 0) {
                        renderSearchResults(listingResults, []);
                    }

                    // Also search for locations (towns, cities)
                    const locationResults = await geocodeLocation(query);
                    renderSearchResults(listingResults, locationResults);
                }, 300);
            });

            // Handle Enter key for immediate search or auto-select single result
            mapSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = mapSearchInput.value.trim();
                    if (query.length >= 2) {
                        // Check if we already have results displayed
                        const listingResults = searchListings(query);

                        // If there's exactly one listing (pin) result, auto-select it
                        if (listingResults.length === 1) {
                            const spot = listingResults[0];
                            collapseSearch();

                            // Find and navigate to the marker
                            let targetMarker = null;
                            unifiedCluster.eachLayer(layer => {
                                if (layer.getLatLng &&
                                    Math.abs(layer.getLatLng().lat - spot.lat) < 0.0001 &&
                                    Math.abs(layer.getLatLng().lng - spot.lng) < 0.0001) {
                                    targetMarker = layer;
                                }
                            });

                            if (targetMarker) {
                                unifiedCluster.zoomToShowLayer(targetMarker, () => {
                                    setTimeout(() => targetMarker.openPopup(), 100);
                                });
                            } else {
                                flyToWithOffset(L.latLng(spot.lat, spot.lng), 17);
                            }
                        } else {
                            // Multiple or no results - trigger search immediately
                            clearTimeout(searchTimeout);
                            (async () => {
                                const locationResults = await geocodeLocation(query);
                                renderSearchResults(listingResults, locationResults);
                            })();
                        }
                    }
                }
                // Note: Escape key is handled by the global document keydown listener
            });
        }

        // ============================================
        // SUNSHINE TEXT GOD RAYS EFFECT
        // Sparkling sunlight rays shoot out on hover
        // Full viewport overlay - no clipping
        // ============================================
        const sunshineText = document.querySelector('h1 span');
        const godRaysGlow = document.getElementById('god-rays-glow');

        if (sunshineText && godRaysGlow) {
            // Desktop: mouse hover behavior
            sunshineText.addEventListener('mouseenter', function(e) {
                godRaysGlow.classList.add('active');
            });

            sunshineText.addEventListener('mousemove', function(e) {
                // Calculate mouse position as percentage of viewport
                const mouseX = (e.clientX / window.innerWidth) * 100;
                const mouseY = (e.clientY / window.innerHeight) * 100;

                // Set CSS variables on the glow element
                godRaysGlow.style.setProperty('--mouse-x', mouseX + '%');
                godRaysGlow.style.setProperty('--mouse-y', mouseY + '%');
            });

            sunshineText.addEventListener('mouseleave', function() {
                godRaysGlow.classList.remove('active');
            });

            // Mobile: touch and hold behavior - rays show while finger is touching (#12)
            sunshineText.addEventListener('touchstart', function(e) {
                godRaysGlow.classList.add('active');
                // Set initial position
                const touch = e.touches[0];
                const touchX = (touch.clientX / window.innerWidth) * 100;
                const touchY = (touch.clientY / window.innerHeight) * 100;
                godRaysGlow.style.setProperty('--mouse-x', touchX + '%');
                godRaysGlow.style.setProperty('--mouse-y', touchY + '%');
            }, { passive: true });

            sunshineText.addEventListener('touchmove', function(e) {
                // Update position as finger moves
                const touch = e.touches[0];
                const touchX = (touch.clientX / window.innerWidth) * 100;
                const touchY = (touch.clientY / window.innerHeight) * 100;
                godRaysGlow.style.setProperty('--mouse-x', touchX + '%');
                godRaysGlow.style.setProperty('--mouse-y', touchY + '%');
            }, { passive: true });

            sunshineText.addEventListener('touchend', function() {
                godRaysGlow.classList.remove('active');
            }, { passive: true });

            sunshineText.addEventListener('touchcancel', function() {
                godRaysGlow.classList.remove('active');
            }, { passive: true });
        }

        // ============================================
        // FIDGET SUN SPINNER
        // Drag to spin with momentum physics
        // ============================================
        const fidgetSun = document.getElementById('fidget-sun');
        const fidgetContainer = fidgetSun ? fidgetSun.parentElement : null;
        if (fidgetSun && fidgetContainer) {
            let rotation = 0;
            let velocity = 0;
            let isDragging = false;
            let lastAngle = 0;
            let lastTime = 0;
            let animationId = null;

            function getAngle(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                fidgetSun.classList.add('spinning');
                const rect = fidgetSun.getBoundingClientRect();
                lastAngle = getAngle(e, rect);
                lastTime = Date.now();
                velocity = 0;
                if (animationId) cancelAnimationFrame(animationId);
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                const rect = fidgetSun.getBoundingClientRect();
                const currentAngle = getAngle(e, rect);
                const now = Date.now();
                const dt = Math.max(now - lastTime, 1);

                let deltaAngle = currentAngle - lastAngle;
                // Handle angle wrap-around
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                rotation += deltaAngle * (180 / Math.PI);
                velocity = (deltaAngle * (180 / Math.PI)) / dt * 35; // Maximum momentum for fast flicks

                fidgetSun.style.transform = `rotate(${rotation}deg)`;
                lastAngle = currentAngle;
                lastTime = now;
            }

            function endDrag() {
                if (!isDragging) return;
                isDragging = false;
                fidgetSun.classList.remove('spinning');
                // Start momentum animation
                animateMomentum();
            }

            function animateMomentum() {
                if (Math.abs(velocity) < 0.005) {
                    velocity = 0;
                    return;
                }
                rotation += velocity;
                velocity *= 0.9995; // Ultra-low friction - precision bearings
                fidgetSun.style.transform = `rotate(${rotation}deg)`;
                animationId = requestAnimationFrame(animateMomentum);
            }

            // Mouse events - use container for larger hit area
            fidgetContainer.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // Touch events
            fidgetContainer.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);

            // Emoji burst on click/tap
            const emojis = FIDGET_SUN_EMOJIS; // Use shared emoji array (#51)
            let clickStartTime = 0;
            let clickStartPos = { x: 0, y: 0 };

            fidgetContainer.addEventListener('mousedown', (e) => {
                clickStartTime = Date.now();
                clickStartPos = { x: e.clientX, y: e.clientY };
            });

            fidgetContainer.addEventListener('mouseup', (e) => {
                const elapsed = Date.now() - clickStartTime;
                const moved = Math.sqrt(
                    Math.pow(e.clientX - clickStartPos.x, 2) +
                    Math.pow(e.clientY - clickStartPos.y, 2)
                );
                // Only burst if it was a quick click without much drag
                if (elapsed < 200 && moved < 10) {
                    burstEmojis(e);
                }
            });

            // Touch events for iPad/tablet - emoji burst on tap
            fidgetContainer.addEventListener('touchstart', (e) => {
                clickStartTime = Date.now();
                if (e.touches && e.touches.length > 0) {
                    clickStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            }, { passive: true });

            fidgetContainer.addEventListener('touchend', (e) => {
                const elapsed = Date.now() - clickStartTime;
                const endPos = e.changedTouches && e.changedTouches.length > 0
                    ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY }
                    : clickStartPos;
                const moved = Math.sqrt(
                    Math.pow(endPos.x - clickStartPos.x, 2) +
                    Math.pow(endPos.y - clickStartPos.y, 2)
                );
                // Only burst if it was a quick tap without much drag
                if (elapsed < 300 && moved < 30) {
                    burstEmojis({ clientX: endPos.x, clientY: endPos.y });
                }
            }, { passive: true });

            function burstEmojis(e) {
                const rect = fidgetSun.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                // Pick 3 random emoji types for this burst
                const shuffled = [...emojis].sort(() => Math.random() - 0.5);
                const selectedEmojis = shuffled.slice(0, 3);

                // Spawn 20 emojis using only the 3 selected types
                const burstCount = 20;
                for (let i = 0; i < burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = selectedEmojis[Math.floor(Math.random() * selectedEmojis.length)];
                    const size = 24 + Math.random() * 20;
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${size}px;
                        pointer-events: none;
                        z-index: 10000;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    // Random direction and velocity - bigger explosion
                    const angle = (Math.PI * 2 * i / burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 250 + Math.random() * 200;  // Faster
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 400;
                    const startTime = performance.now();
                    // Pre-calculate spin direction to avoid flicker
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 180 + Math.random() * 180;

                    function animateEmoji(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);  // Slower fade
                        const scale = 1 + t * 0.5;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmoji);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmoji);
                }
            }

            // Gentle idle spin (pauses when tab hidden to save battery)
            let idleRotation = 0;
            function idleSpin() {
                if (!pageIsVisible) return; // Pause when tab hidden
                if (!isDragging && Math.abs(velocity) < 0.1) {
                    idleRotation += 0.1;
                    fidgetSun.style.transform = `rotate(${rotation + idleRotation}deg)`;
                }
                requestAnimationFrame(idleSpin);
            }
            idleSpin();
            registerVisibilityAnimation(idleSpin);
        }

        // ============================================
        // SIDEBAR/FOOTER FIDGET SUN (for tablet/mobile)
        // Same physics as header version
        // ============================================
        const fidgetSunSidebar = document.getElementById('fidget-sun-sidebar');
        const fidgetSunFooter = document.getElementById('fidget-sun-footer');

        // Use whichever one exists (sidebar takes priority on mobile)
        const mobileFidgetSun = fidgetSunSidebar || fidgetSunFooter;
        const fidgetMobileContainer = mobileFidgetSun ? mobileFidgetSun.parentElement : null;
        if (mobileFidgetSun && fidgetMobileContainer) {
            let rotationF = 0;
            let velocityF = 0;
            let isDraggingF = false;
            let lastAngleF = 0;
            let lastTimeF = 0;
            let animationIdF = null;

            function getAngleF(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            function startDragF(e) {
                e.preventDefault();
                isDraggingF = true;
                mobileFidgetSun.classList.add('spinning');
                const rect = mobileFidgetSun.getBoundingClientRect();
                lastAngleF = getAngleF(e, rect);
                lastTimeF = Date.now();
                velocityF = 0;
                if (animationIdF) cancelAnimationFrame(animationIdF);
            }

            function dragF(e) {
                if (!isDraggingF) return;
                e.preventDefault();
                const rect = mobileFidgetSun.getBoundingClientRect();
                const currentAngle = getAngleF(e, rect);
                const now = Date.now();
                const dt = Math.max(now - lastTimeF, 1);

                let deltaAngle = currentAngle - lastAngleF;
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                rotationF += deltaAngle * (180 / Math.PI);
                velocityF = (deltaAngle * (180 / Math.PI)) / dt * 35;

                mobileFidgetSun.style.transform = `rotate(${rotationF}deg)`;
                lastAngleF = currentAngle;
                lastTimeF = now;
            }

            function endDragF() {
                if (!isDraggingF) return;
                isDraggingF = false;
                mobileFidgetSun.classList.remove('spinning');
                animateMomentumF();
            }

            function animateMomentumF() {
                if (Math.abs(velocityF) < 0.005) {
                    velocityF = 0;
                    return;
                }
                rotationF += velocityF;
                velocityF *= 0.9995;
                mobileFidgetSun.style.transform = `rotate(${rotationF}deg)`;
                animationIdF = requestAnimationFrame(animateMomentumF);
            }

            fidgetMobileContainer.addEventListener('mousedown', startDragF);
            document.addEventListener('mousemove', dragF);
            document.addEventListener('mouseup', endDragF);
            fidgetMobileContainer.addEventListener('touchstart', startDragF, { passive: false });
            document.addEventListener('touchmove', dragF, { passive: false });
            document.addEventListener('touchend', endDragF);

            // Emoji burst on tap/click for mobile
            const emojisF = FIDGET_SUN_EMOJIS; // Use shared emoji array (#51)
            let clickStartTimeF = 0;
            let clickStartPosF = { x: 0, y: 0 };
            let rotationAtStartF = 0;

            function getClientPos(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }

            // Mouse click detection for desktop/dev tools
            fidgetMobileContainer.addEventListener('mousedown', (e) => {
                clickStartTimeF = Date.now();
                rotationAtStartF = rotationF;
                const pos = getClientPos(e);
                clickStartPosF = { x: pos.x, y: pos.y };
            });

            fidgetMobileContainer.addEventListener('mouseup', (e) => {
                const elapsed = Date.now() - clickStartTimeF;
                const rotationDelta = Math.abs(rotationF - rotationAtStartF);
                const pos = getClientPos(e);
                const moved = Math.sqrt(
                    Math.pow(pos.x - clickStartPosF.x, 2) +
                    Math.pow(pos.y - clickStartPosF.y, 2)
                );
                // Trigger emoji if quick tap with minimal movement AND minimal rotation
                if (elapsed < 400 && moved < 50 && rotationDelta < 15) {
                    burstEmojisMobile(pos);
                }
            });

            // Touch detection for actual mobile devices
            fidgetMobileContainer.addEventListener('touchstart', (e) => {
                clickStartTimeF = Date.now();
                rotationAtStartF = rotationF;
                const pos = getClientPos(e);
                clickStartPosF = { x: pos.x, y: pos.y };
            }, { passive: true });

            fidgetMobileContainer.addEventListener('touchend', (e) => {
                const elapsed = Date.now() - clickStartTimeF;
                const rotationDelta = Math.abs(rotationF - rotationAtStartF);
                const endPos = e.changedTouches ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY } : clickStartPosF;
                const moved = Math.sqrt(
                    Math.pow(endPos.x - clickStartPosF.x, 2) +
                    Math.pow(endPos.y - clickStartPosF.y, 2)
                );
                // Trigger emoji if quick tap with minimal movement AND minimal rotation
                if (elapsed < 400 && moved < 80 && rotationDelta < 15) {
                    burstEmojisMobile(endPos);
                }
            }, { passive: true });

            function burstEmojisMobile(pos) {
                const rect = mobileFidgetSun.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const shuffled = [...emojisF].sort(() => Math.random() - 0.5);
                const burstEmojis = shuffled.slice(0, 3);
                const burstCount = 8 + Math.floor(Math.random() * 5);

                for (let i = 0; i < burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = burstEmojis[i % burstEmojis.length];
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${20 + Math.random() * 16}px;
                        pointer-events: none;
                        z-index: 10001;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    const angle = (Math.PI * 2 * i / burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 200 + Math.random() * 150;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 350;
                    const startTime = performance.now();
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 150 + Math.random() * 150;

                    function animateEmojiM(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);
                        const scale = 1 + t * 0.4;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmojiM);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmojiM);
                }
            }

            // Gentle idle spin for mobile (pauses when tab hidden to save battery)
            let idleRotationF = 0;
            function idleSpinF() {
                if (!pageIsVisible) return; // Pause when tab hidden
                if (!isDraggingF && Math.abs(velocityF) < 0.1) {
                    idleRotationF += 0.1;
                    mobileFidgetSun.style.transform = `rotate(${rotationF + idleRotationF}deg)`;
                }
                requestAnimationFrame(idleSpinF);
            }
            idleSpinF();
            registerVisibilityAnimation(idleSpinF);
        }

        // ============================================
        // COLD BEER FREEZE & SNOW EFFECT
        // ============================================
        const coldBeerElement = document.querySelector('.cold-beer');
        const freezeOverlay = document.getElementById('freeze-overlay');
        let snowflakes = [];
        let snowInterval = null;
        let isSnowing = false;

        // Use only text characters for snowflakes (no emoji) for consistent rendering
        const snowflakeChars = ['â„', 'â…', 'â†', 'âœ»', 'âœ¼'];

        function createSnowflake(fast = false) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.textContent = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)];
            snowflake.style.left = Math.random() * 100 + 'vw';

            // Bigger snowflakes with more size variation
            const size = 1.2 + Math.random() * 1.3;
            snowflake.style.fontSize = size + 'rem';

            // Random spin amount (some spin a lot, some barely)
            const spinDirection = Math.random() > 0.5 ? 1 : -1;
            const spinAmount = (180 + Math.random() * 540) * spinDirection;
            snowflake.style.setProperty('--spin', spinAmount + 'deg');

            // Random sway pattern (left-right movement)
            const swayBase = (Math.random() - 0.5) * 60;
            snowflake.style.setProperty('--sway1', (swayBase + (Math.random() - 0.5) * 30) + 'px');
            snowflake.style.setProperty('--sway2', (swayBase * -0.5 + (Math.random() - 0.5) * 40) + 'px');
            snowflake.style.setProperty('--sway3', (swayBase * 0.3 + (Math.random() - 0.5) * 35) + 'px');
            snowflake.style.setProperty('--sway4', (swayBase * -0.2 + (Math.random() - 0.5) * 25) + 'px');

            // Variable fall duration for natural continuous effect (avoids "wave" pattern)
            // Fast snowflakes (initial burst) fall quicker to fill the header area
            const duration = fast ? (2 + Math.random() * 4) : (5 + Math.random() * 12);
            const delay = fast ? 0 : (Math.random() * 0.3);
            snowflake.style.animation = `snowfall ${duration}s linear ${delay}s forwards`;

            document.body.appendChild(snowflake);
            snowflakes.push(snowflake);

            // Remove after animation completes (cleanup regardless of state)
            setTimeout(() => {
                if (snowflake.parentNode) {
                    snowflake.remove();
                }
                snowflakes = snowflakes.filter(s => s !== snowflake);
            }, (duration + delay) * 1000);
        }

        // Create a snowflake already partway through its fall (for pre-filling viewport)
        function createSnowflakeAtProgress(progress) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.textContent = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)];
            snowflake.style.left = Math.random() * 100 + 'vw';

            const size = 1.2 + Math.random() * 1.3;
            snowflake.style.fontSize = size + 'rem';

            const spinDirection = Math.random() > 0.5 ? 1 : -1;
            const spinAmount = (180 + Math.random() * 540) * spinDirection;
            snowflake.style.setProperty('--spin', spinAmount + 'deg');

            const swayBase = (Math.random() - 0.5) * 60;
            snowflake.style.setProperty('--sway1', (swayBase + (Math.random() - 0.5) * 30) + 'px');
            snowflake.style.setProperty('--sway2', (swayBase * -0.5 + (Math.random() - 0.5) * 40) + 'px');
            snowflake.style.setProperty('--sway3', (swayBase * 0.3 + (Math.random() - 0.5) * 35) + 'px');
            snowflake.style.setProperty('--sway4', (swayBase * -0.2 + (Math.random() - 0.5) * 25) + 'px');

            // Use negative delay to start animation partway through
            const duration = 5 + Math.random() * 12;
            const negativeDelay = -progress * duration; // Negative delay starts animation in progress
            snowflake.style.animation = `snowfall ${duration}s linear ${negativeDelay}s forwards`;

            document.body.appendChild(snowflake);
            snowflakes.push(snowflake);

            // Remaining time until animation completes
            const remainingTime = duration * (1 - progress);
            setTimeout(() => {
                if (snowflake.parentNode) snowflake.remove();
                snowflakes = snowflakes.filter(s => s !== snowflake);
            }, remainingTime * 1000);
        }

        // Track cleanup timeout to prevent animation conflicts
        let snowCleanupTimeout = null;

        function startSnow() {
            // Clear any pending cleanup to prevent conflicts
            if (snowCleanupTimeout) {
                clearTimeout(snowCleanupTimeout);
                snowCleanupTimeout = null;
            }

            // If already snowing, just ensure we're active
            if (isSnowing) return;

            // Clean up any leftover thawing snowflakes immediately
            snowflakes.forEach(flake => {
                if (flake.classList.contains('thawing')) {
                    if (flake.parentNode) flake.remove();
                }
            });
            snowflakes = snowflakes.filter(s => !s.classList.contains('thawing'));

            isSnowing = true;
            freezeOverlay.classList.add('active');

            // Create initial burst of FAST snowflakes from the top
            // Fast snowflakes (2-6s duration) fill the header area quickly
            for (let i = 0; i < 25; i++) {
                createSnowflake(true); // Fast snowflakes
            }

            // Start continuous creation - steady rate for natural snow effect
            // ~2 flakes every 40ms = 50 flakes/second
            snowInterval = setInterval(() => {
                if (isSnowing && snowflakes.length < 250) {
                    createSnowflake(); // Normal speed snowflakes
                    createSnowflake();
                }
            }, 40);
        }

        function stopSnow() {
            if (!isSnowing) return; // Prevent multiple stop calls

            isSnowing = false;
            freezeOverlay.classList.remove('active');

            // Stop creating new snowflakes immediately
            if (snowInterval) {
                clearInterval(snowInterval);
                snowInterval = null;
            }

            // Fade out existing snowflakes slowly (2.5s to match cold beer transition)
            snowflakes.forEach(flake => {
                flake.classList.add('thawing');
            });

            // Clean up after slow thaw completes
            snowCleanupTimeout = setTimeout(() => {
                // Only clean up thawing flakes (in case snow restarted)
                const thawingFlakes = snowflakes.filter(s => s.classList.contains('thawing'));
                thawingFlakes.forEach(flake => {
                    if (flake.parentNode) flake.remove();
                });
                snowflakes = snowflakes.filter(s => !s.classList.contains('thawing'));
                snowCleanupTimeout = null;
            }, 2600);
        }

        // Snow close button for mobile
        const snowCloseButton = document.getElementById('snow-close-button');
        let snowActivatedByTap = false;  // Track if snow was activated by tap (vs hold)

        function showSnowCloseButton() {
            if (snowCloseButton) {
                snowCloseButton.classList.add('visible');
            }
        }

        function hideSnowCloseButton() {
            if (snowCloseButton) {
                snowCloseButton.classList.remove('visible');
            }
        }

        if (snowCloseButton) {
            snowCloseButton.addEventListener('click', function() {
                snowActivatedByTap = false;
                stopSnow();
                hideSnowCloseButton();
            });
        }

        if (coldBeerElement) {
            // Check if device supports hover (has a pointer like mouse/trackpad)
            const hasHover = window.matchMedia('(hover: hover)').matches;

            if (hasHover) {
                // Desktop: use hover behavior (like sunshine effect)
                coldBeerElement.addEventListener('mouseenter', startSnow);
                coldBeerElement.addEventListener('mouseleave', stopSnow);
            }

            // Mobile: supports both tap-to-toggle AND touch-and-hold
            let touchStartTime = 0;
            let touchHoldThreshold = 300; // ms - holds longer than this are "hold" mode

            coldBeerElement.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                startSnow();
            }, { passive: true });

            coldBeerElement.addEventListener('touchend', function() {
                const touchDuration = Date.now() - touchStartTime;

                if (touchDuration < touchHoldThreshold) {
                    // Short tap - toggle mode, show close button
                    snowActivatedByTap = true;
                    showSnowCloseButton();
                    // Don't stop snow - let user close with button
                } else {
                    // Long hold - stop when released (like sunshine)
                    if (!snowActivatedByTap) {
                        stopSnow();
                    }
                }
            }, { passive: true });

            coldBeerElement.addEventListener('touchcancel', function() {
                if (!snowActivatedByTap) {
                    stopSnow();
                }
            }, { passive: true });
        }

        // ============================================
        // ACCELEROMETER WIND EFFECT FOR SNOWFLAKES
        // Tilt device to blow wind on snowflakes
        // ============================================
        let windOffset = 0;
        let targetWindOffset = 0;

        function handleDeviceOrientation(event) {
            if (!isSnowing || snowflakes.length === 0) return;

            // gamma is left-right tilt (-90 to 90)
            const tilt = event.gamma || 0;

            // Convert tilt to wind - balanced effect (not too subtle, not too extreme)
            const clampedTilt = Math.max(-50, Math.min(50, tilt));
            // Happy medium - noticeable and whimsical but not overwhelming
            targetWindOffset = clampedTilt * 4; // Up to ~200px drift at max tilt
        }

        // Smooth wind animation loop - applies drift to snowflakes
        function animateWind() {
            // Smooth interpolation for natural, responsive feel
            windOffset += (targetWindOffset - windOffset) * 0.15;

            if (isSnowing && snowflakes.length > 0) {
                snowflakes.forEach((flake) => {
                    if (!flake.classList.contains('melting') && !flake.classList.contains('thawing')) {
                        // Apply varying wind effect based on snowflake "weight" (size)
                        // Smaller flakes are lighter and drift more
                        const size = parseFloat(flake.style.fontSize) || 1.5;
                        const weightFactor = 2.5 - size * 0.6; // Range ~0.7 to ~1.9

                        // Calculate drift
                        const windEffect = windOffset * weightFactor;

                        // Store original left position (in vw) if not already stored
                        if (flake.dataset.originalLeft === undefined) {
                            flake.dataset.originalLeft = flake.style.left;
                        }

                        // Apply wind using calc() to combine vw base with px offset
                        flake.style.left = `calc(${flake.dataset.originalLeft} + ${windEffect}px)`;
                    }
                });
            }

            requestAnimationFrame(animateWind);
        }

        // Request permission for iOS 13+ devices
        function requestAccelerometerPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                DeviceOrientationEvent.requestPermission()
                    .then(permission => {
                        if (permission === 'granted') {
                            window.addEventListener('deviceorientation', handleDeviceOrientation);
                        }
                    })
                    .catch(console.error);
            } else {
                // Non-iOS or older iOS - just add listener
                window.addEventListener('deviceorientation', handleDeviceOrientation);
            }
        }

        // Start wind animation loop
        animateWind();

        // Request accelerometer on first touch of cold beer
        let accelerometerRequested = false;
        if (coldBeerElement) {
            coldBeerElement.addEventListener('touchstart', () => {
                if (!accelerometerRequested) {
                    accelerometerRequested = true;
                    requestAccelerometerPermission();
                }
            }, { once: false, passive: true });
        }

        // Also try to enable on page load for Android/non-iOS
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission !== 'function') {
            window.addEventListener('deviceorientation', handleDeviceOrientation);
        }

        // ============================================
        // COPY PROTECTION
        // Prevents copying of site content (except user input fields)
        // ============================================
        document.addEventListener('copy', function(e) {
            // Allow copying from input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            e.preventDefault();
        });

        document.addEventListener('cut', function(e) {
            // Allow cutting from input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            e.preventDefault();
        });

        // Prevent right-click context menu (optional additional protection)
        document.addEventListener('contextmenu', function(e) {
            // Allow context menu on input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            e.preventDefault();
        });

        // ============================================
        // MOBILE SCROLL INDICATOR
        // Floating button that scrolls up/down based on position
        // ============================================
        const scrollIndicator = document.getElementById('scroll-indicator');
        let scrollBounceInterval = null;
        let scrollUpdatePending = false;

        if (scrollIndicator) {
            // Update arrow direction and color based on scroll position
            // JS runs regardless of viewport - CSS handles visibility via display:none on desktop
            function updateScrollIndicator() {
                scrollUpdatePending = false;
                const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
                // Use documentElement for most accurate page height
                const docHeight = Math.max(
                    document.body.scrollHeight,
                    document.documentElement.scrollHeight,
                    document.body.offsetHeight,
                    document.documentElement.offsetHeight
                );
                const pageHeight = docHeight - window.innerHeight;
                const halfwayPoint = Math.max(pageHeight / 2, 100); // Minimum 100px to avoid edge cases

                // Update direction
                if (scrollY >= halfwayPoint && pageHeight > 0) {
                    scrollIndicator.classList.add('up');
                } else {
                    scrollIndicator.classList.remove('up');
                }

                // Check if button is over yellow background
                const buttonRect = scrollIndicator.getBoundingClientRect();
                const buttonCenterX = buttonRect.left + buttonRect.width / 2;
                const buttonCenterY = buttonRect.top + buttonRect.height / 2;

                // Check elements at button position for yellow backgrounds
                const elementsAtPoint = document.elementsFromPoint(buttonCenterX, buttonCenterY);
                let isOverYellow = false;

                for (const el of elementsAtPoint) {
                    if (el === scrollIndicator) continue;
                    // Check computed background color for yellow tones
                    const bgColor = window.getComputedStyle(el).backgroundColor;
                    if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
                        // Parse RGB values
                        const match = bgColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                        if (match) {
                            const r = parseInt(match[1]);
                            const g = parseInt(match[2]);
                            const b = parseInt(match[3]);
                            // Yellow is high R, high G, low B (like #f8e849 = 248, 232, 73)
                            if (r > 200 && g > 180 && b < 150) {
                                isOverYellow = true;
                                break;
                            }
                        }
                    }
                }

                if (isOverYellow) {
                    scrollIndicator.classList.add('over-yellow');
                } else {
                    scrollIndicator.classList.remove('over-yellow');
                }
            }

            // Throttled scroll update using requestAnimationFrame
            function requestScrollUpdate() {
                if (!scrollUpdatePending) {
                    scrollUpdatePending = true;
                    requestAnimationFrame(updateScrollIndicator);
                }
            }

            // Scroll handler - scroll up or down, also collapse map when expanded
            function handleScrollClick(e) {
                e.preventDefault();
                e.stopPropagation();

                // If map is expanded, collapse it and scroll down
                const mapEl = document.getElementById('map');
                if (mapEl && mapEl.classList.contains('map-expanded')) {
                    // Close any open popups first
                    if (window.map) {
                        window.map.closePopup();
                    }
                    // Collapse search if open
                    if (window.collapseSearch) {
                        window.collapseSearch();
                    }
                    // Remove expanded class
                    mapEl.classList.remove('map-expanded');
                    // Notify Leaflet of size change
                    setTimeout(() => {
                        if (window.map) window.map.invalidateSize({ animate: true });
                    }, 350);
                    // Scroll to route section after a short delay
                    setTimeout(() => {
                        const routeSection = document.querySelector('.route-toggle-section');
                        if (routeSection) {
                            const sectionTop = routeSection.getBoundingClientRect().top + (window.scrollY || window.pageYOffset || 0);
                            window.scrollTo({ top: sectionTop - 20, behavior: 'smooth' });
                        }
                    }, 100);
                    return;
                }

                const isUp = scrollIndicator.classList.contains('up');
                if (isUp) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // Scroll to "The Sunshine Trail Route" section
                    const routeSection = document.querySelector('.route-toggle-section');
                    if (routeSection) {
                        const sectionTop = routeSection.getBoundingClientRect().top + (window.scrollY || window.pageYOffset || 0);
                        window.scrollTo({ top: sectionTop - 20, behavior: 'smooth' });
                    }
                }
            }

            // Prevent touchstart from interfering
            scrollIndicator.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            }, { passive: true });

            // Add both click and touch events for reliable mobile interaction
            scrollIndicator.addEventListener('click', handleScrollClick);
            scrollIndicator.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleScrollClick(e);
            }, { passive: false });

            // Update on scroll - listen to multiple sources for cross-browser compatibility
            window.addEventListener('scroll', requestScrollUpdate, { passive: true });
            document.addEventListener('scroll', requestScrollUpdate, { passive: true });

            // Also update on touchmove for smoother mobile experience
            document.addEventListener('touchmove', requestScrollUpdate, { passive: true });

            // Initial state after short delay to ensure page is fully rendered
            setTimeout(updateScrollIndicator, 100);
            setTimeout(updateScrollIndicator, 500); // Second check after layout stabilizes

            // Periodic bounce animation to draw attention
            scrollBounceInterval = setInterval(() => {
                scrollIndicator.classList.add('bounce');
                setTimeout(() => {
                    scrollIndicator.classList.remove('bounce');
                }, 1200);
            }, 6000); // Bounce every 6 seconds (more frequent)
        }

        // ============================================
        // BEER SECTION IMAGE VIEWPORT ANIMATION (MOBILE)
        // Animate to hover state when fully visible
        // ============================================
        // Store observer reference for cleanup (Bug Fix #34)
        let beerImageObserver = null;
        if (Viewport.isMobile()) {
            const beerSectionImage = document.querySelector('.beer-section-image');
            if (beerSectionImage) {
                beerImageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && entry.intersectionRatio >= 0.9) {
                            beerSectionImage.classList.add('in-view');
                        } else {
                            beerSectionImage.classList.remove('in-view');
                        }
                    });
                }, {
                    threshold: [0.1, 0.9, 1.0],
                    rootMargin: '-10% 0px -10% 0px'
                });

                beerImageObserver.observe(beerSectionImage);
            }
        }

        // ============================================
        // CLEANUP ON PAGE UNLOAD
        // Prevents memory leaks from intervals and event listeners
        // ============================================
        window.addEventListener('beforeunload', function() {
            // Clear scroll bounce interval
            if (scrollBounceInterval) {
                clearInterval(scrollBounceInterval);
                scrollBounceInterval = null;
            }
            // Clear intervals
            if (tickerInterval) {
                clearInterval(tickerInterval);
                tickerInterval = null;
            }
            if (snowInterval) {
                clearInterval(snowInterval);
                snowInterval = null;
            }
            if (snowCleanupTimeout) {
                clearTimeout(snowCleanupTimeout);
                snowCleanupTimeout = null;
            }
            if (emailModalTimer) {
                clearTimeout(emailModalTimer);
                emailModalTimer = null;
            }

            // Clean up snowflakes
            snowflakes.forEach(flake => {
                if (flake.parentNode) flake.remove();
            });
            snowflakes = [];

            // Remove device orientation listener
            window.removeEventListener('deviceorientation', handleDeviceOrientation);

            // Disconnect IntersectionObserver (Bug Fix #34)
            if (beerImageObserver) {
                beerImageObserver.disconnect();
                beerImageObserver = null;
            }

            // Clean up metrics intervals
            pauseMetricsIntervals();
        });
    </script>
</body>
</html>
