<!DOCTYPE html>
<html lang="en" dir="ltr" style="color-scheme: light;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sunshine Trail | Lawson's Finest Liquids</title>
    <meta name="description" content="Explore Sunshine Spots from Waitsfield, VT to Asheville, NC. Interactive map of retailers, hiking trails, river put-ins, and community partners along the Appalachian corridor.">
    <meta name="theme-color" content="#ffffff">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: dark)">
    <meta name="color-scheme" content="light">
    <meta name="supported-color-schemes" content="light">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <link rel="apple-touch-icon" href="assets/images/favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <!-- Lawson's Finest Liquids Adobe Typekit Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/abz4zsp.css">
    <style>
        :root {
            /* Lawson's Finest brand colors - extracted from website */
            --sunshine-gold: #EAC054;      /* Primary gold from "Explore" text & Beer Finder button */
            --sunshine-orange: #E87722;    /* Orange from sun logo */
            --sunshine-red: #C13A28;       /* Red accent from sun logo */
            --deep-brown: #2d2a26;         /* Logo text color */
            --forest-green: #3A5F3A;       /* Trail marker - earthy green */
            --river-blue: #4A90A4;         /* River marker - mountain stream blue */
            --community-purple: #7B5B9A;   /* Community marker - softer purple */
            --cream: #FFFBF2;              /* Warm cream background */
            --light-gold: #FDF5E6;         /* Light gold for highlights */
            --amber: #FCB900;              /* Luminous amber from site */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Allow text selection in input fields */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        html {
            /* White background for Safari tab bar color sampling */
            background-color: #ffffff;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--light-gold);
            color: var(--deep-brown);
            display: flex;
            /* Prevent text selection and copying */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            flex-direction: column;
        }

        header {
            background: #ffffff;
            color: var(--deep-brown);
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e5e5;
            flex-shrink: 0;
            overflow: visible;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 2rem;
            overflow: visible;
        }

        /* Stack tagline under title when viewport is too narrow */
        @media (max-width: 1100px) and (min-width: 769px) {
            header {
                flex-wrap: nowrap;
            }

            .logo-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
                flex-shrink: 0;
            }

            .tagline {
                font-size: 1rem;
            }

            h1 {
                font-size: 2rem;
                white-space: nowrap;
                word-break: keep-all;
                overflow-wrap: normal;
            }
        }

        .header-trail-logo {
            height: 55px;
            width: auto;
        }

        .brand-logo-link {
            display: flex;
            align-items: center;
        }

        .header-brand-logo {
            height: 38px;
            width: auto;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .header-brand-logo:hover {
            opacity: 0.85;
        }

        /* Fidget Sun Spinner */
        .fidget-sun-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            margin: -40px;
            cursor: grab;
        }

        .fidget-sun {
            width: 80px;
            height: 80px;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.05s linear;
            pointer-events: none;
        }

        .fidget-sun-container:active {
            cursor: grabbing;
        }

        .fidget-sun.spinning {
            transition: none;
        }

        /* Footer fidget sun - hidden on desktop */
        .fidget-sun-footer {
            display: none;
        }

        /* Sidebar fidget sun - hidden on desktop */
        .fidget-sun-sidebar {
            display: none;
        }

        @media (max-width: 768px) {
            /* Hide header fidget sun on tablet/mobile */
            .fidget-sun-container {
                display: none;
            }

            /* Show sidebar fidget sun on tablet/mobile */
            .fidget-sun-sidebar {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 30px 40px;
                margin-top: 1rem;
                cursor: grab;
                touch-action: none;
            }

            .fidget-sun-sidebar .fidget-sun {
                width: 80px;
                height: 80px;
                pointer-events: auto !important;
                cursor: grab;
                user-select: none;
                -webkit-user-drag: none;
                touch-action: none;
            }

            .fidget-sun-sidebar:active {
                cursor: grabbing;
            }
        }

        /* Larger fidget sun on bigger phones (iPhone Pro Max, etc.) */
        @media (max-width: 768px) and (min-width: 390px) {
            .fidget-sun-sidebar .fidget-sun {
                width: 100px;
                height: 100px;
            }

            .fidget-sun-sidebar {
                padding: 35px 45px;
            }
        }


        .header-title-link {
            text-decoration: none;
            color: inherit;
            display: block;
            overflow: visible;
        }

        .header-title-link:hover {
            opacity: 1;
        }

        h1 {
            font-family: "new-spirit", serif;
            font-weight: 700;
            font-size: 3rem;
            letter-spacing: 0.5px;
            color: var(--deep-brown);
            overflow: visible;
        }

        h1 span {
            --mouse-x: 50%;
            --mouse-y: 50%;
            --glow-intensity: 0;
            --glow-left: 0px;
            --glow-top: 0px;
            --glow-width: 100px;
            --glow-height: 50px;
            color: #ffc72d;
            cursor: default;
            position: relative;
            z-index: 1;
            overflow: visible;
        }

        /* God rays glow overlay - full viewport coverage, no clipping */
        #god-rays-glow {
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 9999;
        }

        #god-rays-glow.active {
            opacity: 1;
        }

        #god-rays-glow .glow-radial {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                rgba(255, 245, 180, 0.75) 0%,
                rgba(255, 230, 120, 0.55) 5%,
                rgba(255, 210, 80, 0.4) 12%,
                rgba(255, 190, 50, 0.25) 20%,
                rgba(255, 170, 30, 0.12) 30%,
                rgba(255, 150, 0, 0.04) 45%,
                transparent 60%
            );
        }

        /* HDR/P3 enhanced colors for wide-gamut displays */
        @supports (color: color(display-p3 1 1 1)) {
            @media (color-gamut: p3) {
                #god-rays-glow .glow-radial {
                    background: radial-gradient(
                        circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                        color(display-p3 1 0.98 0.75 / 0.75) 0%,
                        color(display-p3 1 0.92 0.5 / 0.55) 5%,
                        color(display-p3 1 0.85 0.35 / 0.4) 12%,
                        color(display-p3 1 0.78 0.22 / 0.25) 20%,
                        color(display-p3 1 0.7 0.12 / 0.12) 30%,
                        color(display-p3 1 0.62 0 / 0.04) 45%,
                        transparent 60%
                    );
                }
            }
        }

        #god-rays-glow .glow-rays {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                repeating-conic-gradient(
                    from 0deg at var(--mouse-x, 50%) var(--mouse-y, 50%),
                    transparent 0deg,
                    rgba(255, 230, 100, 0.25) 2deg,
                    transparent 4deg,
                    transparent 15deg
                );
            filter: blur(4px);
        }

        /* HDR rays for P3 displays */
        @supports (color: color(display-p3 1 1 1)) {
            @media (color-gamut: p3) {
                #god-rays-glow .glow-rays {
                    background:
                        repeating-conic-gradient(
                            from 0deg at var(--mouse-x, 50%) var(--mouse-y, 50%),
                            transparent 0deg,
                            color(display-p3 1 0.92 0.45 / 0.25) 2deg,
                            transparent 4deg,
                            transparent 15deg
                        );
                }
            }
        }

        .tagline {
            font-family: 'new-spirit', serif;
            font-size: 1.25rem;
            color: #666;
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
        }

        .cold-beer {
            transition: color 2.5s ease-out, text-shadow 2.5s ease-out;
            cursor: pointer;
            position: relative;
        }

        .cold-beer:hover {
            transition: color 0.6s ease, text-shadow 0.6s ease;
            color: #7ec8e3;
            text-shadow:
                0 0 8px rgba(135, 206, 235, 0.8),
                0 0 15px rgba(173, 216, 230, 0.6);
        }

        /* Full-page freeze overlay */
        .freeze-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(
                180deg,
                rgba(200, 230, 255, 0.25) 0%,
                rgba(173, 216, 230, 0.15) 50%,
                rgba(135, 206, 250, 0.1) 100%
            );
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.8s ease-out;
            z-index: 9998;
        }

        .freeze-overlay.active {
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        /* Snowflake styles */
        .snowflake {
            position: fixed;
            top: -30px;
            color: #fff;
            font-size: 1.5rem;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            text-shadow: 0 0 8px rgba(200, 230, 255, 0.9), 0 0 15px rgba(173, 216, 230, 0.5);
            /* GPU acceleration for smooth mobile performance */
            will-change: transform, opacity;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        /* Snowfall animation - constant speed fall */
        @keyframes snowfall {
            0% {
                transform: translateY(-20px) rotate(0deg) translateX(0);
                opacity: 0.75;
            }
            25% {
                transform: translateY(calc(27.5vh)) rotate(calc(var(--spin) * 0.25)) translateX(var(--sway1));
            }
            50% {
                transform: translateY(calc(55vh)) rotate(calc(var(--spin) * 0.5)) translateX(var(--sway2));
            }
            75% {
                transform: translateY(calc(82.5vh)) rotate(calc(var(--spin) * 0.75)) translateX(var(--sway3));
            }
            100% {
                transform: translateY(110vh) rotate(var(--spin)) translateX(var(--sway4));
                opacity: 0.25;
            }
        }

        /* Snowflake melting animation for thaw */
        @keyframes snowMelt {
            0% {
                opacity: 0.9;
                transform: scale(1);
            }
            50% {
                opacity: 0.4;
                transform: scale(0.7) translateY(5px);
            }
            100% {
                opacity: 0;
                transform: scale(0.3) translateY(15px);
            }
        }

        .snowflake.melting {
            animation: snowMelt 2.5s ease-out forwards !important;
        }

        .snowflake.thawing {
            transition: opacity 2.5s ease-out;
            opacity: 0 !important;
            /* Disable animation and transform updates during thaw for smoother fade */
            animation-play-state: paused !important;
        }

        /* Mobile-specific optimizations for smoother thaw */
        @media (max-width: 768px) {
            .snowflake.thawing {
                transition: opacity 3s ease-out; /* Longer fade on mobile */
            }
        }

        /* Snow close button (mobile only) - matches popup close button style */
        .snow-close-button {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .snow-close-button.visible {
            display: block;
            opacity: 1;
        }

        .snow-close-button::before {
            content: '';
            display: block;
            width: 18px;
            height: 18px;
            background: url('assets/images/close.svg') no-repeat center center;
            background-size: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .snow-close-button:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .filter-icon {
            width: 36px;
            height: 36px;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        main {
            position: relative;
            flex: 1;
            min-height: 0;
        }

        .sidebar {
            position: absolute;
            top: 1.25rem;
            left: 1.25rem;
            bottom: 1.25rem;
            width: 420px;
            background: white;
            padding: 1.25rem;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 16px;
            z-index: 1000;
        }

        .sidebar h2 {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--deep-brown);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .intro-text {
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: #555;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section h3 {
            font-family: 'new-spirit', serif;
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 0.75rem;
            color: var(--deep-brown);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        /* Only apply hover on devices that support it (not touch scroll) */
        @media (hover: hover) {
            .filter-item:hover {
                background-color: var(--light-gold);
            }
        }

        .filter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--sunshine-gold);
        }

        .filter-item label {
            cursor: pointer;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }


        .count-badge {
            background: #ffc72d;
            padding: 0.25rem 0.6rem;
            border-radius: 8px;
            font-family: 'new-spirit', serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--deep-brown);
            min-width: 1.75rem;
            text-align: center;
        }

        .legend {
            background: #fffbf2;
            padding: 1rem;
            border-radius: 16px;
            margin-top: 1rem;
        }

        .legend h4 {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: var(--deep-brown);
        }

        .legend p {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--deep-brown);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        #map {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        /* Smooth Leaflet transitions */
        .leaflet-tile-container {
            transform: translateZ(0);
            will-change: transform;
        }

        .leaflet-zoom-anim .leaflet-zoom-animated {
            transition: transform 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .leaflet-pan-anim .leaflet-tile,
        .leaflet-pan-anim .leaflet-marker-pane {
            transition: transform 0.25s ease-out;
        }

        .leaflet-fade-anim .leaflet-popup {
            transition: opacity 0.2s ease-in-out;
        }

        /* Prevent marker icon distortion */
        .marker-icon {
            background: transparent !important;
        }

        /* Only apply hover effects on devices that support hover (not touch) */
        @media (hover: hover) and (pointer: fine) {
            .leaflet-marker-icon {
                transition: transform 0.15s ease-out, filter 0.15s ease-out;
                transform-origin: center bottom;
            }

            .leaflet-marker-icon:hover {
                transform: scale(1.1) translateY(-2px);
            }
        }

        /* Marker cluster styling */
        .marker-cluster {
            background: transparent;
        }

        .cluster-inner {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .cluster-brewery { background: #b45309; }
        .cluster-tastingroom { background: #dc2626; }
        .cluster-retailer { background: var(--sunshine-gold); color: var(--deep-brown); }
        .cluster-bar { background: #7c3aed; }
        .cluster-trail { background: var(--forest-green); }
        .cluster-river { background: var(--river-blue); }
        .cluster-community { background: var(--community-purple); }
        .cluster-charger { background: #22c55e; }

        /* Multi-category cluster pill - clear Leaflet defaults but allow pill background */
        .marker-cluster-pill {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Smooth fade-in for cluster pills at all zoom levels */
        .marker-cluster-pill > div {
            animation: clusterPillFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes clusterPillFadeIn {
            0% {
                opacity: 0;
            }
            40% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        /* Smooth transitions for cluster pills only */
        .marker-cluster-pill {
            transition: opacity 0.5s ease;
        }

        /* Custom Leaflet popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .leaflet-popup-close-button {
            width: 26px !important;
            height: 26px !important;
            top: 20px !important;
            right: 24px !important;
            color: transparent !important;
            overflow: hidden;
            opacity: 0.9;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            position: absolute !important;
            z-index: 1000 !important;
            background-color: rgba(255, 255, 255, 0.85) !important;
            border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-close-button::before {
            content: '';
            display: block;
            width: 14px;
            height: 14px;
            background: url('assets/images/close.svg') no-repeat center center;
            background-size: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .leaflet-popup-close-button:hover {
            opacity: 1;
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-family: 'Open Sans', sans-serif;
        }

        .popup-title {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--deep-brown);
            margin-bottom: 0.5rem;
        }

        .popup-category {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        /* Add top padding when category is first (no image above) */
        .popup-category:first-child {
            margin-top: 20px;
        }

        .popup-category.brewery { background: #b45309; color: white; }
        .popup-category.tastingroom { background: #dc2626; color: white; }
        .popup-category.retailer { background: var(--sunshine-gold); color: var(--deep-brown); }
        .popup-category.bar { background: #7c3aed; color: white; }
        .popup-category.trail { background: var(--forest-green); color: white; }
        .popup-category.river { background: var(--river-blue); color: white; }
        .popup-category.community { background: var(--community-purple); color: white; }
        .popup-category.charger { background: #22c55e; color: white; }

        .popup-content-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }

        .popup-description {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .popup-location {
            font-size: 0.8rem;
            color: #777;
        }

        .popup-location a {
            color: var(--sunshine-gold);
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        .popup-location a:hover {
            color: var(--sunshine-orange);
        }

        .popup-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--river-blue);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .popup-link:hover {
            text-decoration: underline;
        }

        .popup-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        .popup-impact {
            background: var(--light-gold);
            padding: 0.6rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-size: 0.8rem;
            line-height: 1.5;
            border-left: 3px solid var(--sunshine-gold);
        }

        .popup-impact-label {
            font-weight: 600;
            color: var(--deep-brown);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .popup-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .popup-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1.1rem 1.75rem;
            border-radius: 50px;
            font-family: "new-spirit", serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            text-align: center;
            flex: 1;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
        }

        .popup-btn-primary {
            background: #ffc72d;
            color: #1a1a1a !important;
            overflow: hidden;
            position: relative;
        }

        .popup-btn-secondary {
            background: var(--deep-brown);
            color: #ffffff !important;
            border: none;
            overflow: hidden;
            position: relative;
        }

        @keyframes letterWave {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-4px);
            }
        }

        .wave-text span {
            display: inline-block;
            animation: letterWave 0.4s ease-in-out;
            animation-fill-mode: both;
        }

        .zoom-hint.wave-text span {
            animation: letterWave 0.25s ease-in-out;
        }

        /* Custom marker styles */
        .leaflet-marker-icon {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Improve rendering of marker icons (some contain embedded PNGs) */
        .leaflet-marker-icon img,
        .marker-cluster-pill img {
            image-rendering: -webkit-optimize-contrast; /* Chrome, Safari */
            image-rendering: crisp-edges; /* Firefox */
            -ms-interpolation-mode: nearest-neighbor; /* IE */
            backface-visibility: hidden;
            transform: translateZ(0); /* Force GPU rendering */
        }

        /* Cluster pill icon wave animation - matches letter wave (bounce up) */
        @keyframes iconWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        /* Only animate icons inside cluster pills on hover, not individual markers */
        @media (hover: hover) {
            .marker-cluster-pill:hover img {
                animation: iconWave 0.4s ease-in-out;
                animation-fill-mode: both;
            }

            /* Right-to-left stagger: last icon animates first (like button text) */
            .marker-cluster-pill:hover img:nth-last-child(2) { animation-delay: 0s; }
            .marker-cluster-pill:hover img:nth-last-child(3) { animation-delay: 0.05s; }
            .marker-cluster-pill:hover img:nth-last-child(4) { animation-delay: 0.1s; }
            .marker-cluster-pill:hover img:nth-last-child(5) { animation-delay: 0.15s; }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            html, body {
                overflow-x: hidden;
                overflow-y: auto;
            }

            main {
                display: flex;
                flex-direction: column;
                height: auto;
                min-height: auto;
                overflow: visible;
            }

            .sidebar {
                position: relative;
                top: auto;
                left: auto;
                bottom: auto;
                width: 100%;
                padding: 1.5rem;
                order: 2;
                box-shadow: none;
                border-radius: 0;
                overflow-y: visible;
                height: auto;
                z-index: auto;
            }

            #map {
                position: relative;
                height: 65vh;
                min-height: 400px;
                max-height: 550px;
                order: 1;
                flex-shrink: 0;
                width: 100%;
            }

            header {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
            }

            .logo-section {
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
            }

            .tagline {
                font-size: 1rem;
                white-space: normal;
                text-align: center;
            }

            h1 {
                font-size: 1.8rem;
            }

            .header-trail-logo {
                height: 45px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .metric-item {
                margin: 0;
            }

            .metric-value {
                font-size: 1.4rem;
            }

            .metric-prefix {
                font-size: 0.95rem;
            }

            .metric-suffix {
                font-size: 0.8rem;
            }

            .metric-label {
                font-size: 0.75rem;
            }

            .bcorp-badge {
                padding: 1rem 1.5rem;
                max-width: 280px;
                margin: 0 auto;
            }

            .bcorp-badge img {
                height: auto;
                max-height: 120px;
            }

            .bottom-brand-logo {
                height: 45px;
            }

            /* Hide footer on mobile since logo will be in sidebar */
            .bottom-brand {
                display: none;
            }
        }

        /* Larger desktop screens */
        @media (min-width: 1400px) {
            .metric-value {
                font-size: 1.8rem;
            }

            h1 {
                font-size: 3.2rem;
            }

            .sidebar {
                width: 460px;
            }

            .zoom-hint {
                left: calc(490px + (100% - 490px) / 2);
            }
        }

        /* Very large screens */
        @media (min-width: 1800px) {
            .sidebar {
                width: 500px;
            }

            h1 {
                font-size: 3.5rem;
            }

            .zoom-hint {
                left: calc(530px + (100% - 530px) / 2);
            }
        }

        /* Desktop screens - use 1 column for metrics to fit decimal numbers */
        @media (min-width: 769px) {
            .metrics-grid {
                grid-template-columns: 1fr !important;
                gap: 0.4rem;
            }

            .metric-item {
                margin: 0;
                padding: 0.5rem;
            }
        }

        /* Zoom hint overlay - centered in visible map area */
        .zoom-hint {
            position: absolute;
            bottom: 100px;
            left: calc(450px + (100% - 450px) / 2);
            transform: translateX(-50%);
            background: rgba(45, 42, 38, 0.95);
            color: var(--cream);
            padding: 0.85rem 1.75rem;
            border-radius: 25px;
            font-family: 'new-spirit', serif;
            font-size: 1.2rem;
            font-weight: 700;
            z-index: 1000;
            pointer-events: auto;
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: breathingGlow 4s ease-in-out infinite;
        }

        @keyframes breathingGlow {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            30% {
                box-shadow: 0 0 25px rgba(234, 192, 84, 0.9), 0 0 50px rgba(234, 192, 84, 0.6), 0 0 80px rgba(234, 192, 84, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(234, 192, 84, 0.8), 0 0 45px rgba(234, 192, 84, 0.5), 0 0 70px rgba(234, 192, 84, 0.25);
            }
            70% {
                box-shadow: 0 0 15px rgba(234, 192, 84, 0.5), 0 0 30px rgba(234, 192, 84, 0.3), 0 0 50px rgba(234, 192, 84, 0.15);
            }
        }

        .zoom-hint:hover {
            /* Keep transform centered, no movement up */
            transform: translateX(-50%);
            /* Keep breathing glow animation - don't disable it */
        }

        .zoom-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Mobile zoom hint adjustments */
        @media (max-width: 768px) {
            .zoom-hint {
                left: 50%;
                bottom: 20px;
                font-size: 0.95rem;
                padding: 0.75rem 1.5rem;
                min-width: 200px;
                max-width: 85%;
                text-align: center;
                white-space: normal;
                line-height: 1.3;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Mobile: slower cluster pill fade */
        @media (max-width: 1200px) {
            .marker-cluster-pill > div {
                animation: clusterPillFadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            }
        }

        /* Style Leaflet zoom controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
            overflow: hidden;
        }

        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out {
            background: #ffc72d !important;
            color: var(--deep-brown) !important;
            font-weight: 700 !important;
            border: none !important;
            width: 48px !important;
            height: 48px !important;
            line-height: 48px !important;
            font-size: 26px !important;
        }

        .leaflet-control-zoom-in:hover,
        .leaflet-control-zoom-out:hover {
            background: #e6b328 !important;
        }

        .leaflet-control-zoom-in {
            border-radius: 10px 10px 0 0 !important;
        }

        .leaflet-control-zoom-out {
            border-radius: 0 0 10px 10px !important;
        }

        .leaflet-bottom.leaflet-right .leaflet-control-zoom {
            margin-bottom: 30px;
            margin-right: 15px;
        }

        /* Map Search Control - aligned with Leaflet zoom controls */
        .map-search-control {
            position: absolute;
            bottom: 150px;
            right: 0;
            z-index: 1000;
            pointer-events: none;
        }

        .map-search-btn {
            width: 48px;
            height: 48px;
            background: #f8e849;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background 0.2s ease;
        }

        .map-search-btn:hover {
            background: #e6d63e;
        }

        .map-search-btn svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: var(--deep-brown);
            stroke-width: 2px;
        }

        .map-search-container {
            position: absolute;
            right: 15px;
            bottom: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }

        .map-search-input {
            width: 0;
            padding: 0;
            border: none;
            border-radius: 10px;
            background: white;
            font-family: 'new-spirit', serif;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            outline: none;
        }

        .map-search-input.expanded {
            width: 320px;
            padding: 12px 16px;
            opacity: 1;
        }

        .map-search-input::placeholder {
            color: #999;
        }

        .map-search-results {
            position: absolute;
            bottom: 60px; /* Float above the input */
            right: 71px; /* Position above input: 15px (container right) + 48px (button) + 8px (gap) */
            width: 320px; /* Same width as expanded input */
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: none;
            z-index: 1002;
            pointer-events: auto;
        }

        .map-search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #fff9e6;
        }

        .search-result-name {
            font-family: 'new-spirit', serif;
            font-weight: 600;
            color: var(--deep-brown);
            font-size: 0.95rem;
        }

        .search-result-location {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .search-result-category {
            display: inline-block;
            font-size: 0.7rem;
            background: #ffc72d;
            color: var(--deep-brown);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 4px;
            text-transform: capitalize;
        }

        .search-no-results {
            padding: 16px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .map-search-control {
                bottom: 140px;
                right: 15px; /* Align with Leaflet zoom controls */
            }

            .map-search-container {
                right: 0;
            }

            .map-search-btn {
                width: 48px; /* Match Leaflet zoom button width */
                height: 48px; /* Match Leaflet zoom button height */
                background: #f8e849;
            }

            .map-search-btn svg {
                width: 22px;
                height: 22px;
            }

            .map-search-input.expanded {
                width: 260px;
                padding: 10px 14px;
                font-size: 0.9rem;
            }

            .map-search-results {
                width: 260px; /* Match mobile input width */
                bottom: 56px; /* Account for larger button */
                right: 56px; /* 48px button + 8px gap (no extra right margin on mobile) */
            }
        }

        /* Extra narrow mobile viewports */
        @media (max-width: 420px) {
            .map-search-control {
                right: 15px; /* Keep aligned with zoom controls */
            }

            .map-search-input.expanded {
                width: calc(100vw - 90px);
                min-width: 220px;
            }

            .map-search-results {
                width: calc(100vw - 90px); /* Match input width on narrow screens */
                min-width: 220px;
                right: 56px; /* Position above input */
            }
        }

        /* Sidebar brand section */
        .sidebar-brand {
            padding: 2rem 0;
            text-align: center;
            margin-top: 1.5rem;
            border-top: 1px solid #e5e5e5;
            animation: fadeInUp 0.6s ease-out 0.9s both;
        }

        .sidebar-brand-link {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .sidebar-brand-link:hover {
            opacity: 0.85;
            transform: translateY(-2px);
        }

        .sidebar-brand-logo {
            height: 60px;
            width: auto;
        }

        .sidebar-brand-cta {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--deep-brown);
            opacity: 0.7;
        }

        /* Bottom brand section (desktop footer) */
        .bottom-brand {
            padding: 3rem 2rem;
            text-align: center;
            background: transparent;
            display: none; /* Hidden by default, sidebar-brand is preferred */
        }

        .bottom-brand-link {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            transition: opacity 0.3s ease;
        }

        .bottom-brand-link:hover {
            opacity: 0.8;
        }

        .bottom-brand-logo {
            height: 70px;
            width: auto;
        }

        .bottom-brand-cta {
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            color: var(--deep-brown);
            opacity: 0.7;
        }

        .demo-disclaimer {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.75rem;
            color: var(--deep-brown);
            opacity: 0.5;
            margin: 1.5rem auto 0.5rem;
            max-width: 300px;
            line-height: 1.4;
        }

        .demo-copyright {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.7rem;
            color: var(--deep-brown);
            opacity: 0.4;
            margin: 0;
        }

        /* Have a Sip Section */
        .beer-section {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 16px;
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1rem;
            animation: fadeInUp 0.6s ease-out 0.8s both;
        }

        .beer-section-image {
            flex: 0 0 auto;
            max-width: 340px;
            cursor: pointer;
            display: block;
        }

        .beer-section-image img {
            max-width: 100%;
            height: auto;
            transition: transform 0.3s ease;
        }

        .beer-section-image:hover img {
            transform: scale(1.05);
        }

        .beer-section-content {
            flex: 1;
        }

        .beer-section-content h3 {
            font-family: "new-spirit", serif;
            font-weight: 700;
            font-size: 1.75rem;
            color: var(--deep-brown);
            margin-bottom: 0.5rem;
        }

        .beer-section-content p {
            font-family: 'Open Sans', sans-serif;
            font-size: 1.05rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .beer-section-btn {
            display: inline-block;
            padding: 1.25rem 3rem;
            background: #ffc72d;
            color: #1a1a1a;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.25rem;
            border-radius: 50px;
            text-decoration: none;
            border: none;
        }


        @media (max-width: 768px) {
            .beer-section {
                padding: 1.25rem;
            }

            .beer-section-image {
                max-width: 280px;
            }

            .beer-section-content h3 {
                font-size: 1.3rem;
            }
        }

        /* Page Load Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Apply animations */
        header {
            animation: fadeInDown 0.6s ease-out;
        }

        .sidebar {
            animation: fadeInLeft 0.6s ease-out 0.2s both;
        }

        .intro-text {
            animation: fadeIn 0.8s ease-out 0.4s both;
        }

        .filter-section {
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }

        .filter-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Only apply hover on devices that support it (not touch scroll) */
        @media (hover: hover) {
            .filter-item:hover {
                transform: translateX(5px);
                background-color: var(--light-gold);
            }
        }

        .filter-item:active {
            transform: translateX(2px) scale(0.98);
        }

        .legend {
            animation: fadeInUp 0.6s ease-out 0.7s both;
        }

        #map {
            animation: fadeIn 1s ease-out 0.3s both;
        }

        footer {
            animation: fadeInUp 0.5s ease-out 0.8s both;
        }

        /* Filter checkbox animation */
        .filter-item input[type="checkbox"] {
            transition: transform 0.2s ease;
        }

        .filter-item input[type="checkbox"]:checked {
            animation: pulse 0.3s ease;
        }

        /* Count badge animation */
        .count-badge {
            transition: all 0.3s ease;
        }

        @media (hover: hover) {
            .filter-item:hover .count-badge {
                background: #ffc72d;
                transform: scale(1.1);
            }
        }

        /* Button hover effects */
        .popup-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .popup-btn:active {
            transform: translateY(0);
        }

        /* Logo hover effect - disabled */
        .header-trail-logo {
            transition: none;
        }

        .header-trail-logo:hover {
            transform: none;
        }

        /* Shimmer effect for loading state */
        .loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* State Filter Buttons */
        .state-filter-section {
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.6s ease-out 0.6s both;
        }

        .state-filter-section h3 {
            font-family: 'new-spirit', serif;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--deep-brown);
        }

        .state-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .state-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ffc72d;
            background: #FFFDF7;
            color: var(--deep-brown);
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        /* No fill/shadow/raise on hover - only wave animation */
        .state-btn:hover {
            /* Wave animation applied via JS - no visual changes here */
        }

        .state-btn:active {
            /* Subtle feedback on click only */
            opacity: 0.9;
        }

        .state-btn.active {
            background: #ffc72d;
            color: var(--deep-brown);
        }

        /* Live Metrics Section - Styled like Lawson's website */
        .metrics-section {
            background: #f7e949;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out 0.65s both;
            box-shadow: 0 4px 20px rgba(234, 192, 84, 0.3);
        }

        .metrics-section-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(45, 42, 38, 0.15);
        }

        .metrics-section-header h3 {
            font-family: 'new-spirit', serif;
            font-weight: 900;
            font-size: 1.75rem;
            color: var(--deep-brown);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 0 0 0.5rem 0;
        }

        .metrics-tagline {
            font-family: 'Open Sans', sans-serif;
            font-weight: 400;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--deep-brown);
            opacity: 0.85;
            margin: 0;
            line-height: 1.4;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        /* Mobile override for metrics grid - must come after base styles */
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr !important;
            }
        }

        .metric-item {
            text-align: center;
            padding: 0.75rem 0.5rem;
            background: #ffc72d;
            border-radius: 12px;
        }

        .metric-value {
            font-family: 'new-spirit', serif;
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--deep-brown);
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 2px;
        }

        .metric-prefix {
            font-size: 1rem;
        }

        .metric-suffix {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .metric-label {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.7rem;
            color: var(--deep-brown);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            opacity: 0.85;
        }

        .metric-link {
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-link:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .metric-number {
            display: inline-block;
            min-width: 1ch;
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .metric-value.counting .metric-number {
            animation: countUp 0.1s ease-out;
        }

        /* Wave animation for metric numbers */
        .metric-number.wave span {
            display: inline-block;
            animation: letterWave 0.4s ease-in-out;
            animation-fill-mode: both;
        }

        /* Pulse dot for "live" indicator */
        .live-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: livePulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes livePulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
            }
        }

        /* BCorp Section */
        .bcorp-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid rgba(45, 42, 38, 0.15);
        }

        /* Ensure equal spacing above metrics grid and below to bcorp */
        .metrics-grid {
            margin-bottom: 0;
        }

        .bcorp-badge {
            display: block;
            background: white;
            border-radius: 12px;
            padding: 1rem 2.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .bcorp-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .bcorp-badge img {
            width: 100%;
            height: auto;
        }

        /* Scenic Route Toggle */
        .route-toggle-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
            animation: fadeInUp 0.6s ease-out 0.55s both;
        }

        .route-toggle-section h3 {
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.05rem;
            margin-bottom: 0.5rem;
            color: var(--deep-brown);
        }

        .route-info {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .route-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .route-toggle:hover {
            background-color: var(--light-gold);
        }

        .route-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--sunshine-gold);
            flex-shrink: 0;
        }

        /* Hide checkbox when loading, show spinner in its place */
        .route-toggle.loading input[type="checkbox"] {
            display: none;
        }

        .route-toggle label {
            cursor: pointer;
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            color: var(--deep-brown);
        }

        /* Route spinner - replaces checkbox when loading */
        .route-toggle .route-spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gold);
            border-top-color: var(--sunshine-gold);
            border-radius: 50%;
            animation: routeSpinner 0.6s linear infinite;
            flex-shrink: 0;
            order: -1; /* Place before label (where checkbox was) */
        }

        .route-toggle.loading .route-spinner {
            display: block;
        }

        @keyframes routeSpinner {
            to { transform: rotate(360deg); }
        }

        /* Route Legend */
        .route-legend {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #fffbf2;
            border-radius: 16px;
        }

        .get-itinerary-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        .get-itinerary-btn {
            display: inline-block;
            padding: 1rem 2.5rem;
            background: #ffc72d;
            border: none;
            border-radius: 50px;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1a1a1a;
            cursor: pointer;
            text-align: center;
        }

        .route-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .route-line {
            width: 24px;
            height: 4px;
            border-radius: 2px;
        }

        .route-line.blue-ridge {
            background: linear-gradient(90deg, #2E86AB, #4ECDC4);
        }

        .route-line.skyline {
            background: linear-gradient(90deg, #7B68EE, #9370DB);
        }

        .route-line.route-100 {
            background: linear-gradient(90deg, #228B22, #32CD32);
        }

        .route-line.connector {
            background: #888;
            border-style: dashed;
        }

        /* Hide Leaflet attribution */
        .leaflet-control-attribution {
            display: none !important;
        }

        /* Email Signup Modal */
        .email-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .email-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .email-modal {
            background: #f7e949;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .email-modal-overlay.visible .email-modal {
            transform: scale(1) translateY(0);
        }

        .email-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--deep-brown);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            line-height: 1;
        }

        .email-modal-close:hover {
            opacity: 1;
        }

        .email-modal-sun {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            touch-action: none;
        }

        .fidget-sun-modal {
            width: 80px;
            height: 80px;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.05s linear;
        }

        .fidget-sun-modal.spinning {
            transition: none;
        }

        .email-modal-sun:active {
            cursor: grabbing;
        }

        .email-modal h2 {
            font-family: 'new-spirit', serif;
            font-weight: 800;
            font-size: 1.75rem;
            color: var(--deep-brown);
            margin-bottom: 0.75rem;
        }

        .email-modal p {
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            color: var(--deep-brown);
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .email-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .email-input {
            padding: 1rem 1.25rem;
            font-size: 1rem;
            border: none;
            border-radius: 50px;
            font-family: 'Open Sans', sans-serif;
            transition: box-shadow 0.2s;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .email-input:focus {
            outline: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        .email-input::placeholder {
            color: #999;
        }

        .email-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--deep-brown);
            cursor: pointer;
        }

        .email-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--deep-brown);
        }

        .location-field {
            position: relative;
            animation: fadeInDown 0.3s ease-out;
            margin-top: 0.75rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .location-input {
            background: #ffffff !important;
        }

        .location-input.detecting {
            background: linear-gradient(90deg, #ffffff 0%, #f0f8ff 50%, #ffffff 100%) !important;
            background-size: 200% 100% !important;
            animation: locationShimmer 1.5s ease-in-out infinite !important;
        }

        @keyframes locationShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .email-submit {
            padding: 1.1rem 2rem;
            background: #ffc72d;
            color: var(--deep-brown);
            border: none;
            border-radius: 50px;
            font-family: 'new-spirit', serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        /* Ripple effect for submit button */
        .email-submit::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .email-submit:active::after {
            width: 300px;
            height: 300px;
        }

        .email-disclaimer {
            font-size: 0.8rem !important;
            color: var(--deep-brown) !important;
            opacity: 0.7;
            margin-bottom: 0 !important;
            margin-top: 1rem !important;
        }

        @media (max-width: 768px) {
            .email-modal {
                padding: 2rem 1.5rem;
                margin: 1rem;
            }

            .email-modal h2 {
                font-size: 1.4rem;
            }

            .email-modal p {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Freeze overlay for cold beer hover effect -->
    <div class="freeze-overlay" id="freeze-overlay"></div>
    <button class="snow-close-button" id="snow-close-button" aria-label="Stop snow effect"></button>

    <!-- God rays glow overlay - fixed position, highest z-index -->
    <div id="god-rays-glow">
        <div class="glow-radial"></div>
        <div class="glow-rays"></div>
    </div>

    <header>
        <div class="logo-section">
            <a href="./" class="header-title-link">
                <h1>The <span>Sunshine</span> Trail</h1>
            </a>
            <p class="tagline">Mountain communities. Outdoor adventures. <span class="cold-beer">Cold beer.</span></p>
        </div>
        <div class="fidget-sun-container">
            <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun" id="fidget-sun" draggable="false">
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <p class="intro-text">
                Explore the <strong>Sunshine Spots</strong> from Waitsfield, Vermont to Asheville, North Carolina.
                Discover retailers, hiking trails, river put-ins, and the community organizations we support along the way.
            </p>

            <div class="metrics-section">
                <div class="metrics-section-header">
                    <h3><span class="live-dot"></span> Live Impact</h3>
                    <p class="metrics-tagline">We pour a little good back into every community we call home.</p>
                </div>
                <div class="metrics-grid">
                    <a href="https://www.lawsonsfinest.com/sip/sunshine-fund/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value" id="metric-donated">
                            <span class="metric-prefix">$</span>
                            <span class="metric-number" id="donations-counter">0</span>
                        </div>
                        <div class="metric-label">Dollars Raised</div>
                    </a>
                    <a href="https://www.lawsonsfinest.com/sip/green-is-grand/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value" id="metric-solar">
                            <span class="metric-number" id="solar-counter">0</span>
                            <span class="metric-suffix">kWh</span>
                        </div>
                        <div class="metric-label">Solar Generated</div>
                    </a>
                    <a href="https://www.bcorporation.net/en-us/find-a-b-corp/company/lawsons-finest-liquids/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value" id="metric-bcorp">
                            <span class="metric-number">83.6</span>
                        </div>
                        <div class="metric-label">B Impact Score</div>
                    </a>
                    <a href="https://www.lawsonsfinest.com/sip/" target="_blank" rel="noopener noreferrer" class="metric-item metric-link">
                        <div class="metric-value" id="metric-nonprofits">
                            <span class="metric-number">496</span>
                        </div>
                        <div class="metric-label">Nonprofits</div>
                    </a>
                </div>
                <div class="bcorp-section">
                    <a href="https://www.bcorporation.net/en-us/find-a-b-corp/company/lawsons-finest-liquids/" target="_blank" rel="noopener noreferrer" class="bcorp-badge" title="Certified B Corporation">
                        <img src="assets/images/b-corp-logo.png" alt="Certified B Corporation">
                    </a>
                </div>
            </div>

            <div class="route-toggle-section">
                <h3>The Sunshine Trail Route</h3>
                <p class="route-info">The ultimate road trip from Asheville, NC to Waitsfield, VT via America's most scenic mountain roads.</p>
                <div class="route-toggle" id="route-toggle-container">
                    <input type="checkbox" id="toggle-scenic-route">
                    <label for="toggle-scenic-route">Show Route on Map</label>
                    <span class="route-spinner"></span>
                </div>

                <div class="route-legend" id="route-legend" style="display: none;">
                    <div class="route-legend-item">
                        <span class="route-line blue-ridge"></span>
                        <span>Blue Ridge Parkway (469 mi)</span>
                    </div>
                    <div class="route-legend-item">
                        <span class="route-line skyline"></span>
                        <span>Skyline Drive (105 mi)</span>
                    </div>
                    <div class="route-legend-item">
                        <span class="route-line connector"></span>
                        <span>I-81 / US-7 Connector</span>
                    </div>
                    <div class="route-legend-item">
                        <span class="route-line route-100"></span>
                        <span>VT Route 100 (217 mi)</span>
                    </div>
                    <div class="get-itinerary-btn-container">
                        <button class="get-itinerary-btn" id="get-itinerary-btn">Get Itinerary</button>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Filter by Category</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <input type="checkbox" id="filter-breweries" checked>
                        <label for="filter-breweries">
                            <img src="assets/images/marker-brewery.svg" alt="" class="filter-icon">
                            Breweries
                            <span class="count-badge" id="count-breweries">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-tastingrooms" checked>
                        <label for="filter-tastingrooms">
                            <img src="assets/images/marker-tastingroom.svg" alt="" class="filter-icon">
                            Tasting Rooms
                            <span class="count-badge" id="count-tastingrooms">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-retailers" checked>
                        <label for="filter-retailers">
                            <img src="assets/images/marker-retailer.svg" alt="" class="filter-icon">
                            Retailers
                            <span class="count-badge" id="count-retailers">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-bars" checked>
                        <label for="filter-bars">
                            <img src="assets/images/marker-bar.svg" alt="" class="filter-icon">
                            Bars & Restaurants
                            <span class="count-badge" id="count-bars">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-trails" checked>
                        <label for="filter-trails">
                            <img src="assets/images/marker-trail.svg?v=2" alt="" class="filter-icon">
                            Trails
                            <span class="count-badge" id="count-trails">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-rivers" checked>
                        <label for="filter-rivers">
                            <img src="assets/images/marker-river.svg?v=2" alt="" class="filter-icon">
                            River Put-ins
                            <span class="count-badge" id="count-rivers">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-community" checked>
                        <label for="filter-community">
                            <img src="assets/images/marker-community.svg" alt="" class="filter-icon">
                            Community Partners
                            <span class="count-badge" id="count-community">0</span>
                        </label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-chargers">
                        <label for="filter-chargers">
                            <img src="assets/images/marker-charger.svg" alt="" class="filter-icon">
                            DC Fast Chargers
                            <span class="count-badge" id="count-chargers">0</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="state-filter-section">
                <h3>Filter by State</h3>
                <div class="state-buttons">
                    <button class="state-btn all-states active" data-state="all">All States</button>
                    <button class="state-btn" data-state="VT">VT</button>
                    <button class="state-btn" data-state="NH">NH</button>
                    <button class="state-btn" data-state="ME">ME</button>
                    <button class="state-btn" data-state="MA">MA</button>
                    <button class="state-btn" data-state="RI">RI</button>
                    <button class="state-btn" data-state="CT">CT</button>
                    <button class="state-btn" data-state="NY">NY</button>
                    <button class="state-btn" data-state="NJ">NJ</button>
                    <button class="state-btn" data-state="PA">PA</button>
                    <button class="state-btn" data-state="VA">VA</button>
                    <button class="state-btn" data-state="NC">NC</button>
                </div>
            </div>

            <div class="beer-section">
                <a href="https://www.lawsonsfinest.com/beer/" target="_blank" rel="noopener noreferrer" class="beer-section-image">
                    <img src="assets/images/beer-cans.png" alt="Lawson's Finest Liquids beers - Hop Wired, Sip of Sunshine, Little Sip">
                </a>
                <div class="beer-section-content">
                    <h3>Have a Sip!</h3>
                    <p>Learn more about our finest and freshest signature liquids, limited releases, and taproom regulars.</p>
                    <a href="https://www.lawsonsfinest.com/beer/" target="_blank" rel="noopener noreferrer" class="beer-section-btn">Our Beers</a>
                </div>
            </div>

            <div class="legend">
                <h4>About This Trail</h4>
                <p>
                    The Sunshine Trail celebrates the shared culture of mountain communities along the East Coast -
                    from the Green Mountains of Vermont to the Blue Ridge of North Carolina.
                    Every spot on this map represents our commitment to quality, community, and the great outdoors.
                </p>
            </div>

            <div class="sidebar-brand">
                <a href="https://www.lawsonsfinest.com" target="_blank" rel="noopener noreferrer" class="sidebar-brand-link">
                    <img src="assets/images/lawsons-logo.svg" alt="Lawson's Finest Liquids" class="sidebar-brand-logo">
                    <span class="sidebar-brand-cta">Visit lawsonsfinest.com</span>
                </a>
                <p class="demo-disclaimer">This is a demonstration project and is not operated by or affiliated with Lawson's Finest Liquids.</p>
                <p class="demo-copyright">&copy; 2026 Ames Consulting LLC. All rights reserved.</p>
                <div class="fidget-sun-sidebar">
                    <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun" id="fidget-sun-sidebar" draggable="false">
                </div>
            </div>
        </aside>

        <div id="map" role="application" aria-label="Interactive map of Sunshine Trail locations from Vermont to North Carolina">
            <div class="zoom-hint" id="zoom-hint" title="Click to find Sunshine Spots near you">
                <span>Zoom for detail</span>
            </div>
            <!-- Map Search Control -->
            <div class="map-search-control" id="map-search-control">
                <div class="map-search-results" id="map-search-results"></div>
                <div class="map-search-container">
                    <input type="text" class="map-search-input" id="map-search-input" placeholder="Search places or listings...">
                    <button class="map-search-btn" id="map-search-btn" title="Search map">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="6" fill="none"/>
                            <line x1="14.5" y1="14.5" x2="20" y2="20"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Email Signup Modal -->
    <div class="email-modal-overlay" id="email-modal">
        <div class="email-modal">
            <button class="email-modal-close" id="email-modal-close" aria-label="Close">&times;</button>
            <div class="email-modal-sun">
                <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun-modal" id="fidget-sun-modal" draggable="false">
            </div>
            <h2>Get Your Free Road Trip Guide</h2>
            <p>Join the Lawson's newsletter to receive a detailed Sunshine Trail road trip plan with recommended stops, local tips, and exclusive brewery news.</p>
            <form class="email-form" id="email-form">
                <input type="text" placeholder="Your Name" required class="email-input" id="name-input">
                <input type="email" placeholder="Your Email" required class="email-input" id="email-input">
                <label class="email-checkbox">
                    <input type="checkbox" id="local-checkbox">
                    <span>Send me info about local happenings</span>
                </label>
                <div class="location-field" id="location-field" style="display: none;">
                    <input type="text" placeholder="Detecting your location..." class="email-input location-input" id="location-input">
                </div>
                <button type="submit" class="email-submit">Send My Itinerary</button>
            </form>
            <p class="email-disclaimer">By signing up, you'll join the Lawson's Finest newsletter. Unsubscribe anytime.</p>
        </div>
    </div>

    <footer class="bottom-brand">
        <a href="https://www.lawsonsfinest.com" target="_blank" rel="noopener noreferrer" class="bottom-brand-link">
            <img src="assets/images/lawsons-logo.svg" alt="Lawson's Finest Liquids" class="bottom-brand-logo">
            <span class="bottom-brand-cta">Visit lawsonsfinest.com</span>
        </a>
        <p class="demo-disclaimer">This is a demonstration project and is not operated by or affiliated with Lawson's Finest Liquids.</p>
        <p class="demo-copyright">&copy; 2026 Ames Consulting LLC. All rights reserved.</p>
        <div class="fidget-sun-footer">
            <img src="assets/images/fidget-sun.png" alt="Spin me!" class="fidget-sun" id="fidget-sun-footer" draggable="false">
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin="anonymous"></script>
    <script>
        // Initialize the map with smooth scrolling and animations
        const map = L.map('map', {
            center: [39.5, -77.5],
            zoom: 6,
            zoomControl: false,  // We'll add it manually to bottom-right
            scrollWheelZoom: true,
            zoomSnap: 0.1,              // Allow finer zoom levels
            zoomDelta: 0.25,            // Smaller zoom steps for smoother feel
            wheelPxPerZoomLevel: 100,   // More wheel movement per zoom level
            wheelDebounceTime: 40,      // Responsive wheel zoom
            zoomAnimation: true,
            fadeAnimation: true,
            markerZoomAnimation: true,
            inertia: true,
            inertiaDeceleration: 2000,  // Smooth deceleration
            inertiaMaxSpeed: 2000,
            easeLinearity: 0.2,         // Smoother easing
            tap: true,
            touchZoom: true,
            doubleClickZoom: true,
            boxZoom: true
        });

        // Add a styled tile layer with smooth transitions
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19,
            updateWhenZooming: false,
            updateWhenIdle: true,
            keepBuffer: 4
        }).addTo(map);

        // Handle window resize
        // If user has zoomed: preserve their current view
        // If user hasn't zoomed: recenter to fit all markers in safe area
        let resizeTimeout;
        let lastBounds = null;

        window.addEventListener('resize', function() {
            if (!lastBounds) {
                lastBounds = map.getBounds();
            }
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                map.invalidateSize();

                // Check if unifiedCluster exists and user hasn't manually zoomed
                if (typeof unifiedCluster !== 'undefined' && !userHasZoomed) {
                    // Recenter to fit all markers
                    const clusterBounds = unifiedCluster.getBounds();
                    if (clusterBounds && clusterBounds.isValid()) {
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;
                        let maxZoom = 6;

                        if (viewportWidth < 768 || viewportHeight < 600) {
                            maxZoom = 4;
                        } else if (viewportWidth < 1200) {
                            maxZoom = 5;
                        }

                        fitBoundsWithSidebarOffset(clusterBounds, {
                            animate: true,
                            duration: 0.5,
                            maxZoom: maxZoom,
                            padding: [40, 40]
                        });
                    }
                } else if (lastBounds) {
                    // User has zoomed - restore their view
                    map.fitBounds(lastBounds, { animate: false });
                }
                lastBounds = null;
            }, 150);
        });

        // Define marker icons - using custom images with correct dimensions
        const markerIcons = {
            retailer: 'assets/images/marker-retailer.svg',
            brewery: 'assets/images/marker-brewery.svg',
            tastingroom: 'assets/images/marker-tastingroom.svg',
            bar: 'assets/images/marker-bar.svg',
            trail: 'assets/images/marker-trail.svg?v=2',
            river: 'assets/images/marker-river.svg?v=2',
            community: 'assets/images/marker-community.svg',
            charger: 'assets/images/marker-charger.svg'
        };

        // Create marker icon with pill background
        function createMarkerIcon(category) {
            const iconUrl = markerIcons[category];
            const pillStyle = 'display:flex;align-items:center;justify-content:center;width:46px;height:46px;background:#FFFDF7;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.25);border:2px solid #ffc72d;position:relative;';

            // Adjust icon size based on aspect ratio for visual balance
            let iconSize = '28px';
            if (category === 'river') {
                iconSize = '36px';  // Larger - wide aspect ratio
            } else if (category === 'trail') {
                iconSize = '26px';  // Slightly smaller - tall aspect ratio
            }
            const imgStyle = 'width:' + iconSize + ';height:' + iconSize + ';object-fit:contain;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);';

            return L.divIcon({
                html: '<div style="' + pillStyle + '"><img src="' + iconUrl + '" style="' + imgStyle + '" alt=""></div>',
                className: 'marker-icon-pill',
                iconSize: L.point(46, 46),
                iconAnchor: L.point(23, 23),
                popupAnchor: L.point(0, -23)
            });
        }

        // Sunshine Trail Data
        const sunshineSpots = [
            // === BREWERIES ===
            {
                name: "Lawson's Finest Liquids Brewery",
                category: "brewery",
                image: "https://www.lawsonsfinest.com/wp-content/uploads/2025/12/LFL_Taproom_Night-1.jpg",
                lat: 44.1852,
                lng: -72.8288,
                location: "155 Carroll Road, Waitsfield, VT",
                description: "The destination brewery and spiritual home of Lawson's Finest Liquids. Features a 34-barrel brewhouse, taproom, and Vermont's largest solar canopy.",
                url: "https://www.lawsonsfinest.com/taproom/"
            },
            {
                name: "Lawson's Original Nanobrewery",
                category: "brewery",
                image: "https://images.unsplash.com/photo-1559526642-c3f001ea68ee?w=800",
                lat: 44.1189,
                lng: -72.8556,
                location: "Warren, VT",
                description: "The 'Crooked Cabin' where Sean Lawson founded the brand in 2008. This 1-barrel nanobrewery is used for R&D and small-batch experimentation. Not open to public.",
                url: "https://www.lawsonsfinest.com/about-us/history/"
            },
            {
                name: "Two Roads Brewing Company",
                category: "brewery",
                image: "https://tworoadsbrewing.com/wp-content/uploads/2023/08/tbr.jpg",
                lat: 41.1884,
                lng: -73.1318,
                location: "1700 Stratford Ave, Stratford, CT",
                description: "Strategic production partner where Sip of Sunshine is brewed for regional distribution. Alternating proprietorship allows Lawson's direct quality control.",
                url: "https://tworoadsbrewing.com/"
            },

            // === TASTING ROOMS ===
            {
                name: "Lawson's Finest Taproom",
                category: "tastingroom",
                image: "https://www.lawsonsfinest.com/wp-content/uploads/2025/12/LFL_Taproom_Guests-1.jpg",
                lat: 44.1854,
                lng: -72.8285,
                location: "155 Carroll Road, Waitsfield, VT",
                description: "The primary tasting room featuring taproom-exclusive beers, seasonal releases, and the full Lawson's experience. Open daily with food menu and Bark Park for dogs.",
                url: "https://www.lawsonsfinest.com/taproom/"
            },

            // === BARS & RESTAURANTS ===
            // North Carolina
            {
                name: "The Whale",
                category: "bar",
                image: "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800",
                lat: 35.5847,
                lng: -82.5673,
                location: "507 Haywood Rd, West Asheville, NC",
                description: "Tastemaker craft beer bar chosen as a primary launch partner for Lawson's NC distribution in 2024. Known for curated draft selection.",
                url: "https://thewhalecollective.com/west-asheville-nc/"
            },
            // Pennsylvania
            {
                name: "City Tap House",
                category: "bar",
                image: "https://images.unsplash.com/photo-1572116469696-31de0f17cc34?w=800",
                lat: 39.9543,
                lng: -75.1715,
                location: "2 Logan Square, Philadelphia, PA",
                description: "Upscale gastropub explicitly featuring Sip of Sunshine on draft. Part of the Center City SIPS happy hour circuit.",
                url: "https://citytap.com/"
            },
            {
                name: "Uptown Beer Garden",
                category: "bar",
                image: "https://images.unsplash.com/photo-1555658636-6e4a36218be7?w=800",
                lat: 39.9536,
                lng: -75.1656,
                location: "1500 JFK Blvd, Philadelphia, PA",
                description: "Massive outdoor beer garden highlighted as a 'SIPS of Sunshine' destination during Philadelphia's summer happy hour program.",
                url: "https://www.uptownbeer.com/"
            },
            // New York
            {
                name: "Greenwood Park",
                category: "bar",
                image: "https://images.unsplash.com/photo-1571613316887-6f8d5cbf7ef7?w=800",
                lat: 40.6592,
                lng: -73.9897,
                location: "555 7th Ave, Brooklyn, NY",
                description: "Massive Brooklyn beer garden that hosted Lawson's Summer Solstice event, indicating strong brand activation capabilities.",
                url: "https://greenwoodparkbk.com/"
            },
            {
                name: "Stout NYC - Grand Central",
                category: "bar",
                image: "https://images.unsplash.com/photo-1546622891-02c72c1537b6?w=800",
                lat: 40.7527,
                lng: -73.9772,
                location: "133 W 33rd St, New York, NY",
                description: "High-visibility commuter hub capturing Metro-North traffic. Key draft account for the NYC market.",
                url: "https://stoutnyc.com/"
            },
            // Connecticut
            {
                name: "Eli Cannon's Tap Room",
                category: "bar",
                image: "https://images.unsplash.com/photo-1534353473418-4cfa6c56fd38?w=800",
                lat: 41.5623,
                lng: -72.6506,
                location: "695 Main St, Middletown, CT",
                description: "Legendary beer bar that hosted Summer Solstice with rare kegs of Double Sunshine. A craft beer institution since 1994.",
                url: "https://elicannons.com/"
            },
            // Rhode Island
            {
                name: "The Red Door",
                category: "bar",
                image: "https://images.unsplash.com/photo-1470337458703-46ad1756a187?w=800",
                lat: 41.8236,
                lng: -71.4222,
                location: "49 Peck St, Providence, RI",
                description: "Upscale cocktail bar featuring Lawson's on a curated beer list. Emphasizes culinary and cocktail pairing.",
                url: "https://reddoorpvd.com/"
            },
            // Massachusetts
            {
                name: "Five Horses Tavern",
                category: "bar",
                image: "https://images.unsplash.com/photo-1543007630-9710e4a00a20?w=800",
                lat: 42.3388,
                lng: -71.0885,
                location: "535 Columbus Ave, Boston, MA",
                description: "Craft-centric gastropub with 40 rotating drafts. A staple account for consistent Lawson's volume in Boston.",
                url: "https://www.fivehorsestavern.com/"
            },
            // Maine
            {
                name: "Luna Rooftop",
                category: "bar",
                image: "https://images.unsplash.com/photo-1527192491265-7e15c55b1ed2?w=800",
                lat: 43.6568,
                lng: -70.2495,
                location: "Canopy Portland Waterfront, Portland, ME",
                description: "High-end rooftop bar positioning Lawson's as a premium lifestyle beverage in Portland's competitive craft scene.",
                url: "https://lunarooftopbarmaine.com/"
            },
            {
                name: "Hunt & Alpine Club",
                category: "bar",
                image: "https://images.unsplash.com/photo-1525268323446-0505b6fe7778?w=800",
                lat: 43.6591,
                lng: -70.2554,
                location: "75 Market St, Portland, ME",
                description: "James Beard semi-finalist cocktail bar. Lawson's presence here validates quality among mixology connoisseurs.",
                url: "https://www.huntandalpineclub.com/"
            },
            // Vermont
            {
                name: "Worthy Burger",
                category: "bar",
                image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=800",
                lat: 43.7864,
                lng: -72.5209,
                location: "56 Rainbow St, South Royalton, VT",
                description: "Craft beer destination that hosted the Summer Solstice event, indicating priority status for Lawson's draft takeovers.",
                url: "https://worthyvermont.com/"
            },
            // Maine - Additional
            {
                name: "The Thirsty Pig",
                category: "bar",
                image: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=800",
                lat: 43.6576,
                lng: -70.2521,
                location: "37 Exchange St, Portland, ME",
                description: "Staple of Portland's Old Port district specializing in house-made sausages and craft beer.",
                url: "https://www.thethirstypig.com/"
            },
            {
                name: "Bonfire Country Bar",
                category: "bar",
                image: "https://images.unsplash.com/photo-1575037614876-c38a4c44842c?w=800",
                lat: 43.6553,
                lng: -70.2577,
                location: "24 Preble St, Portland, ME",
                description: "High-volume venue with Bacon Happier Hour featuring Lawson's in their 20-tap lineup.",
                url: "https://www.bonfirecountrybar.com/"
            },
            // Rhode Island - Additional
            {
                name: "Moonshine Alley",
                category: "bar",
                image: "https://images.unsplash.com/photo-1566417713940-fe7c737a9ef2?w=800",
                lat: 41.8230,
                lng: -71.4150,
                location: "293 Atwells Ave, Providence, RI",
                description: "Nashville-themed venue on Federal Hill serving Lawson's alongside Southern comfort food.",
                url: "https://www.moonshinealley.com/"
            },
            {
                name: "The Scurvy Dog",
                category: "bar",
                image: "https://images.unsplash.com/photo-1574126154517-d1e0d89ef734?w=800",
                lat: 41.8188,
                lng: -71.4380,
                location: "1718 Westminster St, Providence, RI",
                description: "Self-described punk rock pub. Explicitly lists Sip of Sunshine cans. Validates street credibility.",
                url: "https://www.scurvydogbar.com/"
            },
            {
                name: "McBride's Irish Pub",
                category: "bar",
                image: "https://images.unsplash.com/photo-1559329009-cd1c8c17f5b2?w=800",
                lat: 41.8306,
                lng: -71.3978,
                location: "161 Wayland Ave, Providence, RI",
                description: "Historic venue and community hub for Wayland Square neighborhood. Lawson's as a premium option.",
                url: "https://mcbrides-pub.com/"
            },
            // Massachusetts - Additional
            {
                name: "Bostonia Public House",
                category: "bar",
                image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800",
                lat: 42.3551,
                lng: -71.0549,
                location: "131 State St, Boston, MA",
                description: "Financial district venue serving 16oz Sip of Sunshine, targeting corporate after-work crowd.",
                url: "https://bostoniapublichouse.com/"
            },
            // New York - Additional
            {
                name: "Stout NYC - Penn Station",
                category: "bar",
                image: "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800",
                lat: 40.7505,
                lng: -73.9934,
                location: "Penn Station Area, New York, NY",
                description: "Major transit hub location (Amtrak/LIRR/NJT) with high-volume draft account.",
                url: "https://stoutnyc.com/"
            },
            // New Hampshire
            {
                name: "Dwyer's Pub",
                category: "bar",
                image: "https://images.unsplash.com/photo-1558642452-9d2a7deb7f62?w=800",
                lat: 43.0718,
                lng: -70.7626,
                location: "195 Fleet St, Portsmouth, NH",
                description: "Hosted Summer Solstice event with Double Sunshine on draft. Key NH market account.",
                url: "https://www.dwyerspub.com/"
            },
            // Pennsylvania - Additional SIPS Venues
            {
                name: "McGillin's Olde Ale House",
                category: "bar",
                image: "https://images.unsplash.com/photo-1538488881038-e252a119ace7?w=800",
                lat: 39.9512,
                lng: -75.1610,
                location: "1310 Drury St, Philadelphia, PA",
                description: "Philadelphia's oldest continuously operating tavern (est. 1860). Center City SIPS participant.",
                url: "https://mcgillins.com/"
            },
            {
                name: "Independence Beer Garden",
                category: "bar",
                image: "https://images.unsplash.com/photo-1572116469696-31de0f17cc34?w=800",
                lat: 39.9494,
                lng: -75.1502,
                location: "100 S Independence Mall W, Philadelphia, PA",
                description: "Large outdoor beer garden near Independence Hall. Major SIPS venue with hundreds of seats.",
                url: "https://phlbeergarden.com/"
            },
            {
                name: "Barcade",
                category: "bar",
                image: "https://images.unsplash.com/photo-1511882150382-421056c89033?w=800",
                lat: 39.9497,
                lng: -75.1595,
                location: "1326 Chestnut St, Philadelphia, PA",
                description: "Arcade bar combining classic games with craft beer. SIPS participant featuring Lawson's drafts.",
                url: "https://barcadephiladelphia.com/"
            },
            {
                name: "Br Craft & Wurst",
                category: "bar",
                image: "https://images.unsplash.com/photo-1600788886242-5c96aabe3757?w=800",
                lat: 39.9502,
                lng: -75.1603,
                location: "1318 Chestnut St, Philadelphia, PA",
                description: "German-style beer hall and SIPS venue. Perfect pairing for Lawson's IPAs.",
                url: "https://brucraftwurst.com/"
            },
            {
                name: "Fado Irish Pub",
                category: "bar",
                image: "https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?w=800",
                lat: 39.9480,
                lng: -75.1651,
                location: "1500 Locust St, Philadelphia, PA",
                description: "Authentic Irish pub on Rittenhouse Row. SIPS participant with extensive craft selection.",
                url: "https://fadoirishpub.com/philadelphia/"
            },

            // === RETAILERS ===
            // Vermont
            {
                name: "Lawson's Finest Liquids Taproom",
                category: "retailer",
                image: "https://www.lawsonsfinest.com/wp-content/uploads/2025/12/LFL_Taproom_Night-1.jpg",
                lat: 44.1852,
                lng: -72.8288,
                location: "Waitsfield, VT",
                description: "The home of Sip of Sunshine. Visit our taproom for the freshest pours and exclusive releases.",
                url: "https://www.lawsonsfinest.com"
            },
            {
                name: "Mad River Taste Place",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1584225064785-c62a8b43d148?w=800",
                lat: 44.1870,
                lng: -72.8256,
                location: "Waitsfield, VT",
                description: "The Valley's go-to destination for Vermont craft beer, local cider, wine, and hyper-local spirits.",
                url: "https://madrivervalley.com"
            },
            {
                name: "Mehuron's Supermarket",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1604719312566-8912e9227c6a?w=800",
                lat: 44.1858,
                lng: -72.8271,
                location: "Waitsfield, VT",
                description: "Local grocery with an excellent Vermont craft beer selection including Lawson's Finest.",
                url: "https://www.mehurons.com/"
            },
            {
                name: "JD's Quick Stop",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1567696911980-2eed69a46042?w=800",
                lat: 43.9289,
                lng: -72.8411,
                location: "Hancock, VT",
                description: "Famous beer cave with a curated selection of Vermont's finest including Lawson's, Heady Topper, and more.",
                url: "https://www.google.com/search?q=JDs+Quick+Stop+Beer+Cave+Hancock+VT"
            },
            // Massachusetts
            {
                name: "Craft Beer Cellar - Belmont",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1558642452-9d2a7deb7f62?w=800",
                lat: 42.3962,
                lng: -71.1784,
                location: "Belmont, MA",
                description: "Premier craft beer retailer featuring rotating selections from Lawson's Finest Liquids.",
                url: "https://craftbeercellar.com"
            },
            {
                name: "Blanchard's Liquors",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1527192491265-7e15c55b1ed2?w=800",
                lat: 42.3151,
                lng: -71.0589,
                location: "Boston, MA",
                description: "Boston's destination for craft beer with regular Lawson's Finest availability.",
                url: "https://blanchards.net/"
            },
            // Connecticut
            {
                name: "Two Roads Brewing Company",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1532634922-8fe0b757fb13?w=800",
                lat: 41.2226,
                lng: -73.1353,
                location: "Stratford, CT",
                description: "Our brewing partner - Sip of Sunshine is brewed here. Visit the taproom for fresh pours.",
                url: "https://tworoadsbrewing.com"
            },
            // New York
            {
                name: "Whole Foods Market - Union Square",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1534723452862-4c874018d66d?w=800",
                lat: 40.7359,
                lng: -73.9911,
                location: "New York, NY",
                description: "Quality craft beer selection in Manhattan including Lawson's Finest offerings.",
                url: "https://www.wholefoodsmarket.com/stores/unionsquare"
            },
            // Pennsylvania
            {
                name: "Monk's Cafe",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800",
                lat: 39.9478,
                lng: -75.1639,
                location: "Philadelphia, PA",
                description: "Legendary Philadelphia beer bar known for exceptional craft selections.",
                url: "https://monkscafe.com"
            },
            {
                name: "Tired Hands Brewing Company",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1559526642-c3f001ea68ee?w=800",
                lat: 40.0054,
                lng: -75.3099,
                location: "Ardmore, PA",
                description: "Award-winning brewery and fermentaria with rotating guest taps.",
                url: "https://tiredhands.com"
            },
            // Virginia
            {
                name: "Total Wine & More - Richmond",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1578911373434-0cb395d2cbfb?w=800",
                lat: 37.5955,
                lng: -77.5201,
                location: "Richmond, VA",
                description: "Extensive craft beer selection with regular Lawson's Finest availability.",
                url: "https://totalwine.com"
            },
            {
                name: "The Veil Brewing Co.",
                category: "retailer",
                image: "https://images.unsplash.com/photo-1559526642-c3f001ea68ee?w=800",
                lat: 37.5541,
                lng: -77.4599,
                location: "Richmond, VA",
                description: "Richmond's favorite brewery - check for Lawson's guest taps and events.",
                url: "https://theveilbrewing.com"
            },
            // North Carolina
            {
                name: "Weinhaus",
                category: "retailer",
                lat: 35.5951,
                lng: -82.5515,
                location: "Asheville, NC",
                description: "Downtown Asheville's oldest and largest bottle shop with 12 local NC beers on tap.",
                url: "https://weinhaus.com"
            },
            {
                name: "Local 604 Bottle Shop - West",
                category: "retailer",
                lat: 35.5847,
                lng: -82.5760,
                location: "Asheville, NC",
                description: "West Asheville's best little bottle shop with over 20 local breweries represented.",
                url: "https://local604avl.com"
            },
            {
                name: "The Whale - A Craft Beer Collective",
                category: "retailer",
                lat: 35.5943,
                lng: -82.5540,
                location: "Asheville, NC",
                description: "Exceptional craft beer selection - one of the best bottle shops on the East Coast.",
                url: "https://thewhalecollective.com/"
            },
            {
                name: "Appalachian Vintner",
                category: "retailer",
                lat: 35.6012,
                lng: -82.5568,
                location: "Asheville, NC",
                description: "Great selection and one-stop shopping for beer and wine in Asheville.",
                url: "http://www.appalachianvintner.com/"
            },
            // Additional Vermont Retailers
            {
                name: "Cold Hollow Cider Mill",
                category: "retailer",
                lat: 44.3856,
                lng: -72.7469,
                location: "Waterbury, VT",
                description: "Iconic Vermont destination with craft beer, fresh cider donuts, and local products. A Route 100 must-stop.",
                url: "https://coldhollow.com"
            },
            {
                name: "Stowe Public House",
                category: "retailer",
                lat: 44.4654,
                lng: -72.6874,
                location: "Stowe, VT",
                description: "Classic Vermont tavern with an excellent rotating craft beer selection including Lawson's Finest.",
                url: "https://www.stowepublichouse.com/"
            },
            // Additional New Hampshire
            {
                name: "Bert's Better Beers",
                category: "retailer",
                lat: 42.9956,
                lng: -71.4548,
                location: "Hooksett, NH",
                description: "New Hampshire's premier craft beer destination with 1,200+ craft beers. Consistently stocks Lawson's.",
                url: "https://bertsbetterbeers.com",
                image: "https://bertsbetterbeers.com/wp-content/uploads/2023/03/berts-storefront.jpg"
            },
            // Additional Massachusetts
            {
                name: "Yankee Spirits",
                category: "retailer",
                lat: 42.0834,
                lng: -71.0184,
                location: "Attleboro, MA",
                description: "Award-winning liquor store chain with extensive craft beer selection including Lawson's Finest.",
                url: "https://yankeespirits.com"
            },
            {
                name: "Stop & Shop - Boston",
                category: "retailer",
                lat: 42.3467,
                lng: -71.0972,
                location: "Boston, MA",
                description: "Major grocery chain carrying Lawson's Sip of Sunshine in 4-packs. Cold stored for freshness.",
                url: "https://stopandshop.com"
            },
            {
                name: "Gordon's Fine Wines & Liquors",
                category: "retailer",
                lat: 42.4501,
                lng: -71.2326,
                location: "Waltham, MA",
                description: "Family-owned since 1936. Excellent craft beer cave with rotating Lawson's selections.",
                url: "https://gordonswine.com"
            },
            // Additional Connecticut
            {
                name: "Craft Beer Shop - New Haven",
                category: "retailer",
                lat: 41.3083,
                lng: -72.9279,
                location: "New Haven, CT",
                description: "Dedicated craft beer bottle shop in the heart of New Haven. Fresh Lawson's regularly in stock.",
                url: "https://www.google.com/search?q=Craft+Beer+Shop+New+Haven+CT"
            },
            // Additional New York
            {
                name: "Half Time Beverage",
                category: "retailer",
                lat: 41.0255,
                lng: -73.7618,
                location: "Mamaroneck, NY",
                description: "Legendary NY craft beer destination with 2,000+ beers. A bucket-list stop for beer lovers.",
                url: "https://halftimebeverage.com"
            },
            {
                name: "Whole Foods Market - Brooklyn",
                category: "retailer",
                lat: 40.6892,
                lng: -73.9785,
                location: "Brooklyn, NY",
                description: "Fort Greene location with curated craft beer selection including Lawson's Sip of Sunshine.",
                url: "https://wholefoodsmarket.com"
            },
            {
                name: "Wegmans - Rochester",
                category: "retailer",
                lat: 43.1166,
                lng: -77.6088,
                location: "Rochester, NY",
                description: "The original Wegmans location with an exceptional beer department. Lawson's regularly stocked.",
                url: "https://wegmans.com"
            },
            // Additional New Jersey
            {
                name: "Wegmans - Princeton",
                category: "retailer",
                lat: 40.3176,
                lng: -74.6532,
                location: "Princeton, NJ",
                description: "Premium grocery with outstanding craft beer selection and cold storage. Fresh Lawson's available.",
                url: "https://wegmans.com"
            },
            {
                name: "Jersey City Super Buy Rite",
                category: "retailer",
                lat: 40.7282,
                lng: -74.0776,
                location: "575 Manila Ave, Jersey City, NJ",
                description: "New Jersey's largest liquor store with over 30,000 sq ft and one of the largest beer selections in the world. Fresh Lawson's regularly in stock.",
                url: "https://buyritewines.com/"
            },
            // Additional Pennsylvania
            {
                name: "ACME Markets - Wayne",
                category: "retailer",
                lat: 40.0439,
                lng: -75.3879,
                location: "Wayne, PA",
                description: "Full-service grocery with craft beer section featuring Lawson's Sip of Sunshine.",
                url: "https://acmemarkets.com"
            },
            {
                name: "Wegmans - King of Prussia",
                category: "retailer",
                lat: 40.0878,
                lng: -75.3889,
                location: "King of Prussia, PA",
                description: "Expansive beer department with dedicated craft section. Lawson's kept cold for optimal freshness.",
                url: "https://wegmans.com"
            },
            // Additional Virginia
            {
                name: "Total Wine & More - Leesburg",
                category: "retailer",
                lat: 39.1157,
                lng: -77.5636,
                location: "1610 Village Market Blvd, Leesburg, VA",
                description: "Northern Virginia craft beer destination with extensive selection. Fresh Lawson's Sip of Sunshine regularly in stock.",
                url: "https://www.totalwine.com/store-info/virginia-leesburg/218"
            },
            {
                name: "Whole Foods Market - Fairfax",
                category: "retailer",
                lat: 38.8462,
                lng: -77.3064,
                location: "Fairfax, VA",
                description: "Fresh Lawson's on draft and in cans. Part of their curated Virginia craft beer program.",
                url: "https://wholefoodsmarket.com"
            },
            {
                name: "Beer Run - Charlottesville",
                category: "retailer",
                lat: 38.0293,
                lng: -78.4767,
                location: "Charlottesville, VA",
                description: "Craft beer bar and bottle shop near UVA. Fresh Lawson's in cans with rotating draft selections.",
                url: "https://beerrun.com"
            },
            {
                name: "The Staunton Grocery",
                category: "retailer",
                lat: 38.1496,
                lng: -79.0717,
                location: "103 S Coalter St, Staunton, VA",
                description: "Boutique grocery in the Shenandoah Valley with curated craft beer selection. Near Skyline Drive entrance.",
                url: "https://thestauntongrocery.shopsettings.com/"
            },
            // Additional North Carolina
            {
                name: "Tasty Beverage Co.",
                category: "retailer",
                lat: 35.7721,
                lng: -78.6386,
                location: "Raleigh, NC",
                description: "Raleigh's premier craft beer bottle shop with 1,000+ selections. Fresh Lawson's available.",
                url: "https://tastybeverageco.com"
            },
            {
                name: "Good Bottle Co.",
                category: "retailer",
                lat: 35.2106,
                lng: -80.8308,
                location: "Charlotte, NC",
                description: "South End Charlotte's neighborhood bottle shop with curated craft selections including Lawson's.",
                url: "https://goodbottleco.com"
            },
            {
                name: "Wedge Brewing - Grove Arcade",
                category: "retailer",
                lat: 35.5923,
                lng: -82.5574,
                location: "1 Page Ave, Suite 152, Asheville, NC",
                description: "Historic Grove Arcade taproom featuring Asheville-brewed craft beers. Great selection of local and regional brews including Lawson's.",
                url: "https://wedgebrewing.com/locations/grove-arcade/"
            },
            // Rhode Island
            {
                name: "Nikki's Liquors",
                category: "retailer",
                lat: 41.8240,
                lng: -71.4128,
                location: "Providence, RI",
                description: "Providence's go-to craft beer destination. Extensive selection with regular Lawson's stock.",
                url: "https://nikkisliquors.com"
            },
            // Maine
            {
                name: "RSVP Discount Beverage",
                category: "retailer",
                lat: 43.6591,
                lng: -70.2568,
                location: "Portland, ME",
                description: "Portland's largest beer selection with 1,500+ craft beers. Fresh Lawson's in the cooler.",
                url: "https://rsvpdiscountbeverage.com"
            },

            // === TRAILS ===
            // Vermont
            {
                name: "Camel's Hump via Long Trail",
                category: "trail",
                lat: 44.3198,
                lng: -72.8862,
                location: "Duxbury, VT",
                description: "Vermont's most iconic mountain with 360-degree views. 6.8 miles round trip. One of only four peaks in Vermont with alpine tundra.",
                url: "https://www.alltrails.com/trail/us/vermont/camels-hump-via-long-trail-and-burrows-trail"
            },
            {
                name: "Stratton Mountain",
                category: "trail",
                lat: 43.0822,
                lng: -72.9089,
                location: "Stratton, VT",
                description: "Where Benton MacKaye conceived the Appalachian Trail. Features peaceful streams, meadows, and pristine Stratton Pond.",
                url: "https://www.alltrails.com/trail/us/vermont/stratton-mountain-and-stratton-pond-via-long-trail"
            },
            {
                name: "Mount Mansfield - Long Trail",
                category: "trail",
                lat: 44.5437,
                lng: -72.8143,
                location: "Stowe, VT",
                description: "Vermont's highest peak at 4,393 ft. Stunning ridge walk along 'The Chin' with alpine scenery.",
                url: "https://www.alltrails.com/trail/us/vermont/mount-mansfield-via-sunset-ridge-and-long-trail"
            },
            // New Hampshire
            {
                name: "Franconia Ridge Loop",
                category: "trail",
                lat: 44.1604,
                lng: -71.6447,
                location: "Franconia, NH",
                description: "One of the premier day hikes in the entire country. Above-treeline ridge walk with 360-degree views. 8.9 miles.",
                url: "https://www.alltrails.com/trail/us/new-hampshire/franconia-ridge-trail-loop"
            },
            {
                name: "Mount Washington via Tuckerman Ravine",
                category: "trail",
                lat: 44.2706,
                lng: -71.3033,
                location: "Pinkham Notch, NH",
                description: "The Northeast's highest peak at 6,288 ft. Historic and challenging. Once held the world wind speed record.",
                url: "https://www.alltrails.com/trail/us/new-hampshire/mount-washington-via-tuckerman-ravine-trail"
            },
            // Massachusetts
            {
                name: "Mount Greylock - Appalachian Trail",
                category: "trail",
                lat: 42.6376,
                lng: -73.1662,
                location: "Adams, MA",
                description: "Massachusetts' highest point at 3,491 ft. The AT passes over the summit with panoramic views of five states.",
                url: "https://www.alltrails.com/trail/us/massachusetts/mount-greylock-via-hopper-trail"
            },
            {
                name: "Taconic Highlands - Mount Everett",
                category: "trail",
                lat: 42.0977,
                lng: -73.4374,
                location: "Mount Washington, MA",
                description: "A 17-mile AT section with old-growth forest, waterfalls, and open summits without crossing a single road.",
                url: "https://www.alltrails.com/trail/us/massachusetts/mount-everett-via-appalachian-trail"
            },
            // Pennsylvania
            {
                name: "Hawk Mountain Sanctuary",
                category: "trail",
                lat: 40.6359,
                lng: -75.9871,
                location: "Kempton, PA",
                description: "World-renowned raptor migration site. Over 20,000 hawks fly over each fall. Multiple scenic overlooks.",
                url: "https://www.hawkmountain.org/visit/plan-your-visit"
            },
            {
                name: "The Pinnacle",
                category: "trail",
                lat: 40.5805,
                lng: -75.9143,
                location: "Hamburg, PA",
                description: "Considered by many to be the AT's best view in Pennsylvania. 9-mile loop with stunning rock formations.",
                url: "https://www.alltrails.com/trail/us/pennsylvania/pinnacle-and-pulpit-rock-loop-via-appalachian-trail"
            },
            // Virginia
            {
                name: "McAfee Knob",
                category: "trail",
                lat: 37.2390,
                lng: -80.0328,
                location: "Salem, VA",
                description: "The most photographed spot on the entire Appalachian Trail. Iconic rock outcrop with widescreen mountain views. 8.8 miles.",
                url: "https://www.alltrails.com/trail/us/virginia/mcafee-knob-via-appalachian-trail"
            },
            {
                name: "Three Ridges Wilderness",
                category: "trail",
                lat: 37.9189,
                lng: -79.0168,
                location: "Waynesboro, VA",
                description: "Scenic views, 40-foot waterfalls, and swimming holes. A challenging but rewarding AT section.",
                url: "https://www.alltrails.com/trail/us/virginia/three-ridges-via-appalachian-trail"
            },
            {
                name: "Old Rag Mountain",
                category: "trail",
                lat: 38.5533,
                lng: -78.3161,
                location: "Shenandoah NP, VA",
                description: "Virginia's most popular hike. Iconic rock scramble with 360-degree views from the summit.",
                url: "https://www.alltrails.com/trail/us/virginia/old-rag-mountain-loop-trail"
            },
            // North Carolina
            {
                name: "Max Patch",
                category: "trail",
                lat: 35.7972,
                lng: -82.9569,
                location: "Hot Springs, NC",
                description: "A rolling, grassy mountaintop bald with endless wildflowers and stunning 360-degree panoramas. One of our favorites on the AT.",
                url: "https://www.alltrails.com/trail/us/north-carolina/max-patch-loop-trail"
            },
            {
                name: "Roan Highlands - Carvers Gap",
                category: "trail",
                lat: 36.1064,
                lng: -82.1098,
                location: "Roan Mountain, NC/TN",
                description: "Rolling balds with fields of wildflowers. Hike to Round Bald, Jane Bald, and Grassy Ridge for incredible views.",
                url: "https://www.alltrails.com/trail/us/north-carolina/grassy-ridge-bald-via-appalachian-trail"
            },
            {
                name: "Craggy Gardens",
                category: "trail",
                lat: 35.7019,
                lng: -82.3790,
                location: "Blue Ridge Parkway, NC",
                description: "Famous for rhododendron blooms. Easy to moderate trails with panoramic Blue Ridge views.",
                url: "https://www.alltrails.com/trail/us/north-carolina/craggy-gardens-trail"
            },
            {
                name: "Looking Glass Rock",
                category: "trail",
                lat: 35.2957,
                lng: -82.7877,
                location: "Pisgah NF, NC",
                description: "Iconic granite dome near Brevard. Challenging 6.5-mile hike rewarded with spectacular views.",
                url: "https://www.alltrails.com/trail/us/north-carolina/looking-glass-rock-trail"
            },

            // === RIVER PUT-INS ===
            // Vermont
            {
                name: "Mad River - Waitsfield Access",
                category: "river",
                lat: 44.1892,
                lng: -72.8301,
                location: "Waitsfield, VT",
                description: "Local favorite for kayaking and swimming. Class I-II rapids through the heart of the Mad River Valley.",
                url: "https://www.clearwatervt.com/trips"
            },
            {
                name: "White River - Chelsea Park",
                category: "river",
                lat: 43.7832,
                lng: -72.4689,
                location: "Sharon, VT",
                description: "Vermont's longest undammed river. Popular put-in for scenic day paddles with few portages required.",
                url: "https://www.vermontpaddlers.club/white-river"
            },
            {
                name: "Connecticut River - Wilgus State Park",
                category: "river",
                lat: 43.4397,
                lng: -72.4128,
                location: "Ascutney, VT",
                description: "Canoe and kayak rentals available. Part of the 400-mile Connecticut River Paddlers' Trail.",
                url: "https://www.connecticutriverpaddlerstrail.org"
            },
            // New Hampshire
            {
                name: "Connecticut River - Hanover",
                category: "river",
                lat: 43.7022,
                lng: -72.2896,
                location: "Hanover, NH",
                description: "Easy access point on New England's longest river. Beautiful paddling through scenic Upper Valley.",
                url: "https://www.ledyardcanoeclub.org"
            },
            // Virginia
            {
                name: "James River - Buchanan",
                category: "river",
                lat: 37.5275,
                lng: -79.6787,
                location: "Buchanan, VA",
                description: "Upper James River Water Trail access. 64 miles of paddling through the Allegheny and Blue Ridge Mountains.",
                url: "https://www.upperjamesriverwatertrail.com"
            },
            {
                name: "Roanoke River Blueway - Wasena Park",
                category: "river",
                lat: 37.2620,
                lng: -79.9571,
                location: "Roanoke, VA",
                description: "Voted one of the best urban kayaking spots in the US. Easy float through Virginia's Blue Ridge.",
                url: "https://www.roanokecountyparks.com/283/Roanoke-River-Blueway"
            },
            {
                name: "New River - McCoy Access",
                category: "river",
                lat: 37.2419,
                lng: -80.6009,
                location: "Giles County, VA",
                description: "Start of the 37-mile New River Water Trail. Class I to III rapids through stunning mountain scenery.",
                url: "https://www.newriverwatertrail.com"
            },
            // North Carolina
            {
                name: "French Broad River - Asheville",
                category: "river",
                lat: 35.5707,
                lng: -82.5779,
                location: "Asheville, NC",
                description: "The heart of Asheville's outdoor scene. Multiple access points for tubing, kayaking, and paddleboarding.",
                url: "https://www.ashevilleoutdoorcenter.com"
            },
            {
                name: "French Broad River - Headwaters",
                category: "river",
                lat: 35.1430,
                lng: -82.8256,
                location: "Rosman, NC",
                description: "Headwaters Outfitters offers 3-7 hour self-guided trips. Pristine paddling southwest of Asheville.",
                url: "https://www.headwatersoutfitters.com"
            },
            {
                name: "Yadkin River - Surry County",
                category: "river",
                lat: 36.4117,
                lng: -80.6776,
                location: "Elkin, NC",
                description: "Over 100 miles of canoe/kayak waters. Surry County has more river access points than any other NC county.",
                url: "https://www.yadkinriverbluetrail.com"
            },

            // === COMMUNITY PARTNERS ===
            // Verified Lawson's Finest Liquids donation recipients from Cosmic Shift IPA,
            // Sunshine Fund, GivingTuesday, and Good Brews for a Cause programs.
            // Total: $3M+ donated to 400+ nonprofits since 2018.

            // VERMONT - Sunshine Fund & Home State Partners
            {
                name: "Vermont Foodbank",
                category: "community",
                state: "VT",
                lat: 44.2004,
                lng: -72.5073,
                location: "Barre, VT",
                description: "Vermont's largest hunger-relief organization, serving all 14 counties through a network of food shelves, meal sites, and community programs.",
                impact: "Thanks to support from Lawson's Cosmic Shift IPA, families like the Martins in rural Vermont can count on fresh produce and protein each week. 'After my husband's job loss, the food shelf kept our kids fed while we got back on our feet.'",
                image: "https://www.vtfoodbank.org/wp-content/uploads/2024/12/20221028_hpSlider.jpg",
                url: "https://vtfoodbank.org",
                donateUrl: "https://vtfoodbank.org/give"
            },
            {
                name: "Upper Valley Haven",
                category: "community",
                state: "VT",
                lat: 43.6489,
                lng: -72.3212,
                location: "White River Junction, VT",
                description: "Providing food, shelter, education, and service coordination for families and individuals in need in the Upper Valley.",
                impact: "2024 Sunshine Fund recipient. The Haven helped Sarah, a single mom, transition from their shelter to stable housing. 'They didn't just give me a roof - they helped me build a future for my daughter.'",
                url: "https://uppervalleyhaven.org",
                donateUrl: "https://uppervalleyhaven.org/donate"
            },
            {
                name: "Committee on Temporary Shelter (COTS)",
                category: "community",
                state: "VT",
                lat: 44.4759,
                lng: -73.2121,
                location: "Burlington, VT",
                description: "Working to end homelessness in Vermont through shelter, housing, and prevention services since 1982.",
                impact: "2024 Sunshine Fund recipient. Last winter, COTS helped 47 people find permanent housing. James, a veteran, says: 'COTS gave me more than shelter. They gave me back my dignity and a place to call home.'",
                url: "https://cotsonline.org",
                donateUrl: "https://cotsonline.org/donate"
            },
            {
                name: "Green Mountain Farm-to-School",
                category: "community",
                state: "VT",
                lat: 44.0354,
                lng: -73.1795,
                location: "Newport, VT",
                description: "Connecting Vermont farms with schools to provide fresh, local food while teaching kids about nutrition and agriculture.",
                impact: "2024 Sunshine Fund recipient. Thanks to their programs, students in Orleans County now grow vegetables in school gardens. Teacher Amy shares: 'Kids who never touched a vegetable are now excited to eat what they planted.'",
                url: "https://greenmountainfarmtoschool.org",
                donateUrl: "https://greenmountainfarmtoschool.org/donate"
            },
            {
                name: "Friends of the Winooski River",
                category: "community",
                state: "VT",
                lat: 44.4875,
                lng: -72.8899,
                location: "Montpelier, VT",
                description: "Protecting and restoring the Winooski River watershed through education, advocacy, and community engagement.",
                impact: "2024 Sunshine Fund recipient. Their river cleanup events have removed tons of debris while educating hundreds of volunteers. 'Every paddle on the Winooski is cleaner because of their work,' says kayaker Tom.",
                url: "https://winooskiriver.org",
                donateUrl: "https://winooskiriver.org/donate"
            },
            {
                name: "Vermont Community Foundation",
                category: "community",
                state: "VT",
                lat: 44.2598,
                lng: -72.5754,
                location: "Middlebury, VT",
                description: "Partner for the inaugural SIPosium, supporting Vermont's flood recovery and building community resilience across the state.",
                impact: "After devastating floods, the Foundation mobilized rapid response grants. Homeowner Maria recalls: 'Within days of losing everything, we had help rebuilding. The Vermont spirit is real.'",
                url: "https://vermontcf.org",
                donateUrl: "https://vermontcf.org/give"
            },
            {
                name: "Northeast Kingdom Community Action (NEKCA)",
                category: "community",
                state: "VT",
                lat: 44.5342,
                lng: -72.0196,
                location: "St. Johnsbury, VT",
                description: "Fighting poverty and building community in Vermont's Northeast Kingdom through comprehensive support services.",
                impact: "2024 Sunshine Fund recipient. NEKCA's heating assistance kept 200+ families warm last winter. 'Choosing between heat and food shouldn't happen in Vermont,' says director Lisa. 'We make sure it doesn't.'",
                url: "https://nekcavt.org",
                donateUrl: "https://nekcavt.org/donate"
            },

            // NEW HAMPSHIRE - Cosmic Shift Beneficiary
            {
                name: "NH Food Alliance",
                category: "community",
                state: "NH",
                lat: 43.2081,
                lng: -71.5376,
                location: "Concord, NH",
                description: "Building a thriving, fair, and sustainable food system in New Hampshire by connecting farmers, food banks, and communities.",
                impact: "Cosmic Shift IPA beneficiary. The Alliance helped launch 12 new farm-to-food-bank partnerships. Farmer Jake says: 'Now my extra harvest feeds families instead of going to waste. It's farming with purpose.'",
                url: "https://nhfoodalliance.org",
                donateUrl: "https://nhfoodalliance.org/donate"
            },

            // MAINE - Cosmic Shift Beneficiary
            {
                name: "Cultivating Community",
                category: "community",
                state: "ME",
                lat: 43.6591,
                lng: -70.2568,
                location: "Portland, ME",
                description: "Growing food, farmers, and community through urban agriculture programs that serve immigrant and refugee communities.",
                impact: "Cosmic Shift IPA beneficiary. Their refugee farming program has helped 50+ families grow food from their homelands. Amara, from Somalia, shares: 'This garden connects me to home while feeding my children here.'",
                url: "https://cultivatingcommunity.org",
                donateUrl: "https://cultivatingcommunity.org/donate"
            },

            // MASSACHUSETTS - Cosmic Shift Beneficiary
            {
                name: "Spoonfuls (Lovin' Spoonfuls)",
                category: "community",
                state: "MA",
                lat: 42.3376,
                lng: -71.2087,
                location: "Newton, MA",
                description: "New England's largest food rescue operation, preventing 5M+ pounds of fresh food from going to waste each year.",
                impact: "Cosmic Shift IPA beneficiary. Their trucks rescue food daily from grocery stores and restaurants. Shelter director Mike says: 'Spoonfuls brings us restaurant-quality food. Our guests eat with dignity.'",
                url: "https://spoonfuls.org",
                donateUrl: "https://spoonfuls.org/donate"
            },

            // RHODE ISLAND - Cosmic Shift Beneficiary
            {
                name: "Rhode Island Community Food Bank",
                category: "community",
                state: "RI",
                lat: 41.8176,
                lng: -71.3743,
                location: "Providence, RI",
                description: "Fighting hunger and improving lives by providing nutritious food to Rhode Islanders facing food insecurity.",
                impact: "Cosmic Shift IPA beneficiary. They distributed 18 million pounds of food last year. Grandmother Rosa shares: 'When times get hard, the food bank is there. My grandkids never go to bed hungry.'",
                url: "https://rifoodbank.org",
                donateUrl: "https://rifoodbank.org/donate"
            },

            // CONNECTICUT - Cosmic Shift Beneficiary
            {
                name: "Alzheimer's Association - CT Chapter",
                category: "community",
                state: "CT",
                lat: 41.3651,
                lng: -72.9275,
                location: "New Haven, CT",
                description: "Leading the way in Alzheimer's care, support, and research - providing resources for patients and their families.",
                impact: "Cosmic Shift IPA beneficiary. Their support groups help caregivers cope. David, caring for his wife, says: 'I thought I was alone until I found this community. Now I have strength to keep going.'",
                url: "https://alz.org/ct",
                donateUrl: "https://act.alz.org/donate"
            },

            // NEW YORK - Cosmic Shift Beneficiaries
            {
                name: "City Harvest",
                category: "community",
                state: "NY",
                lat: 40.7549,
                lng: -73.9840,
                location: "New York, NY",
                description: "NYC's largest food rescue organization, collecting excess food and delivering it to soup kitchens, food pantries, and community programs.",
                impact: "Cosmic Shift IPA beneficiary. Their trucks rescue 70 million pounds of food annually. Chef Marcus volunteers weekly: 'Food that would be thrown away instead feeds thousands. That's the magic of City Harvest.'",
                url: "https://cityharvest.org",
                donateUrl: "https://cityharvest.org/donate"
            },
            {
                name: "United Way of Greater Rochester",
                category: "community",
                state: "NY",
                lat: 43.1566,
                lng: -77.6088,
                location: "Rochester, NY",
                description: "Building stronger communities through education, financial stability, and health initiatives across the Finger Lakes region.",
                impact: "Cosmic Shift IPA beneficiary. Their early literacy programs have helped 3,000+ kids start school ready to learn. Teacher Patricia notes: 'The difference is clear on day one. These kids are confident and curious.'",
                url: "https://unitedwayrocflx.org",
                donateUrl: "https://unitedwayrocflx.org/donate"
            },

            // NEW JERSEY - Cosmic Shift Beneficiary
            {
                name: "Community FoodBank of New Jersey",
                category: "community",
                state: "NJ",
                lat: 40.7101,
                lng: -74.2097,
                location: "Hillside, NJ",
                description: "Fighting hunger and poverty in New Jersey, distributing food to over 800 partner agencies across the state.",
                impact: "Cosmic Shift IPA beneficiary. They provide 90 million meals annually. Single dad Robert shares: 'The food bank doesn't just fill our fridge - it lets me be a better father because I'm not worried about dinner.'",
                url: "https://cfbnj.org",
                donateUrl: "https://cfbnj.org/donate"
            },

            // PENNSYLVANIA - Cosmic Shift Beneficiary
            {
                name: "Philabundance",
                category: "community",
                state: "PA",
                lat: 39.9153,
                lng: -75.1566,
                location: "Philadelphia, PA",
                description: "The Delaware Valley's largest hunger relief organization, serving 135,000+ people weekly through 350 agency partners.",
                impact: "Cosmic Shift IPA beneficiary. Their Community Kitchen also trains formerly incarcerated individuals for culinary careers. Graduate Jerome says: 'They gave me skills and a second chance. Now I'm a sous chef.'",
                url: "https://philabundance.org",
                donateUrl: "https://philabundance.org/donate"
            },

            // VIRGINIA - Conservation Partner
            {
                name: "James River Association",
                category: "community",
                state: "VA",
                lat: 37.5328,
                lng: -77.4360,
                location: "Richmond, VA",
                description: "Protecting and restoring Virginia's historic James River watershed from the mountains to the Chesapeake Bay since 1976.",
                impact: "Their paddle trips connect thousands with the river each year. Kayaker Christine says: 'I never knew Richmond had such an amazing river until JRA showed me. Now I'm a volunteer river cleaner.'",
                url: "https://thejamesriver.org",
                donateUrl: "https://thejamesriver.org/donate"
            },

            // NORTH CAROLINA - Conservation & Food Security Partners
            {
                name: "Blue Ridge Parkway Foundation",
                category: "community",
                state: "NC",
                lat: 35.5682,
                lng: -82.5315,
                location: "Asheville, NC",
                description: "Preserving America's Favorite Drive by supporting trails, overlooks, and visitor experiences along 469 miles of scenic mountain road.",
                impact: "Their trail crews maintain hundreds of miles of hiking paths. Volunteer Sam shares: 'Every weekend, we're out there clearing trails so families can enjoy these views for generations to come.'",
                url: "https://brpfoundation.org",
                donateUrl: "https://brpfoundation.org/donate"
            },
            {
                name: "French Broad Riverkeeper (MountainTrue)",
                category: "community",
                state: "NC",
                lat: 35.5946,
                lng: -82.5516,
                location: "Asheville, NC",
                description: "Protecting the waters of the French Broad River watershed through monitoring, advocacy, and community engagement.",
                impact: "Their water quality testing and advocacy has made the French Broad swimmable again. Paddler Jen says: 'I remember when no one would touch this water. Now my kids swim here every summer.'",
                url: "https://mountaintrue.org",
                donateUrl: "https://mountaintrue.org/donate"
            },
            {
                name: "MANNA FoodBank",
                category: "community",
                state: "NC",
                lat: 35.5781,
                lng: -82.5024,
                location: "Asheville, NC",
                description: "Ending hunger in Western North Carolina by distributing 50,000+ pounds of food daily through 200+ partner organizations.",
                impact: "After Hurricane Helene, MANNA mobilized emergency food distribution to hard-hit communities. Recipient Angela says: 'We lost everything, but MANNA made sure we didn't lose hope. Hot meals meant the world.'",
                url: "https://mannafoodbank.org",
                donateUrl: "https://mannafoodbank.org/donate"
            },

            // === DC FAST CHARGERS ===
            // North Carolina
            {
                name: "Tesla Supercharger - Asheville",
                category: "charger",
                lat: 35.5732,
                lng: -82.5413,
                location: "264 Thetford St, Asheville, NC",
                description: "Tesla Supercharger with 8 stalls, up to 250kW. Located near downtown Asheville.",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Tesla Supercharger - Mt Airy",
                category: "charger",
                lat: 36.5082,
                lng: -80.6193,
                location: "2905 Rockford St, Mt Airy, NC",
                description: "Tesla Supercharger with 8 stalls, up to 250kW. Great stop on Blue Ridge Parkway northern section.",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Boone",
                category: "charger",
                lat: 36.2038,
                lng: -81.6580,
                location: "1180 Blowing Rock Rd, Boone, NC",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Near Blowing Rock and Blue Ridge Parkway.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            // Virginia
            {
                name: "Electrify America - Staunton",
                category: "charger",
                lat: 38.1408,
                lng: -79.0556,
                location: "255 Lucy Ln, Staunton, VA",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Perfect stop at the north end of Skyline Drive.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Waynesboro",
                category: "charger",
                lat: 38.0686,
                lng: -78.9036,
                location: "109 Lucy Ln, Waynesboro, VA",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Near Skyline Drive and Blue Ridge Parkway junction.",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Tesla Supercharger - Charlottesville",
                category: "charger",
                lat: 38.0543,
                lng: -78.4975,
                location: "1954 Rio Hill Center, Charlottesville, VA",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Great stop when heading north from Skyline Drive.",
                url: "https://www.tesla.com/findus"
            },
            // Massachusetts
            {
                name: "Electrify America - Springfield",
                category: "charger",
                lat: 42.1186,
                lng: -72.5428,
                location: "1655 Boston Rd, Springfield, MA",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Gateway to New England.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            // New Hampshire
            {
                name: "Electrify America - Hooksett",
                category: "charger",
                lat: 43.0697,
                lng: -71.4378,
                location: "1328 Hooksett Rd, Hooksett, NH",
                description: "Electrify America DC fast chargers, up to 350kW. Key I-93 corridor stop en route to Vermont.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            // Vermont
            {
                name: "ChargePoint DC Fast - Waitsfield",
                category: "charger",
                lat: 44.1861,
                lng: -72.8277,
                location: "5134 Main St, Waitsfield, VT",
                description: "ChargePoint DC fast charger at Mobil station, 180kW. Right in the heart of Mad River Valley near Lawson's Taproom.",
                url: "https://www.chargepoint.com/en-us/drivers/find-charger"
            },
            {
                name: "ChargePoint DC Fast - Mad River Green",
                category: "charger",
                lat: 44.1875,
                lng: -72.8261,
                location: "Village Square, Waitsfield, VT",
                description: "ChargePoint DC fast charger at Mad River Green shopping center, 62kW. Walking distance to local shops and Lawson's.",
                url: "https://www.chargepoint.com/en-us/drivers/find-charger"
            },
            {
                name: "Tesla Supercharger - Waterbury",
                category: "charger",
                lat: 44.3396,
                lng: -72.7530,
                location: "1899 Waterbury-Stowe Rd, Waterbury, VT",
                description: "Tesla Supercharger with 8 stalls near Ben & Jerry's Factory. Popular tourist stop.",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - White River Junction",
                category: "charger",
                lat: 43.6489,
                lng: -72.3195,
                location: "270 N Hartland Rd, White River Junction, VT",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Key I-91/I-89 interchange stop.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "NEVI Fast Charger - Bradford",
                category: "charger",
                lat: 43.9931,
                lng: -72.1292,
                location: "172 Waits River Rd, Bradford, VT",
                description: "Vermont NEVI program DC fast charger at Denny Park, up to 150kW. Scenic I-91 corridor charging.",
                url: "https://www.driveelectricvt.com/"
            },
            // Additional DC Fast Chargers to ensure 100-200 mile coverage
            {
                name: "Electrify America - Roanoke",
                category: "charger",
                lat: 37.2756,
                lng: -79.9414,
                location: "4807 Valley View Blvd NW, Roanoke, VA",
                description: "Electrify America DC fast chargers at Target, up to 350kW. Key stop between Blue Ridge Parkway and Skyline Drive.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Lynchburg",
                category: "charger",
                lat: 37.3540,
                lng: -79.1784,
                location: "3901 Wards Rd, Lynchburg, VA",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Strategic stop on US-29 corridor.",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Tysons Corner",
                category: "charger",
                lat: 38.9187,
                lng: -77.2311,
                location: "8357 Leesburg Pike, Tysons, VA",
                description: "Electrify America DC fast chargers, up to 350kW. Major Northern Virginia hub near I-495 Beltway.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Newark",
                category: "charger",
                lat: 40.7282,
                lng: -74.1724,
                location: "450 Broad St, Newark, NJ",
                description: "Tesla Supercharger with 20 stalls, up to 250kW. Key New Jersey Turnpike corridor stop.",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Edison",
                category: "charger",
                lat: 40.5187,
                lng: -74.4121,
                location: "1931 Route 27, Edison, NJ",
                description: "Electrify America DC fast chargers at Walmart, up to 350kW. Central New Jersey charging hub.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            },
            {
                name: "Tesla Supercharger - Milford",
                category: "charger",
                lat: 41.2223,
                lng: -73.0648,
                location: "1201 Boston Post Rd, Milford, CT",
                description: "Tesla Supercharger with 12 stalls, up to 250kW. Convenient I-95 corridor stop between NY and MA.",
                url: "https://www.tesla.com/findus"
            },
            {
                name: "Electrify America - Hartford",
                category: "charger",
                lat: 41.7410,
                lng: -72.6739,
                location: "495 Flatbush Ave, Hartford, CT",
                description: "Electrify America DC fast chargers, up to 350kW. Central Connecticut charging hub on I-84.",
                url: "https://www.electrifyamerica.com/locate-charger/"
            }
        ];

        // Category icon paths for cluster display
        const categoryIconPaths = {
            brewery: 'assets/images/marker-brewery.svg',
            tastingroom: 'assets/images/marker-tastingroom.svg',
            retailer: 'assets/images/marker-retailer.svg',
            bar: 'assets/images/marker-bar.svg',
            trail: 'assets/images/marker-trail.svg?v=2',
            river: 'assets/images/marker-river.svg?v=2',
            community: 'assets/images/marker-community.svg',
            charger: 'assets/images/marker-charger.svg'
        };

        // Category display order for consistent icon ordering
        const categoryOrder = ['brewery', 'tastingroom', 'retailer', 'bar', 'trail', 'river', 'community', 'charger'];

        // ============================================
        // DYNAMIC VIEWPORT UTILITIES
        // Calculates visible map area accounting for sidebar overlay
        // ============================================

        // Get sidebar width in pixels based on screen size
        function getSidebarWidth() {
            if (window.innerWidth <= 1200) return 0;  // Mobile/tablet - sidebar is below map
            if (window.innerWidth >= 1800) return 500;
            if (window.innerWidth >= 1400) return 460;
            return 420;
        }

        // Get the visible map viewport dimensions (excluding sidebar overlay)
        function getVisibleViewport() {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return { width: window.innerWidth, height: window.innerHeight, offsetX: 0 };

            const rect = mapContainer.getBoundingClientRect();
            const sidebarWidth = getSidebarWidth();

            return {
                width: rect.width - sidebarWidth,  // Visible width (excluding sidebar)
                height: rect.height,
                totalWidth: rect.width,
                sidebarWidth: sidebarWidth,
                offsetX: sidebarWidth / 2  // Offset to center in visible area
            };
        }

        // Convert a lat/lng to the visual center of the visible map area
        // This shifts the center to the right to account for sidebar overlay
        function getOffsetCenter(latLng, zoom) {
            const viewport = getVisibleViewport();
            if (viewport.sidebarWidth === 0) return latLng;  // No offset needed on mobile

            const targetPoint = map.project(latLng, zoom || map.getZoom());
            targetPoint.x -= viewport.offsetX;
            return map.unproject(targetPoint, zoom || map.getZoom());
        }

        // Pan to a location, centering it in the visible map area
        function panToWithOffset(latLng, options = {}) {
            const offsetCenter = getOffsetCenter(latLng);
            map.panTo(offsetCenter, options);
        }

        // Fly to a location, centering it in the visible map area
        function flyToWithOffset(latLng, zoom, options = {}) {
            const offsetCenter = getOffsetCenter(latLng, zoom);
            map.flyTo(offsetCenter, zoom, {
                animate: true,
                duration: 1.0,
                ...options
            });
        }

        // Get padding for fitBounds - account for sidebar floating over map
        // Left padding must be sidebar width + margins + buffer to keep pills visible
        function getSidebarPadding() {
            if (window.innerWidth <= 1200) {
                // Mobile/tablet: extra bottom padding to keep content above "Zoom for detail" button
                return [20, 40, 380, 40]; // [top, right, bottom, left]
            }
            const sidebarWidth = getSidebarWidth();
            const margin = 20; // sidebar left margin
            const buffer = 80; // extra buffer for pill radius
            return [60, 60, 60, sidebarWidth + margin + buffer];
        }

        // Custom fitBounds that treats the visible map area (right of sidebar) as the target
        // Uses paddingTopLeft to offset bounds calculation so markers appear in visible area
        function fitBoundsWithSidebarOffset(bounds, options = {}) {
            const viewport = getVisibleViewport();

            if (viewport.sidebarWidth === 0) {
                // Mobile/tablet: extra bottom padding to keep content above "Zoom for detail" button
                map.fitBounds(bounds, {
                    ...options,
                    paddingTopLeft: L.point(40, 20),
                    paddingBottomRight: L.point(40, 140)
                });
                return;
            }

            // Calculate padding dynamically based on actual sidebar width
            // Pill clusters can be 150-200px wide, so we need generous padding
            const leftPadding = viewport.sidebarWidth + 120; // sidebar + margin + pill buffer
            const rightPadding = 140; // buffer for pill clusters on right edge
            const topPadding = 80;
            const bottomPadding = 140; // space for zoom hint button

            map.fitBounds(bounds, {
                ...options,
                paddingTopLeft: L.point(leftPadding, topPadding),
                paddingBottomRight: L.point(rightPadding, bottomPadding)
            });
        }

        // Create unified marker cluster group with multi-category support
        function createUnifiedClusterIcon(cluster) {
            const markers = cluster.getAllChildMarkers();
            const categories = new Set();

            markers.forEach(marker => {
                if (marker.options.category) {
                    categories.add(marker.options.category);
                }
            });

            const uniqueCategories = categoryOrder.filter(cat => categories.has(cat));
            const count = cluster.getChildCount();

            // Consistent icon size across all pills - 28px standard for all icons
            const standardIconSize = '28px';

            function getIconSize(cat) {
                return standardIconSize;
            }

            if (uniqueCategories.length === 1) {
                // Single category - show icon + count in pill format
                const cat = uniqueCategories[0];
                const iconSize = getIconSize(cat);

                const pillStyle = 'position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:inline-flex;align-items:center;gap:5px;padding:8px 12px;background:#FFFDF7;border-radius:23px;box-shadow:0 2px 8px rgba(0,0,0,0.25);border:2px solid #ffc72d;white-space:nowrap;';
                const countStyle = 'font-family:new-spirit,serif;font-weight:700;font-size:14px;color:#2D2A26;background:#ffc72d;padding:4px 10px;border-radius:12px;margin-left:3px;min-width:24px;text-align:center;';
                const iconHtml = '<img src="' + categoryIconPaths[cat] + '" style="width:' + iconSize + ';height:' + iconSize + ';flex-shrink:0;object-fit:contain;display:block;" alt="">';

                const width = 120;
                const height = 50;

                return L.divIcon({
                    html: '<div style="' + pillStyle + '">' + iconHtml + '<span style="' + countStyle + '">' + count + '</span></div>',
                    className: 'marker-cluster-pill',
                    iconSize: L.point(width, height),
                    iconAnchor: L.point(width / 2, height / 2)
                });
            } else {
                // Multiple categories - show icons for each type with consistent size
                const iconsHtml = uniqueCategories.slice(0, 4).map(cat => {
                    const iconSize = getIconSize(cat);
                    return '<img src="' + categoryIconPaths[cat] + '" style="width:' + iconSize + ';height:' + iconSize + ';flex-shrink:0;object-fit:contain;display:block;" alt="">';
                }).join('');

                const numIcons = Math.min(uniqueCategories.length, 4);
                // Calculate dimensions based on content - generous sizing to contain pill
                const width = (numIcons * 35) + 80;
                const height = 55;

                // Use inline styles to guarantee rendering - absolutely positioned to center in container
                const pillStyle = 'position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:inline-flex;align-items:center;gap:5px;padding:8px 12px;background:#FFFDF7;border-radius:23px;box-shadow:0 2px 8px rgba(0,0,0,0.25);border:2px solid #ffc72d;white-space:nowrap;';
                const countStyle = 'font-family:new-spirit,serif;font-weight:700;font-size:14px;color:#2D2A26;background:#ffc72d;padding:4px 10px;border-radius:12px;margin-left:3px;min-width:24px;text-align:center;';

                return L.divIcon({
                    html: '<div style="' + pillStyle + '">' + iconsHtml + '<span style="' + countStyle + '">' + count + '</span></div>',
                    className: 'marker-cluster-pill',
                    iconSize: L.point(width, height),
                    iconAnchor: L.point(width / 2, height / 2)
                });
            }
        }

        const clusterOptions = {
            showCoverageOnHover: false,
            spiderfyOnMaxZoom: true,  // Spider out only when can't zoom any further
            zoomToBoundsOnClick: false,  // We'll handle this manually with sidebar padding
            disableClusteringAtZoom: 17,  // Separate markers at zoom 17+
            maxClusterRadius: 160,  // Larger radius to prevent overlapping pill clusters
            iconCreateFunction: createUnifiedClusterIcon,
            spiderLegPolylineOptions: { weight: 2, color: '#ffc72d', opacity: 0.6 },
            spiderfyDistanceMultiplier: 1.8,  // More spread out spider
            animate: true,
            animateAddingMarkers: false  // Disable fly-in animation on initial load
        };

        // Create a unified cluster group for all main markers
        const unifiedCluster = L.markerClusterGroup(clusterOptions);


        // Store markers by category for filtering
        const markersByCategory = {
            brewery: [],
            tastingroom: [],
            retailer: [],
            bar: [],
            trail: [],
            river: [],
            community: [],
            charger: []
        };

        // Track which categories are visible
        const visibleCategories = {
            brewery: true,
            tastingroom: true,
            retailer: true,
            bar: true,
            trail: true,
            river: true,
            community: true,
            charger: false
        };

        // Add markers to respective layers
        sunshineSpots.forEach(spot => {
            const icon = createMarkerIcon(spot.category);

            // Build popup content with enhanced information for community partners
            let popupContent = '';

            // Add image if available
            if (spot.image) {
                popupContent += `<img src="${spot.image}" alt="${spot.name}" class="popup-image" loading="lazy">`;
            }

            const categoryLabels = {
                'brewery': 'Brewery',
                'tastingroom': 'Tasting Room',
                'retailer': 'Retailer',
                'bar': 'Bar & Restaurant',
                'trail': 'Trail',
                'river': 'River Put-in',
                'community': 'Community Partner',
                'charger': 'DC Fast Charger'
            };
            const categoryLabel = categoryLabels[spot.category] || spot.category;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.location)}`;
            popupContent += `
                <div class="popup-category ${spot.category}">${categoryLabel}</div>
                <div class="popup-title">${spot.name}</div>
                <div class="popup-description">${spot.description}</div>
                <div class="popup-location"><a href="${mapsUrl}" target="_blank" rel="noopener noreferrer">${spot.location}</a></div>
            `;

            // Add impact story for community partners
            if (spot.impact) {
                popupContent += `
                    <div class="popup-impact">
                        <div class="popup-impact-label">Impact Story</div>
                        ${spot.impact}
                    </div>
                `;
            }

            // Add buttons
            if (spot.url || spot.donateUrl) {
                popupContent += '<div class="popup-buttons">';
                if (spot.url) {
                    popupContent += `<a href="${spot.url}" target="_blank" rel="noopener noreferrer" class="popup-btn popup-btn-primary">Learn More</a>`;
                }
                if (spot.donateUrl) {
                    popupContent += `<a href="${spot.donateUrl}" target="_blank" rel="noopener noreferrer" class="popup-btn popup-btn-secondary">Donate</a>`;
                }
                popupContent += '</div>';
            }

            const marker = L.marker([spot.lat, spot.lng], { icon: icon, category: spot.category })
                .bindPopup(popupContent, { maxWidth: 320, closeOnClick: false, autoClose: true });

            // Store marker by category
            markersByCategory[spot.category].push(marker);

            // Add to unified cluster (chargers start hidden, added when route is shown)
            if (spot.category !== 'charger') {
                unifiedCluster.addLayer(marker);
            }
        });

        // Add unified cluster to map
        unifiedCluster.addTo(map);

        // Fit initial view to show all markers with sidebar offset
        // Use setTimeout to ensure cluster is fully rendered before calculating bounds
        setTimeout(function() {
            const clusterBounds = unifiedCluster.getBounds();
            if (clusterBounds.isValid()) {
                // Adapt maxZoom based on viewport - smaller screens need to zoom out more
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                let initialMaxZoom = 6;  // Default for large/wide screens

                if (viewportWidth < 768 || viewportHeight < 600) {
                    initialMaxZoom = 4;  // Small phones and narrow/short viewports
                } else if (viewportWidth < 1200) {
                    initialMaxZoom = 5;  // Tablets and medium screens
                }

                fitBoundsWithSidebarOffset(clusterBounds, {
                    animate: false,  // No animation on initial load
                    maxZoom: initialMaxZoom,
                    padding: [40, 40]
                });
            }
            // Mark initial load complete after a short delay to allow zoom events to finish
            setTimeout(function() {
                window.isInitialLoad = false;
            }, 200);
        }, 100);

        // Custom cluster click handler - zoom with sidebar padding
        unifiedCluster.on('clusterclick', function(e) {
            const cluster = e.layer;
            const currentZoom = map.getZoom();
            const childCount = cluster.getChildCount();

            // If already at high zoom or few markers, spiderfy immediately
            if (currentZoom >= 15 || (currentZoom >= 12 && childCount <= 5)) {
                cluster.spiderfy();
                return;
            }

            const bounds = cluster.getBounds();

            // Zoom to show all markers in the cluster within safe area
            // Use fitBoundsWithSidebarOffset which respects the sidebar
            fitBoundsWithSidebarOffset(bounds, {
                animate: true,
                duration: 0.6,
                easeLinearity: 0.25,
                maxZoom: 15,  // Don't zoom in too far, let user click again if needed
                padding: [60, 60]  // Generous padding to keep markers visible
            });
        });


        // Function to refresh the unified cluster based on visible categories
        function refreshUnifiedCluster() {
            unifiedCluster.clearLayers();
            Object.entries(markersByCategory).forEach(([category, markers]) => {
                if (visibleCategories[category]) {
                    markers.forEach(marker => unifiedCluster.addLayer(marker));
                }
            });
        }

        // Update counts
        function updateCounts() {
            document.getElementById('count-breweries').textContent = sunshineSpots.filter(s => s.category === 'brewery').length;
            document.getElementById('count-tastingrooms').textContent = sunshineSpots.filter(s => s.category === 'tastingroom').length;
            document.getElementById('count-retailers').textContent = sunshineSpots.filter(s => s.category === 'retailer').length;
            document.getElementById('count-bars').textContent = sunshineSpots.filter(s => s.category === 'bar').length;
            document.getElementById('count-trails').textContent = sunshineSpots.filter(s => s.category === 'trail').length;
            document.getElementById('count-rivers').textContent = sunshineSpots.filter(s => s.category === 'river').length;
            document.getElementById('count-community').textContent = sunshineSpots.filter(s => s.category === 'community').length;
            document.getElementById('count-chargers').textContent = sunshineSpots.filter(s => s.category === 'charger').length;
        }
        updateCounts();

        // Filter functionality - using unified cluster
        document.getElementById('filter-breweries').addEventListener('change', function() {
            visibleCategories.brewery = this.checked;
            refreshUnifiedCluster();
        });

        document.getElementById('filter-tastingrooms').addEventListener('change', function() {
            visibleCategories.tastingroom = this.checked;
            refreshUnifiedCluster();
        });

        document.getElementById('filter-retailers').addEventListener('change', function() {
            visibleCategories.retailer = this.checked;
            refreshUnifiedCluster();
        });

        document.getElementById('filter-bars').addEventListener('change', function() {
            visibleCategories.bar = this.checked;
            refreshUnifiedCluster();
        });

        document.getElementById('filter-trails').addEventListener('change', function() {
            visibleCategories.trail = this.checked;
            refreshUnifiedCluster();
        });

        document.getElementById('filter-rivers').addEventListener('change', function() {
            visibleCategories.river = this.checked;
            refreshUnifiedCluster();
        });

        document.getElementById('filter-community').addEventListener('change', function() {
            visibleCategories.community = this.checked;
            refreshUnifiedCluster();
        });

        document.getElementById('filter-chargers').addEventListener('change', function() {
            visibleCategories.charger = this.checked;

            // If user tries to enable chargers, also enable the route (chargers are only relevant along the route)
            if (this.checked) {
                const routeCheckbox = document.getElementById('toggle-scenic-route');
                if (routeCheckbox && !routeCheckbox.checked) {
                    routeCheckbox.checked = true;
                    // Trigger the change event to load the route
                    routeCheckbox.dispatchEvent(new Event('change'));
                }
            }

            refreshUnifiedCluster();
        });

        // Store user's map location for location-aware zooming
        let userMapLocation = null;

        // Add zoom control to bottom-right
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Request geolocation immediately on page load for location-aware zooming
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userMapLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('User location acquired for zoom guidance:', userMapLocation);
                },
                () => { console.log('Geolocation denied or failed'); },
                { enableHighAccuracy: false, timeout: 10000 }
            );
        }

        // Override zoom-in button to drift toward user's physical location
        setTimeout(() => {
            const zoomInBtn = document.querySelector('.leaflet-control-zoom-in');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', (e) => {
                    // If we have user location, guide zoom toward it
                    if (userMapLocation) {
                        e.stopPropagation();
                        e.preventDefault();
                        const currentZoom = map.getZoom();
                        const currentCenter = map.getCenter();

                        // More aggressive drift toward user location - noticeable on first click
                        // Use 45% movement per click for clear direction while staying smooth
                        const newLat = currentCenter.lat + (userMapLocation.lat - currentCenter.lat) * 0.45;
                        const newLng = currentCenter.lng + (userMapLocation.lng - currentCenter.lng) * 0.45;

                        map.setView([newLat, newLng], currentZoom + 0.5, {
                            animate: true,
                            duration: 0.4
                        });
                    }
                }, true);
            }
        }, 100);

        // Fit map to show all markers with smooth animation
        const allMarkers = sunshineSpots.map(s => [s.lat, s.lng]);
        fitBoundsWithSidebarOffset(allMarkers, {
            animate: true,
            duration: 1.0
        });

        // Enable marker animations after initial load completes
        setTimeout(() => {
            unifiedCluster.options.animate = true;
            unifiedCluster.options.animateAddingMarkers = true;
        }, 1500);

        // Zoom hint - hide when zoomed in past level 9
        const zoomHint = document.getElementById('zoom-hint');
        const zoomHintText = zoomHint.querySelector('span');
        const zoomHintOriginalText = zoomHintText.textContent;

        // Wave animation on hover for zoom hint (faster timing)
        zoomHint.addEventListener('mouseenter', () => {
            createWaveAnimation(zoomHintText, 0.015);
        });
        zoomHint.addEventListener('mouseleave', () => {
            resetWaveAnimation(zoomHintText, zoomHintOriginalText);
        });

        // Click handler - find nearest Sunshine Spot
        zoomHint.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            zoomHintText.textContent = 'Finding you...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    // Store user location for zoom button guidance
                    userMapLocation = { lat: userLat, lng: userLng };

                    // Haversine formula for accurate geographic distance calculation
                    function haversineDistance(lat1, lng1, lat2, lng2) {
                        const R = 6371; // Earth's radius in kilometers
                        const dLat = (lat2 - lat1) * Math.PI / 180;
                        const dLng = (lng2 - lng1) * Math.PI / 180;
                        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        return R * c; // Distance in kilometers
                    }

                    // Find the nearest spot
                    let nearestSpot = null;
                    let nearestDistance = Infinity;

                    sunshineSpots.forEach(spot => {
                        const distance = haversineDistance(userLat, userLng, spot.lat, spot.lng);
                        if (distance < nearestDistance) {
                            nearestDistance = distance;
                            nearestSpot = spot;
                        }
                    });

                    if (nearestSpot) {
                        // Create bounds that include user location and nearest spot
                        const bounds = L.latLngBounds([
                            [userLat, userLng],
                            [nearestSpot.lat, nearestSpot.lng]
                        ]);

                        // Zoom to show both with padding
                        fitBoundsWithSidebarOffset(bounds, {
                            maxZoom: 12,
                            animate: true,
                            duration: 1.0
                        });

                        // Add a temporary marker for user location
                        const userMarker = L.circleMarker([userLat, userLng], {
                            radius: 10,
                            fillColor: '#4285F4',
                            color: '#ffffff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(map);

                        // Pulse animation for user location
                        const pulseMarker = L.circleMarker([userLat, userLng], {
                            radius: 20,
                            fillColor: '#4285F4',
                            color: '#4285F4',
                            weight: 2,
                            opacity: 0.5,
                            fillOpacity: 0.2
                        }).addTo(map);

                        // Remove user markers after 10 seconds
                        setTimeout(() => {
                            map.removeLayer(userMarker);
                            map.removeLayer(pulseMarker);
                        }, 10000);
                    }

                    zoomHintText.textContent = zoomHintOriginalText;
                    zoomHint.classList.add('hidden');
                },
                (error) => {
                    zoomHintText.textContent = zoomHintOriginalText;
                    alert('Unable to get your location. Please try zooming manually.');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });

        // Track if user has interacted with zoom controls
        let userHasZoomed = false;
        window.isInitialLoad = true;  // Flag to prevent initial fitBounds from hiding zoom hint

        // Hide zoom hint on any zoom interaction (but not during initial load)
        map.on('zoomstart', function() {
            if (window.isInitialLoad) return;  // Don't hide during initial view fit
            userHasZoomed = true;
            zoomHint.classList.add('hidden');
        });

        map.on('zoomend', function() {
            // Keep hidden if user has interacted, otherwise show based on zoom level
            if (userHasZoomed || map.getZoom() >= 9) {
                zoomHint.classList.add('hidden');
            }
        });

        // Hide zoom hint when Leaflet zoom buttons are clicked
        setTimeout(() => {
            const zoomInBtn = document.querySelector('.leaflet-control-zoom-in');
            const zoomOutBtn = document.querySelector('.leaflet-control-zoom-out');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    userHasZoomed = true;
                    zoomHint.classList.add('hidden');
                });
            }
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    userHasZoomed = true;
                    zoomHint.classList.add('hidden');
                });
            }
        }, 100); // Small delay to ensure Leaflet controls are rendered

        // Save map position before popup opens, restore on close (mobile only)
        let savedMapState = null;

        map.on('popupopen', function(e) {
            // Only save state on mobile/tablet
            if (window.innerWidth <= 1200) {
                savedMapState = {
                    center: map.getCenter(),
                    zoom: map.getZoom()
                };
            }
        });

        map.on('popupclose', function(e) {
            // Only restore state on mobile/tablet
            if (window.innerWidth <= 1200 && savedMapState) {
                map.setView(savedMapState.center, savedMapState.zoom, {
                    animate: true,
                    duration: 0.5
                });
                savedMapState = null;
            }
        });

        // State filtering for community partners
        let currentStateFilter = 'all';
        const stateButtons = document.querySelectorAll('.state-btn');

        // Create a Map to store marker-to-spot associations for state filtering
        const markerToSpotMap = new Map();
        const communitySpots = sunshineSpots.filter(s => s.category === 'community');
        markersByCategory.community.forEach((marker, index) => {
            if (communitySpots[index]) {
                markerToSpotMap.set(marker, communitySpots[index]);
            }
        });

        // Initialize allCommunityMarkers immediately to prevent race conditions
        window.allCommunityMarkers = [...markersByCategory.community];

        // Debounce for rapid filter changes
        let filterDebounceTimer = null;
        let isFiltering = false;

        function filterByState(state) {
            // Debounce rapid filter changes
            if (filterDebounceTimer) {
                clearTimeout(filterDebounceTimer);
            }

            // Update button states immediately for responsive UI
            stateButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.state === state) {
                    btn.classList.add('active');
                }
            });

            filterDebounceTimer = setTimeout(() => {
                // Prevent concurrent filter operations
                if (isFiltering) return;
                isFiltering = true;

                currentStateFilter = state;

                // Filter community markers by state using the marker-to-spot map
                if (state === 'all') {
                    markersByCategory.community = [...window.allCommunityMarkers];
                } else {
                    markersByCategory.community = window.allCommunityMarkers.filter(marker => {
                        const spot = markerToSpotMap.get(marker);
                        return spot && spot.state === state;
                    });
                }

                // Refresh the unified cluster
                refreshUnifiedCluster();

                // Update community count badge
                const filteredCount = markersByCategory.community.length;
                document.getElementById('count-community').textContent = filteredCount;

                // If filtering to a specific state, zoom to show all markers in that state
                if (state !== 'all') {
                    // On mobile, scroll to the map first (#12)
                    if (window.innerWidth <= 768) {
                        const mapElement = document.getElementById('map');
                        if (mapElement) {
                            // Use setTimeout to ensure scroll happens after any DOM updates
                            setTimeout(() => {
                                mapElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 100);
                        }
                    }

                    // Get ALL markers in the selected state (not just community partners)
                    const stateMarkers = sunshineSpots.filter(s => s.state === state);
                    if (stateMarkers.length > 0) {
                        const bounds = stateMarkers.map(s => [s.lat, s.lng]);
                        // Zoom to fit all markers in the state - let bounds determine appropriate zoom
                        fitBoundsWithSidebarOffset(bounds, {
                            animate: true,
                            duration: 0.8,
                            maxZoom: 13,
                            padding: [80, 80]
                        });
                    }

                    // Hide zoom hint when filtering to a specific state
                    const zoomHintEl = document.getElementById('zoom-hint');
                    if (zoomHintEl) {
                        zoomHintEl.style.display = 'none';
                    }
                }

                isFiltering = false;
            }, 50); // 50ms debounce
        }

        // Add click handlers to state buttons
        stateButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterByState(btn.dataset.state);
            });
        });

        // ============================================
        // LIVE IMPACT METRICS - Based on actual Lawson's data
        // ============================================
        // Data sources: Lawson's Impact Reports, Brewbound, CraftBrewingBusiness
        //
        // DONATIONS MODEL (verified data points):
        // - Program started: 2018
        // - 2021: $239,832 donated (confirmed)
        // - 2022: $290,000 donated (confirmed)
        // - By mid-2022: $926,352 cumulative
        // - By mid-2023: $1.25M cumulative
        // - By end 2023: $2M+ cumulative
        // - Current (2026): ~$3M to 496 nonprofits
        // - Growth: Started ~$150k/year, now ~$520k/year
        //
        // SOLAR MODEL (verified data points):
        // - 2019: 43kW rooftop array installed (52,000 kWh/year)
        // - 2022: 215kW solar canopy added (495 panels)
        // - 2023: Additional arrays = 570,000 kWh/year total
        // - 100% solar offset achieved
        //
        // WASTE: 97.2% diversion achieved 2024
        // ============================================

        const impactMetrics = {
            donations: {
                // Base: $3,000,000 as of Jan 1, 2026 (to 496 nonprofits since 2018)
                baseDate: new Date('2026-01-01T00:00:00'),
                baseAmount: 3000000,
                // Current annual rate: ~$520,000/year, growing at 5% annually
                annualRate: 520000,
                annualGrowthRate: 0.05,
                // 10-year projection: ~$9.5M by 2036
            },
            solar: {
                // Cumulative kWh since 2019:
                // 2019-2021: 52,000 kWh/year  3 = 156,000
                // 2022: ~150,000 (canopy added mid-year)
                // 2023-2025: 570,000 kWh/year  3 = 1,710,000
                // Total by Jan 1, 2026: ~2,016,000 kWh
                baseDate: new Date('2026-01-01T00:00:00'),
                baseAmount: 2016000,
                // Current annual rate: 570,000 kWh/year
                annualRate: 570000,
                // Slight efficiency gains: 2% per year
                annualGrowthRate: 0.02,
                // 10-year projection: ~8.5M kWh cumulative by 2036
            },
            waste: {
                // 97.2% waste diversion (achieved 2024)
                // Projecting slight improvement to 98.5% by 2036
                baseDate: new Date('2026-01-01T00:00:00'),
                baseValue: 97.2,
                targetValue: 98.5,
                yearsToTarget: 10
            }
        };

        function calculateCurrentDonations() {
            const now = new Date();
            const msElapsed = now - impactMetrics.donations.baseDate;
            const yearsElapsed = msElapsed / (1000 * 60 * 60 * 24 * 365.25);

            if (yearsElapsed < 0) {
                // Before base date, calculate backwards
                return impactMetrics.donations.baseAmount;
            }

            // Calculate with compound growth on the rate
            let totalAdded = 0;
            const baseRate = impactMetrics.donations.annualRate;
            const growth = impactMetrics.donations.annualGrowthRate;

            // For continuous calculation, integrate the growth
            // Simplified: use average rate for the period
            const avgRate = baseRate * (1 + growth * yearsElapsed / 2);
            totalAdded = avgRate * yearsElapsed;

            return impactMetrics.donations.baseAmount + totalAdded;
        }

        function calculateCurrentSolar() {
            const now = new Date();
            const msElapsed = now - impactMetrics.solar.baseDate;
            const yearsElapsed = msElapsed / (1000 * 60 * 60 * 24 * 365.25);

            if (yearsElapsed < 0) {
                return impactMetrics.solar.baseAmount;
            }

            // Calculate with slight efficiency gains
            const baseRate = impactMetrics.solar.annualRate;
            const growth = impactMetrics.solar.annualGrowthRate;
            const avgRate = baseRate * (1 + growth * yearsElapsed / 2);
            const totalAdded = avgRate * yearsElapsed;

            return impactMetrics.solar.baseAmount + totalAdded;
        }

        function calculateCurrentWaste() {
            const now = new Date();
            const msElapsed = now - impactMetrics.waste.baseDate;
            const yearsElapsed = msElapsed / (1000 * 60 * 60 * 24 * 365.25);

            if (yearsElapsed < 0) {
                return impactMetrics.waste.baseValue;
            }

            // Linear progression toward target
            const progress = Math.min(yearsElapsed / impactMetrics.waste.yearsToTarget, 1);
            const increase = (impactMetrics.waste.targetValue - impactMetrics.waste.baseValue) * progress;

            return impactMetrics.waste.baseValue + increase;
        }

        // Smooth animated counter that transitions to a target value
        function animateToValue(element, targetValue, duration, formatFn) {
            const startValue = parseFloat(element.textContent.replace(/[,$]/g, '')) || 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = startValue + (targetValue - startValue) * easeOutQuart;

                element.textContent = formatFn(currentValue);

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Format functions - show cents/decimals for live ticker effect
        const formatDollars = (val) => val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatKwh = (val) => val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatPercent = (val) => val.toFixed(1);

        // Live ticker update
        let metricsStarted = false;
        let tickerInterval = null;

        function startLiveTicker() {
            if (metricsStarted) return;
            metricsStarted = true;

            const donationsEl = document.getElementById('donations-counter');
            const solarEl = document.getElementById('solar-counter');

            // Initial animation from 0 to current values
            const currentDonations = calculateCurrentDonations();
            const currentSolar = calculateCurrentSolar();

            animateToValue(donationsEl, currentDonations, 2500, formatDollars);
            animateToValue(solarEl, currentSolar, 2500, formatKwh);

            // After initial animation, start live updates every 100ms
            // This makes the counters tick up in real-time showing ongoing impact
            let lastDonations = currentDonations;
            let lastSolar = currentSolar;

            setTimeout(() => {
                tickerInterval = setInterval(() => {
                    const newDonations = calculateCurrentDonations();
                    const newSolar = calculateCurrentSolar();

                    if (donationsEl) {
                        donationsEl.textContent = formatDollars(newDonations);
                        lastDonations = newDonations;
                    }
                    if (solarEl) {
                        solarEl.textContent = formatKwh(newSolar);
                        lastSolar = newSolar;
                    }
                }, 100);
            }, 2600);
        }

        // Use Intersection Observer to trigger animation when visible
        const metricsSection = document.querySelector('.metrics-section');
        if (metricsSection) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        startLiveTicker();
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.3 });

            observer.observe(metricsSection);
        }

        // ============================================
        // SCENIC ROUTE OVERLAYS
        // The Sunshine Trail: Asheville, NC to Waitsfield, VT
        // ============================================

        // Define scenic route coordinates
        // Blue Ridge Parkway: Asheville, NC (Milepost 382) to Waynesboro, VA (Milepost 0)
        const blueRidgeParkway = [
            [35.5951, -82.5515],  // Asheville, NC
            [35.6810, -82.4920],  // Craggy Gardens
            [35.7972, -82.9569],  // Max Patch area
            [35.9150, -82.2760],  // Mount Mitchell area
            [36.1064, -82.1098],  // Roan Mountain
            [36.2987, -81.6904],  // Blowing Rock
            [36.3396, -81.4996],  // Boone area
            [36.5569, -80.9897],  // Fancy Gap
            [36.7180, -80.4070],  // Mabry Mill
            [37.0889, -80.1869],  // Roanoke area
            [37.2390, -80.0328],  // McAfee Knob area
            [37.4530, -79.6190],  // Natural Bridge
            [37.6600, -79.3400],  // Lexington area
            [37.8600, -79.0800],  // Staunton area
            [38.0330, -78.8690],  // Waynesboro (BRP northern terminus)
        ];

        // Skyline Drive: Waynesboro (Rockfish Gap) to Front Royal
        const skylineDrive = [
            [38.0330, -78.8690],  // Rockfish Gap (southern entrance)
            [38.1900, -78.7500],  // Swift Run Gap
            [38.3000, -78.6800],  // Big Meadows
            [38.4500, -78.5500],  // Skyland
            [38.5533, -78.3161],  // Old Rag nearby
            [38.6300, -78.3800],  // Thornton Gap
            [38.7500, -78.2800],  // Dickey Ridge
            [38.9030, -78.1940],  // Front Royal (northern terminus)
        ];

        // Connector Route: Front Royal, VA to Bennington, VT via I-81 / I-87 / US-7
        const connectorRoute = [
            [38.9030, -78.1940],  // Front Royal, VA
            [39.1850, -77.5100],  // Winchester, VA
            [39.4580, -77.4000],  // Hagerstown, MD
            [39.7600, -77.5700],  // Chambersburg, PA
            [40.2700, -76.8800],  // Harrisburg, PA
            [40.5800, -75.4900],  // Allentown area
            [41.0400, -74.1300],  // Northern NJ
            [41.7000, -73.9200],  // Poughkeepsie, NY
            [42.2500, -73.7900],  // Hudson, NY
            [42.6500, -73.7500],  // Albany area
            [42.8800, -73.2000],  // Bennington, VT
        ];

        // Vermont Route 100: Wilmington to Waitsfield
        const route100Vermont = [
            [42.8800, -73.2000],  // Bennington (connector)
            [42.8678, -72.8711],  // Wilmington
            [43.1597, -72.7792],  // Jamaica
            [43.2600, -72.7400],  // Londonderry
            [43.3890, -72.7000],  // Weston
            [43.4700, -72.7300],  // Ludlow
            [43.5500, -72.7100],  // Plymouth
            [43.6200, -72.8000],  // Killington
            [43.7100, -72.8200],  // Pittsfield
            [43.8800, -72.8400],  // Rochester / Hancock
            [43.9700, -72.8400],  // Granville (Moss Glen Falls)
            [44.0800, -72.8200],  // Warren
            [44.1852, -72.8288],  // Waitsfield (Lawson's HQ!)
            [44.3856, -72.7469],  // Waterbury (Cold Hollow)
            [44.4654, -72.6874],  // Stowe
        ];

        // Create route layers
        const routeLayers = L.layerGroup();

        const blueRidgePolyline = L.polyline(blueRidgeParkway, {
            color: '#2E86AB',
            weight: 5,
            opacity: 0.85,
            smoothFactor: 1.5,
            dashArray: null
        }).bindPopup('<strong>Blue Ridge Parkway</strong><br>469 miles of America\'s most scenic mountain road, connecting Great Smoky Mountains to Shenandoah National Park.');

        const skylinePolyline = L.polyline(skylineDrive, {
            color: '#7B68EE',
            weight: 5,
            opacity: 0.85,
            smoothFactor: 1.5,
            dashArray: null
        }).bindPopup('<strong>Skyline Drive</strong><br>105 miles through Shenandoah National Park with 75 scenic overlooks and stunning Blue Ridge views.');

        const connectorPolyline = L.polyline(connectorRoute, {
            color: '#888888',
            weight: 3,
            opacity: 0.6,
            smoothFactor: 1.5,
            dashArray: '10, 10'
        }).bindPopup('<strong>Connector Route</strong><br>Interstate and highway connection from Shenandoah to southern Vermont via the Hudson Valley.');

        const route100Polyline = L.polyline(route100Vermont, {
            color: '#228B22',
            weight: 5,
            opacity: 0.85,
            smoothFactor: 1.5,
            dashArray: null
        }).bindPopup('<strong>Vermont Route 100</strong><br>217 miles through the Green Mountains - Vermont\'s "Main Street" and the best fall foliage drive in New England.');

        // Add all routes to the layer group
        routeLayers.addLayer(blueRidgePolyline);
        routeLayers.addLayer(skylinePolyline);
        routeLayers.addLayer(connectorPolyline);
        routeLayers.addLayer(route100Polyline);

        // Toggle scenic route visibility
        const routeToggle = document.getElementById('toggle-scenic-route');
        const routeLegend = document.getElementById('route-legend');
        const chargerFilter = document.getElementById('filter-chargers');
        const chargerFilterItem = chargerFilter.closest('.filter-item');

        // Initially disable charger filter (route not shown)
        chargerFilter.checked = false;
        chargerFilter.disabled = true;
        chargerFilterItem.style.opacity = '0.5';
        chargerFilterItem.title = 'Enable "Show The Sunshine Trail Route" to see DC Fast Chargers';

        // Email modal timer variables (defined here so they're available in the handler)
        let emailModalTimer = null;
        const emailModalShownKey = 'sunshineTrailEmailModalShown';
        let emailModalShownEarly = localStorage.getItem(emailModalShownKey) === 'true';

        routeToggle.addEventListener('change', function() {
            const zoomHintEl = document.getElementById('zoom-hint');
            const routeToggleContainer = document.getElementById('route-toggle-container');

            // Close search when toggling route
            if (window.collapseSearch) window.collapseSearch();

            if (this.checked) {
                // Show loading spinner FIRST - let it render before heavy operations
                routeToggleContainer.classList.add('loading');

                // Start email modal timer (30 seconds after route is shown)
                if (!emailModalShownEarly) {
                    const emailModal = document.getElementById('email-modal');
                    emailModalTimer = setTimeout(() => {
                        if (emailModal && !emailModalShownEarly) {
                            emailModal.classList.add('visible');
                            emailModalShownEarly = true;
                            localStorage.setItem(emailModalShownKey, 'true');
                        }
                    }, 30000);
                }

                // Use requestAnimationFrame + setTimeout to ensure spinner renders before heavy operations
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        map.addLayer(routeLayers);
                        routeLegend.style.display = 'flex';

                        // Hide zoom hint when route is shown
                        if (zoomHintEl) zoomHintEl.style.display = 'none';

                        // Show chargers when route is shown (add to unified cluster)
                        visibleCategories.charger = true;
                        chargerFilter.checked = true;
                        chargerFilter.disabled = false;
                        chargerFilterItem.style.opacity = '1';
                        chargerFilterItem.title = '';
                        refreshUnifiedCluster();

                        // Animate to show full route with extra padding for wide cluster pills
                        const fullRoute = [
                            ...blueRidgeParkway,
                            ...skylineDrive,
                            ...connectorRoute,
                            ...route100Vermont
                        ];
                        const sidebarWidth = getSidebarWidth();

                        // Use different padding for mobile vs desktop
                        if (window.innerWidth <= 768) {
                            map.fitBounds(fullRoute, {
                                animate: true,
                                duration: 1.0,
                                padding: [50, 30]
                            });
                        } else {
                            map.fitBounds(fullRoute, {
                                animate: true,
                                duration: 1.0,
                                paddingTopLeft: L.point(sidebarWidth + 180, 100),
                                paddingBottomRight: L.point(250, 100)
                            });
                        }

                        // Hide spinner after map operations complete
                        setTimeout(() => {
                            routeToggleContainer.classList.remove('loading');
                        }, 800);
                    }, 16); // One frame delay after rAF ensures paint happens first
                });
            } else {
                // Clear email modal timer if route is hidden
                if (emailModalTimer) {
                    clearTimeout(emailModalTimer);
                    emailModalTimer = null;
                }

                // Show loading spinner FIRST - let it render before heavy operations
                routeToggleContainer.classList.add('loading');

                // Use requestAnimationFrame + setTimeout to ensure spinner renders before heavy operations
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        map.removeLayer(routeLayers);
                        routeLegend.style.display = 'none';

                        // Show zoom hint again when route is hidden (if zoom level warrants it)
                        if (zoomHintEl && map.getZoom() < 9) zoomHintEl.style.display = 'block';

                        // Hide chargers when route is hidden (remove from unified cluster)
                        visibleCategories.charger = false;
                        chargerFilter.checked = false;
                        chargerFilter.disabled = true;
                        chargerFilterItem.style.opacity = '0.5';
                        chargerFilterItem.title = 'Enable "Show The Sunshine Trail Route" to see DC Fast Chargers';
                        refreshUnifiedCluster();

                        // Hide spinner after map operations complete
                        setTimeout(() => {
                            routeToggleContainer.classList.remove('loading');
                        }, 400);
                    }, 16); // One frame delay after rAF ensures paint happens first
                });
            }
        });

        // ============================================
        // EMAIL SIGNUP MODAL
        // Timer logic is handled in the routeToggle listener above
        // ============================================
        const emailModal = document.getElementById('email-modal');
        const emailModalClose = document.getElementById('email-modal-close');
        const emailForm = document.getElementById('email-form');

        function hideEmailModal() {
            if (emailModal) {
                emailModal.classList.remove('visible');
            }
        }

        // Close modal handlers
        if (emailModalClose) {
            emailModalClose.addEventListener('click', hideEmailModal);
        }

        if (emailModal) {
            emailModal.addEventListener('click', function(e) {
                if (e.target === emailModal) {
                    hideEmailModal();
                }
            });
        }

        // Get Itinerary button - always shows modal
        const getItineraryBtn = document.getElementById('get-itinerary-btn');
        if (getItineraryBtn) {
            getItineraryBtn.addEventListener('click', function() {
                if (emailModal) {
                    emailModal.classList.add('visible');
                    // Mark as shown so 30-second timer doesn't show it again
                    emailModalShownEarly = true;
                    localStorage.setItem(emailModalShownKey, 'true');
                    if (emailModalTimer) {
                        clearTimeout(emailModalTimer);
                        emailModalTimer = null;
                    }
                }
            });
        }

        // Location checkbox handling with geolocation
        const localCheckbox = document.getElementById('local-checkbox');
        const locationField = document.getElementById('location-field');
        const locationInput = document.getElementById('location-input');
        let userLocation = null;
        let locationDetectionCancelled = false;

        // If user types in the location field, cancel geolocation detection
        if (locationInput) {
            locationInput.addEventListener('input', function() {
                locationDetectionCancelled = true;
                locationInput.classList.remove('detecting');
                locationInput.placeholder = 'Enter your location';
            });
        }

        if (localCheckbox) {
            localCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    locationField.style.display = 'block';
                    locationInput.classList.add('detecting');
                    locationInput.value = '';
                    locationInput.placeholder = 'Detecting your location...';
                    locationDetectionCancelled = false;

                    // Request geolocation
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            async function(position) {
                                // If user started typing, don't overwrite their input
                                if (locationDetectionCancelled) return;

                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                userLocation = { lat, lng };

                                // Reverse geocode using OpenStreetMap Nominatim (free, no API key)
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 10000);

                                try {
                                    const response = await fetch(
                                        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
                                        {
                                            headers: { 'Accept': 'application/json' },
                                            signal: controller.signal
                                        }
                                    );
                                    clearTimeout(timeoutId);

                                    // Check again in case user typed while fetching
                                    if (locationDetectionCancelled) return;

                                    if (!response.ok) {
                                        throw new Error(`HTTP ${response.status}`);
                                    }

                                    const data = await response.json();

                                    // Build a readable address (town, state)
                                    let address = '';
                                    if (data.address) {
                                        const a = data.address;
                                        // Try various location fields Nominatim might return
                                        const city = a.city || a.town || a.village || a.hamlet || a.municipality || a.county || a.suburb || '';
                                        const state = a.state || a.province || a.region || '';
                                        if (city && state) {
                                            address = `${city}, ${state}`;
                                        } else if (city) {
                                            address = city;
                                        } else if (state) {
                                            address = state;
                                        }
                                    }

                                    // Fallback to display_name if we couldn't extract city/state
                                    if (!address && data.display_name) {
                                        // display_name is like "123 Main St, Northfield, Vermont, USA"
                                        // Extract meaningful parts (skip house number, get town/state)
                                        const parts = data.display_name.split(',').map(p => p.trim());
                                        // Find state-like parts and town
                                        if (parts.length >= 2) {
                                            // Usually format is: specific, town, county, state, country
                                            // Try to get town and state (skip first part if it's a number/address)
                                            const filtered = parts.filter(p => !/^\d/.test(p) && p.toLowerCase() !== 'usa' && p.toLowerCase() !== 'united states');
                                            if (filtered.length >= 2) {
                                                address = `${filtered[0]}, ${filtered[1]}`;
                                            } else if (filtered.length === 1) {
                                                address = filtered[0];
                                            }
                                        }
                                    }

                                    locationInput.classList.remove('detecting');
                                    if (address) {
                                        locationInput.value = address;
                                    } else {
                                        locationInput.placeholder = 'Enter your location';
                                    }
                                } catch (error) {
                                    clearTimeout(timeoutId);
                                    if (error.name === 'AbortError') {
                                        console.warn('Reverse geocoding timed out');
                                    } else {
                                        console.error('Geocoding error:', error);
                                    }
                                    if (locationDetectionCancelled) return;
                                    locationInput.classList.remove('detecting');
                                    locationInput.placeholder = 'Enter your location';
                                }
                            },
                            function(error) {
                                if (locationDetectionCancelled) return;
                                console.error('Geolocation error:', error);
                                locationInput.classList.remove('detecting');
                                locationInput.placeholder = 'Enter your location';
                                locationInput.value = '';

                                // Show helpful message based on error
                                if (error.code === error.PERMISSION_DENIED) {
                                    locationInput.placeholder = 'Location denied - enter manually';
                                } else if (error.code === error.POSITION_UNAVAILABLE) {
                                    locationInput.placeholder = 'Enter your location';
                                } else {
                                    locationInput.placeholder = 'Enter your location';
                                }
                            },
                            { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
                        );
                    } else {
                        locationInput.classList.remove('detecting');
                        locationInput.placeholder = 'Enter your location';
                    }
                } else {
                    locationField.style.display = 'none';
                    userLocation = null;
                    locationDetectionCancelled = false;
                }
            });
        }

        // Handle form submission
        if (emailForm) {
            emailForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('name-input').value;
                const email = document.getElementById('email-input').value;
                const localHappenings = document.getElementById('local-checkbox').checked;
                const location = locationInput ? locationInput.value : '';
                // Here you would typically send to your backend or integrate with Lawson's newsletter
                // For demo, we just log and discard the location data
                console.log('Newsletter signup:', { name, email, localHappenings, location, userLocation });
                // Show success message
                emailForm.innerHTML = '<p style="color: var(--deep-brown); font-weight: 600; font-size: 1.1rem;">Thanks, ' + name.split(' ')[0] + '! Check your inbox for your road trip guide. </p>';
                // Close modal after 5 seconds
                setTimeout(hideEmailModal, 5000);
            });
        }

        // ============================================
        // MODAL FIDGET SUN SPINNER
        // Same spinning behavior as header version
        // ============================================
        const fidgetSunModal = document.getElementById('fidget-sun-modal');
        const fidgetModalContainer = fidgetSunModal ? fidgetSunModal.parentElement : null;
        if (fidgetSunModal && fidgetModalContainer) {
            // Prevent clicks on fidget sun from closing the modal
            fidgetModalContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            fidgetSunModal.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            let rotationM = 0;
            let velocityM = 0;
            let isDraggingM = false;
            let lastAngleM = 0;
            let lastTimeM = 0;
            let animationIdM = null;

            function getAngleM(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            function startDragM(e) {
                e.preventDefault();
                e.stopPropagation();
                isDraggingM = true;
                fidgetSunModal.classList.add('spinning');
                const rect = fidgetSunModal.getBoundingClientRect();
                lastAngleM = getAngleM(e, rect);
                lastTimeM = Date.now();
                velocityM = 0;
                if (animationIdM) cancelAnimationFrame(animationIdM);
            }

            function dragM(e) {
                if (!isDraggingM) return;
                e.preventDefault();
                const rect = fidgetSunModal.getBoundingClientRect();
                const currentAngle = getAngleM(e, rect);
                const now = Date.now();
                const dt = Math.max(now - lastTimeM, 1);

                let deltaAngle = currentAngle - lastAngleM;
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                rotationM += deltaAngle * (180 / Math.PI);
                velocityM = (deltaAngle * (180 / Math.PI)) / dt * 35;

                fidgetSunModal.style.transform = `rotate(${rotationM}deg)`;
                lastAngleM = currentAngle;
                lastTimeM = now;
            }

            function endDragM() {
                if (!isDraggingM) return;
                isDraggingM = false;
                fidgetSunModal.classList.remove('spinning');
                animateMomentumM();
            }

            function animateMomentumM() {
                if (Math.abs(velocityM) < 0.005) {
                    velocityM = 0;
                    return;
                }
                rotationM += velocityM;
                velocityM *= 0.9995;
                fidgetSunModal.style.transform = `rotate(${rotationM}deg)`;
                animationIdM = requestAnimationFrame(animateMomentumM);
            }

            fidgetModalContainer.addEventListener('mousedown', startDragM);
            document.addEventListener('mousemove', dragM);
            document.addEventListener('mouseup', endDragM);
            fidgetModalContainer.addEventListener('touchstart', startDragM, { passive: false });
            document.addEventListener('touchmove', dragM, { passive: false });
            document.addEventListener('touchend', endDragM);

            // Emoji burst on click/tap for modal sun
            const emojisM = ['', '', '', '', '', '', ''];
            let clickStartTimeM = 0;
            let clickStartPosM = { x: 0, y: 0 };

            function getClientPosM(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }

            fidgetModalContainer.addEventListener('mousedown', (e) => {
                clickStartTimeM = Date.now();
                const pos = getClientPosM(e);
                clickStartPosM = { x: pos.x, y: pos.y };
            });

            fidgetModalContainer.addEventListener('mouseup', (e) => {
                const elapsed = Date.now() - clickStartTimeM;
                const pos = getClientPosM(e);
                const moved = Math.sqrt(
                    Math.pow(pos.x - clickStartPosM.x, 2) +
                    Math.pow(pos.y - clickStartPosM.y, 2)
                );
                if (elapsed < 300 && moved < 20) {
                    burstEmojisModal(pos);
                }
            });

            fidgetModalContainer.addEventListener('touchstart', (e) => {
                clickStartTimeM = Date.now();
                const pos = getClientPosM(e);
                clickStartPosM = { x: pos.x, y: pos.y };
            });

            fidgetModalContainer.addEventListener('touchend', (e) => {
                const elapsed = Date.now() - clickStartTimeM;
                const endPos = e.changedTouches ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY } : clickStartPosM;
                const moved = Math.sqrt(
                    Math.pow(endPos.x - clickStartPosM.x, 2) +
                    Math.pow(endPos.y - clickStartPosM.y, 2)
                );
                if (elapsed < 300 && moved < 50) {
                    burstEmojisModal(endPos);
                }
            });

            function burstEmojisModal(pos) {
                const rect = fidgetSunModal.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const shuffled = [...emojisM].sort(() => Math.random() - 0.5);
                const burstEmojis = shuffled.slice(0, 3);
                const burstCount = 8 + Math.floor(Math.random() * 5);

                for (let i = 0; i < burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = burstEmojis[i % burstEmojis.length];
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${20 + Math.random() * 16}px;
                        pointer-events: none;
                        z-index: 10002;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    const angle = (Math.PI * 2 * i / burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 200 + Math.random() * 150;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 350;
                    const startTime = performance.now();
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 150 + Math.random() * 150;

                    function animateEmojiModal(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);
                        const scale = 1 + t * 0.4;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmojiModal);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmojiModal);
                }
            }

            // Gentle idle spin for modal sun
            let idleRotationM = 0;
            function idleSpinM() {
                if (!isDraggingM && Math.abs(velocityM) < 0.1) {
                    idleRotationM += 0.05;
                    fidgetSunModal.style.transform = `rotate(${rotationM + idleRotationM}deg)`;
                }
                requestAnimationFrame(idleSpinM);
            }
            idleSpinM();
        }

        // ============================================
        // BUTTON WAVE ANIMATION
        // Stadium-style wave effect on hover
        // ============================================
        function createWaveAnimation(button, delayPerChar = 0.03) {
            const text = button.textContent;
            button.innerHTML = '';
            button.classList.add('wave-text');

            const chars = [...text];
            const totalChars = chars.length;

            // Split text into spans for each character - animate right to left
            chars.forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char === ' ' ? '\u00A0' : char; // Use non-breaking space
                // Reverse the delay: last char starts first, first char starts last
                span.style.animationDelay = `${(totalChars - 1 - index) * delayPerChar}s`;
                button.appendChild(span);
            });
        }

        function resetWaveAnimation(button, originalText) {
            button.classList.remove('wave-text');
            button.textContent = originalText;
        }

        // Apply wave animation to buttons
        document.querySelectorAll('.popup-btn, .beer-section-btn, .get-itinerary-btn, .email-submit, .state-btn').forEach(btn => {
            const originalText = btn.textContent;
            // Faster animation for short buttons (state buttons, email submit)
            const delay = (btn.classList.contains('email-submit') || btn.classList.contains('state-btn')) ? 0.02 : 0.03;

            btn.addEventListener('mouseenter', () => {
                createWaveAnimation(btn, delay);
            });

            btn.addEventListener('mouseleave', () => {
                resetWaveAnimation(btn, originalText);
            });
        });

        // For dynamically created popup buttons, use event delegation
        document.addEventListener('mouseenter', (e) => {
            if (e.target.classList.contains('popup-btn')) {
                if (!e.target._originalText) {
                    e.target._originalText = e.target.textContent;
                }
                if (!e.target.classList.contains('wave-text')) {
                    createWaveAnimation(e.target);
                }
            }
        }, true);

        document.addEventListener('mouseleave', (e) => {
            if (e.target.classList.contains('popup-btn') && e.target._originalText) {
                resetWaveAnimation(e.target, e.target._originalText);
            }
        }, true);

        // ============================================
        // MAP SEARCH FUNCTIONALITY
        // Search listings and locations
        // ============================================
        const mapSearchBtn = document.getElementById('map-search-btn');
        const mapSearchInput = document.getElementById('map-search-input');
        const mapSearchResults = document.getElementById('map-search-results');
        let searchExpanded = false;

        // Helper function to collapse search (closes input and results)
        // This is called when user interacts with other UI elements
        // Always hides results regardless of searchExpanded state to handle edge cases
        function collapseSearch() {
            searchExpanded = false;
            if (mapSearchInput) {
                mapSearchInput.classList.remove('expanded');
                mapSearchInput.value = '';
                mapSearchInput.blur(); // Remove focus
            }
            if (mapSearchResults) {
                mapSearchResults.classList.remove('visible');
                mapSearchResults.innerHTML = ''; // Clear results content
            }
        }

        // Expose collapseSearch globally so other sections can use it
        window.collapseSearch = collapseSearch;

        // Global Escape key handler - closes search from anywhere
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && (searchExpanded || mapSearchResults?.classList.contains('visible'))) {
                collapseSearch();
            }
        });

        if (mapSearchBtn && mapSearchInput && mapSearchResults) {
            // Toggle search input expansion
            mapSearchBtn.addEventListener('click', () => {
                if (!searchExpanded) {
                    // Expand search
                    searchExpanded = true;
                    mapSearchInput.classList.add('expanded');
                    mapSearchInput.focus();
                    // Hide zoom hint when search is expanded (#11)
                    const zoomHintEl = document.getElementById('zoom-hint');
                    if (zoomHintEl) {
                        zoomHintEl.classList.add('hidden');
                    }
                } else {
                    // Collapse search - use helper function for consistency
                    collapseSearch();
                }
            });

            // Close search when clicking outside search control
            // Check both searchExpanded state AND if results are visible (handles edge cases)
            document.addEventListener('click', (e) => {
                const resultsVisible = mapSearchResults.classList.contains('visible');
                if ((searchExpanded || resultsVisible) && !e.target.closest('#map-search-control')) {
                    collapseSearch();
                }
            });

            // Also close search when clicking anywhere in sidebar (except search control)
            // This ensures interactions like checkboxes, toggles, etc. close the search
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.addEventListener('click', (e) => {
                    const resultsVisible = mapSearchResults.classList.contains('visible');
                    if ((searchExpanded || resultsVisible) && !e.target.closest('#map-search-control')) {
                        collapseSearch();
                    }
                }, true); // Use capture phase to ensure this fires before other handlers
            }

            // Fuzzy search function for listings
            function searchListings(query) {
                const normalizedQuery = query.toLowerCase().replace(/\s+/g, '');
                return sunshineSpots.filter(spot => {
                    const nameMatch = spot.name.toLowerCase().replace(/\s+/g, '').includes(normalizedQuery);
                    const locationMatch = spot.location && spot.location.toLowerCase().replace(/\s+/g, '').includes(normalizedQuery);
                    const descMatch = spot.description && spot.description.toLowerCase().includes(query.toLowerCase());
                    return nameMatch || locationMatch || descMatch;
                }).slice(0, 8); // Limit to 8 results
            }

            // Geocode location using Nominatim with improved error handling
            async function geocodeLocation(query) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=3&countrycodes=us`,
                        {
                            headers: { 'Accept': 'application/json' },
                            signal: controller.signal
                        }
                    );
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data.map(item => ({
                        name: item.display_name.split(',').slice(0, 2).join(','),
                        fullName: item.display_name,
                        lat: parseFloat(item.lat),
                        lng: parseFloat(item.lon),
                        type: 'location'
                    }));
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.warn('Geocoding request timed out');
                    } else {
                        console.error('Geocoding error:', error);
                    }
                    return [];
                }
            }

            // Render search results
            function renderSearchResults(listings, locations) {
                mapSearchResults.innerHTML = '';

                if (listings.length === 0 && locations.length === 0) {
                    mapSearchResults.innerHTML = '<div class="search-no-results">No results found</div>';
                    mapSearchResults.classList.add('visible');
                    return;
                }

                // Add listing results
                listings.forEach(spot => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="search-result-name">${spot.name}</div>
                        <div class="search-result-location">${spot.location || ''}</div>
                        <span class="search-result-category">${spot.category}</span>
                    `;

                    // Handler function for selecting this search result
                    const selectResult = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Close search first
                        collapseSearch();

                        // Find the marker first
                        let targetMarker = null;
                        unifiedCluster.eachLayer(layer => {
                            if (layer.getLatLng &&
                                Math.abs(layer.getLatLng().lat - spot.lat) < 0.0001 &&
                                Math.abs(layer.getLatLng().lng - spot.lng) < 0.0001) {
                                targetMarker = layer;
                            }
                        });

                        if (targetMarker) {
                            // Use zoomToShowLayer which handles clusters properly
                            unifiedCluster.zoomToShowLayer(targetMarker, () => {
                                setTimeout(() => targetMarker.openPopup(), 100);
                            });
                        } else {
                            // Fallback: fly to location using viewport-aware utility
                            flyToWithOffset(L.latLng(spot.lat, spot.lng), 17);
                        }
                    };

                    // Add both click and touchend for mobile compatibility (#13)
                    item.addEventListener('click', selectResult);
                    item.addEventListener('touchend', selectResult, { passive: false });
                    mapSearchResults.appendChild(item);
                });

                // Add location results with separator if we have both types
                if (listings.length > 0 && locations.length > 0) {
                    const separator = document.createElement('div');
                    separator.style.cssText = 'padding: 8px 16px; font-size: 0.75rem; color: #999; background: #f5f5f5; text-transform: uppercase; letter-spacing: 1px;';
                    separator.textContent = 'Places';
                    mapSearchResults.appendChild(separator);
                }

                locations.forEach(loc => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="search-result-name">${loc.name}</div>
                        <div class="search-result-location">${loc.fullName}</div>
                    `;

                    // Handler function for selecting this location result
                    const selectLocation = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Close search first
                        collapseSearch();

                        // Fly to location using viewport-aware utility
                        flyToWithOffset(L.latLng(loc.lat, loc.lng), 12);
                    };

                    // Add both click and touchend for mobile compatibility (#13)
                    item.addEventListener('click', selectLocation);
                    item.addEventListener('touchend', selectLocation, { passive: false });
                    mapSearchResults.appendChild(item);
                });

                mapSearchResults.classList.add('visible');
            }

            // Debounce search
            let searchTimeout;
            mapSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                if (query.length < 2) {
                    mapSearchResults.classList.remove('visible');
                    return;
                }

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    // Search listings first
                    const listingResults = searchListings(query);

                    // If we have good listing matches, show them immediately
                    if (listingResults.length > 0) {
                        renderSearchResults(listingResults, []);
                    }

                    // Also search for locations (towns, cities)
                    const locationResults = await geocodeLocation(query);
                    renderSearchResults(listingResults, locationResults);
                }, 300);
            });

            // Handle Enter key for immediate search
            mapSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = mapSearchInput.value.trim();
                    if (query.length >= 2) {
                        // Trigger search immediately
                        clearTimeout(searchTimeout);
                        (async () => {
                            const listingResults = searchListings(query);
                            const locationResults = await geocodeLocation(query);
                            renderSearchResults(listingResults, locationResults);
                        })();
                    }
                }
                // Note: Escape key is handled by the global document keydown listener
            });
        }

        // ============================================
        // SUNSHINE TEXT GOD RAYS EFFECT
        // Sparkling sunlight rays shoot out on hover
        // Full viewport overlay - no clipping
        // ============================================
        const sunshineText = document.querySelector('h1 span');
        const godRaysGlow = document.getElementById('god-rays-glow');

        if (sunshineText && godRaysGlow) {
            // Desktop: mouse hover behavior
            sunshineText.addEventListener('mouseenter', function(e) {
                godRaysGlow.classList.add('active');
            });

            sunshineText.addEventListener('mousemove', function(e) {
                // Calculate mouse position as percentage of viewport
                const mouseX = (e.clientX / window.innerWidth) * 100;
                const mouseY = (e.clientY / window.innerHeight) * 100;

                // Set CSS variables on the glow element
                godRaysGlow.style.setProperty('--mouse-x', mouseX + '%');
                godRaysGlow.style.setProperty('--mouse-y', mouseY + '%');
            });

            sunshineText.addEventListener('mouseleave', function() {
                godRaysGlow.classList.remove('active');
            });

            // Mobile: touch and hold behavior - rays show while finger is touching (#12)
            sunshineText.addEventListener('touchstart', function(e) {
                godRaysGlow.classList.add('active');
                // Set initial position
                const touch = e.touches[0];
                const touchX = (touch.clientX / window.innerWidth) * 100;
                const touchY = (touch.clientY / window.innerHeight) * 100;
                godRaysGlow.style.setProperty('--mouse-x', touchX + '%');
                godRaysGlow.style.setProperty('--mouse-y', touchY + '%');
            }, { passive: true });

            sunshineText.addEventListener('touchmove', function(e) {
                // Update position as finger moves
                const touch = e.touches[0];
                const touchX = (touch.clientX / window.innerWidth) * 100;
                const touchY = (touch.clientY / window.innerHeight) * 100;
                godRaysGlow.style.setProperty('--mouse-x', touchX + '%');
                godRaysGlow.style.setProperty('--mouse-y', touchY + '%');
            }, { passive: true });

            sunshineText.addEventListener('touchend', function() {
                godRaysGlow.classList.remove('active');
            }, { passive: true });

            sunshineText.addEventListener('touchcancel', function() {
                godRaysGlow.classList.remove('active');
            }, { passive: true });
        }

        // ============================================
        // FIDGET SUN SPINNER
        // Drag to spin with momentum physics
        // ============================================
        const fidgetSun = document.getElementById('fidget-sun');
        const fidgetContainer = fidgetSun ? fidgetSun.parentElement : null;
        if (fidgetSun && fidgetContainer) {
            let rotation = 0;
            let velocity = 0;
            let isDragging = false;
            let lastAngle = 0;
            let lastTime = 0;
            let animationId = null;

            function getAngle(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                fidgetSun.classList.add('spinning');
                const rect = fidgetSun.getBoundingClientRect();
                lastAngle = getAngle(e, rect);
                lastTime = Date.now();
                velocity = 0;
                if (animationId) cancelAnimationFrame(animationId);
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                const rect = fidgetSun.getBoundingClientRect();
                const currentAngle = getAngle(e, rect);
                const now = Date.now();
                const dt = Math.max(now - lastTime, 1);

                let deltaAngle = currentAngle - lastAngle;
                // Handle angle wrap-around
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                rotation += deltaAngle * (180 / Math.PI);
                velocity = (deltaAngle * (180 / Math.PI)) / dt * 35; // Maximum momentum for fast flicks

                fidgetSun.style.transform = `rotate(${rotation}deg)`;
                lastAngle = currentAngle;
                lastTime = now;
            }

            function endDrag() {
                if (!isDragging) return;
                isDragging = false;
                fidgetSun.classList.remove('spinning');
                // Start momentum animation
                animateMomentum();
            }

            function animateMomentum() {
                if (Math.abs(velocity) < 0.005) {
                    velocity = 0;
                    return;
                }
                rotation += velocity;
                velocity *= 0.9995; // Ultra-low friction - precision bearings
                fidgetSun.style.transform = `rotate(${rotation}deg)`;
                animationId = requestAnimationFrame(animateMomentum);
            }

            // Mouse events - use container for larger hit area
            fidgetContainer.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // Touch events
            fidgetContainer.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);

            // Emoji burst on click
            const emojis = ['', '', '', '', '', '', ''];
            let clickStartTime = 0;
            let clickStartPos = { x: 0, y: 0 };

            fidgetContainer.addEventListener('mousedown', (e) => {
                clickStartTime = Date.now();
                clickStartPos = { x: e.clientX, y: e.clientY };
            });

            fidgetContainer.addEventListener('mouseup', (e) => {
                const elapsed = Date.now() - clickStartTime;
                const moved = Math.sqrt(
                    Math.pow(e.clientX - clickStartPos.x, 2) +
                    Math.pow(e.clientY - clickStartPos.y, 2)
                );
                // Only burst if it was a quick click without much drag
                if (elapsed < 200 && moved < 10) {
                    burstEmojis(e);
                }
            });

            function burstEmojis(e) {
                const rect = fidgetSun.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                // Pick 3 random emoji types for this burst
                const shuffled = [...emojis].sort(() => Math.random() - 0.5);
                const selectedEmojis = shuffled.slice(0, 3);

                // Spawn 20 emojis using only the 3 selected types
                const burstCount = 20;
                for (let i = 0; i < burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = selectedEmojis[Math.floor(Math.random() * selectedEmojis.length)];
                    const size = 24 + Math.random() * 20;
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${size}px;
                        pointer-events: none;
                        z-index: 10000;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    // Random direction and velocity - bigger explosion
                    const angle = (Math.PI * 2 * i / burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 250 + Math.random() * 200;  // Faster
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 400;
                    const startTime = performance.now();
                    // Pre-calculate spin direction to avoid flicker
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 180 + Math.random() * 180;

                    function animateEmoji(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);  // Slower fade
                        const scale = 1 + t * 0.5;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmoji);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmoji);
                }
            }

            // Gentle idle spin
            let idleRotation = 0;
            function idleSpin() {
                if (!isDragging && Math.abs(velocity) < 0.1) {
                    idleRotation += 0.1;
                    fidgetSun.style.transform = `rotate(${rotation + idleRotation}deg)`;
                }
                requestAnimationFrame(idleSpin);
            }
            idleSpin();
        }

        // ============================================
        // SIDEBAR/FOOTER FIDGET SUN (for tablet/mobile)
        // Same physics as header version
        // ============================================
        const fidgetSunSidebar = document.getElementById('fidget-sun-sidebar');
        const fidgetSunFooter = document.getElementById('fidget-sun-footer');

        // Use whichever one exists (sidebar takes priority on mobile)
        const mobileFidgetSun = fidgetSunSidebar || fidgetSunFooter;
        const fidgetMobileContainer = mobileFidgetSun ? mobileFidgetSun.parentElement : null;
        if (mobileFidgetSun && fidgetMobileContainer) {
            let rotationF = 0;
            let velocityF = 0;
            let isDraggingF = false;
            let lastAngleF = 0;
            let lastTimeF = 0;
            let animationIdF = null;

            function getAngleF(e, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX);
            }

            function startDragF(e) {
                e.preventDefault();
                isDraggingF = true;
                mobileFidgetSun.classList.add('spinning');
                const rect = mobileFidgetSun.getBoundingClientRect();
                lastAngleF = getAngleF(e, rect);
                lastTimeF = Date.now();
                velocityF = 0;
                if (animationIdF) cancelAnimationFrame(animationIdF);
            }

            function dragF(e) {
                if (!isDraggingF) return;
                e.preventDefault();
                const rect = mobileFidgetSun.getBoundingClientRect();
                const currentAngle = getAngleF(e, rect);
                const now = Date.now();
                const dt = Math.max(now - lastTimeF, 1);

                let deltaAngle = currentAngle - lastAngleF;
                if (deltaAngle > Math.PI) deltaAngle -= 2 * Math.PI;
                if (deltaAngle < -Math.PI) deltaAngle += 2 * Math.PI;

                rotationF += deltaAngle * (180 / Math.PI);
                velocityF = (deltaAngle * (180 / Math.PI)) / dt * 35;

                mobileFidgetSun.style.transform = `rotate(${rotationF}deg)`;
                lastAngleF = currentAngle;
                lastTimeF = now;
            }

            function endDragF() {
                if (!isDraggingF) return;
                isDraggingF = false;
                mobileFidgetSun.classList.remove('spinning');
                animateMomentumF();
            }

            function animateMomentumF() {
                if (Math.abs(velocityF) < 0.005) {
                    velocityF = 0;
                    return;
                }
                rotationF += velocityF;
                velocityF *= 0.9995;
                mobileFidgetSun.style.transform = `rotate(${rotationF}deg)`;
                animationIdF = requestAnimationFrame(animateMomentumF);
            }

            fidgetMobileContainer.addEventListener('mousedown', startDragF);
            document.addEventListener('mousemove', dragF);
            document.addEventListener('mouseup', endDragF);
            fidgetMobileContainer.addEventListener('touchstart', startDragF, { passive: false });
            document.addEventListener('touchmove', dragF, { passive: false });
            document.addEventListener('touchend', endDragF);

            // Emoji burst on tap/click for mobile
            const emojisF = ['', '', '', '', '', '', ''];
            let clickStartTimeF = 0;
            let clickStartPosF = { x: 0, y: 0 };
            let rotationAtStartF = 0;

            function getClientPos(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }

            // Mouse click detection for desktop/dev tools
            fidgetMobileContainer.addEventListener('mousedown', (e) => {
                clickStartTimeF = Date.now();
                rotationAtStartF = rotationF;
                const pos = getClientPos(e);
                clickStartPosF = { x: pos.x, y: pos.y };
            });

            fidgetMobileContainer.addEventListener('mouseup', (e) => {
                const elapsed = Date.now() - clickStartTimeF;
                const rotationDelta = Math.abs(rotationF - rotationAtStartF);
                const pos = getClientPos(e);
                const moved = Math.sqrt(
                    Math.pow(pos.x - clickStartPosF.x, 2) +
                    Math.pow(pos.y - clickStartPosF.y, 2)
                );
                // Trigger emoji if quick tap with minimal movement AND minimal rotation
                if (elapsed < 400 && moved < 50 && rotationDelta < 15) {
                    burstEmojisMobile(pos);
                }
            });

            // Touch detection for actual mobile devices
            fidgetMobileContainer.addEventListener('touchstart', (e) => {
                clickStartTimeF = Date.now();
                rotationAtStartF = rotationF;
                const pos = getClientPos(e);
                clickStartPosF = { x: pos.x, y: pos.y };
            }, { passive: true });

            fidgetMobileContainer.addEventListener('touchend', (e) => {
                const elapsed = Date.now() - clickStartTimeF;
                const rotationDelta = Math.abs(rotationF - rotationAtStartF);
                const endPos = e.changedTouches ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY } : clickStartPosF;
                const moved = Math.sqrt(
                    Math.pow(endPos.x - clickStartPosF.x, 2) +
                    Math.pow(endPos.y - clickStartPosF.y, 2)
                );
                // Trigger emoji if quick tap with minimal movement AND minimal rotation
                if (elapsed < 400 && moved < 80 && rotationDelta < 15) {
                    burstEmojisMobile(endPos);
                }
            }, { passive: true });

            function burstEmojisMobile(pos) {
                const rect = mobileFidgetSun.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const shuffled = [...emojisF].sort(() => Math.random() - 0.5);
                const burstEmojis = shuffled.slice(0, 3);
                const burstCount = 8 + Math.floor(Math.random() * 5);

                for (let i = 0; i < burstCount; i++) {
                    const emoji = document.createElement('div');
                    emoji.textContent = burstEmojis[i % burstEmojis.length];
                    emoji.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: ${20 + Math.random() * 16}px;
                        pointer-events: none;
                        z-index: 10001;
                        transform: translate(-50%, -50%);
                        will-change: transform, opacity, left, top;
                    `;
                    document.body.appendChild(emoji);

                    const angle = (Math.PI * 2 * i / burstCount) + (Math.random() - 0.5) * 0.6;
                    const speed = 200 + Math.random() * 150;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const gravity = 350;
                    const startTime = performance.now();
                    const spinDirection = Math.random() > 0.5 ? 1 : -1;
                    const spinSpeed = 150 + Math.random() * 150;

                    function animateEmojiM(currentTime) {
                        const t = (currentTime - startTime) / 1000;
                        const x = centerX + vx * t;
                        const y = centerY + vy * t + 0.5 * gravity * t * t;
                        const opacity = Math.max(0, 1 - t * 0.9);
                        const scale = 1 + t * 0.4;
                        const spin = t * spinSpeed * spinDirection;

                        emoji.style.left = `${x}px`;
                        emoji.style.top = `${y}px`;
                        emoji.style.opacity = opacity;
                        emoji.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${spin}deg)`;

                        if (opacity > 0) {
                            requestAnimationFrame(animateEmojiM);
                        } else {
                            emoji.remove();
                        }
                    }
                    requestAnimationFrame(animateEmojiM);
                }
            }

            // Gentle idle spin for mobile
            let idleRotationF = 0;
            function idleSpinF() {
                if (!isDraggingF && Math.abs(velocityF) < 0.1) {
                    idleRotationF += 0.1;
                    mobileFidgetSun.style.transform = `rotate(${rotationF + idleRotationF}deg)`;
                }
                requestAnimationFrame(idleSpinF);
            }
            idleSpinF();
        }

        // ============================================
        // COLD BEER FREEZE & SNOW EFFECT
        // ============================================
        const coldBeerElement = document.querySelector('.cold-beer');
        const freezeOverlay = document.getElementById('freeze-overlay');
        let snowflakes = [];
        let snowInterval = null;
        let isSnowing = false;

        function createSnowflake() {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.textContent = ['', '', '', '', '', '', ''][Math.floor(Math.random() * 7)];
            snowflake.style.left = Math.random() * 100 + 'vw';

            // Bigger snowflakes with more size variation
            const size = 1.2 + Math.random() * 1.3;
            snowflake.style.fontSize = size + 'rem';

            // Random spin amount (some spin a lot, some barely)
            const spinDirection = Math.random() > 0.5 ? 1 : -1;
            const spinAmount = (180 + Math.random() * 540) * spinDirection;
            snowflake.style.setProperty('--spin', spinAmount + 'deg');

            // Random sway pattern (left-right movement)
            const swayBase = (Math.random() - 0.5) * 60;
            snowflake.style.setProperty('--sway1', (swayBase + (Math.random() - 0.5) * 30) + 'px');
            snowflake.style.setProperty('--sway2', (swayBase * -0.5 + (Math.random() - 0.5) * 40) + 'px');
            snowflake.style.setProperty('--sway3', (swayBase * 0.3 + (Math.random() - 0.5) * 35) + 'px');
            snowflake.style.setProperty('--sway4', (swayBase * -0.2 + (Math.random() - 0.5) * 25) + 'px');

            // Variable fall duration for natural continuous effect (avoids "wave" pattern)
            // Wide range ensures snowflakes finish at different times for steady coverage
            const duration = 5 + Math.random() * 12;  // 5-17 seconds (wider spread)
            const delay = Math.random() * 0.5;
            snowflake.style.animation = `snowfall ${duration}s linear ${delay}s forwards`;

            document.body.appendChild(snowflake);
            snowflakes.push(snowflake);

            // Remove after animation completes (cleanup regardless of state)
            setTimeout(() => {
                if (snowflake.parentNode) {
                    snowflake.remove();
                }
                snowflakes = snowflakes.filter(s => s !== snowflake);
            }, (duration + delay) * 1000);
        }

        function startSnow() {
            if (isSnowing) return;
            isSnowing = true;
            freezeOverlay.classList.add('active');

            // Create initial burst of snowflakes from the top
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    if (isSnowing) createSnowflake();
                }, i * 20);  // Staggered over ~1000ms
            }

            // Start continuous creation - matches initial burst density
            // Creates 3-4 snowflakes every 40ms to maintain heavy snowfall
            snowInterval = setInterval(() => {
                if (isSnowing && snowflakes.length < 250) {
                    // Create multiple flakes per interval for heavy snow
                    createSnowflake();
                    createSnowflake();
                    if (Math.random() > 0.4) {
                        createSnowflake();
                    }
                    if (Math.random() > 0.7) {
                        createSnowflake();
                    }
                }
            }, 40);  // Fast interval for heavy continuous snowfall
        }

        function stopSnow() {
            isSnowing = false;
            freezeOverlay.classList.remove('active');

            // Stop creating new snowflakes immediately
            if (snowInterval) {
                clearInterval(snowInterval);
                snowInterval = null;
            }

            // Fade out existing snowflakes slowly (2.5s to match cold beer transition)
            snowflakes.forEach(flake => {
                flake.classList.add('thawing');
            });

            // Clean up after slow thaw completes
            setTimeout(() => {
                snowflakes.forEach(flake => {
                    if (flake.parentNode) flake.remove();
                });
                snowflakes = [];
            }, 2600);
        }

        // Snow close button for mobile
        const snowCloseButton = document.getElementById('snow-close-button');
        let snowActivatedByTap = false;  // Track if snow was activated by tap (vs hold)

        function showSnowCloseButton() {
            if (snowCloseButton) {
                snowCloseButton.classList.add('visible');
            }
        }

        function hideSnowCloseButton() {
            if (snowCloseButton) {
                snowCloseButton.classList.remove('visible');
            }
        }

        if (snowCloseButton) {
            snowCloseButton.addEventListener('click', function() {
                snowActivatedByTap = false;
                stopSnow();
                hideSnowCloseButton();
            });
        }

        if (coldBeerElement) {
            // Check if device supports hover (has a pointer like mouse/trackpad)
            const hasHover = window.matchMedia('(hover: hover)').matches;

            if (hasHover) {
                // Desktop: use hover behavior (like sunshine effect)
                coldBeerElement.addEventListener('mouseenter', startSnow);
                coldBeerElement.addEventListener('mouseleave', stopSnow);
            }

            // Mobile: supports both tap-to-toggle AND touch-and-hold
            let touchStartTime = 0;
            let touchHoldThreshold = 300; // ms - holds longer than this are "hold" mode

            coldBeerElement.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                startSnow();
            }, { passive: true });

            coldBeerElement.addEventListener('touchend', function() {
                const touchDuration = Date.now() - touchStartTime;

                if (touchDuration < touchHoldThreshold) {
                    // Short tap - toggle mode, show close button
                    snowActivatedByTap = true;
                    showSnowCloseButton();
                    // Don't stop snow - let user close with button
                } else {
                    // Long hold - stop when released (like sunshine)
                    if (!snowActivatedByTap) {
                        stopSnow();
                    }
                }
            }, { passive: true });

            coldBeerElement.addEventListener('touchcancel', function() {
                if (!snowActivatedByTap) {
                    stopSnow();
                }
            }, { passive: true });
        }

        // ============================================
        // ACCELEROMETER WIND EFFECT FOR SNOWFLAKES
        // Tilt device to blow wind on snowflakes
        // ============================================
        let windOffset = 0;
        let targetWindOffset = 0;

        function handleDeviceOrientation(event) {
            if (!isSnowing || snowflakes.length === 0) return;

            // gamma is left-right tilt (-90 to 90)
            const tilt = event.gamma || 0;

            // Convert tilt to wind - balanced effect (not too subtle, not too extreme)
            const clampedTilt = Math.max(-50, Math.min(50, tilt));
            // Happy medium - noticeable and whimsical but not overwhelming
            targetWindOffset = clampedTilt * 4; // Up to ~200px drift at max tilt
        }

        // Smooth wind animation loop - applies drift to snowflakes
        function animateWind() {
            // Smooth interpolation for natural, responsive feel
            windOffset += (targetWindOffset - windOffset) * 0.15;

            if (isSnowing && snowflakes.length > 0) {
                snowflakes.forEach((flake) => {
                    if (!flake.classList.contains('melting') && !flake.classList.contains('thawing')) {
                        // Apply varying wind effect based on snowflake "weight" (size)
                        // Smaller flakes are lighter and drift more
                        const size = parseFloat(flake.style.fontSize) || 1.5;
                        const weightFactor = 2.5 - size * 0.6; // Range ~0.7 to ~1.9

                        // Calculate drift
                        const windEffect = windOffset * weightFactor;

                        // Apply as marginLeft (works alongside CSS animation transform)
                        flake.style.marginLeft = windEffect + 'px';
                    }
                });
            }

            requestAnimationFrame(animateWind);
        }

        // Request permission for iOS 13+ devices
        function requestAccelerometerPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                DeviceOrientationEvent.requestPermission()
                    .then(permission => {
                        if (permission === 'granted') {
                            window.addEventListener('deviceorientation', handleDeviceOrientation);
                        }
                    })
                    .catch(console.error);
            } else {
                // Non-iOS or older iOS - just add listener
                window.addEventListener('deviceorientation', handleDeviceOrientation);
            }
        }

        // Start wind animation loop
        animateWind();

        // Request accelerometer on first touch of cold beer
        let accelerometerRequested = false;
        if (coldBeerElement) {
            coldBeerElement.addEventListener('touchstart', () => {
                if (!accelerometerRequested) {
                    accelerometerRequested = true;
                    requestAccelerometerPermission();
                }
            }, { once: false, passive: true });
        }

        // Also try to enable on page load for Android/non-iOS
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission !== 'function') {
            window.addEventListener('deviceorientation', handleDeviceOrientation);
        }

        // ============================================
        // COPY PROTECTION
        // Prevents copying of site content (except user input fields)
        // ============================================
        document.addEventListener('copy', function(e) {
            // Allow copying from input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            e.preventDefault();
        });

        document.addEventListener('cut', function(e) {
            // Allow cutting from input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            e.preventDefault();
        });

        // Prevent right-click context menu (optional additional protection)
        document.addEventListener('contextmenu', function(e) {
            // Allow context menu on input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            e.preventDefault();
        });

        // ============================================
        // CLEANUP ON PAGE UNLOAD
        // Prevents memory leaks from intervals and event listeners
        // ============================================
        window.addEventListener('beforeunload', function() {
            // Clear intervals
            if (tickerInterval) {
                clearInterval(tickerInterval);
                tickerInterval = null;
            }
            if (snowInterval) {
                clearInterval(snowInterval);
                snowInterval = null;
            }
            if (emailModalTimer) {
                clearTimeout(emailModalTimer);
                emailModalTimer = null;
            }

            // Clean up snowflakes
            snowflakes.forEach(flake => {
                if (flake.parentNode) flake.remove();
            });
            snowflakes = [];

            // Remove device orientation listener
            window.removeEventListener('deviceorientation', handleDeviceOrientation);
        });
    </script>
</body>
</html>
